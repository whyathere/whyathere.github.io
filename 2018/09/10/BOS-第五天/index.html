<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="BOS," />










<meta name="description" content="分区之下拉框 分区添加业务分析城市region，国家地理区域区域：需要划分成多个分区，区域过大。分区：地理位置   明细信息  门牌号  单双号   路名 关键字 辅助关键字 分区添加：闵行区 分区信息更改：  bc subareasubarea有一个外键：region id Struts2表单数据封装三种方式：  1、modelDriven 2、set属性 3、对象 ognl表达式  页面标签：">
<meta name="keywords" content="BOS">
<meta property="og:type" content="article">
<meta property="og:title" content="BOS 第五天">
<meta property="og:url" content="http://yoursite.com/2018/09/10/BOS-第五天/index.html">
<meta property="og:site_name" content="Bill">
<meta property="og:description" content="分区之下拉框 分区添加业务分析城市region，国家地理区域区域：需要划分成多个分区，区域过大。分区：地理位置   明细信息  门牌号  单双号   路名 关键字 辅助关键字 分区添加：闵行区 分区信息更改：  bc subareasubarea有一个外键：region id Struts2表单数据封装三种方式：  1、modelDriven 2、set属性 3、对象 ognl表达式  页面标签：">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="http://whyathere.github.io/images/bos/day05/分区分析图.jpg">
<meta property="og:image" content="http://whyathere.github.io/images/bos/day05/综合查询分析.jpg">
<meta property="og:image" content="http://whyathere.github.io/images/bos/day05/测试load方法的请求.jpg">
<meta property="og:image" content="http://whyathere.github.io/images/bos/day05/分区数据导出功能.jpg">
<meta property="og:updated_time" content="2018-09-10T08:30:00.919Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="BOS 第五天">
<meta name="twitter:description" content="分区之下拉框 分区添加业务分析城市region，国家地理区域区域：需要划分成多个分区，区域过大。分区：地理位置   明细信息  门牌号  单双号   路名 关键字 辅助关键字 分区添加：闵行区 分区信息更改：  bc subareasubarea有一个外键：region id Struts2表单数据封装三种方式：  1、modelDriven 2、set属性 3、对象 ognl表达式  页面标签：">
<meta name="twitter:image" content="http://whyathere.github.io/images/bos/day05/分区分析图.jpg">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/2018/09/10/BOS-第五天/"/>





  <title>BOS 第五天 | Bill</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Bill</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/09/10/BOS-第五天/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Bill">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">BOS 第五天</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-09-10T16:30:00+08:00">
                2018-09-10
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/项目/" itemprop="url" rel="index">
                    <span itemprop="name">项目</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h3 id="分区之下拉框"><a href="#分区之下拉框" class="headerlink" title="分区之下拉框"></a>分区之下拉框</h3><hr>
<h4 id="分区添加业务分析"><a href="#分区添加业务分析" class="headerlink" title="分区添加业务分析"></a>分区添加业务分析</h4><p>城市region，国家地理区域<br>区域：需要划分成多个分区，区域过大。<br>分区：地理位置   明细信息  门牌号  单双号   路名 关键字 辅助关键字</p>
<p>分区添加：闵行区</p>
<p>分区信息更改：  bc subarea<br>subarea有一个外键：region id</p>
<p>Struts2表单数据封装<br>三种方式：</p>
<ul>
<li>1、modelDriven</li>
<li>2、set属性</li>
<li>3、对象 ognl表达式</li>
</ul>
<p>页面标签：region.id</p>
<hr>
<h4 id="分区添加之下拉框显示说明"><a href="#分区添加之下拉框显示说明" class="headerlink" title="分区添加之下拉框显示说明"></a>分区添加之下拉框显示说明</h4><p>subarea.jsp前端页面编辑<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;form id=<span class="string">"addSubareaForm"</span> method=<span class="string">"post"</span> action=<span class="string">"<span class="variable">$&#123;pageContext.request.contextPath&#125;</span>/bc/subAreaAction_save"</span>&gt;</span><br></pre></td></tr></table></figure></p>
<p>在做分区添加的时候主键是怎么做的？<br>easyui的下拉框<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;td&gt;</span><br><span class="line">    &lt;%--下拉框--%&gt;</span><br><span class="line">    &lt;input class=<span class="string">"easyui-combobox"</span> name=<span class="string">"region.id"</span></span><br><span class="line">    data-options=<span class="string">"valueField:'id',textField:'name',url:'json/standard.json'"</span>/&gt;</span><br><span class="line">&lt;/td&gt;</span><br></pre></td></tr></table></figure></p>
<pre><code>valueField:&apos;id&apos;:json格式数据返回的&apos;id&apos;的内容
textField：下拉框显示的内容。是id=&apos;id&apos;的name的值
</code></pre><p>后台是返回的是List<region></region></p>
<hr>
<h5 id="分区添加之区域列表回显实现"><a href="#分区添加之区域列表回显实现" class="headerlink" title="分区添加之区域列表回显实现"></a>分区添加之区域列表回显实现</h5><p>首先regionAction<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">//分区添加业务  区域全部查询  ajaxList形式返回</span><br><span class="line">@Action(value = <span class="string">"regionAction_ajaxList"</span>,results = &#123; @Result(name = <span class="string">"ajaxList"</span>, <span class="built_in">type</span> =<span class="string">"json"</span>)&#125;)</span><br><span class="line">public String <span class="function"><span class="title">ajaxList</span></span>() &#123;</span><br><span class="line">    try &#123;</span><br><span class="line">       List&lt;Region&gt; regions=serviceFacade.getRegionService().ajaxList();</span><br><span class="line">       push(regions);</span><br><span class="line">    &#125; catch (Exception e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">return</span> <span class="string">"ajaxList"</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>实现层<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">public List&lt;Region&gt; <span class="function"><span class="title">ajaxList</span></span>() &#123;</span><br><span class="line">    <span class="built_in">return</span> regionDao.findAll();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这样后端数据就完成了<br>然后前端想显示省市区的话需要在Region类内添加一个getName方法<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">public String <span class="function"><span class="title">getName</span></span>() &#123;</span><br><span class="line">    <span class="built_in">return</span> province + city + district;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这样前端就可以显示如下的格式<br>    山西省太原市小店区<br>但是由于get方法默认注解为@Column：在自动建表的时候，数据库里就会添加一个name的字段出来<br>由于这个字段跟Region表无关，因此必须要让这个字段不要在表里建立字段<br>需要添加注解：  @Transient<br>作用：瞬时，声明这个字段不会在表里创建出来，不要在表中建立name字段</p>
<hr>
<h4 id="分区添加之区域下拉框自动补全效果"><a href="#分区添加之区域下拉框自动补全效果" class="headerlink" title="分区添加之区域下拉框自动补全效果"></a>分区添加之区域下拉框自动补全效果</h4><pre><code>在前端添加参数
</code></pre><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">data-options=<span class="string">"mode:'remote',valueField:'id'</span></span><br></pre></td></tr></table></figure>
<p>mode:’remote’ ：它会在你输入的时候到服务器获取数据<br>例如我输入一个’天’，那么它就会往后台添加一个p：天<br>那么就可以在后台添加<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">//分区添加业务  区域全部查询  ajaxList形式返回</span><br><span class="line">@Action(value = <span class="string">"regionAction_ajaxList"</span>,results = &#123; @Result(name = <span class="string">"ajaxList"</span>, <span class="built_in">type</span> =<span class="string">"json"</span>)&#125;)</span><br><span class="line">public String <span class="function"><span class="title">ajaxList</span></span>() &#123;</span><br><span class="line">    try &#123;</span><br><span class="line">        String q=getParameter(<span class="string">"q"</span>);</span><br><span class="line">        //q如果没有值   就所有的都差  如果有值就模糊查询</span><br><span class="line">       List&lt;Region&gt; regions=serviceFacade.getRegionService().ajaxList(q);</span><br><span class="line">       push(regions);</span><br><span class="line">    &#125; catch (Exception e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">return</span> <span class="string">"ajaxList"</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>在实现层添加重载方法<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">public List&lt;Region&gt; ajaxList(String q) &#123;</span><br><span class="line">    <span class="keyword">if</span> (StringUtils.isNotBlank(q))&#123;</span><br><span class="line">        //模糊查询</span><br><span class="line">      <span class="built_in">return</span>  regionDao.ajaxListRegionByProviceOrCityDistrict(<span class="string">"%"</span>+q+<span class="string">"%"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">return</span> regionDao.findAll();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>在DAO层添加方法<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"> @Query(<span class="string">"from Region where province like ?1 or  city like ?1 or district like ?1"</span>)</span><br><span class="line">public List&lt;Region&gt; ajaxListRegionByProviceOrCityDistrict(String s);</span><br></pre></td></tr></table></figure></p>
<p>完成！！！注意返回值类型</p>
<hr>
<h4 id="分区添加业务功能"><a href="#分区添加业务功能" class="headerlink" title="分区添加业务功能"></a>分区添加业务功能</h4><p>1、首先在前端页面添加分区按钮点击事件<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">//添加分区保存按钮点击事件</span><br><span class="line">$(<span class="string">"#save"</span>).click(<span class="function"><span class="title">function</span></span> () &#123;</span><br><span class="line">    //提交表单</span><br><span class="line">    <span class="keyword">if</span> ($(<span class="string">"#addSubareaForm"</span>).form(<span class="string">"validate"</span>)) &#123;</span><br><span class="line">        $(<span class="string">"#addSubareaForm"</span>).submit();</span><br><span class="line">        $(<span class="string">"#addSubareaWindow"</span>).window(<span class="string">"close"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p>
<p>2、创建subAreaAction<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">@SuppressWarnings(<span class="string">"all"</span>)</span><br><span class="line">@Controller(<span class="string">"subareaAction"</span>)</span><br><span class="line">@Scope(<span class="string">"prototype"</span>)</span><br><span class="line">@Namespace(<span class="string">"/bc"</span>) // 根据页码的/user而来，不能乱写</span><br><span class="line">@ParentPackage(<span class="string">"bos"</span>) // 要进行扩展struts.xml中的</span><br><span class="line">public class SubareaAction extends BaseAction&lt;Subarea&gt; &#123;</span><br><span class="line"></span><br><span class="line">    // 区域添加</span><br><span class="line">    @Action(value = <span class="string">"subAreaAction_save"</span>, results = </span><br><span class="line">	&#123;@Result(name = <span class="string">"save"</span>, location = <span class="string">"/WEB-INF/pages/base/subarea.jsp"</span>)&#125;)</span><br><span class="line">    public String <span class="function"><span class="title">save</span></span>() &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            serviceFacade.getSubAreaService().save(model);</span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            push(<span class="literal">false</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">return</span> <span class="string">"save"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>3、依次创建 SubAreaService 和 SubAreaServiceImpl 以及 SubAreaDao<br>SubAreaService<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">public interface SubAreaService &#123;</span><br><span class="line">    public void save(Subarea model);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>SubAreaServiceImpl<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">@Service</span><br><span class="line">@Transactional</span><br><span class="line">public class SubAreaServiceImpl implements SubAreaService &#123;</span><br><span class="line"></span><br><span class="line">    @Autowired</span><br><span class="line">    private SubAreaDao subAreaDao;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public void save(Subarea model) &#123;</span><br><span class="line">    subAreaDao.save(model);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>SubAreaDao<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">public interface SubAreaDao extends JpaRepository&lt;Subarea, String&gt; &#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<hr>
<h4 id="分区分页查询编码以及延迟加载问题说明"><a href="#分区分页查询编码以及延迟加载问题说明" class="headerlink" title="分区分页查询编码以及延迟加载问题说明"></a>分区分页查询编码以及延迟加载问题说明</h4><p><img src="http://whyathere.github.io/images/bos/day05/分区分析图.jpg" alt=""><br>依照其他action操作即可，但是肯定会有延迟加载的问题。<br>原因：事务管理在业务层有效，但是web没有延迟加载的 DecidedZone 和 Region 的数据。<br>DecidedZone在它的get方法上面添加 @JSON(serialize = false)<br>但是Region是需要的在页面上显示的<br>解决方法有两种：</p>
<ol>
<li>业务层   配置region立刻查询数据库  将数据封装到对象中</li>
<li>将entityManager对象生命周期延伸到web  可以被json plugin序列化的时候查询数据库</li>
<li>报错信息：<br>Caused by: org.hibernate.LazyInitializationException: could not initialize proxy - no Session<br> at org.hibernate.proxy.AbstractLazyInitializer.initialize(AbstractLazyInitializer.java:167)<br> at org.hibernate.proxy.AbstractLazyInitializer.getImplementation(AbstractLazyInitializer.java:215)<br> at org.hibernate.proxy.pojo.javassist.JavassistLazyInitializer.invoke(JavassistLazyInitializer.java:190)<br> at com.zero.bos.domain.bc.Region_$$_javassist_4.getCity(Region_$$_javassist_4.java)<br> … 90 more<br>原因是：Region数据拿不到<br>第一种 做法：在代码中，进行region的查询。查询后就会默认进行数据的封装，而不会在需要的时候再去查询。<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public Page&lt;Subarea&gt; pageQuery(PageRequest pageable) &#123;</span><br><span class="line">    //拿到数据 但是没有region数据，要让它立即查询 需要调取数据</span><br><span class="line">    Page&lt;Subarea&gt; data = subAreaDao.findAll(pageable);</span><br><span class="line">    //目标数据</span><br><span class="line">    List&lt;Subarea&gt; list = data.getContent();</span><br><span class="line">    //拿到每一个数据</span><br><span class="line">    <span class="keyword">for</span> (Subarea s: list)&#123;</span><br><span class="line">        Hibernate.initialize(s.getRegion()); //立刻进行Region的查询  那么数据就都封装到data中了</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">return</span> data;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>每个进行查询，会向region表发语句，查询后就会默认封装到data中。</p>
<p>第二种：将EntityManager的生命周期放大<br>在web.xml中添加过滤器<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&lt;!--将EntityManager生命周期延伸到web--&gt;</span><br><span class="line">&lt;filter&gt;</span><br><span class="line">    &lt;filter-name&gt;OpenEntityManagerInViewFilter&lt;/filter-name&gt;</span><br><span class="line">    &lt;filter-class&gt;org.springframework.orm.jpa.support.OpenEntityManagerInViewFilter&lt;/filter-class&gt;</span><br><span class="line">&lt;/filter&gt;</span><br><span class="line"></span><br><span class="line">&lt;filter-mapping&gt;</span><br><span class="line">    &lt;filter-name&gt;OpenEntityManagerInViewFilter&lt;/filter-name&gt;</span><br><span class="line">    &lt;url-pattern&gt;/*&lt;/url-pattern&gt;</span><br><span class="line">&lt;/filter-mapping&gt;</span><br></pre></td></tr></table></figure></p>
<hr>
<h4 id="多表条件查询客户端实现"><a href="#多表条件查询客户端实现" class="headerlink" title="多表条件查询客户端实现"></a>多表条件查询客户端实现</h4><p>综合查询分析图：<br><img src="http://whyathere.github.io/images/bos/day05/综合查询分析.jpg" alt=""><br>这是一个多表、分页、条件的综合查询。<br>多条件查询，点击下一页的时候：客户端需要将用户输入表单的条件参数携带传给服务器<br>问题1：客户端每次分页查询的条件，是否可以不需要服务器提供<br>分页查询每次都是往：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">url: <span class="string">"<span class="variable">$&#123;pageContext.request.contextPath&#125;</span>/bc/subAreaAction_pageQuery"</span>,</span><br></pre></td></tr></table></figure></p>
<p>这个地址发<br>由于条件参数是在from表单中的，但是我们需要带有分页的功能，那么就需要在点击分页的时候还带着之前的查询条件。<br>那么可以将form发送给datagrid插件，这个插件有功能可以将请求发送到它的url中<br>并且将条件发送给后台，而且点击就分页的时候也会带着这些条件。<br>datagrid插件 方法…向 url 地址发送请求  并且可以 携带参数？</p>
<p>那么点击查询按钮的时候，触发datagrid的load方法，将表单里的参数，转换成{}<br>测试load方法能否传递给后台：<br>页面添加代码:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$(<span class="string">"#btn"</span>).click(<span class="function"><span class="title">function</span></span> () &#123;</span><br><span class="line">   //调用datagrid load 方法</span><br><span class="line">    $(<span class="string">"#grid"</span>).datagrid(<span class="string">"load"</span>,&#123;</span><br><span class="line">        name:<span class="string">'lisi'</span>,</span><br><span class="line">        age:23</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p>
<p><img src="http://whyathere.github.io/images/bos/day05/测试load方法的请求.jpg" alt=""><br>可以看到会往后台查询action发送，两个参数而且还有页面。<br>而且刷新之后，会再次往服务器发送请求，并且带着之前的参数。<br>服务器不需要将条件回送</p>
<p>查询是调用的datagrid的load方法，将参数json给load方法参数<br>解决：每一次分页查询，客户端都会将条件参数自动的发送给datagrid的url<br>每次调用dagagrid的load方法都会向datagrid的url发送请求，发送条件和页码</p>
<p>那么form表单如何将input数据  转换json对象<br>{region.privince：’江苏省’,…}—-&gt;load  pageQuery Model:Subarea<br>那么form对象如何序列化：<br>jquery表单 序列号json<br>searileze()—&gt;name=list&amp;age=23<br>searlizeArra()  是一个数组<br>那么就需要自己拼接出来<br>$.fn.来扩展jquery的方法,将对象转换为json对象发送给后台<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">//封装js方法，基于jquery</span><br><span class="line">$.fn.serializeJson = <span class="function"><span class="title">function</span></span> () &#123;</span><br><span class="line">    var serializeObj = &#123;&#125;;</span><br><span class="line">    var array = this.serializeArray();</span><br><span class="line">    var str = this.serialize();</span><br><span class="line">    $(array).each(<span class="function"><span class="title">function</span></span> () &#123;</span><br><span class="line">        <span class="keyword">if</span> (serializeObj[this.name]) &#123;</span><br><span class="line">            <span class="keyword">if</span> ($.isArray(serializeObj[this.name])) &#123;</span><br><span class="line">                serializeObj[this.name].push(this.value);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                serializeObj[this.name] = [serializeObj[this.name], this.value];</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            serializeObj[this.name] = this.value;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="built_in">return</span> serializeObj;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<p>这样前端的页面就完成了。</p>
<hr>
<h4 id="分区条件查询之单表查询代码实现"><a href="#分区条件查询之单表查询代码实现" class="headerlink" title="分区条件查询之单表查询代码实现"></a>分区条件查询之单表查询代码实现</h4><p>分析：客户端 提交参数  条件参数  可变  page+rows—&gt;action–&gt;pageQuery方法<br>那么就要考虑model能不能接收这些条件参数<br>page和rows  是BaseAction接收的，可以接收<br>条件参数 –&gt;封装Model 也就是 SubArea对象中<br>由于是使用ognl表达式，所以前端页面上面的要加上region.province</p>
<p>JpaRepository&lt;Subarea, String&gt;无法完成复杂的查询</p>
<p>JpaSpecificationExecutor<subarea>帮助我们完成复杂条件的查询<br>接口可以继承多个接口，用，隔开即可<br>这样Impl类就有<br>findAll（specal，pageable）;<br>action调用实现类<br>那么action就需要提供给它2个参数<br>参数1：Specification<br>参数2：PageRequest  page rows<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">public interface Specification&lt;T&gt; &#123;</span><br><span class="line">    Predicate toPredicate(Root&lt;T&gt; var1, CriteriaQuery&lt;?&gt; var2, CriteriaBuilder var3);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></subarea></p>
<p>参数1是一个接口，我们需要在action编写一个该接口的实现类。<br>接口的方法，实现类实现该方法，将请求参数  封装到Predicate<br>那么就是model里面取数据，然后往接口的实现类里面封<br>难度就是怎么写出来实现类；</p>
<p>spring data jpa如果做复杂的单表查询或者多表的复杂查询，全部采用<br>将条件封装到接口  Specification接口的实现类中<br>然后直接传递给DAO  即可，dao只需要继承JpaSpecificationExcecutor<t><br>首先进行无条件的测试：<br>SubareaAction<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">@Action(value = <span class="string">"subAreaAction_pageQuery"</span>)</span><br><span class="line">public String <span class="function"><span class="title">pageQuery</span></span>() &#123;</span><br><span class="line">    try &#123;</span><br><span class="line">        //将条件从Model中取出来  封装到Specification接口实现方法中</span><br><span class="line">        Specification&lt;Subarea&gt; spec=new Specification&lt;Subarea&gt;() &#123;</span><br><span class="line">            @Override</span><br><span class="line">            public Predicate toPredicate(Root&lt;Subarea&gt; root, CriteriaQuery&lt;?&gt; criteriaQuery, CriteriaBuilder criteriaBuilder) &#123;</span><br><span class="line">                <span class="built_in">return</span> null;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br></pre></td></tr></table></figure></t></p>
<p>service<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Page&lt;Subarea&gt; pageQuery(PageRequest pageRequest, Specification&lt;Subarea&gt; spec);</span><br></pre></td></tr></table></figure></p>
<p>serviceImpl<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public Page&lt;Subarea&gt; pageQuery(PageRequest pageRequest, Specification&lt;Subarea&gt; spec) &#123;</span><br><span class="line">    <span class="built_in">return</span> subAreaDao.findAll(spec,pageRequest);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>启动后查询正常</p>
<hr>
<p>下面进行条件查询<br>所以的查询关系都是and条件<br>数组不好声明，因为不确定条件有几个。但是可以用集合，然后转换成数组<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">// 区域的分页查询 分区分页查询 无条件分页+无条件分页查询</span><br><span class="line">//Subarea封装所有的请求参数条件 mysql <span class="built_in">limit</span> oracle rownum 动态的sql ，条件不一样</span><br><span class="line">@Action(value = <span class="string">"subAreaAction_pageQuery"</span>)</span><br><span class="line">public String <span class="function"><span class="title">pageQuery</span></span>() &#123;</span><br><span class="line">    try &#123;</span><br><span class="line">        //将条件从Model中取出来  封装到Specification接口实现方法中</span><br><span class="line">        Specification&lt;Subarea&gt; spec=new Specification&lt;Subarea&gt;() &#123;</span><br><span class="line">            @Override</span><br><span class="line">            public Predicate toPredicate(Root&lt;Subarea&gt; root, CriteriaQuery&lt;?&gt; criteriaQuery, CriteriaBuilder cb) &#123;</span><br><span class="line">                List&lt;Predicate&gt; list=new ArrayList&lt;Predicate&gt;();  //存放多个对象条件</span><br><span class="line">                //条件封装实现  root（查询的主表对象实体类） query  <span class="built_in">cd</span>（连接对象条件 类似 hibernate Critira Restrictions.）三个关键字</span><br><span class="line">                //1：关键字查询  查询自己的表就可以了 不需要多表连接的</span><br><span class="line">                <span class="keyword">if</span> (StringUtils.isNotBlank(model.getAddresskey()))&#123;</span><br><span class="line">                    //用户要进行关键字查询   前面是需要匹配的字段 后面是匹配的值  进行模糊查询</span><br><span class="line">                   Predicate p1= cb.like(root.get(<span class="string">"addresskey"</span>).as(String.class),<span class="string">"%"</span>+model.getAddresskey()+<span class="string">"%"</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                //2:多表查询   分区连接区域</span><br><span class="line"></span><br><span class="line">                Predicate[] p=new Predicate[list.size()];</span><br><span class="line">                <span class="built_in">return</span> cb.and(list.toArray(p));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">        //2：</span><br><span class="line">        //PageRequest pageable = new PageRequest(page - 1, rows);</span><br><span class="line">        //dao 参数 Pageable pageable 自动完成分页查询 将分页结果数据 自动封装到Page&lt;T&gt;</span><br><span class="line">        //从Page 对象获取总记录数 和 每页分页记录数List&lt;Staff&gt;</span><br><span class="line">        Page&lt;Subarea&gt; pageData = serviceFacade.getSubAreaService().pageQuery(getPageRequest(),spec);</span><br><span class="line">        setPageData(pageData);</span><br><span class="line">    &#125; catch (Exception e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">        push(<span class="literal">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">return</span> <span class="string">"pageQuery"</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<ol>
<li>创建接口的实现类</li>
<li>将model取出来放到实现类的方法中</li>
<li>通过model取条件</li>
</ol>
<h4 id="分区条件查询多表查询实现"><a href="#分区条件查询多表查询实现" class="headerlink" title="分区条件查询多表查询实现"></a>分区条件查询多表查询实现</h4><p>root参数代表的是主表<br>root–&gt;Subarea—&gt;Region<br>它会在判断到model.getRegion不为null的时候去连接Region表，那么怎么连接呢？<br>在一方当中，多方是一个set集合<br>在这里 root n: 1 region 多方连接一方<br>一方连接一方<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">root.join(root.getModel().getSingularAttribute(<span class="string">"region"</span>, Region.class), JoinType.LEFT);</span><br></pre></td></tr></table></figure></p>
<p>如果是多方的话就是getSet<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">//2:多表查询   分区连接区域</span><br><span class="line"> <span class="keyword">if</span> (model.getRegion() != null) &#123;</span><br><span class="line">     //连接区域表</span><br><span class="line">     Join&lt;Subarea, Region&gt; regionJoin = root.join(root.getModel().getSingularAttribute(<span class="string">"region"</span>, Region.class), JoinType.LEFT);</span><br><span class="line">     //regionJoin 操作 区域表</span><br><span class="line">     <span class="keyword">if</span> (StringUtils.isNotBlank(model.getRegion().getProvince())) &#123;</span><br><span class="line">         Predicate p2 = cb.like(regionJoin.&lt;String&gt;get(<span class="string">"province"</span>).as(String.class), <span class="string">"%"</span> + model.getRegion().getProvince() + <span class="string">"%"</span>);</span><br><span class="line">         list.add(p2);</span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line">     <span class="keyword">if</span> (StringUtils.isNotBlank(model.getRegion().getCity())) &#123;</span><br><span class="line">         Predicate p3 = cb.like(regionJoin.&lt;String&gt;get(<span class="string">"city"</span>).as(String.class), <span class="string">"%"</span> + model.getRegion().getCity() + <span class="string">"%"</span>);</span><br><span class="line">         list.add(p3);</span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line">     <span class="keyword">if</span> (StringUtils.isNotBlank(model.getRegion().getDistrict())) &#123;</span><br><span class="line">         Predicate p4 = cb.like(regionJoin.&lt;String&gt;get(<span class="string">"district"</span>).as(String.class), <span class="string">"%"</span> + model.getRegion().getDistrict() + <span class="string">"%"</span>);</span><br><span class="line">         list.add(p4);</span><br><span class="line">     &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure></p>
<p>定区编号只要oid==相等就会被当成一个对象，所以比较的不是内存地址。除去了内存编号的地址<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">//3:定区的编号查询  root subarea --decidezone</span><br><span class="line">                    <span class="keyword">if</span> (model.getDecidedZone()!=null&amp;&amp;StringUtils.isNotBlank(model.getDecidedZone().getId()))&#123;</span><br><span class="line">                   Predicate p5=     cb.equal(root.get(<span class="string">"decidedZone"</span>).as(DecidedZone.class),model.getDecidedZone());</span><br><span class="line">                    &#125;</span><br></pre></td></tr></table></figure></p>
<p>这里只要model.getDecidedZone()不为null，它就有OID<br>cb.equal(root.get(“decidedZone”).as(DecidedZone.class) 如果和model.getDecidedZone()<br>是相等的对象，那就有OID了。<br>完整代码如下：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line">// 区域的分页查询 分区分页查询 无条件分页+无条件分页查询</span><br><span class="line">//Subarea封装所有的请求参数条件 mysql <span class="built_in">limit</span> oracle rownum 动态的sql ，条件不一样</span><br><span class="line">@Action(value = <span class="string">"subAreaAction_pageQuery"</span>)</span><br><span class="line">public String <span class="function"><span class="title">pageQuery</span></span>() &#123;</span><br><span class="line">    try &#123;</span><br><span class="line">        //将条件从Model中取出来  封装到Specification接口实现方法中</span><br><span class="line">        Specification&lt;Subarea&gt; spec = new Specification&lt;Subarea&gt;() &#123;</span><br><span class="line">            @Override</span><br><span class="line">            public Predicate toPredicate(Root&lt;Subarea&gt; root, CriteriaQuery&lt;?&gt; criteriaQuery, CriteriaBuilder cb) &#123;</span><br><span class="line">                List&lt;Predicate&gt; list = new ArrayList&lt;Predicate&gt;();  //存放多个对象条件</span><br><span class="line">                //条件封装实现  root（查询的主表对象实体类） query  <span class="built_in">cd</span>（连接对象条件 类似 hibernate Critira Restrictions.）三个关键字</span><br><span class="line">                //1：关键字查询  查询自己的表就可以了 不需要多表连接的</span><br><span class="line">                <span class="keyword">if</span> (StringUtils.isNotBlank(model.getAddresskey())) &#123;</span><br><span class="line">                    //用户要进行关键字查询   前面是需要匹配的字段 后面是匹配的值  进行模糊查询</span><br><span class="line">                    Predicate p1 = cb.like(root.get(<span class="string">"addresskey"</span>).as(String.class), <span class="string">"%"</span> + model.getAddresskey() + <span class="string">"%"</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                //2:多表查询   分区连接区域</span><br><span class="line">                <span class="keyword">if</span> (model.getRegion() != null) &#123;</span><br><span class="line">                    //连接区域表</span><br><span class="line">                    Join&lt;Subarea, Region&gt; regionJoin = root.join(root.getModel().getSingularAttribute(<span class="string">"region"</span>, Region.class), JoinType.LEFT);</span><br><span class="line">                    //regionJoin 操作 区域表</span><br><span class="line">                    <span class="keyword">if</span> (StringUtils.isNotBlank(model.getRegion().getProvince())) &#123;</span><br><span class="line">                        Predicate p2 = cb.like(regionJoin.&lt;String&gt;get(<span class="string">"province"</span>).as(String.class), <span class="string">"%"</span> + model.getRegion().getProvince() + <span class="string">"%"</span>);</span><br><span class="line">                        list.add(p2);</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> (StringUtils.isNotBlank(model.getRegion().getCity())) &#123;</span><br><span class="line">                        Predicate p3 = cb.like(regionJoin.&lt;String&gt;get(<span class="string">"city"</span>).as(String.class), <span class="string">"%"</span> + model.getRegion().getCity() + <span class="string">"%"</span>);</span><br><span class="line">                        list.add(p3);</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> (StringUtils.isNotBlank(model.getRegion().getDistrict())) &#123;</span><br><span class="line">                        Predicate p4 = cb.like(regionJoin.&lt;String&gt;get(<span class="string">"district"</span>).as(String.class), <span class="string">"%"</span> + model.getRegion().getDistrict() + <span class="string">"%"</span>);</span><br><span class="line">                        list.add(p4);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                //3:定区的编号查询  root subarea --decidezone</span><br><span class="line">                <span class="keyword">if</span> (model.getDecidedZone() != null &amp;&amp; StringUtils.isNotBlank(model.getDecidedZone().getId())) &#123;</span><br><span class="line">                    Predicate p5 = cb.equal(root.get(<span class="string">"decidedZone"</span>).as(DecidedZone.class), model.getDecidedZone());</span><br><span class="line">                    list.add(p5);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                //集合转换成数组</span><br><span class="line">                Predicate[] p = new Predicate[list.size()];</span><br><span class="line">                <span class="built_in">return</span> cb.and(list.toArray(p));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">        //2：</span><br><span class="line">        //PageRequest pageable = new PageRequest(page - 1, rows);</span><br><span class="line">        //dao 参数 Pageable pageable 自动完成分页查询 将分页结果数据 自动封装到Page&lt;T&gt;</span><br><span class="line">        //从Page 对象获取总记录数 和 每页分页记录数List&lt;Staff&gt;</span><br><span class="line">        Page&lt;Subarea&gt; pageData = serviceFacade.getSubAreaService().pageQuery(getPageRequest(), spec);</span><br><span class="line">        setPageData(pageData);</span><br><span class="line">    &#125; catch (Exception e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">        push(<span class="literal">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">return</span> <span class="string">"pageQuery"</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>CriteriaBuilder就相当于连接条件<br>Root代表着我们的泛型</p>
<hr>
<h3 id="分区数据导出"><a href="#分区数据导出" class="headerlink" title="分区数据导出"></a>分区数据导出</h3><p>将满足条件的数据  通过  导出…<br>浏览器   采用下载的形式  将数据  生成Excel文档<br>1、满足条件数据如何查询到</p>
<p>2、满足数据List<t>  27条记录<br>下载….Poi 生成工作簿  才能下载<br>读的时候也是读到内存里，然后存到数据库。<br>—&gt;List<t>—-&gt;WorkBook(sheet row cell)<br>3、workbook.write(response.getOutputStream())<br>添加两个头  附件形式下载</t></t></p>
<p><img src="http://whyathere.github.io/images/bos/day05/分区数据导出功能.jpg" alt=""></p>
<p>首先点击前端页面的导出按钮：<br>浏览器导出（下载形式） 生成Excel 直接发请求的时候把满足的条件找到，条件可能有0到N个，那么条件要<br>怎么传递给后端呢？<br>解决：直接提交表单   把条件都带过去  到后端去验证<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;form id=<span class="string">"searchSubareaForm"</span> action=<span class="string">"<span class="variable">$&#123;pageContext.request.contextPath&#125;</span>/bc/subAreaAction_download"</span> method=<span class="string">"post"</span>&gt;</span><br></pre></td></tr></table></figure></p>
<p>后端代码<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br></pre></td><td class="code"><pre><span class="line">//subAreaAction_download  接收表单的提交的参数信息  对多条件查询</span><br><span class="line">    @Action(value = <span class="string">"subAreaAction_download"</span>)</span><br><span class="line">    public String <span class="function"><span class="title">download</span></span>() &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            //将条件从Model中取出来  封装到Specification接口实现方法中</span><br><span class="line">            Specification&lt;Subarea&gt; spec = new Specification&lt;Subarea&gt;() &#123;</span><br><span class="line">                @Override</span><br><span class="line">                public Predicate toPredicate(Root&lt;Subarea&gt; root, CriteriaQuery&lt;?&gt; criteriaQuery, CriteriaBuilder cb) &#123;</span><br><span class="line">                    List&lt;Predicate&gt; list = new ArrayList&lt;Predicate&gt;();  //存放多个对象条件</span><br><span class="line">                    //条件封装实现  root（查询的主表对象实体类） query  <span class="built_in">cd</span>（连接对象条件 类似 hibernate Critira Restrictions.）三个关键字</span><br><span class="line">                    //1：关键字查询  查询自己的表就可以了 不需要多表连接的</span><br><span class="line">                    <span class="keyword">if</span> (StringUtils.isNotBlank(model.getAddresskey())) &#123;</span><br><span class="line">                        //用户要进行关键字查询   前面是需要匹配的字段 后面是匹配的值  进行模糊查询</span><br><span class="line">                        Predicate p1 = cb.like(root.get(<span class="string">"addresskey"</span>).as(String.class), <span class="string">"%"</span> + model.getAddresskey() + <span class="string">"%"</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                    //2:多表查询   分区连接区域</span><br><span class="line">                    <span class="keyword">if</span> (model.getRegion() != null) &#123;</span><br><span class="line">                        //连接区域表</span><br><span class="line">                        Join&lt;Subarea, Region&gt; regionJoin = root.join(root.getModel().getSingularAttribute(<span class="string">"region"</span>, Region.class), JoinType.LEFT);</span><br><span class="line">                        //regionJoin 操作 区域表</span><br><span class="line">                        <span class="keyword">if</span> (StringUtils.isNotBlank(model.getRegion().getProvince())) &#123;</span><br><span class="line">                            Predicate p2 = cb.like(regionJoin.&lt;String&gt;get(<span class="string">"province"</span>).as(String.class), <span class="string">"%"</span> + model.getRegion().getProvince() + <span class="string">"%"</span>);</span><br><span class="line">                            list.add(p2);</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                        <span class="keyword">if</span> (StringUtils.isNotBlank(model.getRegion().getCity())) &#123;</span><br><span class="line">                            Predicate p3 = cb.like(regionJoin.&lt;String&gt;get(<span class="string">"city"</span>).as(String.class), <span class="string">"%"</span> + model.getRegion().getCity() + <span class="string">"%"</span>);</span><br><span class="line">                            list.add(p3);</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                        <span class="keyword">if</span> (StringUtils.isNotBlank(model.getRegion().getDistrict())) &#123;</span><br><span class="line">                            Predicate p4 = cb.like(regionJoin.&lt;String&gt;get(<span class="string">"district"</span>).as(String.class), <span class="string">"%"</span> + model.getRegion().getDistrict() + <span class="string">"%"</span>);</span><br><span class="line">                            list.add(p4);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    //3:定区的编号查询  root subarea --decidezone</span><br><span class="line">                    <span class="keyword">if</span> (model.getDecidedZone() != null &amp;&amp; StringUtils.isNotBlank(model.getDecidedZone().getId())) &#123;</span><br><span class="line">                        Predicate p5 = cb.equal(root.get(<span class="string">"decidedZone"</span>).as(DecidedZone.class), model.getDecidedZone());</span><br><span class="line">                        list.add(p5);</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    //集合转换成数组</span><br><span class="line">                    Predicate[] p = new Predicate[list.size()];</span><br><span class="line">                    <span class="built_in">return</span> cb.and(list.toArray(p));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;;</span><br><span class="line">            //2：</span><br><span class="line">            //PageRequest pageable = new PageRequest(page - 1, rows);</span><br><span class="line">            //dao 参数 Pageable pageable 自动完成分页查询 将分页结果数据 自动封装到Page&lt;T&gt;</span><br><span class="line">            //从Page 对象获取总记录数 和 每页分页记录数List&lt;Staff&gt;</span><br><span class="line">            //Page&lt;Subarea&gt; pageData = serviceFacade.getSubAreaService().pageQuery(getPageRequest(), spec);</span><br><span class="line">            //2：dao已经实现了多条件查询</span><br><span class="line">            List&lt;Subarea&gt; subs = serviceFacade.getSubAreaService().findSubareaBySpecification(spec);</span><br><span class="line">            //setPageData(pageData);</span><br><span class="line">            //3: 将集合数据写入到工作簿当中   POI加上下载知识点</span><br><span class="line">            //先写到工作簿中去</span><br><span class="line">            //创建Excel工作簿</span><br><span class="line">            HSSFWorkbook workbook = new HSSFWorkbook();</span><br><span class="line">            //在excel中建一个工作表，其名为缺省值</span><br><span class="line">            HSSFSheet sheet = workbook.createSheet(<span class="string">"铁"</span>);</span><br><span class="line">            //在索引0的位置创建行（最顶端的行）</span><br><span class="line">            HSSFRow row = sheet.createRow(0);</span><br><span class="line">            //在索引0的位置创建单元格(左上端)</span><br><span class="line">            //标题</span><br><span class="line">            row.createCell(0).setCellValue(<span class="string">"分区编号"</span>);</span><br><span class="line">            row.createCell(1).setCellValue(<span class="string">"区域编号"</span>);</span><br><span class="line">            row.createCell(2).setCellValue(<span class="string">"关键字"</span>);</span><br><span class="line">            row.createCell(3).setCellValue(<span class="string">"起始号"</span>);</span><br><span class="line">            row.createCell(4).setCellValue(<span class="string">"结束号"</span>);</span><br><span class="line">            row.createCell(5).setCellValue(<span class="string">"位置信息"</span>);</span><br><span class="line">            //循环放入行中</span><br><span class="line">            <span class="keyword">if</span> (subs != null &amp;&amp; subs.size() != 0) &#123;</span><br><span class="line">                <span class="keyword">for</span> (Subarea s : subs) &#123;</span><br><span class="line">                    int lastRowNum = sheet.getLastRowNum();//当前sheet  最后一行的 角标 0</span><br><span class="line">                    //没循环一次创建一行</span><br><span class="line">                    HSSFRow row1 = sheet.createRow(lastRowNum + 1);</span><br><span class="line">                    //在索引0的位置创建单元格(左上端)</span><br><span class="line">                    //标题 分区编号 区域编号 关键字 起始号 结束号 位置信息</span><br><span class="line">                    row1.createCell(0).setCellValue(s.getId());</span><br><span class="line">                    row1.createCell(1).setCellValue(s.getRegion().getId());</span><br><span class="line">                    row1.createCell(2).setCellValue(s.getAddresskey());</span><br><span class="line">                    row1.createCell(3).setCellValue(s.getStartnum());</span><br><span class="line">                    row1.createCell(4).setCellValue(s.getEndnum());</span><br><span class="line">                    row1.createCell(5).setCellValue(s.getPosition());</span><br><span class="line">                &#125;</span><br><span class="line">                //工作簿完成</span><br><span class="line">                //下载  两个头 一个流</span><br><span class="line">                //文件名</span><br><span class="line">                String filename = new Date(System.currentTimeMillis()).toLocaleString() + <span class="string">"张思思.xls"</span>;</span><br><span class="line">                //父类没有response，所以需要将response添加到父类</span><br><span class="line">                HttpServletResponse response = getResponse();</span><br><span class="line">                //ServletContext.getMimeType 根据文件的扩展名  获取对应Mime 类型</span><br><span class="line">                response.setContentType(getServletContext().getMimeType(filename));</span><br><span class="line">                //2、附件头  通过浏览器拿请求类型</span><br><span class="line">                response.setHeader(<span class="string">"Content-Disposition"</span>, <span class="string">"attachment;filename="</span> + MyFileUtils.encodeDownloadFilename(filename, getRequest().getHeader(<span class="string">"user-agent"</span>)));</span><br><span class="line">                //3、输出流</span><br><span class="line">                try &#123;</span><br><span class="line">                    workbook.write(response.getOutputStream());</span><br><span class="line">                &#125; catch (IOException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            push(<span class="literal">false</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        //4：下载不需要跳转，就是当前页面</span><br><span class="line">        <span class="built_in">return</span> NONE;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p>

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/BOS/" rel="tag"># BOS</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2018/09/10/BOS-第七天/" rel="next" title="BOS-第七天">
                <i class="fa fa-chevron-left"></i> BOS-第七天
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2018/09/10/BOS-第四天/" rel="prev" title="BOS 第四天">
                BOS 第四天 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">John Doe</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">43</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">12</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">24</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          

          

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#分区之下拉框"><span class="nav-number">1.</span> <span class="nav-text">分区之下拉框</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#分区添加业务分析"><span class="nav-number">1.1.</span> <span class="nav-text">分区添加业务分析</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#分区添加之下拉框显示说明"><span class="nav-number">1.2.</span> <span class="nav-text">分区添加之下拉框显示说明</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#分区添加之区域列表回显实现"><span class="nav-number">1.2.1.</span> <span class="nav-text">分区添加之区域列表回显实现</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#分区添加之区域下拉框自动补全效果"><span class="nav-number">1.3.</span> <span class="nav-text">分区添加之区域下拉框自动补全效果</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#分区添加业务功能"><span class="nav-number">1.4.</span> <span class="nav-text">分区添加业务功能</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#分区分页查询编码以及延迟加载问题说明"><span class="nav-number">1.5.</span> <span class="nav-text">分区分页查询编码以及延迟加载问题说明</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#多表条件查询客户端实现"><span class="nav-number">1.6.</span> <span class="nav-text">多表条件查询客户端实现</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#分区条件查询之单表查询代码实现"><span class="nav-number">1.7.</span> <span class="nav-text">分区条件查询之单表查询代码实现</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#分区条件查询多表查询实现"><span class="nav-number">1.8.</span> <span class="nav-text">分区条件查询多表查询实现</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#分区数据导出"><span class="nav-number">2.</span> <span class="nav-text">分区数据导出</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2019</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">John Doe</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Muse</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  

</body>
</html>
