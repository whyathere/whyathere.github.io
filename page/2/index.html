<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT" />










<meta property="og:type" content="website">
<meta property="og:title" content="Bill">
<meta property="og:url" content="http://yoursite.com/page/2/index.html">
<meta property="og:site_name" content="Bill">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Bill">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/page/2/"/>





  <title>Bill</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Bill</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/09/10/MySQL主主说明/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Bill">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/09/10/MySQL主主说明/" itemprop="url">MySQL多主循环 使用</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-09-10T16:30:00+08:00">
                2018-09-10
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/数据库/" itemprop="url" rel="index">
                    <span itemprop="name">数据库</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="配置文件样例："><a href="#配置文件样例：" class="headerlink" title="配置文件样例："></a>配置文件样例：</h3><p>164：<br>port=3306<br>server-id=164<br>log-bin=mysql<br>binlog-do-db=mytest<br>binlog-ignore-db=mysql  #忽略的数据库<br>log-slave-updates=true    #需要<br>replicate-do-db=mytest    #要同步的数据库，如果需要多个库，重复这行<br>replicate-do-db=zero_bos #<br>slave-skip-errors=all   #忽略同步过程中的错误</p>
<h3 id="参数说明"><a href="#参数说明" class="headerlink" title="参数说明"></a>参数说明</h3><p>MySQL的配置文件各种参数说明<br>binlog-do-db：指定mysql的binlog日志记录哪个db<br>Replicate_Do_DB：参数是在slave上配置，指定slave要复制哪个库<br>binlog-do-db=需要复制的数据库名，如果复制多个数据库，重复设置这个选项即可<br>binlog-ignore-db=不需要复制的数据库苦命，如果复制多个数据库，重复设置这个选项即可<br>replicate-do-db=需要复制的数据库名，如果复制多个数据库，重复设置这个选项即可<br>replicate-ignore-db=需要复制的数据库名，如果复制多个数据库，重复设置这个选项即可<br>log-bin=mysql-bin  //启动二进制日志系统<br>sync_binlog = 1 or N：This makes MySQL synchronize the binary log’s contents to disk each time it commits a transaction </p>
<p>注意：如果你想做一个复杂点的结构：比如说，A-&gt;B-&gt;C，其中B是A的从服务器，同时B又是C的主服务器，那么B服务器除了需要打开log-bin之外，还需要打开log-slave-updates选项，你可以再B上使用“show variables like ‘log%’;”来确认是否已经生效。</p>
<h3 id="注意事项"><a href="#注意事项" class="headerlink" title="注意事项"></a>注意事项</h3><ol>
<li>若同步某一数据库，应确保主从服务器上均有此数据库</li>
<li>不指定‘binlog-do-db’ 与‘replicate-do-db’即位同步整个服务器</li>
<li>配置完成后，尽量不要对从库进行插入、更新等操作，只进行查询操作即可</li>
</ol>
<h3 id="常用操作命令"><a href="#常用操作命令" class="headerlink" title="常用操作命令"></a>常用操作命令</h3><ol>
<li>停止从库服务：slave stop;</li>
<li>重置从库服务：slave reset;   // 重新启动从库服务后，会从新同步</li>
</ol>
<h4 id="权限相关"><a href="#权限相关" class="headerlink" title="权限相关"></a>权限相关</h4><ol>
<li>在主服务器上查询当前二进制文件的文件名及偏移位置：show master status;</li>
<li>启动从服务器上的复制线程：start slave;</li>
<li>刷新权限：FLUSH PRIVILEGES;</li>
</ol>
<h4 id="日志相关"><a href="#日志相关" class="headerlink" title="日志相关"></a>日志相关</h4><ol>
<li>是否启用了日志：show variables like ‘log_%’; </li>
<li>刷新日志：flush logs;</li>
</ol>
<h3 id="从库"><a href="#从库" class="headerlink" title="从库"></a>从库</h3><p>从库更改要复制的主库：change master to master_host=’10.0.0.164’,master_user=’replicate’,master_password=’123456’，<br>master_log_file=’mysql-bin.000013’,master_log_pos=107;;</p>
<h3 id="遇到的错误"><a href="#遇到的错误" class="headerlink" title="遇到的错误"></a>遇到的错误</h3><h4 id="1"><a href="#1" class="headerlink" title="1"></a>1</h4><p>1.错误提示：<br>Last_IO_Error: Got fatal error 1236 from master when reading dat<br>a from binary log: ‘Could not find first log file name in binary log index file’<br>解决方法：查看master的错误日志<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">180413 16:33:02 [Note] Error reading relay <span class="built_in">log</span> event: slave SQL thread was killed</span><br><span class="line">180413 16:33:02 [Note] Slave I/O thread killed <span class="keyword">while</span> connecting to master</span><br><span class="line">180413 16:33:02 [Note] Slave I/O thread exiting, <span class="built_in">read</span> up to <span class="built_in">log</span> <span class="string">'mysql.000004'</span>, position 107</span><br><span class="line">180413 16:33:05 [Note] Slave SQL thread initialized, starting replication <span class="keyword">in</span> <span class="built_in">log</span> <span class="string">'mysql.000004'</span> at position 107, relay <span class="built_in">log</span> <span class="string">'.\DESKTOP-5ECA991-relay-bin.000015'</span> position: 4</span><br><span class="line">180413 16:33:06 [ERROR] Slave I/O: error connecting to master <span class="string">'root@10.0.0.32:3306'</span> - retry-time: 60  retries: 86400, Error_code: 2003</span><br></pre></td></tr></table></figure></p>
<p>将从库的改为’mysql.000004’ at position 107</p>
<h4 id="2"><a href="#2" class="headerlink" title="2"></a>2</h4><p>2.错误提示<br>Slave I/O: Got fatal error 1236 from master when reading data from binary<br>log: ‘Binary log is not open’,Error_code: 1236<br>原因：没有设置log-bin，在master的my文件中设置log-bin=mysql-bin  //启动二进制日志系统 </p>
<h3 id="主从相关单词意义"><a href="#主从相关单词意义" class="headerlink" title="主从相关单词意义"></a>主从相关单词意义</h3><ol>
<li>Slave_IO_Running: No是主从同步故障</li>
<li>Slave_SQL_Running: Yes是从服务器读取中继日志</li>
</ol>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/09/10/Idea遇到的问题/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Bill">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/09/10/Idea遇到的问题/" itemprop="url">Idea遇到的问题</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-09-10T16:30:00+08:00">
                2018-09-10
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/工具/" itemprop="url" rel="index">
                    <span itemprop="name">工具</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <ol>
<li>从git上拉取代码后无法运行，而且Idea也编译代码。<br> 解决办法：本例中ide左下角有提示，需要修改才可以。所以任意修改一下代码就可以正常编译了。</li>
</ol>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/09/10/BOS-第四天/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Bill">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/09/10/BOS-第四天/" itemprop="url">BOS 第四天</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-09-10T16:30:00+08:00">
                2018-09-10
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/项目/" itemprop="url" rel="index">
                    <span itemprop="name">项目</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="取派员的批量作废"><a href="#取派员的批量作废" class="headerlink" title="取派员的批量作废"></a>取派员的批量作废</h3><h4 id="业务分析"><a href="#业务分析" class="headerlink" title="业务分析"></a>业务分析</h4><pre><code>（1）分析：
          首先需要知道用户选中了那几个取派员。通过ID来识别，通过js来获取选中的取派员的ID。
          那么这些怎么传递给后台就是关键了。要考虑：是同步请求还是异步请求，肯定是异步操作。
          异步操作那就是ajax。
          往后端传递的数据格式：{&quot;&quot;:&quot;1,2,3,4&quot;}
         satffAction接收所有ids，接收到字符串进行切割，就会变成字符串数组
         String ids[]={1,2,3,4};
         -----&gt;service----&gt;dao
         事务管理  循环更新每一条记录
         update xxx  set deltag=&quot;1&quot;  where id=&quot;&quot;

 （2）步骤：
        1、选中一行或者多行，如果没有选中不发送ajax请求，给予用户提示
        2、选中后，获取所有取派员ID，拼接成字符串给ajax
        3、action接收ids----&gt;service（切割 循环更新dao）
</code></pre><h4 id="前端页面代码"><a href="#前端页面代码" class="headerlink" title="前端页面代码"></a>前端页面代码</h4><pre><code>        <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">	<span class="keyword">function</span> <span class="function"><span class="title">doDelete</span></span>() &#123;</span><br><span class="line">	//  取派员批量作废  业务分析 : </span><br><span class="line">	//  作废 必须 选中一行或者多行 取派员记录 然后才能作废 </span><br><span class="line">	var arr = $(<span class="string">"#grid"</span>).datagrid(<span class="string">"getSelections"</span>);//  [&#123;id:1.......&#125;,&#123;id:2&#125;,&#123;&#125;]</span><br><span class="line">	<span class="keyword">if</span> (arr == null || arr.length == 0) &#123;</span><br><span class="line">		$.messager.alert(<span class="string">"警告"</span>, <span class="string">"至少选中一行"</span>, <span class="string">"warning"</span>);</span><br><span class="line">		<span class="built_in">return</span>;</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		//  用户选中  ...批量作废  发送   ids ---&gt;action  ids  ---&gt;业务层 <span class="keyword">for</span> 事务管理   dao  update  xxx <span class="built_in">set</span>  deltag =<span class="string">'1'</span> <span class="built_in">where</span> id = ?</span><br><span class="line">		// ajax  请求   获取用户选中所有id   发送action  </span><br><span class="line">		var idsArray = new Array();</span><br><span class="line">		//  2: 遍历数组   获取数组对象 id  拼接  ids  给ajax </span><br><span class="line">		<span class="keyword">for</span> (var i = 0; i &lt; arr.length; i++) &#123;</span><br><span class="line">			// js  数组操作</span><br><span class="line">			idsArray.push(arr[i].id);</span><br><span class="line">		&#125;//  循环结束  将所有选中取派员对象id  存放到idsArray数组中</span><br><span class="line"></span><br><span class="line">		// 将含有全部取派员id数组 转换字符串   join 方法 将数组转化成字符串 </span><br><span class="line">		var ids = idsArray.join(<span class="string">","</span>);//  1,2,3,4</span><br><span class="line">		// 3: 将选中取派员ids 发送给action  批量删除  update 操作</span><br><span class="line">	    $.post(<span class="string">"<span class="variable">$&#123;pageContext.request.contextPath&#125;</span>/bc/staffAction_delBatch"</span>,&#123;<span class="string">"ids"</span>:ids&#125;,<span class="keyword">function</span>(data)&#123;</span><br><span class="line">    		//  data(<span class="literal">true</span>/<span class="literal">false</span>)  Map</span><br><span class="line">    			 <span class="keyword">if</span>(data)&#123;</span><br><span class="line">    				    $.messager.alert(<span class="string">"恭喜"</span>,<span class="string">"批量修改成功"</span>,<span class="string">"info"</span>); </span><br><span class="line">    			&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    				    $.messager.alert(<span class="string">"错误"</span>,<span class="string">"批量作废失败"</span>,<span class="string">"error"</span>);</span><br><span class="line">    				  &#125;</span><br><span class="line">    		 // 作废成功 datagrid url 地址 再发送一次 以实现页面的及时刷新，否则需要重新打开才会显示</span><br><span class="line">    		 $(<span class="string">"#grid"</span>).datagrid(<span class="string">"reload"</span>);</span><br><span class="line">    		&#125;);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

由以上可知，ajax通过post方式将数据发送到了staffAction_delBatch。
</code></pre><h4 id="SatffAction中的代码"><a href="#SatffAction中的代码" class="headerlink" title="SatffAction中的代码"></a>SatffAction中的代码</h4><pre><code><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">	// 取派员批量删除</span><br><span class="line">@Action(value = <span class="string">"staffAction_delBatch"</span>, results = &#123;</span><br><span class="line">@Result(name = <span class="string">"delBatch"</span>, location = <span class="string">"/WEB-INF/pages/base/staff.jsp"</span>) &#125;)</span><br><span class="line">public String <span class="function"><span class="title">delBatch</span></span>() &#123;</span><br><span class="line">	try &#123;</span><br><span class="line">		String ids=getParameter(<span class="string">"ids"</span>);</span><br><span class="line">		serviceFacade.getStaffService().delBatch(ids);</span><br><span class="line">		push(<span class="literal">true</span>);</span><br><span class="line">		&#125; catch (Exception e) &#123;</span><br><span class="line">		e.printStackTrace();</span><br><span class="line">		push(<span class="literal">false</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="built_in">return</span> <span class="string">"delBatch"</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</code></pre><h4 id="实现层Impl代码"><a href="#实现层Impl代码" class="headerlink" title="实现层Impl代码"></a>实现层Impl代码</h4><pre><code><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public void delBatch(String ids) &#123;</span><br><span class="line">	// 业务层进行ids切割</span><br><span class="line">	<span class="keyword">if</span> (StringUtils.isNotBlank(ids)) &#123;</span><br><span class="line">		String delIds[] = ids.split(<span class="string">","</span>);</span><br><span class="line">		<span class="keyword">for</span> (String id : delIds) &#123;</span><br><span class="line">			staffDao.delBatch(id);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</code></pre><p>​    </p>
<h3 id="区域分区定区"><a href="#区域分区定区" class="headerlink" title="区域分区定区"></a>区域分区定区</h3><h4 id="区域分区定区说明"><a href="#区域分区定区说明" class="headerlink" title="区域分区定区说明"></a>区域分区定区说明</h4><p>取派员：取货 送货 是分区域的<br>将全国 地理信息  录入bos系统<br>区域信息   包括国家行政信息</p>
<pre><code>Region  区域表
</code></pre><p>存放  国家 各省各市  地理信息<br>例如：江苏省   南京市  玄武区</p>
<p> 定区管理客户，取派员通过定区获取客户信息</p>
<p> 省市区录入会很麻烦，因为数据太多，想要简化的话就需要一键上传</p>
<p> 一键将外部的数据源导入</p>
<h4 id="区域一键上传使用说明"><a href="#区域一键上传使用说明" class="headerlink" title="区域一键上传使用说明"></a>区域一键上传使用说明</h4><pre><code>excel文件上传   action
</code></pre><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;input <span class="built_in">type</span>=<span class="string">"file"</span>&gt;</span><br></pre></td></tr></table></figure>
<pre><code>google  one click
优点：可以在页面的任意一个标签添加上传功能

后台就需要使用java语音来解析 Excel，获取里面的数据转换成对象

以便于插入到数据库中

List&lt;Region&gt; ---&gt;Dao

JPA自带了保存方法

上传的时候要做判断，必须是Excel类型的文件才能上传
</code></pre><h4 id="一键文件上传前端代码"><a href="#一键文件上传前端代码" class="headerlink" title="一键文件上传前端代码"></a>一键文件上传前端代码</h4><pre><code>(1)首先将一键上传的组件导入到项目中的js目录下
    这里放在了js/oneclick目录下
    然后在regin.jsp页面引入该插件
</code></pre><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;script</span><br><span class="line">  src=<span class="string">"<span class="variable">$&#123;pageContext.request.contextPath &#125;</span>/js/oneclick/jquery.ocupload-1.1.2.js"</span></span><br><span class="line">  <span class="built_in">type</span>=<span class="string">"text/javascript"</span>&gt;&lt;/script&gt;</span><br><span class="line">&lt;script <span class="built_in">type</span>=<span class="string">"text/javascript"</span>&gt;</span><br></pre></td></tr></table></figure>
<p>找到toobar中的工具栏<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#125;, &#123;</span><br><span class="line">	id : <span class="string">'button-import'</span>,</span><br><span class="line">	text : <span class="string">'导入'</span>,</span><br><span class="line">	iconCls : <span class="string">'icon-redo'</span></span><br><span class="line">&#125;];</span><br></pre></td></tr></table></figure></p>
<p>那么我们创建一个名称为  button-import的函数<br><img src="http://whyathere.github.io/images/bos/bos04/一键上传前端代码.jpg" alt=""><br>    这里需要注意的有正则表达式：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/^(.+\.xls|.+\.xlsx)$/; //a.xls ss.xlsx这两种格式  .代表任意字符  + 至少一个字符  \. 转义.</span><br></pre></td></tr></table></figure></p>
<h4 id="一键文件上传原理分析"><a href="#一键文件上传原理分析" class="headerlink" title="一键文件上传原理分析"></a>一键文件上传原理分析</h4><p>（1）如何接收上传的Excel文件<br> Struts2是如何接受上传文件的，通过拦截器（已经有的一个拦截器）FileUploadInterceptor<br> FileUploadInterceptor的源码注释<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">* &lt;!-- START SNIPPET: description --&gt;</span><br><span class="line">* &lt;p/&gt;</span><br><span class="line">* Interceptor that is based off of &#123;@link MultiPartRequestWrapper&#125;, <span class="built_in">which</span> is automatically applied <span class="keyword">for</span> any request that</span><br><span class="line">* includes a file. It adds the following parameters, <span class="built_in">where</span> [File Name] is the name given to the file uploaded by the</span><br><span class="line">* HTML form:</span><br><span class="line">* &lt;p/&gt;</span><br><span class="line">* &lt;ul&gt;</span><br><span class="line">* &lt;p/&gt;</span><br><span class="line">* &lt;li&gt;[File Name] : File - the actual File&lt;/li&gt;</span><br><span class="line">* &lt;p/&gt;</span><br><span class="line">* &lt;li&gt;[File Name]ContentType : String - the content <span class="built_in">type</span> of the file&lt;/li&gt;</span><br><span class="line">* &lt;p/&gt;</span><br><span class="line">* &lt;li&gt;[File Name]FileName : String - the actual name of the file uploaded (not the HTML name)&lt;/li&gt;</span><br><span class="line">* &lt;p/&gt;</span><br><span class="line">* &lt;/ul&gt;</span><br><span class="line">* &lt;p/&gt;</span><br></pre></td></tr></table></figure></p>
<pre><code>Name:文件名
ContentType：文件类型
FileName：文件名
</code></pre><p> 原始案例：先来一个表单</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">* &lt;!-- START SNIPPET: example-form --&gt;</span><br><span class="line">*   &amp;lt;s:form action=<span class="string">"doUpload"</span> method=<span class="string">"post"</span> enctype=<span class="string">"multipart/form-data"</span>&amp;gt;</span><br><span class="line">*       &amp;lt;s:file name=<span class="string">"upload"</span> label=<span class="string">"File"</span>/&amp;gt;</span><br><span class="line">*       &amp;lt;s:submit/&amp;gt;</span><br><span class="line">*   &amp;lt;/s:form&amp;gt;</span><br><span class="line">* &lt;!-- END SNIPPET: example-form --&gt;</span><br></pre></td></tr></table></figure>
<p>官方Action案例<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">* &lt;!-- START SNIPPET: example-action --&gt;</span><br><span class="line">*    package com.example;</span><br><span class="line">*</span><br><span class="line">*    import java.io.File;</span><br><span class="line">*    import com.opensymphony.xwork2.ActionSupport;</span><br><span class="line">*</span><br><span class="line">*    public UploadAction extends ActionSupport &#123;</span><br><span class="line">*       private File file;</span><br><span class="line">*       private String contentType;</span><br><span class="line">*       private String filename;</span><br><span class="line">*</span><br><span class="line">*       public void setUpload(File file) &#123;</span><br><span class="line">*          this.file = file;</span><br><span class="line">*       &#125;</span><br><span class="line">*</span><br><span class="line">*       public void setUploadContentType(String contentType) &#123;</span><br><span class="line">*          this.contentType = contentType;</span><br><span class="line">*       &#125;</span><br><span class="line">*</span><br><span class="line">*       public void setUploadFileName(String filename) &#123;</span><br><span class="line">*          this.filename = filename;</span><br><span class="line">*       &#125;</span><br><span class="line">*</span><br><span class="line">*       public String <span class="function"><span class="title">execute</span></span>() &#123;</span><br><span class="line">*          //...</span><br><span class="line">*          <span class="built_in">return</span> SUCCESS;</span><br><span class="line">*       &#125;</span><br><span class="line">*  &#125;</span><br></pre></td></tr></table></figure></p>
<p> 拦截器把文件解析完了，action接受文件。弄一个set方法就可以了，拦截器调set方法，拿到文件。<br> 按照规范是setUpload<br> 因此action中也添加一个upload属性，并且添加set方法就可以拿到upload，即上传文件。这里一定要和前端页面name一样。</p>
<p> 由于Struts2是先执行拦截器，再执行action。所以一定要保证它走了    FileUploadInterceptor拦截器<br> FileUploadInterceptor是在默认栈里的，所以不需要配置</p>
<h4 id="一键上传文件解析-poi"><a href="#一键上传文件解析-poi" class="headerlink" title="一键上传文件解析-poi"></a>一键上传文件解析-poi</h4><pre><code> Apache-poi
Excel工作簿
</code></pre><p><img src="http://whyathere.github.io/images/bos/bos04/Apache-poi的read.jpg" alt=""><br>    首先通过流inp拿到工作簿 Workbook<br>    拿到工作簿之后，拿到sheet下标<br>    拿到之后一行行读  sheet<br>    然后再一格格的读就可以了<br> <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">// 创建对Excel工作簿文件的引用</span><br><span class="line">   HSSFWorkbook workbook = new HSSFWorkbook(new FileInputStream(fileToBeRead));</span><br></pre></td></tr></table></figure></p>
<h4 id="关于-FileUploadInterceptor拦截器"><a href="#关于-FileUploadInterceptor拦截器" class="headerlink" title="关于 FileUploadInterceptor拦截器"></a>关于 FileUploadInterceptor拦截器</h4><pre><code>思考：FileUploadInterceptor 是怎么来检测到你上传了文件的。
</code></pre><p>  FileUploadInterceptor：位于Struts2的defaultStack第十的位置，通过它的名称就可以知道它是用于处<br>  理文件的Struts2处理文件上传内部使用的是commons-fileupload组件，当我们在form表单中把enctype属性设置为<br>  “multipart/form-data”时表示这是一个文件上传请求，当Struts2接收到这样一个请求后把请求包装在一个<br>  MultiPartRequestWrapper对象中，而MultiPartRequestWrapper又包装了JakartaMultiPartRequest，<br>  JakartaMultiPartRequest对象才是真正处理文件上传的request对象<br>  下面说一下该拦截器中三个重要属性：</p>
<ol>
<li>maximumSize –&gt;允许上传文件最大大小，单位为byte（字节）</li>
<li>allowedTypesSet –&gt;允许上传文件类型集合</li>
<li><p>allowedExtensionsSet –&gt;允许上传文件扩展名集合</p>
<p>必须这三个条件都符合，文件上传才能成功。<br>下面是拦截器的intercept方法：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br></pre></td><td class="code"><pre><span class="line">public String intercept(ActionInvocation invocation) throws Exception &#123;  </span><br><span class="line">    ActionContext ac = invocation.getInvocationContext();//获取ActionContext对象  </span><br><span class="line">    //获取request对象  </span><br><span class="line">    HttpServletRequest request = (HttpServletRequest) ac.get(ServletActionContext.HTTP_REQUEST);  </span><br><span class="line">    //判断是否是文件上传请求  </span><br><span class="line">    <span class="keyword">if</span> (!(request instanceof MultiPartRequestWrapper)) &#123;  </span><br><span class="line">        <span class="keyword">if</span> (LOG.isDebugEnabled()) &#123;  </span><br><span class="line">            ActionProxy proxy = invocation.getProxy();  </span><br><span class="line">            LOG.debug(getTextMessage(<span class="string">"struts.messages.bypass.request"</span>, new Object[]&#123;proxy.getNamespace(), proxy.getActionName()&#125;, ac.getLocale()));  </span><br><span class="line">        &#125;  </span><br><span class="line">        //如果不是则直接调用下一个拦截器，因为不需要处理文件上传  </span><br><span class="line">        <span class="built_in">return</span> invocation.invoke();  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    ValidationAware validation = null;  </span><br><span class="line">    Object action = invocation.getAction();//获取当前Action对象  </span><br><span class="line">    //判断有无实现ValidationAware接口，当Action继承自ActionSupport类时是实现了该接口的  </span><br><span class="line">    <span class="keyword">if</span> (action instanceof ValidationAware) &#123;  </span><br><span class="line">        validation = (ValidationAware) action;  </span><br><span class="line">    &#125;  </span><br><span class="line">    //前面说了文件上传时request类型就是MultiPartRequestWrapper  </span><br><span class="line">    MultiPartRequestWrapper multiWrapper = (MultiPartRequestWrapper) request;  </span><br><span class="line">    //判断文件上传是否有错误，也就是是否符合上面的三个上传条件  </span><br><span class="line">    <span class="keyword">if</span> (multiWrapper.hasErrors()) &#123;  </span><br><span class="line">        <span class="keyword">for</span> (String error : multiWrapper.getErrors()) &#123;  </span><br><span class="line">            <span class="keyword">if</span> (validation != null) &#123;//有错误则添加ActionError，注意validation就是当前Action对象  </span><br><span class="line">                validation.addActionError(error);  </span><br><span class="line">            &#125;  </span><br><span class="line">  </span><br><span class="line">            LOG.warn(error);  </span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    //获取上传文件参数名(input的name属性值)枚举，因为struts2支持一欠上传多个文件  </span><br><span class="line">    Enumeration fileParameterNames = multiWrapper.getFileParameterNames();  </span><br><span class="line">    <span class="keyword">while</span> (fileParameterNames != null &amp;&amp; fileParameterNames.hasMoreElements()) &#123;//迭代  </span><br><span class="line">        // 当前文件参数名  </span><br><span class="line">        String inputName = (String) fileParameterNames.nextElement();  </span><br><span class="line">        // 获取上传文件类型，因为多个文件上传input的name属性可以相同，所以这里是数组  </span><br><span class="line">        String[] contentType = multiWrapper.getContentTypes(inputName);  </span><br><span class="line">  </span><br><span class="line">        <span class="keyword">if</span> (isNonEmpty(contentType)) &#123;  </span><br><span class="line">            // 获取上传文件的真实名称(在客户端文件系统中的名称)，至于返回值为什么是数组与上同理  </span><br><span class="line">            String[] fileName = multiWrapper.getFileNames(inputName);  </span><br><span class="line">            <span class="keyword">if</span> (isNonEmpty(fileName)) &#123;  </span><br><span class="line">                // 获取上传的文件  </span><br><span class="line">                File[] files = multiWrapper.getFiles(inputName);  </span><br><span class="line">                <span class="keyword">if</span> (files != null &amp;&amp; files.length &gt; 0) &#123;  </span><br><span class="line">                    List&lt;File&gt; acceptedFiles = new ArrayList&lt;File&gt;(files.length);  </span><br><span class="line">                    List&lt;String&gt; acceptedContentTypes = new ArrayList&lt;String&gt;(files.length);  </span><br><span class="line">                    List&lt;String&gt; acceptedFileNames = new ArrayList&lt;String&gt;(files.length);  </span><br><span class="line">                    String contentTypeName = inputName + <span class="string">"ContentType"</span>;  </span><br><span class="line">                    String fileNameName = inputName + <span class="string">"FileName"</span>;//这时就是文件上传时接收文件类型与文件名称固定写法的原因  </span><br><span class="line">                    //迭代文件数组  </span><br><span class="line">                    <span class="keyword">for</span> (int index = 0; index &lt; files.length; index++) &#123;  </span><br><span class="line">                        //判断该文件是否合法，如果合法则添加到合法集合中  </span><br><span class="line">                        <span class="keyword">if</span> (acceptFile(action, files[index], fileName[index], contentType[index], inputName, validation, ac.getLocale())) &#123;  </span><br><span class="line">                            acceptedFiles.add(files[index]);  </span><br><span class="line">                            acceptedContentTypes.add(contentType[index]);  </span><br><span class="line">                            acceptedFileNames.add(fileName[index]);  </span><br><span class="line">                        &#125;  </span><br><span class="line">                    &#125;  </span><br><span class="line">                    //如果合法文件集合不为空  </span><br><span class="line">                    <span class="keyword">if</span> (!acceptedFiles.isEmpty()) &#123;  </span><br><span class="line">                        Map&lt;String, Object&gt; params = ac.getParameters();  </span><br><span class="line">                        //将上传的文件，文件类型，文件名称存储到ActionContext的parameters Map中  </span><br><span class="line">                        params.put(inputName, acceptedFiles.toArray(new File[acceptedFiles.size()]));  </span><br><span class="line">                        params.put(contentTypeName, acceptedContentTypes.toArray(new String[acceptedContentTypes.size()]));  </span><br><span class="line">                        params.put(fileNameName, acceptedFileNames.toArray(new String[acceptedFileNames.size()]));  </span><br><span class="line">                    &#125;  </span><br><span class="line">                &#125;  </span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;  </span><br><span class="line">                LOG.warn(getTextMessage(action, <span class="string">"struts.messages.invalid.file"</span>, new Object[]&#123;inputName&#125;, ac.getLocale()));  </span><br><span class="line">            &#125;  </span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;  </span><br><span class="line">            LOG.warn(getTextMessage(action, <span class="string">"struts.messages.invalid.content.type"</span>, new Object[]&#123;inputName&#125;, ac.getLocale()));  </span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    // 调用下一个拦截器，当然也调用了Action  </span><br><span class="line">    String result = invocation.invoke();  </span><br><span class="line">  </span><br><span class="line">    // 当Action执行完毕，拦截器执行依次返回又执行到该拦截器，清理文件上传时的临时文件  </span><br><span class="line">    fileParameterNames = multiWrapper.getFileParameterNames();  </span><br><span class="line">    <span class="keyword">while</span> (fileParameterNames != null &amp;&amp; fileParameterNames.hasMoreElements()) &#123;  </span><br><span class="line">        String inputValue = (String) fileParameterNames.nextElement();  </span><br><span class="line">        File[] files = multiWrapper.getFiles(inputValue);  </span><br><span class="line">  </span><br><span class="line">        <span class="keyword">for</span> (File currentFile : files) &#123;  </span><br><span class="line">            <span class="keyword">if</span> (LOG.isInfoEnabled()) &#123;  </span><br><span class="line">                LOG.info(getTextMessage(action, <span class="string">"struts.messages.removing.file"</span>, new Object[]&#123;inputValue, currentFile&#125;, ac.getLocale()));  </span><br><span class="line">            &#125;  </span><br><span class="line">  </span><br><span class="line">            <span class="keyword">if</span> ((currentFile != null) &amp;&amp; currentFile.isFile()) &#123;  </span><br><span class="line">                <span class="keyword">if</span> (currentFile.delete() == <span class="literal">false</span>) &#123;//这里调用了currentFile.delete()将临时文件删除，因为此时在Action对上传的文件处理已经完成  </span><br><span class="line">                    LOG.warn(<span class="string">"Resource Leaking:  Could not remove uploaded file '"</span>+currentFile.getCanonicalPath()+<span class="string">"'."</span>);  </span><br><span class="line">                &#125;  </span><br><span class="line">            &#125;  </span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;  </span><br><span class="line">    //返回上一个拦截器  </span><br><span class="line">    <span class="built_in">return</span> result;  </span><br><span class="line">&#125;  </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">下面再去看一下该拦截器是如何判断上传的文件是否合法的，即acceptFile方法：</span><br><span class="line"></span><br><span class="line">[java] view plain copy</span><br><span class="line">protected boolean acceptFile(Object action, File file, String filename, String contentType, String inputName, ValidationAware validation, Locale locale) &#123;  </span><br><span class="line">    boolean fileIsAcceptable = <span class="literal">false</span>;  </span><br><span class="line">  </span><br><span class="line">    // If it<span class="string">'s null the upload failed  </span></span><br><span class="line"><span class="string">    if (file == null) &#123;  </span></span><br><span class="line"><span class="string">        String errMsg = getTextMessage(action, "struts.messages.error.uploading", new Object[]&#123;inputName&#125;, locale);  </span></span><br><span class="line"><span class="string">        if (validation != null) &#123;  </span></span><br><span class="line"><span class="string">            validation.addFieldError(inputName, errMsg);  </span></span><br><span class="line"><span class="string">        &#125;  </span></span><br><span class="line"><span class="string">  </span></span><br><span class="line"><span class="string">        LOG.warn(errMsg);  </span></span><br><span class="line"><span class="string">    &#125; else if (maximumSize != null &amp;&amp; maximumSize &lt; file.length()) &#123;  </span></span><br><span class="line"><span class="string">        String errMsg = getTextMessage(action, "struts.messages.error.file.too.large", new Object[]&#123;inputName, filename, file.getName(), "" + file.length()&#125;, locale);  </span></span><br><span class="line"><span class="string">        if (validation != null) &#123;  </span></span><br><span class="line"><span class="string">            validation.addFieldError(inputName, errMsg);  </span></span><br><span class="line"><span class="string">        &#125;  </span></span><br><span class="line"><span class="string">  </span></span><br><span class="line"><span class="string">        LOG.warn(errMsg);  </span></span><br><span class="line"><span class="string">    &#125; else if ((!allowedTypesSet.isEmpty()) &amp;&amp; (!containsItem(allowedTypesSet, contentType))) &#123;  </span></span><br><span class="line"><span class="string">        String errMsg = getTextMessage(action, "struts.messages.error.content.type.not.allowed", new Object[]&#123;inputName, filename, file.getName(), contentType&#125;, locale);  </span></span><br><span class="line"><span class="string">        if (validation != null) &#123;  </span></span><br><span class="line"><span class="string">            validation.addFieldError(inputName, errMsg);  </span></span><br><span class="line"><span class="string">        &#125;  </span></span><br><span class="line"><span class="string">  </span></span><br><span class="line"><span class="string">        LOG.warn(errMsg);  </span></span><br><span class="line"><span class="string">    &#125; else if ((! allowedExtensionsSet.isEmpty()) &amp;&amp; (!hasAllowedExtension(allowedExtensionsSet, filename))) &#123;  </span></span><br><span class="line"><span class="string">        String errMsg = getTextMessage(action, "struts.messages.error.file.extension.not.allowed", new Object[]&#123;inputName, filename, file.getName(), contentType&#125;, locale);  </span></span><br><span class="line"><span class="string">        if (validation != null) &#123;  </span></span><br><span class="line"><span class="string">            validation.addFieldError(inputName, errMsg);  </span></span><br><span class="line"><span class="string">        &#125;  </span></span><br><span class="line"><span class="string">  </span></span><br><span class="line"><span class="string">        LOG.warn(errMsg);  </span></span><br><span class="line"><span class="string">    &#125; else &#123;  </span></span><br><span class="line"><span class="string">        fileIsAcceptable = true;  </span></span><br><span class="line"><span class="string">    &#125;  </span></span><br><span class="line"><span class="string">  </span></span><br><span class="line"><span class="string">    return fileIsAcceptable;  </span></span><br><span class="line"><span class="string">&#125;</span></span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>该方法逻辑很简单，就是依次判断上传的文件是否为null，是否符合设定的文件大小，是否符合设定的文件类型，<br>是否符合设定的文件扩展名。如果没有设定文件类型与文件扩展名则表示文件类型与文件扩展名没有限制，而在<br>defaultStack中，该拦截器的这两个都是没有进行设定的，但是上传文件的最大大小是设置了的，肯定有人会说<br>maximumSize不是也没有设置吗？没错，在该拦截器maximumSize的确没有设置，默认值就是为null，刚刚也说<br>了，真正处理文件上传的request对象是JakartaMultiPartRequest，在JakartaMultiPartRequest中有一个<br>相应的maxSize属性在实例化JakartaMultiPartRequest对象的时候通过struts2的容器把该值注入进来了，<br>该值的配置在struts2-core.jar中的org.apache.struts2包中的default.properties文件中<br>(struts.multipart.maxSize=2097152)，默认值为2097152，即2M大小。<br>  我们在进行文件上传的时候是在Action中定义相应的属性来接收上传的文件，文件的类型与文件名，但在大家发现没有在该拦截器并没有调用当前Action设置当前上传文件的方法，即没有调用相应的setXxx()、setXxxContentType()、setXxxFileName()方法，xxx为input的name属性值，只是将上传的文件，文件类型，文件名称存储到ActionContext的parameters Map中，这个问题在ParametersInterceptor拦截器进行讲解。</p>
<h4 id="POI代码"><a href="#POI代码" class="headerlink" title="POI代码"></a>POI代码</h4><p>目标：从Excel表中拿到数据装到List<region>然后放入到数据库中。<br>那么循环sheet就可以了。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">public interface Sheet extends Iterable&lt;Row&gt; &#123;</span><br></pre></td></tr></table></figure></region></p>
<p>for each继承了这个接口才能够循环<br>那么这里Sheet就相当于List而Row就相当于Region<br>这里循环遍历从每一个sheet内获取数据，但是要把第一行跳过。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">public interface Sheet extends Iterable&lt;Row&gt; &#123;</span><br></pre></td></tr></table></figure></p>
<p>由于Sheet继承了Iterable，所以Sheet相当于一个List<br>一键上传的action代码<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">// 如何接收上传的文件？</span><br><span class="line">	private File upload;   //与前端页面的name一致，当前的action就可以获取上传文件</span><br><span class="line">	</span><br><span class="line">	public void setUpload(File upload) &#123;</span><br><span class="line">		this.upload = upload;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	// 一键上传</span><br><span class="line">	@Action(value = <span class="string">"regionAction_oneclickupload"</span>, results = &#123;</span><br><span class="line">			@Result(name = <span class="string">"oneclickupload"</span>, location = <span class="string">"/WEB-INF/pages/base/region.jsp"</span>) &#125;)</span><br><span class="line">	public String <span class="function"><span class="title">oneclickupload</span></span>() &#123;</span><br><span class="line">		try &#123;</span><br><span class="line">			//如何接收上传文件</span><br><span class="line">            // 创建对Excel工作簿文件的引用</span><br><span class="line">            HSSFWorkbook workbook = new HSSFWorkbook(new FileInputStream(upload));</span><br><span class="line">            // 创建对工作表的引用。</span><br><span class="line">            // 本例是按名引用（让我们假定那张表有着缺省名<span class="string">"Sheet1"</span>）</span><br><span class="line">//            HSSFSheet sheet = workbook.getSheet(<span class="string">"Sheet1"</span>);</span><br><span class="line">            HSSFSheet sheet = workbook.getSheetAt(0);</span><br><span class="line">            // 也可用getSheetAt(int index)按索引引用，</span><br><span class="line">            // 在Excel文档中，第一张工作表的缺省索引是0，</span><br><span class="line">            // 其语句为：HSSFSheet sheet = workbook.getSheetAt(0);</span><br><span class="line">            // 读取左上端单元</span><br><span class="line">            List&lt;Region&gt; regions=new ArrayList&lt;Region&gt;();</span><br><span class="line">			<span class="keyword">for</span> (Row row:sheet)&#123;</span><br><span class="line">				//如果是第一行就跳过</span><br><span class="line">				<span class="keyword">if</span> (row.getRowNum()==0)&#123;</span><br><span class="line">					<span class="built_in">continue</span>;</span><br><span class="line">				&#125;</span><br><span class="line">				Region r=new Region();//一行代表一个Region对象</span><br><span class="line">				//依次从几个小格中取数据</span><br><span class="line">				r.setId(row.getCell(0).getStringCellValue());</span><br><span class="line">				r.setProvince(row.getCell(1).getStringCellValue());</span><br><span class="line">				r.setCity(row.getCell(2).getStringCellValue());</span><br><span class="line">				r.setDistrict(row.getCell(3).getStringCellValue());</span><br><span class="line">				r.setPostcode(row.getCell(4).getStringCellValue());</span><br><span class="line"></span><br><span class="line">				/*r.setShortcode(shortcode);</span><br><span class="line">				r.setCitycode(citycode);*/</span><br><span class="line">				regions.add(r);</span><br><span class="line">			&#125;</span><br><span class="line">			//业务层，将数据更新</span><br><span class="line">			serviceFacade.getRegionService().batchImport(regions);</span><br><span class="line"></span><br><span class="line">//			push(<span class="literal">true</span>);</span><br><span class="line">		&#125; catch (Exception e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">			push(<span class="literal">false</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="built_in">return</span> <span class="string">"oneclickupload"</span>;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure></p>
<p>说明：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">HSSFSheet sheet = workbook.getSheetAt(0);</span><br></pre></td></tr></table></figure></p>
<p>按照表单取第一个工作簿<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">List&lt;Region&gt; regions=new ArrayList&lt;Region&gt;();</span><br></pre></td></tr></table></figure></p>
<p>将当前工作簿作为一个List集合，每行为Region<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (Row row:sheet)&#123;</span><br><span class="line">	//如果是第一行就跳过</span><br><span class="line">	<span class="keyword">if</span> (row.getRowNum()==0)&#123;</span><br><span class="line">		<span class="built_in">continue</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	Region r=new Region();//一行代表一个Region对象</span><br><span class="line">	//依次从几个小格中取数据</span><br><span class="line">	r.setId(row.getCell(0).getStringCellValue());</span><br><span class="line">	r.setProvince(row.getCell(1).getStringCellValue());</span><br><span class="line">	r.setCity(row.getCell(2).getStringCellValue());</span><br><span class="line">	r.setDistrict(row.getCell(3).getStringCellValue());</span><br><span class="line">	r.setPostcode(row.getCell(4).getStringCellValue());</span><br><span class="line"></span><br><span class="line">	/*r.setShortcode(shortcode);</span><br><span class="line">	r.setCitycode(citycode);*/</span><br><span class="line">	regions.add(r);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>循环遍历，将工作簿放入到regions集合中。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">//业务层，将数据更新</span><br><span class="line">serviceFacade.getRegionService().batchImport(regions);</span><br></pre></td></tr></table></figure></p>
<p>调用业务层，更新数据到数据库。</p>
<h4 id="分页"><a href="#分页" class="headerlink" title="分页"></a>分页</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">//服务器完成  回送200</span><br><span class="line">onComplete : <span class="keyword">function</span>(data, self, element) &#123;</span><br><span class="line">	//data 服务器回送  <span class="literal">true</span>/<span class="literal">false</span></span><br><span class="line">    <span class="keyword">if</span> (data) &#123;</span><br><span class="line">    $.messager.alert(<span class="string">"恭喜"</span>, <span class="string">"上传成功"</span>, <span class="string">"info"</span>);</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">	$.messager.alert(<span class="string">"错误"</span>, <span class="string">"上传失败"</span>, <span class="string">"error"</span>);</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<p>这里不管前端传什么，都会提示“上传成功”。如果在action中添加push(true);data为string<br>也会当做true。false也会为string会被当做true<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">@OneToMany(cascade=CascadeType.ALL, fetch=FetchType.LAZY, mappedBy=<span class="string">"region"</span>)</span><br><span class="line">@JSON(serialize = <span class="literal">false</span>)</span><br><span class="line">public Set&lt;Subarea&gt; <span class="function"><span class="title">getSubareas</span></span>() &#123;</span><br><span class="line">    <span class="built_in">return</span> this.subareas;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>将不需要显示的不进行数据化处理，否则会出现懒加载<br>区域分页查询代码<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">// 区域的分页查询</span><br><span class="line">@Action(value = <span class="string">"regionAction_pageQuery"</span>, results = &#123;</span><br><span class="line">        @Result(name = <span class="string">"pageQuery"</span>, <span class="built_in">type</span> = <span class="string">"json"</span>)&#125;)</span><br><span class="line">public String <span class="function"><span class="title">pageQuery</span></span>() &#123;</span><br><span class="line">    Map&lt;String, Object&gt; data = new HashMap&lt;String, Object&gt;();</span><br><span class="line">    try &#123;</span><br><span class="line">        PageRequest pageable = new PageRequest(page - 1, rows);</span><br><span class="line">        Page&lt;Region&gt; pageData = serviceFacade.getRegionService().pageQuery(pageable);</span><br><span class="line">        //dao 参数 Pageable pageable 自动完成分页查询 将分页结果数据 自动封装到Page&lt;T&gt;</span><br><span class="line">        //从Page 对象获取总记录数 和 每页分页记录数List&lt;Staff&gt;</span><br><span class="line">        data.put(<span class="string">"total"</span>, pageData.getTotalElements());</span><br><span class="line">        data.put(<span class="string">"rows"</span>, pageData.getContent());</span><br><span class="line">        push(data);</span><br><span class="line">    &#125; catch (Exception e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">        push(<span class="literal">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">return</span> <span class="string">"pageQuery"</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h4 id="分页优化"><a href="#分页优化" class="headerlink" title="分页优化"></a>分页优化</h4><p>首先分析之前两个分页的相同之处，如下图所示:<br><img src="http://whyathere.github.io/images/bos/bos04/分页相同代码分析.jpg" alt=""><br>比较代码几乎都一样，只有泛型不同。<br>前端的分页插件默认会自动从栈顶拿分页数据，所以之前的后端代码都是push（data）；<br>那么如果 我们想对分页代码进行优化就将重复的代码放入到父类中，以方便子类调用<br>而结果集由于要被不同的action所使用，所以不能在类中配置，而且应该配置一个全家的结果集<br>在struts.xml中<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&lt;!-- 定义全局结果集视图 --&gt;</span><br><span class="line">&lt;global-results&gt;</span><br><span class="line">	&lt;result name=<span class="string">"no_login"</span> <span class="built_in">type</span>=<span class="string">"redirect"</span>&gt;/login.jsp&lt;/result&gt;</span><br><span class="line">	&lt;result name=<span class="string">"pageQuery"</span> <span class="built_in">type</span>=<span class="string">"json"</span>&gt;</span><br><span class="line">		&lt;param name=<span class="string">"root"</span>&gt;obj&lt;/param&gt;</span><br><span class="line">	&lt;/result&gt;</span><br><span class="line">&lt;/global-results&gt;</span><br></pre></td></tr></table></figure></p>
<p>之后，只要结果集是pageQuery就会走这个结果集。<br>那么代码中的结果集就不需要配置了<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">results = &#123;@Result(name = <span class="string">"pageQuery"</span>, <span class="built_in">type</span> = <span class="string">"json"</span>)&#125;</span><br></pre></td></tr></table></figure></p>
<p>return “pageQuery”;就全部都走全局结果集</p>
<p>但是这个的数据一定要放在栈顶，但是有的时候栈顶数据不能是这个，而是model<br>一定放的话就会产生冲突（默认是model），会影响数据的获取。<br>这里涉及到一个拦截器：ModelDrivenInterceptor，在action执行前执行</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ModelDriven modelDriven = (ModelDriven) action;</span><br><span class="line">ValueStack stack = invocation.getStack();</span><br></pre></td></tr></table></figure>
<p>作用是将model压到栈顶。</p>
<p>插件默认是从栈顶拿数据，但是插件可以配置不从栈顶拿<br>只要配置了root就不从栈顶取数据了，而是搜索值栈。</p>
<p>model在栈顶，而BaseAction也在值栈，那么BaseAction所有的属性和方法也可以取到，<br>getObj方法在值栈，之前用push放栈顶。<br>例如：push<user>   &lt;s:property value=”name”&gt;<br>push将user放入值栈，前端通过 &lt;s:property value=”name”&gt;  可以拿到name<br>可以拿到name的原因是：user提供了get方法<br>而这里，BaseAction在值栈，那么getObj能拿到。<br>插件会搜索obj，全局结果集已经挂起，而正好父类BaseAciton提供getObj，那么就可以<br>通过这个方法拿到Map<br>父类结果集优化代码<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">//分页结果集的优化</span><br><span class="line">protected PageRequest <span class="function"><span class="title">getPageRequest</span></span>() &#123;</span><br><span class="line">    PageRequest pageable = new PageRequest(page - 1, rows);</span><br><span class="line">    <span class="built_in">return</span> pageable;</span><br><span class="line">&#125;</span><br><span class="line">//父类要的</span><br><span class="line">private Page&lt;T&gt; pageData;</span><br><span class="line"></span><br><span class="line">public void setPageData(Page&lt;T&gt; pageData) &#123;</span><br><span class="line">    this.pageData = pageData;</span><br><span class="line">&#125;</span><br><span class="line">//父类 提供getObj方法</span><br><span class="line">public Map&lt;String, Object&gt; <span class="function"><span class="title">getObj</span></span>()&#123;</span><br><span class="line">    Map&lt;String, Object&gt; data = new HashMap&lt;String, Object&gt;();</span><br><span class="line">    data.put(<span class="string">"total"</span>, pageData.getTotalElements());</span><br><span class="line">    data.put(<span class="string">"rows"</span>, pageData.getContent());</span><br><span class="line">    <span class="built_in">return</span> data;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></user></p>
<p>这样子类的代码就简单了。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">return</span> <span class="string">"pageQuery"</span>;  //走全局结果集</span><br></pre></td></tr></table></figure></p>
<p>就会走全局结果集，找到这个结果集走json，配置了以后不会走栈顶，会搜索值栈，getObj<br>从而拿到数据<br>子类代码<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Page&lt;Region&gt; pageData = serviceFacade.getRegionService().pageQuery(getPageRequest());</span><br><span class="line">setPageData(pageData);</span><br></pre></td></tr></table></figure></p>
<p>这里的setPageData是将数据发送给父类，以便于父类生成Map&lt;String,Object&gt;</p>
<h4 id="分页查询结果集优化流程说明"><a href="#分页查询结果集优化流程说明" class="headerlink" title="分页查询结果集优化流程说明"></a>分页查询结果集优化流程说明</h4><p><img src="http://whyathere.github.io/images/bos/bos04/分页查询优化封装.png" alt=""><br>第一步：父类封装了Spring Data JPA 需要的分页查询对象<br>封装好后，返回给子类。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">protected PageRequest <span class="function"><span class="title">getPageRequest</span></span>() &#123;</span><br><span class="line">    PageRequest pageable = new PageRequest(page - 1, rows);</span><br><span class="line">    <span class="built_in">return</span> pageable;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>第二步：子类拿到数据之后去数据库进行查询<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Page&lt;Region&gt; pageData = serviceFacade.getRegionService().pageQuery(getPageRequest());</span><br></pre></td></tr></table></figure></p>
<p>第三步：查询好分页数据之后传递给父类<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">setPageData(pageData);</span><br></pre></td></tr></table></figure></p>
<p>父类：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">//父类要的</span><br><span class="line">private Page&lt;T&gt; pageData;</span><br><span class="line"></span><br><span class="line">public void setPageData(Page&lt;T&gt; pageData) &#123;</span><br><span class="line">    this.pageData = pageData;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>第四步：给到父类之后，子类就会去找全局结果集。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">return</span> <span class="string">"pageQuery"</span>;</span><br></pre></td></tr></table></figure></p>
<p>全局结果集：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&lt;!-- 定义全局结果集视图 --&gt;</span><br><span class="line">&lt;global-results&gt;</span><br><span class="line">	&lt;result name=<span class="string">"no_login"</span> <span class="built_in">type</span>=<span class="string">"redirect"</span>&gt;/login.jsp&lt;/result&gt;</span><br><span class="line">	&lt;result name=<span class="string">"pageQuery"</span> <span class="built_in">type</span>=<span class="string">"json"</span>&gt;</span><br><span class="line">		&lt;param name=<span class="string">"root"</span>&gt;obj&lt;/param&gt;</span><br><span class="line">	&lt;/result&gt;</span><br><span class="line">&lt;/global-results&gt;</span><br></pre></td></tr></table></figure></p>
<p>这里配置了root而且使用Json，root就会走struts2的json插件中的JSONResult的findRootObject方法<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">protected Object findRootObject(ActionInvocation invocation) &#123;</span><br><span class="line">    Object rootObject;</span><br><span class="line">    <span class="keyword">if</span> (this.root != null) &#123;</span><br><span class="line">        ValueStack stack = invocation.getStack();</span><br><span class="line">        rootObject = stack.findValue(root);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        rootObject = invocation.getStack().peek(); // model overrides action</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">return</span> rootObject;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>进行判断 if (this.root != null)<br>这个root的值就是Obj，else就不走了，不拿栈顶数据。<br>走：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rootObject = stack.findValue(root);</span><br></pre></td></tr></table></figure></p>
<p>第五步：搜索值栈（从上往下依次搜索）<br>值栈的栈顶是：model<br>在值栈的某个区域有getObj，这个方法是stack.findValue(root);来调用的（插件调用的）<br>找到getObj，这样就又会找到父类的getObj方法<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">//父类 提供getObj方法</span><br><span class="line">public Map&lt;String, Object&gt; <span class="function"><span class="title">getObj</span></span>()&#123;</span><br><span class="line">    Map&lt;String, Object&gt; data = new HashMap&lt;String, Object&gt;();</span><br><span class="line">    data.put(<span class="string">"total"</span>, pageData.getTotalElements());</span><br><span class="line">    data.put(<span class="string">"rows"</span>, pageData.getContent());</span><br><span class="line">    <span class="built_in">return</span> data;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>就会返回Map，那么序列化的也是Map。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/09/10/BOS-第六天/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Bill">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/09/10/BOS-第六天/" itemprop="url">BOS 第六天</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-09-10T16:30:00+08:00">
                2018-09-10
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/项目/" itemprop="url" rel="index">
                    <span itemprop="name">项目</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="定区"><a href="#定区" class="headerlink" title="定区"></a>定区</h3><p>目前接触到了三张表，区域，定区，分区</p>
<p>region<br>        定区<br>staff    取派员<br>subarea 分区上有可能定区的，但肯定有区域</p>
<p>​        </p>
<p>region分为多个subarea<br>那么去派员隶属于分区，那么去派员就应该和分区subare有关系。</p>
<p>受理业务：<br>        客户下单<br>        自动分单  给对应的取派员</p>
<p>取派员与定区相关联，定区和分区有关系。</p>
<p>模拟客户：客户端   都是有固定的地址  根据地址就可以判断是属于哪个定区的（有定区ID）<br>客户表里有  id name decidedzone </p>
<pre><code>在这里定区指向取派员表
</code></pre><h4 id="定区添加业务分析"><a href="#定区添加业务分析" class="headerlink" title="定区添加业务分析"></a>定区添加业务分析</h4><ol>
<li>定区添加  获取取派员的ID  下拉框选取  显示</li>
<li>循环更新  分区表  显示未被定区关联分区显示  checkbox显示<br>服务器端：action  接受表单信息</li>
<li>checkbox分区信息  能否提交给后台？  可以接收</li>
</ol>
<p>定区的主键ID是uuid<br>业务层：<br>    svae（decidezone（瞬时态，没有id，但是需要））<br>    更新分区的时候<br>    定区的主键策略  assigend 需要加ajax校验</p>
<h4 id="定区添加取派员下拉框显示"><a href="#定区添加取派员下拉框显示" class="headerlink" title="定区添加取派员下拉框显示"></a>定区添加取派员下拉框显示</h4><p>在这里由于之前设置了取派员的作废标识<br>所以这里不能用默认的findAll<br>前端代码<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;td&gt;选择负责人&lt;/td&gt;</span><br><span class="line">&lt;td&gt;</span><br><span class="line">	&lt;input class=<span class="string">"easyui-combobox"</span> name=<span class="string">"staff.id"</span></span><br><span class="line">					data-options=<span class="string">"valueField:'id',textField:'name',url:'<span class="variable">$&#123;pageContext.request.contextPath&#125;</span>/bc/staffAction_ajaxList'"</span> /&gt;</span><br><span class="line">&lt;/td&gt;</span><br></pre></td></tr></table></figure></p>
<p>action<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">// 定区关联取派员</span><br><span class="line">@Action(value = <span class="string">"staffAction_ajaxList"</span>,results = &#123;@Result(name = <span class="string">"ajaxList"</span>,<span class="built_in">type</span> = <span class="string">"json"</span>)&#125;)</span><br><span class="line">public String <span class="function"><span class="title">ajaxList</span></span>() &#123;</span><br><span class="line">	try &#123;</span><br><span class="line">		List&lt;Staff&gt; staffs=serviceFacade.getStaffService().findStaffInUse();</span><br><span class="line">		push(staffs);</span><br><span class="line">	&#125; catch (Exception e) &#123;</span><br><span class="line">		e.printStackTrace();</span><br><span class="line">		push(<span class="literal">false</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="built_in">return</span> <span class="string">"ajaxList"</span>;  //走全局结果集</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>Dao<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">@Query(<span class="string">"from Staff where deltag = '0' "</span>)</span><br><span class="line">public List&lt;Staff&gt; findStaffInUse();</span><br></pre></td></tr></table></figure></p>
<h4 id="代码实现"><a href="#代码实现" class="headerlink" title="代码实现"></a>代码实现</h4><p>前端会发送多个ID往后端<br>分区的Update中的DecidedZone是一个对象。<br><img src="http://whyathere.github.io/images/bos/day05/定区添加截图.jpg" alt=""><br>从图可以看出<br>关联分区的时候，是一个对象。<br>创建DecidedZoneService相关的类<br>DecidedZoneServiceImpl<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">@Service</span><br><span class="line">@Transactional</span><br><span class="line">public class DecidedZoneServiceImpl implements DecidedZoneService &#123;</span><br><span class="line"></span><br><span class="line">    @Autowired</span><br><span class="line">    private DecidedZoneDao decidedZoneDao;</span><br><span class="line"></span><br><span class="line">    @Autowired</span><br><span class="line">    private SubAreaDao subAreaDao;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public void save(DecidedZone model, String[] subareaIds) &#123;</span><br><span class="line">        //定区表添加 分区表外键更新</span><br><span class="line">        decidedZoneDao.save(model);</span><br><span class="line">        <span class="keyword">if</span> (subareaIds != null &amp;&amp; subareaIds.length != 0) &#123;</span><br><span class="line">            <span class="keyword">for</span> (String sid: subareaIds) &#123;</span><br><span class="line">                subAreaDao.assignSubareaToDecidedzone(model,sid);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>将DecidedZoneService添加到门面类FacadeService<br>DecidedZoneAction<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">// 区域添加</span><br><span class="line">@Action(value = <span class="string">"decidedZoneAction_save"</span>, results = &#123;</span><br><span class="line">        @Result(name = <span class="string">"save"</span>, location = <span class="string">"/WEB-INF/pages/base/decidedzone.jsp"</span>)&#125;)</span><br><span class="line">public String <span class="function"><span class="title">save</span></span>() &#123;</span><br><span class="line">    try &#123;</span><br><span class="line">        String[] subAreaIds = getRequest().getParameterValues(<span class="string">"subAreaId"</span>);</span><br><span class="line">        serviceFacade.getDecidedZoneService().save(model,subAreaIds);</span><br><span class="line">    &#125; catch (Exception e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">return</span> <span class="string">"save"</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>Dao<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">public interface SubAreaDao extends JpaRepository&lt;Subarea, String&gt;, JpaSpecificationExecutor&lt;Subarea&gt; &#123;</span><br><span class="line"></span><br><span class="line">    @Query(<span class="string">"from Subarea where decidedZone is null "</span>)</span><br><span class="line">    public List&lt;Subarea&gt; findnoassociation();</span><br><span class="line"></span><br><span class="line">    @Modifying</span><br><span class="line">    @Query(<span class="string">"update Subarea set decidedZone=?1 where id=?2"</span>)</span><br><span class="line">    public  void assignSubareaToDecidedzone(DecidedZone model,String sid);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>关联分区选中的是<br>这里查找的是 Subarea的 decidedZone_id 不为空的<br>一旦被选中就会将 Subarea的 decidedZone_id 标记为1</p>
<h4 id="定区条件分页查询"><a href="#定区条件分页查询" class="headerlink" title="定区条件分页查询"></a>定区条件分页查询</h4><ol>
<li>给查询定区的窗口设置一个id<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;form id=<span class="string">"searchDecidedZoneForm"</span>&gt;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>是否关联分区<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&lt;td&gt;是否关联分区&lt;/td&gt;</span><br><span class="line">                &lt;td&gt;</span><br><span class="line">                    &lt;select id=<span class="string">"cc"</span> class=<span class="string">"easyui-combobox"</span> name=<span class="string">"isAssociationSubarea"</span> style=<span class="string">"width:170px;"</span>&gt;</span><br><span class="line">                        &lt;option value=<span class="string">""</span>&gt;===请选择===&lt;/option&gt;</span><br><span class="line">                        &lt;option value=<span class="string">"1"</span>&gt;是&lt;/option&gt;</span><br><span class="line">                        &lt;option value=<span class="string">"0"</span>&gt;否&lt;/option&gt;</span><br><span class="line">                    &lt;/select&gt;</span><br><span class="line">                &lt;/td&gt;</span><br></pre></td></tr></table></figure></p>
<p>条件查询<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">//条件查询定区</span><br><span class="line">  $(<span class="string">"#btn"</span>).click(<span class="function"><span class="title">function</span></span> () &#123;</span><br><span class="line">      //from序列化</span><br><span class="line">      var jsonObj = $(<span class="string">"#searchDecidedZoneForm"</span>).serializeJson();</span><br><span class="line">      //调用datagrid load 方法 form序列化</span><br><span class="line">      $(<span class="string">"#grid"</span>).datagrid(<span class="string">"load"</span>, jsonObj);</span><br><span class="line">      //3：关闭窗口</span><br><span class="line">      $(<span class="string">"#searchWindow"</span>).window(<span class="string">"close"</span>);</span><br><span class="line"></span><br><span class="line">  &#125;);</span><br></pre></td></tr></table></figure></p>
<p>datagrid<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">// 收派标准数据表格</span><br><span class="line">$(<span class="string">'#grid'</span>).datagrid(&#123;</span><br><span class="line">    iconCls: <span class="string">'icon-forward'</span>,</span><br><span class="line">    fit: <span class="literal">true</span>,</span><br><span class="line">    border: <span class="literal">true</span>,</span><br><span class="line">    rownumbers: <span class="literal">true</span>,</span><br><span class="line">    striped: <span class="literal">true</span>,</span><br><span class="line">    pageList: [3, 5, 10],</span><br><span class="line">    pagination: <span class="literal">true</span>,</span><br><span class="line">    toolbar: toolbar,</span><br><span class="line">    url: <span class="string">"<span class="variable">$&#123;pageContext.request.contextPath&#125;</span>/bc/decidedZoneAction_pageQuery"</span>,</span><br><span class="line">    idField: <span class="string">'id'</span>,</span><br><span class="line">    columns: columns,</span><br><span class="line">    onDblClickRow: doDblClickRow</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p>
<p>条件分页查询Action<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">// 区域的分页查询</span><br><span class="line">@Action(value = <span class="string">"decidedZoneAction_pageQuery"</span>)</span><br><span class="line">public String <span class="function"><span class="title">pageQuery</span></span>() &#123;</span><br><span class="line">    //PageRequest pageable = new PageRequest(page - 1, rows);</span><br><span class="line">    //dao 参数 Pageable pageable 自动完成分页查询 将分页结果数据 自动封装到Page&lt;T&gt;</span><br><span class="line">    //从Page 对象获取总记录数 和 每页分页记录数List&lt;Staff&gt;</span><br><span class="line">    Page&lt;DecidedZone&gt; pageData = serviceFacade.getDecidedZoneService().pageQuery(getPageRequest(), getSpecification());</span><br><span class="line">    setPageData(pageData);</span><br><span class="line">    <span class="built_in">return</span> <span class="string">"pageQuery"</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="CRM"><a href="#CRM" class="headerlink" title="CRM"></a>CRM</h3><h4 id="关联客户业务分析"><a href="#关联客户业务分析" class="headerlink" title="关联客户业务分析"></a>关联客户业务分析</h4><pre><code>要把所有的级联删除，否则可能删除全部的数据内容
</code></pre><ol>
<li>首先要将定区和客户关联起来，以便于通过客户信息找到定区，然后通过定区找到可以分配的取派员。</li>
<li>左边显示当前定区未关联的客户信息，右侧是显示已经关联的客户信息，而且可以左右移动<br> . 直观感觉是右侧的是提交    ，左右移动后要做关联，表内数据要更改。客户表内添加一个decidedzone_id</li>
<li>CRM是一个单独的系统，提供web服务。 </li>
<li>搭建新的系统 crm客户关系系统  customer</li>
<li>塔尖环境：ssh</li>
<li>为bos系统提供客户表的 crud 操作</li>
<li>restful 最典型的</li>
<li>@POST（保存） @PUT（修改） @GET（查询） @DELETE（删除） 四种注解表示类型</li>
<li>@Product 生产者 服务器响应客户端数据类型 CRM回送给BOS数据类型<br>@Customer  消费者 Bos发送给CRM系统数据类型 xml/json<br>@Path  客户端请求路径编写<br>@PathParam  获取请求路径的参数信息<br><a href="http://whyathere.github.io/images/bos/day05/RestFul示例.jpg" target="_blank" rel="noopener"></a>    </li>
</ol>
<p>本地测试OK之后再放业务</p>
<p>过程：ajax–&gt;bos–&gt;action–&gt;service–&gt;restful(crm)–&gt;WebClient(crud)</p>
<h4 id="定区关联客户之CRM系统环境搭建"><a href="#定区关联客户之CRM系统环境搭建" class="headerlink" title="定区关联客户之CRM系统环境搭建"></a>定区关联客户之CRM系统环境搭建</h4><p>hibernate.properties 用于自动建表<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">@Entity</span><br><span class="line">@Table(name = <span class="string">"t_customer"</span>,catalog = <span class="string">"zero_bos"</span>)</span><br><span class="line">@XmlRootElement(name = <span class="string">"Customer"</span>)  //使用restful的时候要添加，网络传输序列化所需要的注解</span><br><span class="line">public class Customer implements java.io.Serializable &#123;</span><br><span class="line"></span><br><span class="line">    @GenericGenerator(name = <span class="string">"generator"</span>, strategy = <span class="string">"uuid"</span>)</span><br><span class="line">    @Id</span><br><span class="line">    @GeneratedValue(generator = <span class="string">"generator"</span>)</span><br><span class="line">    private String id;</span><br></pre></td></tr></table></figure></p>
<p>CRM-SERVICE<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">@Produces(<span class="string">"*/*"</span>)</span><br><span class="line">public interface CustomerService &#123;</span><br><span class="line">    @GET</span><br><span class="line">    @Path(<span class="string">"/customer"</span>)</span><br><span class="line">    @Produces(&#123; <span class="string">"application/xml"</span>, <span class="string">"application/json"</span> &#125;)</span><br><span class="line">    public List&lt;Customer&gt; getNoAssociations();</span><br></pre></td></tr></table></figure></p>
<p>讲解：查询有@GET方法，路径”/customer”。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/09/10/BOS-第七天/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Bill">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/09/10/BOS-第七天/" itemprop="url">BOS-第七天</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-09-10T16:30:00+08:00">
                2018-09-10
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/项目/" itemprop="url" rel="index">
                    <span itemprop="name">项目</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="业务受理"><a href="#业务受理" class="headerlink" title="业务受理"></a>业务受理</h3><h4 id="取派业务业务分析说明"><a href="#取派业务业务分析说明" class="headerlink" title="取派业务业务分析说明"></a>取派业务业务分析说明</h4><p>当用户打电话来的时候，录入用户信息的时候，录入完之后。业务通知单就要生成，录入系统之后发生了什么呢？<br>这种物业通知单应该隶属于哪一个取派员，将这个通知单自动分配给取派员。<br>那么这里就是根据用户的地址自动分配给取派员，要自动分解是属于哪一个区域的取派员。</p>
<p>业务通知单自动分拣 说明  如下图</p>
<ol>
<li>系统自动根据委托发件人的详细地址CRM中的地址库进行完全匹配，获取对应的分拣<br> 编码：bos根据用户地址<br> webservice—-&gt;CRM<br> CRM提供根据地址查询客户信息的服务<br> findCustomerByAddress—&gt;Customer–&gt;decidezoneID–&gt;DecideZone–&gt;Staff<br> 业务通知单  给予  指定 取派员!<br> 总结：根据地址找到定区，以分配取派员</li>
<li>管理分区 匹配方法<br> 地址有误、客户找不到的时候第一个方法就不适用了<br> 通过分区中的属性，解析出详细地址，省市区。<br> 如果关键字相同就通过辅助关键字匹配。<br>例子：用户输入的取件地址<br> 规则：根据省市区查找区域，查询Region。通过级联查询找到这个区域的所有分区(subarea)<br> –&gt;循环筛选关键字–&gt;通过分区去找定区–&gt;Staff</li>
</ol>
<p>今天主要要实现的是自动分拣（自动分单）<br>两种方法的目的是一致的，最终都是分拣到取派员。</p>
<pre><code>有两种情况： 1.已经录入过客户，输入手机号以后会回显客户的其他信息。
           2.客户直接打电话过来，没有注册就需要通过bos添加到CRM里面
</code></pre><h4 id="通知单和工单设计说明"><a href="#通知单和工单设计说明" class="headerlink" title="通知单和工单设计说明"></a>通知单和工单设计说明</h4><pre><code>如果自动分拣成功，就有取派员的编号。
如果没有的话就是一个空值。自动分单也分类型：自动 人工  可以根据类型来查询
受理人：操作员    

业务通知单和工单：
业务通知单的：描述客户订单具体信息
工单：描述取派员任务
业务通知单一旦生成   对应一个工单（描述取派员任务）
工单的生成时机：自动分拣成功，系统自动生成工单；如果业务通知单自动分拣，人工--&gt;工单生成时机是在人工调度的时候生成。
</code></pre><h4 id="省市区三级联动"><a href="#省市区三级联动" class="headerlink" title="省市区三级联动"></a>省市区三级联动</h4><p>用户选择省 发送ajax请求  获取对应的市<br><img src="http://whyathere.github.io/images/bos/day07/取件省市区三级联动.jpg" alt=""><br>页面加载完成，立刻发送ajax请求，访问省信息<br>            //加载省<br>            $.post(“${pageContext.request.contextPath}/bc/regionAction_ajaxListProvinces”, function (data) {<br>                $(data).each(function () {<br>                    $(“#province”).append(“<option value="" + this + "">“ + this + “</option>“);<br>                });<br>            });<br>            //用户统计省  发送ajax  获取到对应的市<br>            $(“#province”).change(function () {<br>                $.post(‘${pageContext.request.contextPath}/bc/regionAction_ajaxListCitys’, {“province”: this.value}, function (data) {<br>                    //List<string><br>                    $(data).each(function () {<br>                        $(‘#city’).append(“<option value="" + this + "">“ + this + “</option>“);<br>                    });<br>                });<br>            });<br>Action<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">    //省</span><br><span class="line">    @Action(value = <span class="string">"regionAction_ajaxListProvinces"</span>, results = &#123;@Result(name = <span class="string">"ajaxListProvinces"</span>, <span class="built_in">type</span> = <span class="string">"json"</span>)&#125;)</span><br><span class="line">    public String <span class="function"><span class="title">ajaxListProvinces</span></span>() &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            List&lt;String&gt; regions = serviceFacade.getRegionService().ajaxListProvinces();</span><br><span class="line">            push(regions);</span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">return</span> <span class="string">"ajaxListProvinces"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">//当  省改变时，自动查询市</span><br><span class="line">    //City</span><br><span class="line">    @Action(value = <span class="string">"regionAction_ajaxListCitys"</span>, results = &#123;@Result(name = <span class="string">"ajaxListCitys"</span>, <span class="built_in">type</span> = <span class="string">"json"</span>)&#125;)</span><br><span class="line">    public String <span class="function"><span class="title">ajaxListCitys</span></span>() &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            List&lt;String&gt; citys = serviceFacade.getRegionService().ajaxListCitys(model.getProvince());</span><br><span class="line">            push(citys);</span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">return</span> <span class="string">"ajaxListCitys"</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></string></p>
<p>但是这个时候多切换几次省市，就会发现问题。如下图：<br><img src="http://whyathere.github.io/images/bos/day07/省市区三级联动异常.jpg" alt=""><br>切换省以后，后面的市会将上次查找的也叠加进来。</p>
<p>优化：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">//加载省</span><br><span class="line">$.post(<span class="string">"<span class="variable">$&#123;pageContext.request.contextPath&#125;</span>/bc/regionAction_ajaxListProvinces"</span>, <span class="keyword">function</span> (data) &#123;</span><br><span class="line">    $(data).each(<span class="function"><span class="title">function</span></span> () &#123;</span><br><span class="line">        $(<span class="string">"#province"</span>).append(<span class="string">"&lt;option value='"</span> + this + <span class="string">"'&gt;"</span> + this + <span class="string">"&lt;/option&gt;"</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;);</span><br><span class="line">//用户统计省  发送ajax  获取到对应的市</span><br><span class="line">$(<span class="string">"#province"</span>).change(<span class="function"><span class="title">function</span></span> () &#123;</span><br><span class="line">    $(<span class="string">"#city"</span>)[0].length=1;</span><br><span class="line">    $.post(<span class="string">'$&#123;pageContext.request.contextPath&#125;/bc/regionAction_ajaxListCitys'</span>, &#123;<span class="string">"province"</span>: this.value&#125;, <span class="keyword">function</span> (data) &#123;</span><br><span class="line">        //List&lt;String&gt;</span><br><span class="line">        $(data).each(<span class="function"><span class="title">function</span></span> () &#123;</span><br><span class="line">            $(<span class="string">'#city'</span>).append(<span class="string">"&lt;option value='"</span> + this + <span class="string">"'&gt;"</span> + this + <span class="string">"&lt;/option&gt;"</span>);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">//用户选择市  发送ajax  获取到对应的区</span><br><span class="line">$(<span class="string">"#city"</span>).change(<span class="function"><span class="title">function</span></span> () &#123;</span><br><span class="line">    $(<span class="string">"#district"</span>)[0].length=1;</span><br><span class="line">    $.post(<span class="string">'$&#123;pageContext.request.contextPath&#125;/bc/regionAction_ajaxListDistricts'</span>, &#123;<span class="string">"city"</span>: this.value&#125;, <span class="keyword">function</span> (data) &#123;</span><br><span class="line">        //List&lt;String&gt;</span><br><span class="line">        $(data).each(<span class="function"><span class="title">function</span></span> () &#123;</span><br><span class="line">            $(<span class="string">'#district'</span>).append(<span class="string">"&lt;option value='"</span> + this + <span class="string">"'&gt;"</span> + this + <span class="string">"&lt;/option&gt;"</span>);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p>
<p>但是这个时候又出问题了。在上次点击了省和市之后，然后再取消省和市的选择。单点击区会出现下面的情况：<br><img src="http://whyathere.github.io/images/bos/day07/省市区三级联动异常2.jpg" alt=""><br>这就很尴尬了，所以还是需要优化。在JS页面中，在city的联动中添加代码：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">//用户统计省  发送ajax  获取到对应的市</span><br><span class="line">         $(<span class="string">"#province"</span>).change(<span class="function"><span class="title">function</span></span> () &#123;</span><br><span class="line">             $(<span class="string">"#city"</span>)[0].length=1;</span><br><span class="line">             $(<span class="string">"#district"</span>)[0].length=1;</span><br></pre></td></tr></table></figure></p>
<p>搞定！！！！</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/09/10/BOS-第五天/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Bill">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/09/10/BOS-第五天/" itemprop="url">BOS 第五天</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-09-10T16:30:00+08:00">
                2018-09-10
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/项目/" itemprop="url" rel="index">
                    <span itemprop="name">项目</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="分区之下拉框"><a href="#分区之下拉框" class="headerlink" title="分区之下拉框"></a>分区之下拉框</h3><hr>
<h4 id="分区添加业务分析"><a href="#分区添加业务分析" class="headerlink" title="分区添加业务分析"></a>分区添加业务分析</h4><p>城市region，国家地理区域<br>区域：需要划分成多个分区，区域过大。<br>分区：地理位置   明细信息  门牌号  单双号   路名 关键字 辅助关键字</p>
<p>分区添加：闵行区</p>
<p>分区信息更改：  bc subarea<br>subarea有一个外键：region id</p>
<p>Struts2表单数据封装<br>三种方式：</p>
<ul>
<li>1、modelDriven</li>
<li>2、set属性</li>
<li>3、对象 ognl表达式</li>
</ul>
<p>页面标签：region.id</p>
<hr>
<h4 id="分区添加之下拉框显示说明"><a href="#分区添加之下拉框显示说明" class="headerlink" title="分区添加之下拉框显示说明"></a>分区添加之下拉框显示说明</h4><p>subarea.jsp前端页面编辑<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;form id=<span class="string">"addSubareaForm"</span> method=<span class="string">"post"</span> action=<span class="string">"<span class="variable">$&#123;pageContext.request.contextPath&#125;</span>/bc/subAreaAction_save"</span>&gt;</span><br></pre></td></tr></table></figure></p>
<p>在做分区添加的时候主键是怎么做的？<br>easyui的下拉框<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;td&gt;</span><br><span class="line">    &lt;%--下拉框--%&gt;</span><br><span class="line">    &lt;input class=<span class="string">"easyui-combobox"</span> name=<span class="string">"region.id"</span></span><br><span class="line">    data-options=<span class="string">"valueField:'id',textField:'name',url:'json/standard.json'"</span>/&gt;</span><br><span class="line">&lt;/td&gt;</span><br></pre></td></tr></table></figure></p>
<pre><code>valueField:&apos;id&apos;:json格式数据返回的&apos;id&apos;的内容
textField：下拉框显示的内容。是id=&apos;id&apos;的name的值
</code></pre><p>后台是返回的是List<region></region></p>
<hr>
<h5 id="分区添加之区域列表回显实现"><a href="#分区添加之区域列表回显实现" class="headerlink" title="分区添加之区域列表回显实现"></a>分区添加之区域列表回显实现</h5><p>首先regionAction<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">//分区添加业务  区域全部查询  ajaxList形式返回</span><br><span class="line">@Action(value = <span class="string">"regionAction_ajaxList"</span>,results = &#123; @Result(name = <span class="string">"ajaxList"</span>, <span class="built_in">type</span> =<span class="string">"json"</span>)&#125;)</span><br><span class="line">public String <span class="function"><span class="title">ajaxList</span></span>() &#123;</span><br><span class="line">    try &#123;</span><br><span class="line">       List&lt;Region&gt; regions=serviceFacade.getRegionService().ajaxList();</span><br><span class="line">       push(regions);</span><br><span class="line">    &#125; catch (Exception e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">return</span> <span class="string">"ajaxList"</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>实现层<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">public List&lt;Region&gt; <span class="function"><span class="title">ajaxList</span></span>() &#123;</span><br><span class="line">    <span class="built_in">return</span> regionDao.findAll();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这样后端数据就完成了<br>然后前端想显示省市区的话需要在Region类内添加一个getName方法<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">public String <span class="function"><span class="title">getName</span></span>() &#123;</span><br><span class="line">    <span class="built_in">return</span> province + city + district;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这样前端就可以显示如下的格式<br>    山西省太原市小店区<br>但是由于get方法默认注解为@Column：在自动建表的时候，数据库里就会添加一个name的字段出来<br>由于这个字段跟Region表无关，因此必须要让这个字段不要在表里建立字段<br>需要添加注解：  @Transient<br>作用：瞬时，声明这个字段不会在表里创建出来，不要在表中建立name字段</p>
<hr>
<h4 id="分区添加之区域下拉框自动补全效果"><a href="#分区添加之区域下拉框自动补全效果" class="headerlink" title="分区添加之区域下拉框自动补全效果"></a>分区添加之区域下拉框自动补全效果</h4><pre><code>在前端添加参数
</code></pre><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">data-options=<span class="string">"mode:'remote',valueField:'id'</span></span><br></pre></td></tr></table></figure>
<p>mode:’remote’ ：它会在你输入的时候到服务器获取数据<br>例如我输入一个’天’，那么它就会往后台添加一个p：天<br>那么就可以在后台添加<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">//分区添加业务  区域全部查询  ajaxList形式返回</span><br><span class="line">@Action(value = <span class="string">"regionAction_ajaxList"</span>,results = &#123; @Result(name = <span class="string">"ajaxList"</span>, <span class="built_in">type</span> =<span class="string">"json"</span>)&#125;)</span><br><span class="line">public String <span class="function"><span class="title">ajaxList</span></span>() &#123;</span><br><span class="line">    try &#123;</span><br><span class="line">        String q=getParameter(<span class="string">"q"</span>);</span><br><span class="line">        //q如果没有值   就所有的都差  如果有值就模糊查询</span><br><span class="line">       List&lt;Region&gt; regions=serviceFacade.getRegionService().ajaxList(q);</span><br><span class="line">       push(regions);</span><br><span class="line">    &#125; catch (Exception e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">return</span> <span class="string">"ajaxList"</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>在实现层添加重载方法<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">public List&lt;Region&gt; ajaxList(String q) &#123;</span><br><span class="line">    <span class="keyword">if</span> (StringUtils.isNotBlank(q))&#123;</span><br><span class="line">        //模糊查询</span><br><span class="line">      <span class="built_in">return</span>  regionDao.ajaxListRegionByProviceOrCityDistrict(<span class="string">"%"</span>+q+<span class="string">"%"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">return</span> regionDao.findAll();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>在DAO层添加方法<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"> @Query(<span class="string">"from Region where province like ?1 or  city like ?1 or district like ?1"</span>)</span><br><span class="line">public List&lt;Region&gt; ajaxListRegionByProviceOrCityDistrict(String s);</span><br></pre></td></tr></table></figure></p>
<p>完成！！！注意返回值类型</p>
<hr>
<h4 id="分区添加业务功能"><a href="#分区添加业务功能" class="headerlink" title="分区添加业务功能"></a>分区添加业务功能</h4><p>1、首先在前端页面添加分区按钮点击事件<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">//添加分区保存按钮点击事件</span><br><span class="line">$(<span class="string">"#save"</span>).click(<span class="function"><span class="title">function</span></span> () &#123;</span><br><span class="line">    //提交表单</span><br><span class="line">    <span class="keyword">if</span> ($(<span class="string">"#addSubareaForm"</span>).form(<span class="string">"validate"</span>)) &#123;</span><br><span class="line">        $(<span class="string">"#addSubareaForm"</span>).submit();</span><br><span class="line">        $(<span class="string">"#addSubareaWindow"</span>).window(<span class="string">"close"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p>
<p>2、创建subAreaAction<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">@SuppressWarnings(<span class="string">"all"</span>)</span><br><span class="line">@Controller(<span class="string">"subareaAction"</span>)</span><br><span class="line">@Scope(<span class="string">"prototype"</span>)</span><br><span class="line">@Namespace(<span class="string">"/bc"</span>) // 根据页码的/user而来，不能乱写</span><br><span class="line">@ParentPackage(<span class="string">"bos"</span>) // 要进行扩展struts.xml中的</span><br><span class="line">public class SubareaAction extends BaseAction&lt;Subarea&gt; &#123;</span><br><span class="line"></span><br><span class="line">    // 区域添加</span><br><span class="line">    @Action(value = <span class="string">"subAreaAction_save"</span>, results = </span><br><span class="line">	&#123;@Result(name = <span class="string">"save"</span>, location = <span class="string">"/WEB-INF/pages/base/subarea.jsp"</span>)&#125;)</span><br><span class="line">    public String <span class="function"><span class="title">save</span></span>() &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            serviceFacade.getSubAreaService().save(model);</span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            push(<span class="literal">false</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">return</span> <span class="string">"save"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>3、依次创建 SubAreaService 和 SubAreaServiceImpl 以及 SubAreaDao<br>SubAreaService<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">public interface SubAreaService &#123;</span><br><span class="line">    public void save(Subarea model);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>SubAreaServiceImpl<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">@Service</span><br><span class="line">@Transactional</span><br><span class="line">public class SubAreaServiceImpl implements SubAreaService &#123;</span><br><span class="line"></span><br><span class="line">    @Autowired</span><br><span class="line">    private SubAreaDao subAreaDao;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public void save(Subarea model) &#123;</span><br><span class="line">    subAreaDao.save(model);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>SubAreaDao<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">public interface SubAreaDao extends JpaRepository&lt;Subarea, String&gt; &#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<hr>
<h4 id="分区分页查询编码以及延迟加载问题说明"><a href="#分区分页查询编码以及延迟加载问题说明" class="headerlink" title="分区分页查询编码以及延迟加载问题说明"></a>分区分页查询编码以及延迟加载问题说明</h4><p><img src="http://whyathere.github.io/images/bos/day05/分区分析图.jpg" alt=""><br>依照其他action操作即可，但是肯定会有延迟加载的问题。<br>原因：事务管理在业务层有效，但是web没有延迟加载的 DecidedZone 和 Region 的数据。<br>DecidedZone在它的get方法上面添加 @JSON(serialize = false)<br>但是Region是需要的在页面上显示的<br>解决方法有两种：</p>
<ol>
<li>业务层   配置region立刻查询数据库  将数据封装到对象中</li>
<li>将entityManager对象生命周期延伸到web  可以被json plugin序列化的时候查询数据库</li>
<li>报错信息：<br>Caused by: org.hibernate.LazyInitializationException: could not initialize proxy - no Session<br> at org.hibernate.proxy.AbstractLazyInitializer.initialize(AbstractLazyInitializer.java:167)<br> at org.hibernate.proxy.AbstractLazyInitializer.getImplementation(AbstractLazyInitializer.java:215)<br> at org.hibernate.proxy.pojo.javassist.JavassistLazyInitializer.invoke(JavassistLazyInitializer.java:190)<br> at com.zero.bos.domain.bc.Region_$$_javassist_4.getCity(Region_$$_javassist_4.java)<br> … 90 more<br>原因是：Region数据拿不到<br>第一种 做法：在代码中，进行region的查询。查询后就会默认进行数据的封装，而不会在需要的时候再去查询。<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public Page&lt;Subarea&gt; pageQuery(PageRequest pageable) &#123;</span><br><span class="line">    //拿到数据 但是没有region数据，要让它立即查询 需要调取数据</span><br><span class="line">    Page&lt;Subarea&gt; data = subAreaDao.findAll(pageable);</span><br><span class="line">    //目标数据</span><br><span class="line">    List&lt;Subarea&gt; list = data.getContent();</span><br><span class="line">    //拿到每一个数据</span><br><span class="line">    <span class="keyword">for</span> (Subarea s: list)&#123;</span><br><span class="line">        Hibernate.initialize(s.getRegion()); //立刻进行Region的查询  那么数据就都封装到data中了</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">return</span> data;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>每个进行查询，会向region表发语句，查询后就会默认封装到data中。</p>
<p>第二种：将EntityManager的生命周期放大<br>在web.xml中添加过滤器<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&lt;!--将EntityManager生命周期延伸到web--&gt;</span><br><span class="line">&lt;filter&gt;</span><br><span class="line">    &lt;filter-name&gt;OpenEntityManagerInViewFilter&lt;/filter-name&gt;</span><br><span class="line">    &lt;filter-class&gt;org.springframework.orm.jpa.support.OpenEntityManagerInViewFilter&lt;/filter-class&gt;</span><br><span class="line">&lt;/filter&gt;</span><br><span class="line"></span><br><span class="line">&lt;filter-mapping&gt;</span><br><span class="line">    &lt;filter-name&gt;OpenEntityManagerInViewFilter&lt;/filter-name&gt;</span><br><span class="line">    &lt;url-pattern&gt;/*&lt;/url-pattern&gt;</span><br><span class="line">&lt;/filter-mapping&gt;</span><br></pre></td></tr></table></figure></p>
<hr>
<h4 id="多表条件查询客户端实现"><a href="#多表条件查询客户端实现" class="headerlink" title="多表条件查询客户端实现"></a>多表条件查询客户端实现</h4><p>综合查询分析图：<br><img src="http://whyathere.github.io/images/bos/day05/综合查询分析.jpg" alt=""><br>这是一个多表、分页、条件的综合查询。<br>多条件查询，点击下一页的时候：客户端需要将用户输入表单的条件参数携带传给服务器<br>问题1：客户端每次分页查询的条件，是否可以不需要服务器提供<br>分页查询每次都是往：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">url: <span class="string">"<span class="variable">$&#123;pageContext.request.contextPath&#125;</span>/bc/subAreaAction_pageQuery"</span>,</span><br></pre></td></tr></table></figure></p>
<p>这个地址发<br>由于条件参数是在from表单中的，但是我们需要带有分页的功能，那么就需要在点击分页的时候还带着之前的查询条件。<br>那么可以将form发送给datagrid插件，这个插件有功能可以将请求发送到它的url中<br>并且将条件发送给后台，而且点击就分页的时候也会带着这些条件。<br>datagrid插件 方法…向 url 地址发送请求  并且可以 携带参数？</p>
<p>那么点击查询按钮的时候，触发datagrid的load方法，将表单里的参数，转换成{}<br>测试load方法能否传递给后台：<br>页面添加代码:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$(<span class="string">"#btn"</span>).click(<span class="function"><span class="title">function</span></span> () &#123;</span><br><span class="line">   //调用datagrid load 方法</span><br><span class="line">    $(<span class="string">"#grid"</span>).datagrid(<span class="string">"load"</span>,&#123;</span><br><span class="line">        name:<span class="string">'lisi'</span>,</span><br><span class="line">        age:23</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p>
<p><img src="http://whyathere.github.io/images/bos/day05/测试load方法的请求.jpg" alt=""><br>可以看到会往后台查询action发送，两个参数而且还有页面。<br>而且刷新之后，会再次往服务器发送请求，并且带着之前的参数。<br>服务器不需要将条件回送</p>
<p>查询是调用的datagrid的load方法，将参数json给load方法参数<br>解决：每一次分页查询，客户端都会将条件参数自动的发送给datagrid的url<br>每次调用dagagrid的load方法都会向datagrid的url发送请求，发送条件和页码</p>
<p>那么form表单如何将input数据  转换json对象<br>{region.privince：’江苏省’,…}—-&gt;load  pageQuery Model:Subarea<br>那么form对象如何序列化：<br>jquery表单 序列号json<br>searileze()—&gt;name=list&amp;age=23<br>searlizeArra()  是一个数组<br>那么就需要自己拼接出来<br>$.fn.来扩展jquery的方法,将对象转换为json对象发送给后台<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">//封装js方法，基于jquery</span><br><span class="line">$.fn.serializeJson = <span class="function"><span class="title">function</span></span> () &#123;</span><br><span class="line">    var serializeObj = &#123;&#125;;</span><br><span class="line">    var array = this.serializeArray();</span><br><span class="line">    var str = this.serialize();</span><br><span class="line">    $(array).each(<span class="function"><span class="title">function</span></span> () &#123;</span><br><span class="line">        <span class="keyword">if</span> (serializeObj[this.name]) &#123;</span><br><span class="line">            <span class="keyword">if</span> ($.isArray(serializeObj[this.name])) &#123;</span><br><span class="line">                serializeObj[this.name].push(this.value);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                serializeObj[this.name] = [serializeObj[this.name], this.value];</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            serializeObj[this.name] = this.value;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="built_in">return</span> serializeObj;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<p>这样前端的页面就完成了。</p>
<hr>
<h4 id="分区条件查询之单表查询代码实现"><a href="#分区条件查询之单表查询代码实现" class="headerlink" title="分区条件查询之单表查询代码实现"></a>分区条件查询之单表查询代码实现</h4><p>分析：客户端 提交参数  条件参数  可变  page+rows—&gt;action–&gt;pageQuery方法<br>那么就要考虑model能不能接收这些条件参数<br>page和rows  是BaseAction接收的，可以接收<br>条件参数 –&gt;封装Model 也就是 SubArea对象中<br>由于是使用ognl表达式，所以前端页面上面的要加上region.province</p>
<p>JpaRepository&lt;Subarea, String&gt;无法完成复杂的查询</p>
<p>JpaSpecificationExecutor<subarea>帮助我们完成复杂条件的查询<br>接口可以继承多个接口，用，隔开即可<br>这样Impl类就有<br>findAll（specal，pageable）;<br>action调用实现类<br>那么action就需要提供给它2个参数<br>参数1：Specification<br>参数2：PageRequest  page rows<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">public interface Specification&lt;T&gt; &#123;</span><br><span class="line">    Predicate toPredicate(Root&lt;T&gt; var1, CriteriaQuery&lt;?&gt; var2, CriteriaBuilder var3);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></subarea></p>
<p>参数1是一个接口，我们需要在action编写一个该接口的实现类。<br>接口的方法，实现类实现该方法，将请求参数  封装到Predicate<br>那么就是model里面取数据，然后往接口的实现类里面封<br>难度就是怎么写出来实现类；</p>
<p>spring data jpa如果做复杂的单表查询或者多表的复杂查询，全部采用<br>将条件封装到接口  Specification接口的实现类中<br>然后直接传递给DAO  即可，dao只需要继承JpaSpecificationExcecutor<t><br>首先进行无条件的测试：<br>SubareaAction<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">@Action(value = <span class="string">"subAreaAction_pageQuery"</span>)</span><br><span class="line">public String <span class="function"><span class="title">pageQuery</span></span>() &#123;</span><br><span class="line">    try &#123;</span><br><span class="line">        //将条件从Model中取出来  封装到Specification接口实现方法中</span><br><span class="line">        Specification&lt;Subarea&gt; spec=new Specification&lt;Subarea&gt;() &#123;</span><br><span class="line">            @Override</span><br><span class="line">            public Predicate toPredicate(Root&lt;Subarea&gt; root, CriteriaQuery&lt;?&gt; criteriaQuery, CriteriaBuilder criteriaBuilder) &#123;</span><br><span class="line">                <span class="built_in">return</span> null;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br></pre></td></tr></table></figure></t></p>
<p>service<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Page&lt;Subarea&gt; pageQuery(PageRequest pageRequest, Specification&lt;Subarea&gt; spec);</span><br></pre></td></tr></table></figure></p>
<p>serviceImpl<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public Page&lt;Subarea&gt; pageQuery(PageRequest pageRequest, Specification&lt;Subarea&gt; spec) &#123;</span><br><span class="line">    <span class="built_in">return</span> subAreaDao.findAll(spec,pageRequest);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>启动后查询正常</p>
<hr>
<p>下面进行条件查询<br>所以的查询关系都是and条件<br>数组不好声明，因为不确定条件有几个。但是可以用集合，然后转换成数组<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">// 区域的分页查询 分区分页查询 无条件分页+无条件分页查询</span><br><span class="line">//Subarea封装所有的请求参数条件 mysql <span class="built_in">limit</span> oracle rownum 动态的sql ，条件不一样</span><br><span class="line">@Action(value = <span class="string">"subAreaAction_pageQuery"</span>)</span><br><span class="line">public String <span class="function"><span class="title">pageQuery</span></span>() &#123;</span><br><span class="line">    try &#123;</span><br><span class="line">        //将条件从Model中取出来  封装到Specification接口实现方法中</span><br><span class="line">        Specification&lt;Subarea&gt; spec=new Specification&lt;Subarea&gt;() &#123;</span><br><span class="line">            @Override</span><br><span class="line">            public Predicate toPredicate(Root&lt;Subarea&gt; root, CriteriaQuery&lt;?&gt; criteriaQuery, CriteriaBuilder cb) &#123;</span><br><span class="line">                List&lt;Predicate&gt; list=new ArrayList&lt;Predicate&gt;();  //存放多个对象条件</span><br><span class="line">                //条件封装实现  root（查询的主表对象实体类） query  <span class="built_in">cd</span>（连接对象条件 类似 hibernate Critira Restrictions.）三个关键字</span><br><span class="line">                //1：关键字查询  查询自己的表就可以了 不需要多表连接的</span><br><span class="line">                <span class="keyword">if</span> (StringUtils.isNotBlank(model.getAddresskey()))&#123;</span><br><span class="line">                    //用户要进行关键字查询   前面是需要匹配的字段 后面是匹配的值  进行模糊查询</span><br><span class="line">                   Predicate p1= cb.like(root.get(<span class="string">"addresskey"</span>).as(String.class),<span class="string">"%"</span>+model.getAddresskey()+<span class="string">"%"</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                //2:多表查询   分区连接区域</span><br><span class="line"></span><br><span class="line">                Predicate[] p=new Predicate[list.size()];</span><br><span class="line">                <span class="built_in">return</span> cb.and(list.toArray(p));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">        //2：</span><br><span class="line">        //PageRequest pageable = new PageRequest(page - 1, rows);</span><br><span class="line">        //dao 参数 Pageable pageable 自动完成分页查询 将分页结果数据 自动封装到Page&lt;T&gt;</span><br><span class="line">        //从Page 对象获取总记录数 和 每页分页记录数List&lt;Staff&gt;</span><br><span class="line">        Page&lt;Subarea&gt; pageData = serviceFacade.getSubAreaService().pageQuery(getPageRequest(),spec);</span><br><span class="line">        setPageData(pageData);</span><br><span class="line">    &#125; catch (Exception e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">        push(<span class="literal">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">return</span> <span class="string">"pageQuery"</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<ol>
<li>创建接口的实现类</li>
<li>将model取出来放到实现类的方法中</li>
<li>通过model取条件</li>
</ol>
<h4 id="分区条件查询多表查询实现"><a href="#分区条件查询多表查询实现" class="headerlink" title="分区条件查询多表查询实现"></a>分区条件查询多表查询实现</h4><p>root参数代表的是主表<br>root–&gt;Subarea—&gt;Region<br>它会在判断到model.getRegion不为null的时候去连接Region表，那么怎么连接呢？<br>在一方当中，多方是一个set集合<br>在这里 root n: 1 region 多方连接一方<br>一方连接一方<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">root.join(root.getModel().getSingularAttribute(<span class="string">"region"</span>, Region.class), JoinType.LEFT);</span><br></pre></td></tr></table></figure></p>
<p>如果是多方的话就是getSet<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">//2:多表查询   分区连接区域</span><br><span class="line"> <span class="keyword">if</span> (model.getRegion() != null) &#123;</span><br><span class="line">     //连接区域表</span><br><span class="line">     Join&lt;Subarea, Region&gt; regionJoin = root.join(root.getModel().getSingularAttribute(<span class="string">"region"</span>, Region.class), JoinType.LEFT);</span><br><span class="line">     //regionJoin 操作 区域表</span><br><span class="line">     <span class="keyword">if</span> (StringUtils.isNotBlank(model.getRegion().getProvince())) &#123;</span><br><span class="line">         Predicate p2 = cb.like(regionJoin.&lt;String&gt;get(<span class="string">"province"</span>).as(String.class), <span class="string">"%"</span> + model.getRegion().getProvince() + <span class="string">"%"</span>);</span><br><span class="line">         list.add(p2);</span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line">     <span class="keyword">if</span> (StringUtils.isNotBlank(model.getRegion().getCity())) &#123;</span><br><span class="line">         Predicate p3 = cb.like(regionJoin.&lt;String&gt;get(<span class="string">"city"</span>).as(String.class), <span class="string">"%"</span> + model.getRegion().getCity() + <span class="string">"%"</span>);</span><br><span class="line">         list.add(p3);</span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line">     <span class="keyword">if</span> (StringUtils.isNotBlank(model.getRegion().getDistrict())) &#123;</span><br><span class="line">         Predicate p4 = cb.like(regionJoin.&lt;String&gt;get(<span class="string">"district"</span>).as(String.class), <span class="string">"%"</span> + model.getRegion().getDistrict() + <span class="string">"%"</span>);</span><br><span class="line">         list.add(p4);</span><br><span class="line">     &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure></p>
<p>定区编号只要oid==相等就会被当成一个对象，所以比较的不是内存地址。除去了内存编号的地址<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">//3:定区的编号查询  root subarea --decidezone</span><br><span class="line">                    <span class="keyword">if</span> (model.getDecidedZone()!=null&amp;&amp;StringUtils.isNotBlank(model.getDecidedZone().getId()))&#123;</span><br><span class="line">                   Predicate p5=     cb.equal(root.get(<span class="string">"decidedZone"</span>).as(DecidedZone.class),model.getDecidedZone());</span><br><span class="line">                    &#125;</span><br></pre></td></tr></table></figure></p>
<p>这里只要model.getDecidedZone()不为null，它就有OID<br>cb.equal(root.get(“decidedZone”).as(DecidedZone.class) 如果和model.getDecidedZone()<br>是相等的对象，那就有OID了。<br>完整代码如下：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line">// 区域的分页查询 分区分页查询 无条件分页+无条件分页查询</span><br><span class="line">//Subarea封装所有的请求参数条件 mysql <span class="built_in">limit</span> oracle rownum 动态的sql ，条件不一样</span><br><span class="line">@Action(value = <span class="string">"subAreaAction_pageQuery"</span>)</span><br><span class="line">public String <span class="function"><span class="title">pageQuery</span></span>() &#123;</span><br><span class="line">    try &#123;</span><br><span class="line">        //将条件从Model中取出来  封装到Specification接口实现方法中</span><br><span class="line">        Specification&lt;Subarea&gt; spec = new Specification&lt;Subarea&gt;() &#123;</span><br><span class="line">            @Override</span><br><span class="line">            public Predicate toPredicate(Root&lt;Subarea&gt; root, CriteriaQuery&lt;?&gt; criteriaQuery, CriteriaBuilder cb) &#123;</span><br><span class="line">                List&lt;Predicate&gt; list = new ArrayList&lt;Predicate&gt;();  //存放多个对象条件</span><br><span class="line">                //条件封装实现  root（查询的主表对象实体类） query  <span class="built_in">cd</span>（连接对象条件 类似 hibernate Critira Restrictions.）三个关键字</span><br><span class="line">                //1：关键字查询  查询自己的表就可以了 不需要多表连接的</span><br><span class="line">                <span class="keyword">if</span> (StringUtils.isNotBlank(model.getAddresskey())) &#123;</span><br><span class="line">                    //用户要进行关键字查询   前面是需要匹配的字段 后面是匹配的值  进行模糊查询</span><br><span class="line">                    Predicate p1 = cb.like(root.get(<span class="string">"addresskey"</span>).as(String.class), <span class="string">"%"</span> + model.getAddresskey() + <span class="string">"%"</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                //2:多表查询   分区连接区域</span><br><span class="line">                <span class="keyword">if</span> (model.getRegion() != null) &#123;</span><br><span class="line">                    //连接区域表</span><br><span class="line">                    Join&lt;Subarea, Region&gt; regionJoin = root.join(root.getModel().getSingularAttribute(<span class="string">"region"</span>, Region.class), JoinType.LEFT);</span><br><span class="line">                    //regionJoin 操作 区域表</span><br><span class="line">                    <span class="keyword">if</span> (StringUtils.isNotBlank(model.getRegion().getProvince())) &#123;</span><br><span class="line">                        Predicate p2 = cb.like(regionJoin.&lt;String&gt;get(<span class="string">"province"</span>).as(String.class), <span class="string">"%"</span> + model.getRegion().getProvince() + <span class="string">"%"</span>);</span><br><span class="line">                        list.add(p2);</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> (StringUtils.isNotBlank(model.getRegion().getCity())) &#123;</span><br><span class="line">                        Predicate p3 = cb.like(regionJoin.&lt;String&gt;get(<span class="string">"city"</span>).as(String.class), <span class="string">"%"</span> + model.getRegion().getCity() + <span class="string">"%"</span>);</span><br><span class="line">                        list.add(p3);</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> (StringUtils.isNotBlank(model.getRegion().getDistrict())) &#123;</span><br><span class="line">                        Predicate p4 = cb.like(regionJoin.&lt;String&gt;get(<span class="string">"district"</span>).as(String.class), <span class="string">"%"</span> + model.getRegion().getDistrict() + <span class="string">"%"</span>);</span><br><span class="line">                        list.add(p4);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                //3:定区的编号查询  root subarea --decidezone</span><br><span class="line">                <span class="keyword">if</span> (model.getDecidedZone() != null &amp;&amp; StringUtils.isNotBlank(model.getDecidedZone().getId())) &#123;</span><br><span class="line">                    Predicate p5 = cb.equal(root.get(<span class="string">"decidedZone"</span>).as(DecidedZone.class), model.getDecidedZone());</span><br><span class="line">                    list.add(p5);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                //集合转换成数组</span><br><span class="line">                Predicate[] p = new Predicate[list.size()];</span><br><span class="line">                <span class="built_in">return</span> cb.and(list.toArray(p));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">        //2：</span><br><span class="line">        //PageRequest pageable = new PageRequest(page - 1, rows);</span><br><span class="line">        //dao 参数 Pageable pageable 自动完成分页查询 将分页结果数据 自动封装到Page&lt;T&gt;</span><br><span class="line">        //从Page 对象获取总记录数 和 每页分页记录数List&lt;Staff&gt;</span><br><span class="line">        Page&lt;Subarea&gt; pageData = serviceFacade.getSubAreaService().pageQuery(getPageRequest(), spec);</span><br><span class="line">        setPageData(pageData);</span><br><span class="line">    &#125; catch (Exception e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">        push(<span class="literal">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">return</span> <span class="string">"pageQuery"</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>CriteriaBuilder就相当于连接条件<br>Root代表着我们的泛型</p>
<hr>
<h3 id="分区数据导出"><a href="#分区数据导出" class="headerlink" title="分区数据导出"></a>分区数据导出</h3><p>将满足条件的数据  通过  导出…<br>浏览器   采用下载的形式  将数据  生成Excel文档<br>1、满足条件数据如何查询到</p>
<p>2、满足数据List<t>  27条记录<br>下载….Poi 生成工作簿  才能下载<br>读的时候也是读到内存里，然后存到数据库。<br>—&gt;List<t>—-&gt;WorkBook(sheet row cell)<br>3、workbook.write(response.getOutputStream())<br>添加两个头  附件形式下载</t></t></p>
<p><img src="http://whyathere.github.io/images/bos/day05/分区数据导出功能.jpg" alt=""></p>
<p>首先点击前端页面的导出按钮：<br>浏览器导出（下载形式） 生成Excel 直接发请求的时候把满足的条件找到，条件可能有0到N个，那么条件要<br>怎么传递给后端呢？<br>解决：直接提交表单   把条件都带过去  到后端去验证<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;form id=<span class="string">"searchSubareaForm"</span> action=<span class="string">"<span class="variable">$&#123;pageContext.request.contextPath&#125;</span>/bc/subAreaAction_download"</span> method=<span class="string">"post"</span>&gt;</span><br></pre></td></tr></table></figure></p>
<p>后端代码<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br></pre></td><td class="code"><pre><span class="line">//subAreaAction_download  接收表单的提交的参数信息  对多条件查询</span><br><span class="line">    @Action(value = <span class="string">"subAreaAction_download"</span>)</span><br><span class="line">    public String <span class="function"><span class="title">download</span></span>() &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            //将条件从Model中取出来  封装到Specification接口实现方法中</span><br><span class="line">            Specification&lt;Subarea&gt; spec = new Specification&lt;Subarea&gt;() &#123;</span><br><span class="line">                @Override</span><br><span class="line">                public Predicate toPredicate(Root&lt;Subarea&gt; root, CriteriaQuery&lt;?&gt; criteriaQuery, CriteriaBuilder cb) &#123;</span><br><span class="line">                    List&lt;Predicate&gt; list = new ArrayList&lt;Predicate&gt;();  //存放多个对象条件</span><br><span class="line">                    //条件封装实现  root（查询的主表对象实体类） query  <span class="built_in">cd</span>（连接对象条件 类似 hibernate Critira Restrictions.）三个关键字</span><br><span class="line">                    //1：关键字查询  查询自己的表就可以了 不需要多表连接的</span><br><span class="line">                    <span class="keyword">if</span> (StringUtils.isNotBlank(model.getAddresskey())) &#123;</span><br><span class="line">                        //用户要进行关键字查询   前面是需要匹配的字段 后面是匹配的值  进行模糊查询</span><br><span class="line">                        Predicate p1 = cb.like(root.get(<span class="string">"addresskey"</span>).as(String.class), <span class="string">"%"</span> + model.getAddresskey() + <span class="string">"%"</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                    //2:多表查询   分区连接区域</span><br><span class="line">                    <span class="keyword">if</span> (model.getRegion() != null) &#123;</span><br><span class="line">                        //连接区域表</span><br><span class="line">                        Join&lt;Subarea, Region&gt; regionJoin = root.join(root.getModel().getSingularAttribute(<span class="string">"region"</span>, Region.class), JoinType.LEFT);</span><br><span class="line">                        //regionJoin 操作 区域表</span><br><span class="line">                        <span class="keyword">if</span> (StringUtils.isNotBlank(model.getRegion().getProvince())) &#123;</span><br><span class="line">                            Predicate p2 = cb.like(regionJoin.&lt;String&gt;get(<span class="string">"province"</span>).as(String.class), <span class="string">"%"</span> + model.getRegion().getProvince() + <span class="string">"%"</span>);</span><br><span class="line">                            list.add(p2);</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                        <span class="keyword">if</span> (StringUtils.isNotBlank(model.getRegion().getCity())) &#123;</span><br><span class="line">                            Predicate p3 = cb.like(regionJoin.&lt;String&gt;get(<span class="string">"city"</span>).as(String.class), <span class="string">"%"</span> + model.getRegion().getCity() + <span class="string">"%"</span>);</span><br><span class="line">                            list.add(p3);</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                        <span class="keyword">if</span> (StringUtils.isNotBlank(model.getRegion().getDistrict())) &#123;</span><br><span class="line">                            Predicate p4 = cb.like(regionJoin.&lt;String&gt;get(<span class="string">"district"</span>).as(String.class), <span class="string">"%"</span> + model.getRegion().getDistrict() + <span class="string">"%"</span>);</span><br><span class="line">                            list.add(p4);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    //3:定区的编号查询  root subarea --decidezone</span><br><span class="line">                    <span class="keyword">if</span> (model.getDecidedZone() != null &amp;&amp; StringUtils.isNotBlank(model.getDecidedZone().getId())) &#123;</span><br><span class="line">                        Predicate p5 = cb.equal(root.get(<span class="string">"decidedZone"</span>).as(DecidedZone.class), model.getDecidedZone());</span><br><span class="line">                        list.add(p5);</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    //集合转换成数组</span><br><span class="line">                    Predicate[] p = new Predicate[list.size()];</span><br><span class="line">                    <span class="built_in">return</span> cb.and(list.toArray(p));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;;</span><br><span class="line">            //2：</span><br><span class="line">            //PageRequest pageable = new PageRequest(page - 1, rows);</span><br><span class="line">            //dao 参数 Pageable pageable 自动完成分页查询 将分页结果数据 自动封装到Page&lt;T&gt;</span><br><span class="line">            //从Page 对象获取总记录数 和 每页分页记录数List&lt;Staff&gt;</span><br><span class="line">            //Page&lt;Subarea&gt; pageData = serviceFacade.getSubAreaService().pageQuery(getPageRequest(), spec);</span><br><span class="line">            //2：dao已经实现了多条件查询</span><br><span class="line">            List&lt;Subarea&gt; subs = serviceFacade.getSubAreaService().findSubareaBySpecification(spec);</span><br><span class="line">            //setPageData(pageData);</span><br><span class="line">            //3: 将集合数据写入到工作簿当中   POI加上下载知识点</span><br><span class="line">            //先写到工作簿中去</span><br><span class="line">            //创建Excel工作簿</span><br><span class="line">            HSSFWorkbook workbook = new HSSFWorkbook();</span><br><span class="line">            //在excel中建一个工作表，其名为缺省值</span><br><span class="line">            HSSFSheet sheet = workbook.createSheet(<span class="string">"铁"</span>);</span><br><span class="line">            //在索引0的位置创建行（最顶端的行）</span><br><span class="line">            HSSFRow row = sheet.createRow(0);</span><br><span class="line">            //在索引0的位置创建单元格(左上端)</span><br><span class="line">            //标题</span><br><span class="line">            row.createCell(0).setCellValue(<span class="string">"分区编号"</span>);</span><br><span class="line">            row.createCell(1).setCellValue(<span class="string">"区域编号"</span>);</span><br><span class="line">            row.createCell(2).setCellValue(<span class="string">"关键字"</span>);</span><br><span class="line">            row.createCell(3).setCellValue(<span class="string">"起始号"</span>);</span><br><span class="line">            row.createCell(4).setCellValue(<span class="string">"结束号"</span>);</span><br><span class="line">            row.createCell(5).setCellValue(<span class="string">"位置信息"</span>);</span><br><span class="line">            //循环放入行中</span><br><span class="line">            <span class="keyword">if</span> (subs != null &amp;&amp; subs.size() != 0) &#123;</span><br><span class="line">                <span class="keyword">for</span> (Subarea s : subs) &#123;</span><br><span class="line">                    int lastRowNum = sheet.getLastRowNum();//当前sheet  最后一行的 角标 0</span><br><span class="line">                    //没循环一次创建一行</span><br><span class="line">                    HSSFRow row1 = sheet.createRow(lastRowNum + 1);</span><br><span class="line">                    //在索引0的位置创建单元格(左上端)</span><br><span class="line">                    //标题 分区编号 区域编号 关键字 起始号 结束号 位置信息</span><br><span class="line">                    row1.createCell(0).setCellValue(s.getId());</span><br><span class="line">                    row1.createCell(1).setCellValue(s.getRegion().getId());</span><br><span class="line">                    row1.createCell(2).setCellValue(s.getAddresskey());</span><br><span class="line">                    row1.createCell(3).setCellValue(s.getStartnum());</span><br><span class="line">                    row1.createCell(4).setCellValue(s.getEndnum());</span><br><span class="line">                    row1.createCell(5).setCellValue(s.getPosition());</span><br><span class="line">                &#125;</span><br><span class="line">                //工作簿完成</span><br><span class="line">                //下载  两个头 一个流</span><br><span class="line">                //文件名</span><br><span class="line">                String filename = new Date(System.currentTimeMillis()).toLocaleString() + <span class="string">"张思思.xls"</span>;</span><br><span class="line">                //父类没有response，所以需要将response添加到父类</span><br><span class="line">                HttpServletResponse response = getResponse();</span><br><span class="line">                //ServletContext.getMimeType 根据文件的扩展名  获取对应Mime 类型</span><br><span class="line">                response.setContentType(getServletContext().getMimeType(filename));</span><br><span class="line">                //2、附件头  通过浏览器拿请求类型</span><br><span class="line">                response.setHeader(<span class="string">"Content-Disposition"</span>, <span class="string">"attachment;filename="</span> + MyFileUtils.encodeDownloadFilename(filename, getRequest().getHeader(<span class="string">"user-agent"</span>)));</span><br><span class="line">                //3、输出流</span><br><span class="line">                try &#123;</span><br><span class="line">                    workbook.write(response.getOutputStream());</span><br><span class="line">                &#125; catch (IOException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            push(<span class="literal">false</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        //4：下载不需要跳转，就是当前页面</span><br><span class="line">        <span class="built_in">return</span> NONE;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/06/06/Eclipse/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Bill">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/06/06/Eclipse/" itemprop="url">Eclipse</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-06-06T18:23:46+08:00">
                2018-06-06
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/开发工具/" itemprop="url" rel="index">
                    <span itemprop="name">开发工具</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="Eclipse-ini文件"><a href="#Eclipse-ini文件" class="headerlink" title="Eclipse.ini文件"></a>Eclipse.ini文件</h3><p>该文档中提及的以下警告信息需要重点注意。</p>
<ul>
<li>-vmargs 之后的所有行都被作为参数传递给JVM；Eclipse的所有参数和选项必须在 -vmargs之前指定(正如在命令行上使用参数一样)。</li>
</ul>
<p>这就是为什么要在文件开始处插入 -vm 选项的原因。</p>
<ul>
<li>在命令行中使用 -vmargs将覆盖所有在 .ini文件中的 -vmargs设置，除非在.ini文件中或命令行中指定了 –auncher.appendVmargs。</li>
</ul>
<p><strong>设置 -vm选项</strong></p>
<p>设置 -vm 选项用于确定Eclipse使用那个JVM实现。你可能会注意到我们已经选定了JVM作为一个库(<em>.dll /</em>.so)，这在启动时能提供更好的性能，还支持程序作为Eclipse可执行文件运行而并不是作为Java可执行文件。</p>
<p>如果没有设置-vm 选项时，Eclipse 使用那个JVM，请注意Eclipse不查询JAVA_HOME 环境变量(Eclipse wiki)。相反，Eclipse执行解析path环境变量的Java命令。</p>
<p><strong>自定义JVM参数</strong></p>
<p>推荐的JVM参数列表来自于Piotr Gabryanczyk 在Java内存管理模型方面的研究成果。最初用于JetBRAINS Intellij设置，这种配置对Eclipse环境也有用的。在一下场合中有帮助；</p>
<ul>
<li>防止垃圾回收器中断程序的运行超过10ms(-XX:MaxGCPauseMillis=10)</li>
<li>降低垃圾回收器启动的级别到30%的所占用内存(-XX:MaxHeapFreeRatio=70)</li>
<li>强制垃圾回收器作为一个并行线程运行，降低对应用程序的干扰(-XX:+UseConcMarkSweepGC)</li>
<li>为垃圾回收器选择增量模式，可以在GC工作中生成中断让应用程序明确地停止冻结(-XX:+CMSIncrementalPacing)</li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/06/05/Spring-MVC/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Bill">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/06/05/Spring-MVC/" itemprop="url">Spring MVC</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-06-05T10:03:30+08:00">
                2018-06-05
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Spring-MVC/" itemprop="url" rel="index">
                    <span itemprop="name">Spring MVC</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="SpringMVC的注解"><a href="#SpringMVC的注解" class="headerlink" title="SpringMVC的注解"></a>SpringMVC的注解</h3><ol>
<li>@ModelAttribute</li>
</ol>
<p>大致有两种使用方式，一种是直接标记在方法上，一种是标记在方法的参数中，两种标记方法产生的效果也各不相同。</p>
<ul>
<li>注解放在方法上面</li>
</ul>
<p>当同一个controller中有任意一个方法被@ModelAttribute注解标记，页面请求只要进入这个控制器，不管请求那个方法，均会先执行被@ModelAttribute标记的方法，所以我们可以用@ModelAttribute注解的方法做一些初始化操作。当同一个controller中有多个方法被@ModelAttribute注解标记，所有被@ModelAttribute标记的方法均会被执行，按先后顺序执行，然后再进入请求的方法。</p>
<p>​    </p>
<p>下面方法做一些变形，变形为带有参数的返回，这样也是实际开发中经常会操作的 </p>
<p>首先创建一个pojo对象，对象包含name，sex两个属性。并对JSP及控制器代码做一些修改</p>
<p>页面首先使用EL表达式接收返回参数</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">&lt;%@ page contentType=<span class="string">"text/html;charset=UTF-8"</span> language=<span class="string">"java"</span> <span class="keyword">import</span>=<span class="string">"java.util.*"</span> %&gt;</span><br><span class="line">&lt;%</span><br><span class="line">    String path = request.getContextPath();</span><br><span class="line">    String basePath = request.getScheme() + <span class="string">"://"</span> + request.getServerName() + <span class="string">":"</span> + request.getServerPort() + path + <span class="string">"/"</span>;</span><br><span class="line">%&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">    &lt;title&gt;Title&lt;/title&gt;</span><br><span class="line">    &lt;script type=<span class="string">"text/javascript"</span>&gt;</span><br><span class="line">        $(function () &#123;</span><br><span class="line">            $(<span class="string">"#modelTest"</span>).on(<span class="string">"click"</span>, function () &#123;</span><br><span class="line"></span><br><span class="line">                window.location.href = <span class="string">"&lt;%=basePath%&gt;model/modelTest.do"</span>;</span><br><span class="line">            &#125;)</span><br><span class="line">        &#125;);</span><br><span class="line">    &lt;/script&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line"></span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;input type=<span class="string">"button"</span> id=<span class="string">"modelTest"</span> value=<span class="string">"测试"</span>&gt;</span><br><span class="line"></span><br><span class="line">&lt;input type=<span class="string">"text"</span> value=<span class="string">"$&#123;pojo.name &#125;"</span>&gt;</span><br><span class="line">&lt;input type=<span class="string">"text"</span> value=<span class="string">"$&#123;pojo.sex &#125;"</span>&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>
<p>@ModelAtterbute方法无返回值情况</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="meta">@RequestMapping</span>(value=<span class="string">"model"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ModelAttributeTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ModelAttribute</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">(Model mode)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        PojoTest pojo=<span class="keyword">new</span> PojoTest(<span class="keyword">null</span>, <span class="string">"小明"</span>, <span class="string">"男"</span>);</span><br><span class="line">        mode.addAttribute(<span class="string">"pojo"</span>, pojo);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping</span>(value=<span class="string">"modelTest.do"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">modelTest</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"modelTest"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>访问ModelTest.jsp页面并点击测试</p>
<p> <img src="https://img-blog.csdn.net/20170225235700722?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvSGFycnlfWkhfV2FuZw==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt=""></p>
<p>从执行结果看出，当访问请求时，会首先访问init方法，然后再对modelTest方法进行访问，并且是同一个请求，因为model模型数据的作用域与request相同，所以可以用此标记直接标记在方法上对实际要访问的方法进行一些初始化操作</p>
<ul>
<li>@ModelAttribute标记方法有返回值</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="meta">@RequestMapping</span>(value=<span class="string">"model"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ItemController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ModelAttribute</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">init</span><span class="params">(Model mode)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"进入init方法"</span>);</span><br><span class="line">        PojoTest pojo=<span class="keyword">new</span> PojoTest(<span class="string">"小明"</span>, <span class="string">"男"</span>);</span><br><span class="line">        mode.addAttribute(<span class="string">"pojo"</span>, pojo);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"model/befor"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping</span>(value=<span class="string">"befor"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">befor</span><span class="params">()</span></span>&#123;</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">"进入befor方法"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"index"</span>;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping</span>(value=<span class="string">"modelTest"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">modelTest</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"进入modelTest方法"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"modelTest"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里稍微做了点变形，可以看到在被@ModelAttribute方法中设值了返回路径为befor方法，但是在在代码运行的过程中并不会跳转befor方法，而是在代码执行完成return之前直接跳转了实际请求的方法。不执行return</p>
<p> 进入init方法<br>进入modelTest方法</p>
<ul>
<li><p>当@RequestMapping标记和@ModelAttribute同时标记在一个方法上</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="meta">@RequestMapping</span>(value=<span class="string">"model"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ModelAttributeTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping</span>(value=<span class="string">"modelTest.do"</span>)</span><br><span class="line">    <span class="meta">@ModelAttribute</span>(value=<span class="string">"pojo"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">modelTest</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"进入modelTest方法"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="string">"modelTest"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>点击测试页面发现进入控制器后返回，页面报404，这是因为当两个注解标记到同一个方法上时，逻辑视图名并不是返回值，而是返回请求的路径，根据model/modelTest.do生成逻辑视图。在这里我们修改下代码，把controller上的@RequestMapping标记去掉，并修改下页面的请求路径，让生成的视图路径和访问的页面路径相同</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ModelAttributeTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping</span>(value=<span class="string">"modelTest.do"</span>)</span><br><span class="line">    <span class="meta">@ModelAttribute</span>(value=<span class="string">"pojo"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">modelTest</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"进入modelTest方法"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="string">"modelTest"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&lt;script type=<span class="string">"text/javascript"</span>&gt;</span><br><span class="line">       $(function()&#123;</span><br><span class="line">           $(<span class="string">"#modelTest"</span>).on(<span class="string">"click"</span>,function()&#123;</span><br><span class="line">  </span><br><span class="line">               window.location.href=<span class="string">"&lt;%=basePath%&gt;modelTest.do"</span>;</span><br><span class="line">           &#125;)</span><br><span class="line">       &#125;);</span><br><span class="line"> &lt;/script&gt;</span><br><span class="line"> &lt;body&gt;</span><br><span class="line">  </span><br><span class="line">   &lt;input type=<span class="string">"button"</span> id=<span class="string">"modelTest"</span> value=<span class="string">"测试"</span>&gt;</span><br><span class="line">  </span><br><span class="line">   &lt;input type=<span class="string">"text"</span> value=<span class="string">"$&#123;pojo &#125;"</span>&gt;</span><br><span class="line">  </span><br><span class="line"> &lt;/body&gt;</span><br></pre></td></tr></table></figure>
<p>点击测试页面，会发现当两个注解同时注解到一个方法上时，方法的返回值会变成model模型的返回值，key是标记的名</p>
<h4 id="ModelAttribute标记在参数前"><a href="#ModelAttribute标记在参数前" class="headerlink" title="@ModelAttribute标记在参数前"></a>@ModelAttribute标记在参数前</h4><p>从from表单或url地址中取值，这里就以url地址为例，为了避免url地址中文乱码问题，这里调用了encodeURL函数</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&lt;script type=<span class="string">"text/javascript"</span>&gt;</span><br><span class="line">        $(function()&#123;</span><br><span class="line">            $(<span class="string">"#modelTest"</span>).on(<span class="string">"click"</span>,function()&#123;</span><br><span class="line"></span><br><span class="line">                window.location.href=<span class="string">"&lt;%=basePath%&gt;model/modelTest.do?userName="</span>+encodeURI(<span class="string">'小明'</span>)+<span class="string">"&amp;sex="</span>+encodeURI(<span class="string">'男'</span>);</span><br><span class="line">            &#125;)</span><br><span class="line">        &#125;);</span><br><span class="line">  &lt;/script&gt;</span><br><span class="line">  &lt;body&gt;</span><br><span class="line"></span><br><span class="line">    &lt;input type=<span class="string">"button"</span> id=<span class="string">"modelTest"</span> value=<span class="string">"测试"</span>&gt;</span><br><span class="line">    &lt;input type=<span class="string">"text"</span> value=<span class="string">"$&#123;pojo.userName &#125;"</span>&gt;</span><br><span class="line">    &lt;input type=<span class="string">"text"</span> value=<span class="string">"$&#123;pojo.sex &#125;"</span>&gt;</span><br><span class="line"></span><br><span class="line">  &lt;/body&gt;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="meta">@RequestMapping</span>(value=<span class="string">"model"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ModelAttributeTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping</span>(value=<span class="string">"modelTest.do"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">modelTest</span><span class="params">(@ModelAttribute(<span class="string">"pojo"</span>)</span> PojoTest pojo) </span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            pojo.setUserName(<span class="keyword">new</span> String(pojo.getUserName().getBytes(<span class="string">"iso-8859-1"</span>),<span class="string">"utf-8"</span>));</span><br><span class="line">            pojo.setSex(<span class="keyword">new</span> String(pojo.getSex().getBytes(<span class="string">"iso-8859-1"</span>),<span class="string">"utf-8"</span>));</span><br><span class="line">        &#125; <span class="keyword">catch</span> (UnsupportedEncodingException e) &#123;</span><br><span class="line">            <span class="comment">// TODO Auto-generated catch block</span></span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(pojo);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"modelTest"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>点击页面测试，页面文本框会显示URL地址传递过来的参数，因为SpringMVC会自动匹匹配页面传递过来的参数的name属性和后台控制器中的方法中的参数名，如果参数名相同，会自动匹配，如果控制器中方法是封装的bean,会自动匹配bean中的属性，其实这种取值方式不需要用@ModelAttribute注解，只要满足匹配要求，也能拿得到值</p>
<p> <img src="https://img-blog.csdn.net/20170226011711946?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvSGFycnlfWkhfV2FuZw==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt=""></p>
<p>从model对象中取值</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="meta">@RequestMapping</span>(value=<span class="string">"model"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ModelAttributeTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ModelAttribute</span>(<span class="string">"pojo"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> PojoTest <span class="title">init</span><span class="params">( PojoTest pojo)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        pojo.setSex(<span class="string">"男"</span>);</span><br><span class="line">        <span class="keyword">return</span> pojo;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping</span>(value=<span class="string">"modelTest.do"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">modelTest</span><span class="params">(@ModelAttribute(<span class="string">"pojo"</span>)</span> PojoTest pojo) </span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        pojo.setUserName(<span class="string">"小明"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"modelTest"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>点击测试发现，modelTest拿到inint方法中的pojo对象，合并两次set的参数后返回页面</p>
</li>
</ul>
<p>   <img src="https://img-blog.csdn.net/20170226023308348?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvSGFycnlfWkhfV2FuZw==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt=""></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/05/31/FastDfs分布式文件系统/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Bill">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/05/31/FastDfs分布式文件系统/" itemprop="url">FastDFS 分布式文件系统</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-05-31T10:40:45+08:00">
                2018-05-31
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/框架/" itemprop="url" rel="index">
                    <span itemprop="name">框架</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="FastDfs简介"><a href="#FastDfs简介" class="headerlink" title="FastDfs简介"></a>FastDfs简介</h3><ol>
<li>FastDfs是一个轻量级的开源分布式文件系统</li>
<li>FastDfs主要解决了大容量的文件存储和高并发访问的问题，文件存取时实现了负载均衡</li>
<li>FastDfs实现了软件方式的RAID，可以使用廉价的IDE硬盘进行存储</li>
<li>支持存储服务器在线扩容</li>
<li>支持相同内容的文件只保存一份，节约磁盘空间</li>
<li>FastDFS只能通过Client API访问，不支持POSIX访问方式</li>
<li><p>FastDFS特别适合大中型网站使用，用来存储资源文件(如：图片、文档、音频、视频等等)</p>
<p>  FastDFS是一个开源的轻量级分布式文件系统，她对文件进行管理，功能包括：文件存储、文件同步、文件访问（文件上传、文件下载）等，解决了大容量存储和负载均衡的问题。特别适合以文件为载体的在线服务，如相册网站、视频网站等等。  </p>
</li>
</ol>
<p>FastDFS服务端有两个角色：<strong>跟踪器(tracker)</strong>和<strong>存储节点(storage)</strong>。跟踪器主要做调度工作，在访问上起负载均衡 的作用。</p>
<h4 id="Tracker"><a href="#Tracker" class="headerlink" title="Tracker"></a>Tracker</h4><p><img src="https://github.com/whyathere/tuchuang/blob/master/%E6%A1%86%E6%9E%B6/FastDFS/%E5%BC%95%E5%85%A5Tracker.jpg?raw=true" alt=""></p>
<p>Group之间是相互独立的，Group内是相互备份的；Tracker之间也是相互独立的。</p>
<ul>
<li><p>Group之间 相互独立</p>
</li>
<li><p>同一Group内的Storage Server 之间需要互相备份</p>
<p>文件存放到一个Storage以后，需要备份到别的服务器</p>
</li>
<li><p>Tracker之间是不交互的</p>
<ul>
<li>每个storage server都需要向所有Tracker去主动报告信息</li>
</ul>
</li>
</ul>
<p><strong>要点：</strong></p>
<ol>
<li>group内的server内容都是一致的</li>
<li>一个负责跟踪一个负责存储</li>
<li>group会向每个tracker都汇报，tracker存储的信息很少</li>
</ol>
<p><img src="https://github.com/whyathere/tuchuang/blob/master/%E6%A1%86%E6%9E%B6/FastDFS/%E4%B8%8A%E4%BC%A0%E6%96%87%E4%BB%B6%E6%97%B6%E5%BA%8F%E5%9B%BE.jpg?raw=true" alt=""></p>
<h4 id="选定Tracker-Server"><a href="#选定Tracker-Server" class="headerlink" title="选定Tracker Server"></a>选定Tracker Server</h4><ul>
<li>Tracker Server不止一个，客户端选择哪一个做上传文件？</li>
</ul>
<p>Client是如何知道上传到那个Tracker Server</p>
<p>Client可以维护一个Tracker列表</p>
<ul>
<li>Tracker如何选择Group？(三种策略)<ul>
<li>round robin(轮询)</li>
<li>load balance(选择最大剩余空间的组上传文件)</li>
<li>specify group(指定group上传)</li>
</ul>
</li>
</ul>
<h4 id="选定Storage-Server"><a href="#选定Storage-Server" class="headerlink" title="选定Storage Server"></a>选定Storage Server</h4><ul>
<li>一个组内有多个Storage Server ，选择哪一个？<ul>
<li><ol>
<li>Round robin，所有server轮询使用(默认)</li>
</ol>
</li>
<li><ol start="2">
<li>根据IP地址进行排序选择第一个服务器(IP地址最小者)</li>
</ol>
</li>
<li><ol start="3">
<li>根据优先级进行排序(上传优先级由storage server来设置，参数为upload_priority)</li>
</ol>
</li>
</ul>
</li>
</ul>
<p><img src="https://github.com/whyathere/tuchuang/blob/master/%E6%A1%86%E6%9E%B6/FastDFS/storage%20Server%20%E7%9A%84%E5%AD%98%E5%82%A8%E7%BB%93%E6%9E%84.jpg?raw=true" alt=""></p>
<h4 id="选择storage-path"><a href="#选择storage-path" class="headerlink" title="选择storage path"></a>选择storage path</h4><ul>
<li>如何选择storage path(虚拟磁盘目录M00，M01路径)<ul>
<li><ol>
<li>round robin ，轮询(默认)</li>
</ol>
</li>
<li><ol start="2">
<li>load balance，选择使用剩余空间最大的存储路径</li>
</ol>
</li>
</ul>
</li>
</ul>
<p>目录和文件</p>
<ul>
<li>选定存放目录？<ul>
<li>storage会生成一个file_id(wKjGgVgbV2-ABdo-AAAAHw.jpg)，采用Base64编码，file_id包含字段包括：storage server_ip(文件的源服务器)、文件创建时间、文件大小、文件CRC32校验码和随机数、；(这个时候文件名已经和最早的文件名是两回事儿了)</li>
<li>每个存储目录下有两个256*256个子目录，storage 会按文件file_id进行两次hash，路由到其中一个子目录，然后将文件以file_id为文件名存储到该子目录下</li>
</ul>
</li>
</ul>
<p>Group1/M00/00/OC/wKjGgVgbV2-ABdo-AAAAHw.jpg   </p>
<p>tracker可以通过上面的东西迅速的找到文件</p>
<p><strong>要点：</strong></p>
<ul>
<li>server之间不分主从，每个目录可以不止放一个文件</li>
<li>存储服务器启动的时候就会把两个256*256个目录一次创建出来</li>
<li>file_id必须由client来保存。</li>
</ul>
<p>怎么确定存放在那个目录</p>
<p>storage会按照文件的file_id(wKjGgVgbV2-ABdo-AAAAHw.jpg   )做两次hash算法，路由到其中一个子目录中。</p>
<h4 id="Storage-Server之间的文件同步"><a href="#Storage-Server之间的文件同步" class="headerlink" title="Storage Server之间的文件同步"></a>Storage Server之间的文件同步</h4><ul>
<li>同一组内的storage server之间是对等的，文件上传、删除等操作可以在任意一台storage server上进行；</li>
<li>文件同步只在组内的storage server之间进行，采用push方式，即源服务器同步给目标服务器；</li>
<li>源头数据才需要同步，备份数据不需要再次同步，否则就构成环路了；</li>
<li>上述第二条规则有个例外，就是新增加一台storage server时，由已有的一套storage server将已有的所有数据(包括源头数据和备份数据)同步给新增服务器</li>
</ul>
<p>client是FastDFS提供的客户端</p>
<p>FastDFS有覆盖方法，可以修改某个已经上传的文件，甚至是追加操作。</p>
<p>例子：</p>
<p>A，B，C三个服务器在同一个组中</p>
<ul>
<li>9:30用户向服务器A上传了一个文件X(文件创建时间9:30)</li>
<li>9:31用户向服务器B上传了一个文件Y(文件创建时间9:31)</li>
<li>9:32用户向服务器A上传了一个文件Z(文件创建时间9:32)</li>
</ul>
<p>A向B，C同步文件X，并且向Tracker Server汇报</p>
<ul>
<li>我向B同步了X(文件创建时间9:30)</li>
<li>我向C同步了X(文件创建时间9:30)</li>
</ul>
<p><img src="https://github.com/whyathere/tuchuang/blob/master/%E6%A1%86%E6%9E%B6/FastDFS/storage%20Server%E4%B9%8B%E9%97%B4%E7%9A%84%E6%96%87%E4%BB%B6%E5%90%8C%E6%AD%A5.jpg?raw=true" alt=""></p>
<p><img src="https://github.com/whyathere/tuchuang/blob/master/%E6%A1%86%E6%9E%B6/FastDFS/storage%20Server%E4%B9%8B%E9%97%B4%E7%9A%84%E6%96%87%E4%BB%B6%E5%90%8C%E6%AD%A52.jpg?raw=true" alt=""></p>
<p>通过文件名都可以取到创建时间和源服务器地址</p>
<p>这个时候下载文件Y，tracker会去那个服务器上面寻找呢?</p>
<p>这个时候可以直接从B中下载，如果这个时候B宕机了，只有和A或C中找，查tracker中的表时，B–&gt;A在9：31前的都同步了，就去A中找。如果A也宕机了，就去C中找，看这个时间前的是否同步。</p>
<p>tracker不需要保存左侧的信息，根据文件名就可以了。</p>
<p><img src="https://github.com/whyathere/tuchuang/blob/master/%E6%A1%86%E6%9E%B6/FastDFS/storage%20Server%E4%B9%8B%E9%97%B4%E7%9A%84%E6%96%87%E4%BB%B6%E5%90%8C%E6%AD%A53.jpg?raw=true" alt=""></p>
<p>这个时候假设用户想下载文件Z，就去源服务器下载，如果源服务器宕机，就去其他服务器下载。根据时间判断是否在这个时间前的同步了，如果同步了就下载，如果没有就下载。</p>
<p><img src="https://github.com/whyathere/tuchuang/blob/master/%E6%A1%86%E6%9E%B6/FastDFS/storage%20Server%E4%B9%8B%E9%97%B4%E7%9A%84%E6%96%87%E4%BB%B6%E5%90%8C%E6%AD%A54.jpg?raw=true" alt=""></p>
<p>当试图下载文件的时候，根据文件名拿到创建时间和服务器，根据时间来判断是否可以下载。</p>
<p>FastDFS文件同步方式</p>
<p><img src="https://github.com/whyathere/tuchuang/blob/master/%E6%A1%86%E6%9E%B6/FastDFS/FastDFS%E6%96%87%E4%BB%B6%E5%90%8C%E6%AD%A5%E6%96%B9%E5%BC%8F.jpg?raw=true" alt=""></p>
<p>最后最早同步时间，</p>
<p>对于服务器A来讲，服务器B向他同步的时间是9:31,服务器C是9:33.计算最后的时间，那么根据上图。</p>
<p>对服务器A，它的最早同步时间是9:31</p>
<p>对服务器B，它的最早同步时间是9:32</p>
<p><strong>取最小值，然后直接和最小值进行比对。</strong></p>
<p> <img src="https://github.com/whyathere/tuchuang/blob/master/%E6%A1%86%E6%9E%B6/FastDFS/%E6%9C%80%E5%90%8E%E6%9C%80%E6%97%A9%E5%90%8C%E6%AD%A5%E6%97%B6%E9%97%B4.jpg?raw=true" alt=""></p>
<p>X可以从三个服务器下载</p>
<p>Y可以从A和B服务器下载，C不行。</p>
<p>Z可以从源服务器A下载，或者服务器B下载,C不行</p>
<p>W只能从服务器C这个源服务器下载，虽然根据时间判断C已经将9:33前的同步到了A和B这两个服务器，但是根据规则，它不能去A和B下载。</p>
<p>虽然简单，但是会牺牲一下。</p>
<p>选择一个可供下载的Storage Server策略</p>
<ul>
<li>该文件上传到源Storage server(文件直接上传到该服务器上的)</li>
<li>文件创建时间戳&lt;Storage server被同步到的文件时间戳，这意味着当前文件已经被同步过来了；</li>
<li>文件创建时间戳=Storage server被同步到的文件时间戳，且(当前时间-文件创建时间戳)&gt;一个文件同步完成需要的最大时间(如5分钟);</li>
<li>(当前时间-文件创建时间戳)&gt;文件同步延迟阈值，比如我们把阈值设置为1天，表示文件同步在一天内肯定可以完成</li>
</ul>
<p>当走到第四个的时候可能已经出问题了。</p>
<p>tracker定位一个组中的server</p>
<h3 id="FastDFS的使用"><a href="#FastDFS的使用" class="headerlink" title="FastDFS的使用"></a>FastDFS的使用</h3><p><img src="https://github.com/whyathere/tuchuang/blob/master/%E6%A1%86%E6%9E%B6/FastDFS/FastDFS%E7%9A%84%E4%BD%BF%E7%94%A8.jpg?raw=true" alt=""></p>
<p>这里的FastDFSAPI可以当做client</p>
<p><img src="https://github.com/whyathere/tuchuang/blob/master/%E6%A1%86%E6%9E%B6/FastDFS/FastDFS%E7%9A%84%E4%BD%BF%E7%94%A8%E5%92%8Cnagix%E9%9B%86%E6%88%90.jpg?raw=true" alt=""></p>
<p>上图这种就是</p>
<p>如果上传的话还是走Nginx，到应用服务器</p>
<p>如果下载的时候，直接通过Nginx，直接到FastDFS，模块和Nginx集成。绕过应用服务器</p>
<p>要点：</p>
<ul>
<li>Tracker server内部没有数据库，要么是内存要么是纯文件，文件格式自己定义</li>
</ul>
<h3 id="防止盗链"><a href="#防止盗链" class="headerlink" title="防止盗链"></a>防止盗链</h3><ul>
<li>辛苦上传的文件不想被人盗取</li>
<li>给URL增加token<ul>
<li>Token只有自己的网站才能生成</li>
<li>Token会过期</li>
</ul>
</li>
</ul>
<p>refer</p>
<h4 id="防止盗链的配置"><a href="#防止盗链的配置" class="headerlink" title="防止盗链的配置"></a>防止盗链的配置</h4><p>是否做token检查，缺省为false</p>
<p>http.anti_steal.check_token=true</p>
<p>即生成token的有效时长 秒</p>
<p>http.anti_steal.token_ttl=900</p>
<p>生成token的密钥，尽量设置得长一些</p>
<p>http.anti_steal.secret<em>key=@#%*&amp;$)87)</em>+$%!~</p>
<p>Token = md5(文件名，密钥，时间戳)</p>
<p><img src="https://github.com/whyathere/tuchuang/blob/master/%E6%A1%86%E6%9E%B6/FastDFS/%E9%98%B2%E6%AD%A2%E7%9B%97%E9%93%BE%E7%9A%84%E9%85%8D%E7%BD%AE.jpg?raw=true" alt=""></p>
<p>将文件名、密钥和时间戳的组合通过md5加密传给token</p>
<p>token是在服务器端生成</p>
<p>客户端下载文件的时候，除了传fileid以外还需要token</p>
<p>客户端发送的是fileid，服务器端返回的是一个token</p>
<h4 id="合并存储"><a href="#合并存储" class="headerlink" title="合并存储"></a>合并存储</h4><ul>
<li>海量小文件的缺点<ul>
<li>元数据管理低效，磁盘文件系统中，目录项(dentry)、索引节点(inode)和数据(data)保存在存储介质的不同位置上</li>
<li>数据存储分散</li>
<li>磁盘的大量随机访问降低效率</li>
</ul>
</li>
<li>FastDFS提供的合并存储功能<ul>
<li>默认大文件64M</li>
<li>每个文件空间称为slot(256bytes&lt;=slot&lt;=16MB)</li>
</ul>
</li>
</ul>
<p><img src="https://github.com/whyathere/tuchuang/blob/master/%E6%A1%86%E6%9E%B6/FastDFS/%E6%B2%A1%E6%9C%89%E5%90%88%E5%B9%B6%E6%97%B6%E7%9A%84%E6%96%87%E4%BB%B6ID.jpg?raw=true" alt=""></p>
<p><img src="https://github.com/whyathere/tuchuang/blob/master/%E6%A1%86%E6%9E%B6/FastDFS/%E5%90%88%E5%B9%B6%E6%97%B6%E7%9A%84%E6%96%87%E4%BB%B6.jpg?raw=true" alt=""></p>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><ul>
<li>FastDFS是穷人的解决方案</li>
<li>FastDFS把简洁和高效做到了极致，非常节约资源，中小网站完全用的起</li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/05/28/Spring-集成Hibernate3/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Bill">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/05/28/Spring-集成Hibernate3/" itemprop="url">Spring--集成Hibernate3</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-05-28T17:26:07+08:00">
                2018-05-28
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/框架/" itemprop="url" rel="index">
                    <span itemprop="name">框架</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><img src="https://github.com/whyathere/tuchuang/blob/master/%E7%BE%8E%E5%9B%BE/%E9%95%BF%E9%A2%88%E9%B9%BF.jpg?raw=true" alt=""></p>
<h3 id="集成Hibernate3"><a href="#集成Hibernate3" class="headerlink" title="集成Hibernate3"></a>集成Hibernate3</h3><p>​       Hibernate是全自动的ORM框架，能自动为对象生成相应SQL并透明的持久化对象到数据库。</p>
<p> <strong>Spring2.5+版本支持Hibernate 3.1+版本，不支持低版本，Spring3.0.5版本提供对Hibernate 3.6.0 Final版本支持。</strong></p>
<h4 id="如何集成"><a href="#如何集成" class="headerlink" title="如何集成"></a>如何集成</h4><p>Spring通过使用如下Bean进行集成Hibernate：</p>
<ul>
<li>LocalSessionFactoryBean ：用于支持XML映射定义读取：</li>
<li>configLocation和configLocations：用于定义Hibernate配置文件位置，一般使用classpath:hibernate.cfg.xml形式指定；</li>
<li>mappingLocations：用于指定Hibernate映射文件位置，如chapter8/hbm/user.hbm.xml;</li>
<li>hibernateProperties：用于定义Hibernate属性，即Hibernate配置文件中的属性；</li>
<li>dataSource：定义数据源；</li>
<li>hibernateProperties、dataSource用于消除Hibernate配置文件，因此如果使用configLocations指定配置文件，就不要设置这两个属性了，否则会产生重复配置。推荐使用dataSource来指定数据源，而使用hibernateProperties指定Hibernate属性。</li>
<li>AnnotationSessionFactoryBean：用于支持注解风格映射定义读取，该类继承LocalSessionFactoryBean并额外提供自动查找注解风格配置模型的能力；</li>
<li>AnnotatedClasses：设置注解了模型类，通过注解指定映射元数据。</li>
<li>packagesToScan：通过扫码指定的包获取注解模型类，而不是手工指定，如”com.zero.**.model”将扫码com.zero包及子包下的model包下所有注解模型类。</li>
</ul>
<p>接下来学习一下Spring如何继承Hibernate吧；</p>
<p><strong>1、准备jar包：</strong></p>
<p>首先准备Spring对ORM框架支持的jar包：</p>
<p>org.springframework.orm-3.0.5.RELEASE.jar      //提供对ORM框架集成</p>
<p>下载hibernate-distribution-3.6.0.Final包，获取如下Hibernate需要的jar包：</p>
<p>hibernate3.jar        //核心包</p>
<p>lib\required\antlr-2.7.6.jar        //HQL解析时使用的包</p>
<p>lib\required\javassist-3.9.0.GA.jar        //字节码类库，类似与cglib</p>
<p>lib\required\commons-collections-3.1.jar  //对集合类型支持包，前边测试时已经提供过了，无需再拷贝该包了</p>
<p>lib\required\dom4j-1.6.1.jar            //xml解析包，用于解析配置使用</p>
<p>lib\required\jta-1.1.jar                 //JTA事务支持包</p>
<p>lib\jpa\hibernate-jpa-2.0-api-1.0.0.Final.jar //用于支持JPA</p>
<p> 下载slf4j-1.6.1.zip（<a href="http://www.slf4j.org/download.html），slf4j是日志系统门面（Simple" target="_blank" rel="noopener">http://www.slf4j.org/download.html），slf4j是日志系统门面（Simple</a> Logging Facade for Java），用于对各种日志框架提供给一致的日志访问接口，从而能随时替换日志框架（如log4j、java.util.logging）：</p>
<p>将这些jar包添加到类路径中。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="page-number current">2</span><a class="page-number" href="/page/3/">3</a><a class="extend next" rel="next" href="/page/3/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">John Doe</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">28</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">11</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">14</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          

          

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">John Doe</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Muse</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  

</body>
</html>
