<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT" />










<meta property="og:type" content="website">
<meta property="og:title" content="Bill">
<meta property="og:url" content="http://yoursite.com/page/3/index.html">
<meta property="og:site_name" content="Bill">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Bill">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/page/3/"/>





  <title>Bill</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Bill</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/09/10/深入理解计算机原理/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Bill">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/09/10/深入理解计算机原理/" itemprop="url">深入理解计算机原理</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-09-10T18:27:21+08:00">
                2018-09-10
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="第三章"><a href="#第三章" class="headerlink" title="第三章"></a>第三章</h2><h3 id="程序编码"><a href="#程序编码" class="headerlink" title="程序编码"></a>程序编码</h3><h4 id="机器级代码"><a href="#机器级代码" class="headerlink" title="机器级代码"></a>机器级代码</h4><p>​    计算机系统使用了多种不同形式的抽象，利用更简单的抽象模型来隐藏实现的细节。其中两种尤为重要。第一种是由指令集体系结构或指令集架构，来定义机器级程序的格式和行为，它定义了处理器状态、指令的格式，以及每条指令对状态的影响。</p>
<p>​    它们并发地执行许多指令，但是可以采取措施保证整体行为与ISA指定的顺序执行的行为完全一致。</p>
<p>​    第二种抽象是，机器级程序使用的内存地址是虚拟的地址，提供的内存模型看上去是一个非常大的字节数组。存储器系统的实际实现是将多个硬件存储器和操作系统软件组合起来。</p>
<p>​    在编译过程中，编译器会将C语言提供的相对比较抽象的执行模型表示的程序转化成处理器执行的非常基本的指令。</p>
<p>​    计算机系统底层硬件只识别机器语言，而处理器就是用来执行一系列指令，每条指令执行某个简单的操作。比如两个数相加，汇编指令ADD会被编码为一个或多个字节组成的二进制格式。</p>
<p>​    这里 <strong>一个处理器支持的指令和指令的字节级编码称为它的指令集体系结构(Instruction-Set Architecture ,ISA)</strong></p>
<p>​    而不同的处理器家族，比如Intel IA32、IBM/Freescale PowerPC和AMD处理器家族，都有不同的ISA。不同类型的CPU有不同的机器指令系统，也就有不同的汇编语言是一样的。不同的处理器，其指令集体系结构也不一样，也就是说一个程序编译在一种机器上运行，就不能在另外一种机器上运行。如何处理这种兼容性问题呢？ <strong>ISA在编译器编写者和处理器设计人之间提供了一个抽象概念层，编译器编写者只需要知道允许那些指令，以及它们是如何编写的；而处理器设计者必须建造出这些指令的处理器。</strong></p>
<ul>
<li>程序计数器(通常称为”PC”，在x86-64中用%rip表示)给出将要执行的下一条指令在内存中的地址。</li>
</ul>
<p>机器代码只是简单地将内存看出一个很大的、按字节寻址的数组。C语言中的聚合数据类型，例如数组和结构，在机器代码中用一组连续的字节来表示。<strong>即使是对标量数据类型，汇编代码也不区分有符号或无符号整数，不区分各种类型的指针，甚至不区分指针和整数</strong></p>
<p>​    程序内存包括：程序的可执行机器代码，操作系统需要的一些信息，用来管理过程调用和返回的运行时栈，以及用户分配的内存块。程序内存用 <strong>虚拟地址来寻址</strong>。在任意给定时刻，只有有限的一部分虚拟地址被认为是合法的。例如，x86-64的虚拟地址是由64位的字来表示的。在目前的实现中，这些地址的高16位必须设置为0，所以一个地址实际上能够指定的是2的48次方或64TB范围内的一个字节。操作系统负责管理虚拟地址空间，将虚拟地址翻译成实际处理器内存中的物理地址。</p>
<p>反汇编器只是基于机器代码文件中的字节序列来确定汇编代码。它不需要访问该程序的源代码或汇编代码。</p>
<h3 id="数据格式"><a href="#数据格式" class="headerlink" title="数据格式"></a>数据格式</h3><p>​    由于是从16位体系结构扩展成32位的，Intel 用术语 “字(word)”表示16位数据类型。因此32位数为”双字(double words)”，称64位数为”四字(quad words)”。</p>
<table>
<thead>
<tr>
<th style="text-align:center">C声明</th>
<th style="text-align:center">Intel数据类型</th>
<th style="text-align:center">汇编代码后缀</th>
<th style="text-align:center">大小(字节)</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">char</td>
<td style="text-align:center">字节</td>
<td style="text-align:center">b</td>
<td style="text-align:center">1</td>
</tr>
<tr>
<td style="text-align:center">short</td>
<td style="text-align:center">字</td>
<td style="text-align:center">w</td>
<td style="text-align:center">2</td>
</tr>
<tr>
<td style="text-align:center">int</td>
<td style="text-align:center">字</td>
<td style="text-align:center">l</td>
<td style="text-align:center">4</td>
</tr>
<tr>
<td style="text-align:center">long</td>
<td style="text-align:center">四字</td>
<td style="text-align:center">q</td>
<td style="text-align:center">8</td>
</tr>
<tr>
<td style="text-align:center">char*</td>
<td style="text-align:center">四字</td>
<td style="text-align:center">q</td>
<td style="text-align:center">8</td>
</tr>
<tr>
<td style="text-align:center">float</td>
<td style="text-align:center">单精度</td>
<td style="text-align:center">s</td>
<td style="text-align:center">4</td>
</tr>
<tr>
<td style="text-align:center">double</td>
<td style="text-align:center">双精度</td>
<td style="text-align:center">l</td>
<td style="text-align:center">8</td>
</tr>
</tbody>
</table>
<p>​            C语言数据类型在x86-64中的大小。在64位机器中，指针长8字节</p>
<p>​    浮点数主要有两种形式：单精度(4字节)值，对应于C语言数据类型float；双精度对应double。    </p>
<p>​    如上表所示，大多数GCC生成的汇编代码指令都有一个字符的后缀，表明操作数的大小。例如：数据传送指令有四个变种：movb(传送字节)、movw(传送字)、movl(传送双字)和movq(传送四字)。注意，汇编代码也会使用后缀’1’来表示4字节整数和8字节双精度浮点数。因为浮点数使用的是一组完全不同的指令和寄存器。</p>
<h3 id="访问信息"><a href="#访问信息" class="headerlink" title="访问信息"></a>访问信息</h3><p>​    一个x86-64的中央处理单元(CPU)包含一组16个存储64位值的 <strong>通用目的的寄存器</strong>。这些寄存器用来<strong>存储整数数据和指针。</strong></p>
<p><img src="http://pcq0v117m.bkt.clouddn.com/2018-11-16-093431.png" alt=""></p>
<h4 id="操作数指示符"><a href="#操作数指示符" class="headerlink" title="操作数指示符"></a>操作数指示符</h4><p>​    大多数指令有一个或多个 <strong>操作数(operand)</strong>，指示出执行一个操作中要使用的源数据值，以及放置结果的目的位置。x86-64支持多种操作数格式。如下图。源数据值可以以常数形式给出，或是从寄存器或内存中读出。结果可以存放在寄存器或内存中。因此，各种不同的操作数的可能性被分为三种类型。</p>
<p>​    第一种类型是 <strong>立即数(immediate)</strong>，用来表示常数值。在ATT格式的汇编代码中，立即数的书写方式是’$’后面跟一个用标准C表示法表示的整数，比如,$-577或$0x1F。不同的指令允许的立即数数值范围不同，汇编器会自动选择最紧凑的方式进行数值编码。</p>
<p>​    第二种类型是 <strong>寄存器(register)</strong>，它表示某个寄存器的内容，16个寄存器的低位1字节、2字节、4字节或8字节中的一个作为操作数，这些字节分别对应于8位、16位、32位或64位。符号ra来表示任意寄存器a，用引用R[ra]来表示它的值，这是将寄存器集合看成一个数组R，用寄存器标识符做索引。</p>
<p>​    第三类操作数是 <strong>内存引用</strong>，它会根据计算出来的地址(通常称为有效地址)访问某个内存位置。因为将内存看成一个很大的字节数组。</p>
<p><img src="http://pcq0v117m.bkt.clouddn.com/2018-11-16-093554.png" alt="image-20181116173554467"></p>
<h4 id="数据传送指令"><a href="#数据传送指令" class="headerlink" title="数据传送指令"></a>数据传送指令</h4><p>​    最频繁使用的指令是将数据从一个位置复制到另一个位置。</p>
<table>
<thead>
<tr>
<th style="text-align:center">指令</th>
<th style="text-align:center">效果</th>
<th style="text-align:center">描述</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">MOV       S,D</td>
<td style="text-align:center">D←S</td>
<td style="text-align:center">传送</td>
</tr>
<tr>
<td style="text-align:center">movb</td>
<td style="text-align:center"></td>
<td style="text-align:center">传送字节</td>
</tr>
<tr>
<td style="text-align:center">movw</td>
<td style="text-align:center"></td>
<td style="text-align:center">传送字(2字节)</td>
</tr>
<tr>
<td style="text-align:center">movl</td>
<td style="text-align:center"></td>
<td style="text-align:center">传送双字(4字节)</td>
</tr>
<tr>
<td style="text-align:center">movq</td>
<td style="text-align:center"></td>
<td style="text-align:center">传送四字(8字节)</td>
</tr>
<tr>
<td style="text-align:center">movabsq     I,R</td>
<td style="text-align:center">R←I</td>
<td style="text-align:center">传送绝对的四字</td>
</tr>
</tbody>
</table>
<p>​    源操作数指定的值是一个立即数，存储在寄存器中或者内存中。目的操作数指定一个 <strong>位置</strong>，要么是一个寄存器要么是一个内存地址。x86-64限制， <strong>传送指令的两个操作数不能都指向内存位置。</strong>因为这样需要将需要两条指令：第一条指令将源值加载到寄存器中，第二条将寄存器值写入到目的位置。</p>
<h4 id="压入和弹出栈数据"><a href="#压入和弹出栈数据" class="headerlink" title="压入和弹出栈数据"></a>压入和弹出栈数据</h4><p>在x86-64中，程序栈存放在内存中某个区域。栈向下增长，这样一来，栈顶元素的地址是所有栈中元素地址中最低的。栈指针%rsp保存着栈顶元素的地址。</p>
<p>将一个四字值压入栈中，首先要将栈指针减8，然后将值写到新的栈顶地址。因此，指令 pushq %rbp的行为等价于下面两条指令：</p>
<p>​    subq $8,%rsp</p>
<p>​    movq %rbp,(%rsp)</p>
<p>它们之前的区别是在机器代码中pushq指令编码为1个字节，而上面那两条指令一共需要8个字节。</p>
<p>如下图前两栏给出的是，当%rsp为0x108,%rax 为0x123时，执行指令pushq %rax的效果。首先%rsp会减8，得到0x100，然后将0x123存放到内存地址0x100处。</p>
<p><img src="http://pcq0v117m.bkt.clouddn.com/2018-11-16-093235.png" alt="image-20181116173231518"></p>
<p>弹出一个四字的操作包括从栈顶位置读出数据，然后将栈指针加8.因此，指令popq %rax等价于下面两条指令：        </p>
<p>​    movq (%rsp),%rax</p>
<p>​    add $8,%rsp</p>
<p>​    上图的第三栏说明的是在执行完pushq后立即执行指令popq %rdx的效果。先从内存中读处值 0x123，再写到寄存器%rdx中，然后，寄存器%rsp的值将增加回到0x108。如图中所示，值0x123仍然会保持在内存位置0x100中，知道被覆盖(例如被另外一条入栈操作覆盖)。无论如何，%rsp指向的地址总是栈顶。</p>
<p>​    因为栈和程序代码以及其他形式的程序数据都是放在同一内存中，所以程序可以用标准的内存寻址方法访问栈内的任意位置。例如，假设栈顶元素是四字，指令movq 8(%rsp),%rdx会将第二个四字从栈中复制到寄存器%rdx.</p>
<h2 id="第八章：异常控制流"><a href="#第八章：异常控制流" class="headerlink" title="第八章：异常控制流"></a>第八章：异常控制流</h2><p>从处理器通电开始，知道断电，程序计数器假设了一个值的序列</p>
<p>​        a0,a1,a2……,an-1</p>
<p>每个ak是某个相应的指令Ik的地址。每次从ak到ak+1的过渡叫  <code>控制转移</code>(control transfer)。这样的控制转义序列叫做处理器的 <code>控制流</code>(flow of control 或control flow)。</p>
<p>最简单的控制流是一个“平滑的”序列，每个Ik和Ik+1在内存中都是相邻的。不相邻的就是平滑流的突变，通常是由诸如跳转、调用和返回这样的程序指令造成的。这样使得程序能够对程序变量表示的内部程序状态中的变化做出反应。</p>
<p>系统也应该要对系统状态的变化做出反应，例如网络信号的到达，必须放到内存中，需要处理器进行反应。现代的操作系统通过 <code>是控制流发生突变来对这些情况做出反应</code>。一般而言，我们称这些突变为 <strong>异常控制流(Exceptional Control Flow ,ECF)</strong></p>
<p>应用和操作系统的交互都是围绕着ECF开始的。一个计算机操作系统中所有层次上有各种各样的ECF，从异常开始，异常位于硬件和操作系统交界的部分。</p>
<h3 id="异常"><a href="#异常" class="headerlink" title="异常"></a>异常</h3><p>异常是异常控制流的一种形式，它一部分由硬件实现，一部分由操作系统实现;是控制流中的一种突变，用来响应处理器状态中的某些变化。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/09/10/Redis/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Bill">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/09/10/Redis/" itemprop="url">Redis</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-09-10T18:27:21+08:00">
                2018-09-10
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="Redis"><a href="#Redis" class="headerlink" title="Redis"></a>Redis</h2><h3 id="大概"><a href="#大概" class="headerlink" title="大概"></a>大概</h3><p>redis是单线程的</p>
<p>io多路复用，所以不需要线程池</p>
<h3 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h3><h4 id="如何保证缓存与数据库双写时数据一致性？"><a href="#如何保证缓存与数据库双写时数据一致性？" class="headerlink" title="如何保证缓存与数据库双写时数据一致性？"></a>如何保证缓存与数据库双写时数据一致性？</h4><p>只要用缓存，就可能涉及到缓存与数据库双存储双写，只要是双写，就一定有数据一致性的问题。</p>
<ul>
<li>先更新数据库，再更新缓存</li>
<li>先删除缓存，再更新数据库</li>
<li>先更新数据库，再删除缓存</li>
</ul>
<h5 id="先更新数据库，再更新缓存"><a href="#先更新数据库，再更新缓存" class="headerlink" title="先更新数据库，再更新缓存**"></a>先更新数据库，再更新缓存**</h5><p><strong>原因一：线程安全角度</strong></p>
<p>同时有请求A和请求B进行更新操作，那么会出现<br>（1）线程A更新了数据库<br>（2）线程B更新了数据库<br>（3）线程B更新了缓存<br>（4）线程A更新了缓存<br>这就出现请求A更新缓存应该比请求B更新缓存早才对，但是因为网络等原因，B却比A更早更新了缓存。这就导致了脏数据，因此不考虑。<br><strong>原因二（业务场景角度）</strong><br>有如下两点：<br>（1）如果你是一个写数据库场景比较多，而读数据场景比较少的业务需求，采用这种方案就会导致，数据压根还没读到，缓存就被频繁的更新，浪费性能。<br>（2）如果你写入数据库的值，并不是直接写入缓存的，而是要经过一系列复杂的计算再写入缓存。那么，每次写入数据库后，都再次计算写入缓存的值，无疑是浪费性能的。显然，删除缓存更为适合。</p>
<h5 id="先删缓存，再更新数据库"><a href="#先删缓存，再更新数据库" class="headerlink" title="先删缓存，再更新数据库"></a>先删缓存，再更新数据库</h5><p>A更新操作，B查询操作</p>
<h3 id="本地安装启动redis"><a href="#本地安装启动redis" class="headerlink" title="本地安装启动redis"></a>本地安装启动redis</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo make test</span><br></pre></td></tr></table></figure>
<p>在执行redis 编译测试的时候提示</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">xcrun: error: invalid active developer path (/Library/Developer/CommandLineTools), missing xcrun at: /Library/Developer/CommandLineTools/usr/bin/xcrun</span><br></pre></td></tr></table></figure>
<p>解决办法是打开 Terminal，执行如下命令：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">xcode-select --install</span><br></pre></td></tr></table></figure>
<p>这将下载并安装 xcode 开发者工具，之后就会修复这个问题。这个问题是因为需要你明确同意许可协议。如果你有多个版本的 Xcode 或者只需要命令行工具而非 Xcode，你可能需要重置 Xcode 的路径：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span> 重置 Xcode 路径</span><br><span class="line">xcode-select --switch /Applications/Xcode.app</span><br><span class="line"><span class="meta">#</span> 使用命令行工具</span><br><span class="line">xcode-select --switch /Library/Developer/CommandLineTool</span><br></pre></td></tr></table></figure>
<h3 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h3><p>redis-cli              启动客户端</p>
<p>get  ‘key’            通过key来取值</p>
<p>redis-cli shutdown      关闭redis客户端，包括server</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/09/10/复制hexo/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Bill">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/09/10/复制hexo/" itemprop="url">复制hexo</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-09-10T18:27:21+08:00">
                2018-09-10
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <ul>
<li>在系统上安装相应的hexo，初始化。</li>
<li>之后将source  themes _config.yml复制过来即可</li>
<li>hexo clean.   </li>
<li>hexo g</li>
<li>hexo d</li>
<li></li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/09/10/Spring-刘欣/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Bill">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/09/10/Spring-刘欣/" itemprop="url">Spring刘欣</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-09-10T17:49:57+08:00">
                2018-09-10
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/框架/" itemprop="url" rel="index">
                    <span itemprop="name">框架</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>Spring</p>
<h3 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h3><p>耦合具有两面性。一方面，紧密耦合的代码难以测试，难以复用、难以理解，并且典型地表现出“打地鼠”式的bug特性。另一方面，一定程度的耦合又是必须的—完全没有耦合的代码什么都做不了。为了完成有意义的功能，不同的类必须适当的进行交互。总而言之，耦合是必须的，但应当被小心谨慎地管理。</p>
<p>创建应用组件之间协作的行为通常称为装配（wiring）。Spring有多种装配bean的方式，采用xml是很常见的一种装配行为。</p>
<h4 id="观察它如何工作"><a href="#观察它如何工作" class="headerlink" title="观察它如何工作"></a>观察它如何工作</h4><p>Spring通过应用上下文(Application Context)装载bean的定义并把它们组装起来。Spring应用上下文全权负责对象的创建和组装。Spring自带了多种应用上下文的实现，它们之间主要的区别仅仅在于如何配置。</p>
<p>ClassPathXmlApplicationContext    该类加载位于应用程序类路径下的一个或多个XML配置文件。</p>
<h4 id="容纳你的Bean"><a href="#容纳你的Bean" class="headerlink" title="容纳你的Bean"></a>容纳你的Bean</h4><p>在基于Spring的应用中，你的应用对象生存于Spring容器(container)中。Spring容器负责创建对象，装配它们，配置它们并管理它们的整个生命周期，从生存到死亡(在这里，可能就是new 到 finalize())。</p>
<p>首先了解容纳对象的容器，有助于理解对象是如何被管理的。</p>
<p>容器上Spring容器的核心。Spring容器使用DI管理构成应用的组建，它会创建相互协作的组件之间的关联。</p>
<p>Spring容器并不是只有一个。Spring自带了多个容器实现，可以归为两种不同的类型。bean工厂上最简单的容器，提供基本的DI支持。应用上下文基于BeanFactory构建，并提供应用框架级别的服务，例如从属性文件解析文本信息以及发布应用事件给感兴趣的事件监听者。</p>
<p>虽然我们可以在bean工厂和应用上下文之间任选一种。但bean工厂对大多数应用来说太低级了，因此，应用上下文要比bean工厂更受欢迎。我们把精力集中在应用上下文上，不再浪费时间讨论bean工厂。</p>
<h5 id="使用应用上下文"><a href="#使用应用上下文" class="headerlink" title="使用应用上下文"></a>使用应用上下文</h5><p>常用的几个应用上下文</p>
<p>AnnotationConfigApplicationContext：从一个或多个基于Java的配置类中加载Spring应用上下文。</p>
<p>ClassPathXmlApplicationContext：从类路径下的一个或多个XML配置文件中加载上下文定义，把应用上下文的定义文件作为类资源。</p>
<p>FileSystemXmlApplicationContext：从文件系统下的一个或多个XML配置文件中加载上下文定义。</p>
<p>DI是组装应用对象的一种方式，借助这种方式对象无需知道依赖来自何处或者依赖的实现方式。不同于自己获取依赖对象，对象会在运行期赋予它们所依赖的对象。依赖对象通常会通过接口了解所注入的对象，这样的话就能确保低耦合。</p>
<h3 id="装配Bean"><a href="#装配Bean" class="headerlink" title="装配Bean"></a>装配Bean</h3><h4 id="Spring-配置的可选方案"><a href="#Spring-配置的可选方案" class="headerlink" title="Spring 配置的可选方案"></a>Spring 配置的可选方案</h4><p>Spring容器负责创建应用程序中的bean并通过DI来协调这些对象之间的关系。但是，作为开发人员，你需要告诉Spring要创建哪些bean并且如何将其装配在一起。</p>
<h3 id="Basic-BeanFactory"><a href="#Basic-BeanFactory" class="headerlink" title="Basic BeanFactory"></a>Basic BeanFactory</h3><p>SRP:单一职责原则</p>
<p><strong>职责：</strong>是引起变化的原因</p>
<ul>
<li>如果有多于一个的动机去改变一个类，这个类就具有多于一个职责</li>
<li>把多个职责耦合在一起，一个变化可能会消弱或者抑制这个类完成其他职责的能力</li>
</ul>
<p><strong>SRP:对于一个类而言，应该仅有一个引起它变化的原因</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Class&lt;?&gt; clz = cl.loadClass(beanClassName);</span><br><span class="line"><span class="keyword">return</span> clz.newInstance();</span><br></pre></td></tr></table></figure>
<p>上面代码能够返回实例的前提是，类有一个缺省的无参构造函数。这样才能用newInstance的方式创建出来。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testGetBean</span><span class="params">()</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    BeanFactory beanFactory = <span class="keyword">new</span> DefaultBeanFactory(<span class="string">"petstore-v1.xml"</span>);</span><br><span class="line"></span><br><span class="line">    BeanDefinition bd = beanFactory.getBeanDefinition(<span class="string">"petStore"</span>);</span><br><span class="line"></span><br><span class="line">    			        assertEquals(<span class="string">"org.litespring.service.test.v1.PetStoreService"</span>,bd.getBeanClassName());</span><br><span class="line"></span><br><span class="line">    PetStoreService petStore =   (PetStoreService)beanFactory.getBean(<span class="string">"petStore"</span>);</span><br><span class="line"></span><br><span class="line">    assertNotNull(petStore);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">new</span> DefaultBeanFactory(<span class="string">"petstore-v1.xml"</span>);</span><br></pre></td></tr></table></figure>
<p>能够返回bean的定义，而bean的定义也是一个接口。</p>
<p>然后从factory中获取bean。</p>
<p>实现类放到support下面，接口放到factory下面。</p>
<p>getBean是返回一个实例。</p>
<p>这里面的代码有太多了try/catch</p>
<p>常见的方法引入Exception，包装一个Exception可以throw出去，让调用方去处理。</p>
<p>现在的文件有两个功能，一个是读取xml文件，生成bean定义，就是getBeanDefinition</p>
<p>一个是生成bean的实例。所以要创建两个exception</p>
<p>RuntimeException是一个unchecked的异常。</p>
<p><img src="https://i.loli.net/2018/08/31/5b890ff0692d6.jpg" alt=""></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">catch</span> (DocumentException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> BeanDefinitionStoreException(<span class="string">"IOException parsing XML document from"</span>+configFile,e);</span><br></pre></td></tr></table></figure>
<p>xml异常</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">        <span class="keyword">if</span> (bd == <span class="keyword">null</span>)&#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> BeanCreationException(<span class="string">"Bean Definition does not exist"</span>);</span><br><span class="line"><span class="comment">//            return null;</span></span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>
<p>bean异常</p>
<p>SRP：单一职责原则</p>
<ul>
<li>职责：是引起变化的原因<ul>
<li>如果有多于一个的动机起改变一个类，这个类就具有多于一个职责</li>
<li>把多个职责耦合在一起，一个的变化可能会消弱或者抑制这个类完成其他职责的能力</li>
</ul>
</li>
<li>SRP：对于一个类而言，应该仅有一个引起它变化的原因。</li>
</ul>
<p><img src="https://i.loli.net/2018/09/03/5b8ce0a3bf779.png" alt=""></p>
<p>这里现在的DefaultBeanFactory具有多于一个 的职责。</p>
<p>现在需要单独 的抽取出来</p>
<p>BeanDefinition是一个内部的概念，不应该暴露给client也不应该放到BeanFactory这个借口上，只让客户看到一个最小集。</p>
<p>创建一个接口出来，专门用于处理BeanDefinition</p>
<p>创建一个reader来读取并解析xml，那么读取来以后怎么把definition告诉factory呢？让BeanDefiniton提供一个方法，registerBeanDefinition.当reader去解析xml文件后，可以去调用register方法，让reader持有一个BeanFactory的实例。但是这样并不好，BeanFactory是给客户使用的，并不希望客户调用register方法。BeanDefinition本质上是一个内部的概念，把一个xml变成一个BeanDefinition，我们拥有它的意义是通过反射去创建一个Bean的实例。所以BeanDefiniton应该是一个内部的概念。</p>
<p><img src="https://i.loli.net/2018/09/03/5b8ce03672ef7.png" alt=""></p>
<p>这样有两个好处，1/xmlBeanDefinitionReader只知道一个知识，我可以去获得和注册BeanDefinition，但是并不知道getBean。这个类知道越少的类越好。接口最小化</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">先修改testCase</span><br></pre></td></tr></table></figure>
<p>XmlBeanDefinitionReader设置单一职责</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">DefaultBeanFactory factory = <span class="keyword">null</span>;</span><br><span class="line">XmlBeanDefinitionReader reader = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Before</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setUp</span><span class="params">()</span></span>&#123;</span><br><span class="line">    factory = <span class="keyword">new</span> DefaultBeanFactory();</span><br><span class="line">    reader = <span class="keyword">new</span> XmlBeanDefinitionReader(factory);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testGetBean</span><span class="params">()</span></span>&#123;</span><br><span class="line">    </span><br><span class="line">    reader.loadBeanDefinitions(<span class="string">"petstore-v1.xml"</span>);</span><br><span class="line"></span><br><span class="line">    PetStoreService petStore =   (PetStoreService)factory.getBean(<span class="string">"petStore"</span>);</span><br><span class="line"></span><br><span class="line">    assertNotNull(petStore);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上面的去除重复的测试用例代码</p>
<p>@Before</p>
<p>每次调用测试用例setUp都会被调用</p>
<p>没运行一个测试用例，reader和factory都会被清空一次。测试用例之间互不影响。</p>
<p>每个测试用例都会调用@Before。factory和reader都是new出来的，各个测试用例之间互不影响。</p>
<h4 id="ApplicationContext"><a href="#ApplicationContext" class="headerlink" title="ApplicationContext"></a>ApplicationContext</h4><p>在spring中，实际工作中很少会用BeanDefinition。而是使用ApplicationContext，封装了Factory和DefinitionReader。后面从ApplicationContext中获取Bean而不用关心底层的实现和处理。</p>
<p>创建一个新的Test。 ApplicationContextTest</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ApplicationContextTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testGetBean</span><span class="params">()</span></span>&#123;</span><br><span class="line">        ApplicationContext ctx = <span class="keyword">new</span> ClassPathXmlApplicationContext(<span class="string">"petstore-v1.xml"</span>);</span><br><span class="line">        PetStoreService petStoreService = (PetStoreService)ctx.getBean(<span class="string">"petStore"</span>);</span><br><span class="line">        Assert.assertNotNull(petStoreService);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ApplicationContext是一个接口。</p>
<p>ClassPathXmlApplicationContext是一个实现，从类路径下寻找文件。</p>
<p>ApplicationContext有一个方法，getBean：从Context中把petStore这个bean取出。但是这个方法已经在BeanFactory中定义过了。因此可以让ApplicationContext去扩展BeanFactory接口，这样ApplicationContext就具有getBean方法了。</p>
<p><img src="https://i.loli.net/2018/07/29/5b5d55783c730.jpg" alt=""></p>
<p>根据上图，把BeanFactory两个关于BeanDefinition的两个方法挪到BeanDefinitionRegistry中。 </p>
<p>ApplicationContext是给客户使用的，继承了BeanFactory，它的实现就是ClassPathXmlApplicationContext</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ClassPathXmlApplicationContext</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ClassPathXmlApplicationContext</span> <span class="keyword">implements</span> <span class="title">ApplicationContext</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> DefaultBeanFactory factory = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ClassPathXmlApplicationContext</span><span class="params">(String conigFile)</span> </span>&#123;</span><br><span class="line">       factory = <span class="keyword">new</span> DefaultBeanFactory();</span><br><span class="line">        XmlBeanDefinitionReader reader = <span class="keyword">new</span> XmlBeanDefinitionReader(factory);</span><br><span class="line">        reader.loadBeanDefinitions(conigFile);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">getBean</span><span class="params">(String beanID)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> factory.getBean(beanID);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>实现了ApplicationContext内部有了一个DefaultBeanFactory的实例。</p>
<p>然后在构造中，new出来reader和factory。</p>
<p>loadBeanDefinitions过程当中，DefaultBeanFactory会不断的调用BeanDefinition的方法registerBeanDefinition。于是这些Defnition就会进入到factory中。</p>
<p>持有所有的实例，就可以通过getBean来获取</p>
<h4 id="filesysytemapplication和ClassPathXmlApplicationContext的共同点—-Resource"><a href="#filesysytemapplication和ClassPathXmlApplicationContext的共同点—-Resource" class="headerlink" title="filesysytemapplication和ClassPathXmlApplicationContext的共同点—-Resource"></a>filesysytemapplication和ClassPathXmlApplicationContext的共同点—-Resource</h4><p>Rresource类图</p>
<p><img src="https://i.loli.net/2018/07/29/5b5d5efbf1eda.png" alt=""></p>
<p>都会变成inputstream送给dom4j去解析</p>
<p>ResourceTest</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ResourceTest</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testClassPathResource</span><span class="params">()</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">        Resource r = <span class="keyword">new</span> ClassPathResource(<span class="string">"petstore-v1.xml"</span>);</span><br><span class="line"></span><br><span class="line">        InputStream is = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            is = r.getInputStream();</span><br><span class="line">            Assert.assertNotNull(is);</span><br><span class="line">        &#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (is != <span class="keyword">null</span>)&#123;</span><br><span class="line">                is.close();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testFileSystemResource</span><span class="params">()</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">        Resource r = <span class="keyword">new</span> FileSystemResource(<span class="string">"/Users/mac/Documents/workspace/litespring/src/test/resources/petstore-v1.xml"</span>);</span><br><span class="line"></span><br><span class="line">        InputStream is = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            is = r.getInputStream();</span><br><span class="line">            Assert.assertNotNull(is);</span><br><span class="line">        &#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (is != <span class="keyword">null</span>)&#123;</span><br><span class="line">                is.close();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ClassPathResource</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ClassPathResource</span> <span class="keyword">implements</span> <span class="title">Resource</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String path;</span><br><span class="line">    <span class="keyword">private</span> ClassLoader classLoader;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ClassPathResource</span><span class="params">(String path)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>(path,(ClassLoader)<span class="keyword">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ClassPathResource</span><span class="params">(String path, ClassLoader classLoader)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.path = path;</span><br><span class="line">        <span class="keyword">this</span>.classLoader =(classLoader !=<span class="keyword">null</span>? classLoader: ClassUtils.getDefaultClassLoader());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> InputStream <span class="title">getInputStream</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        InputStream is = <span class="keyword">this</span>.classLoader.getResourceAsStream(<span class="keyword">this</span>.path);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (is == <span class="keyword">null</span>)&#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> FileNotFoundException(path+<span class="string">"cannot be opened"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> is;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getDescription</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.path;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">FileSystemXmlApplicationContext</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FileSystemXmlApplicationContext</span> <span class="keyword">implements</span> <span class="title">ApplicationContext</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> DefaultBeanFactory factory = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">FileSystemXmlApplicationContext</span><span class="params">(String configFile)</span> </span>&#123;</span><br><span class="line">        factory = <span class="keyword">new</span> DefaultBeanFactory();</span><br><span class="line">        XmlBeanDefinitionReader reader = <span class="keyword">new</span> XmlBeanDefinitionReader(factory);</span><br><span class="line">        Resource resource = <span class="keyword">new</span> FileSystemResource(configFile);</span><br><span class="line">        reader.loadBeanDefinitions(resource);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">getBean</span><span class="params">(String beanID)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> factory.getBean(beanID);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个类与classpath的区别几乎只有Resource的区别。</p>
<p>模版方法</p>
<p><img src="https://i.loli.net/2018/07/29/5b5d717a04950.png" alt=""></p>
<p>抽象出一个新的抽象类，实现了applicationContext的接口</p>
<p> <img src="http://pcq0v117m.bkt.clouddn.com/loaderClass.png" alt=""></p>
<p>这里还是让BeanFactory只保留一个getBean()最小集。把一些不常用的，可配置的相关方法放到一个新的接口当中。</p>
<p>ConfigurableBeanFactory</p>
<h3 id="Setter注入"><a href="#Setter注入" class="headerlink" title="Setter注入"></a>Setter注入</h3><p>新增的PetStoreService</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"petStore"</span> <span class="attr">class</span>=<span class="string">"org.litespring.service.v2.PetStoreService"</span> &gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"accountDao"</span> <span class="attr">ref</span>=<span class="string">"accoutDao"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"itemDao"</span> <span class="attr">ref</span>=<span class="string">"itemDao"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>我们之前用BeanDefinition表达了<bean>标签中的id, class.这些property怎么表达？</bean></p>
<p>ref怎么表达？</p>
<p>value怎么表达？</p>
<p>这里必须要做点抽象，或者说用类来代表这些感念。</p>
<p>两个类：</p>
<ul>
<li>RuntimeBeanReference <ul>
<li><ul>
<li>beanName</li>
<li>getBeanName()</li>
</ul>
</li>
</ul>
</li>
<li>TypedStringValue<ul>
<li><ul>
<li>value</li>
<li>getValue()</li>
</ul>
</li>
</ul>
</li>
</ul>
<h4 id="整体类图"><a href="#整体类图" class="headerlink" title="整体类图"></a>整体类图</h4><p><img src="http://pcq0v117m.bkt.clouddn.com/fullClassMap.jpg" alt=""></p>
<p><strong>XmlBeanDefinitionReader</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">XmlBeanDefinitionReader</span> </span>&#123;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String ID_ATTRIBUTE = <span class="string">"id"</span>;	</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String CLASS_ATTRIBUTE = <span class="string">"class"</span>;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String SCOPE_ATTRIBUTE = <span class="string">"scope"</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String PROPERTY_ELEMENT = <span class="string">"property"</span>;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String REF_ATTRIBUTE = <span class="string">"ref"</span>;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String VALUE_ATTRIBUTE = <span class="string">"value"</span>;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String NAME_ATTRIBUTE = <span class="string">"name"</span>;</span><br><span class="line">	</span><br><span class="line">	BeanDefinitionRegistry registry;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">protected</span> <span class="keyword">final</span> Log logger = LogFactory.getLog(getClass());</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">XmlBeanDefinitionReader</span><span class="params">(BeanDefinitionRegistry registry)</span></span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.registry = registry;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">loadBeanDefinitions</span><span class="params">(Resource resource)</span></span>&#123;</span><br><span class="line">		InputStream is = <span class="keyword">null</span>;</span><br><span class="line">		<span class="keyword">try</span>&#123;			</span><br><span class="line">			is = resource.getInputStream();</span><br><span class="line">			SAXReader reader = <span class="keyword">new</span> SAXReader();</span><br><span class="line">			Document doc = reader.read(is);</span><br><span class="line">			</span><br><span class="line">			Element root = doc.getRootElement(); <span class="comment">//&lt;beans&gt;</span></span><br><span class="line">			Iterator&lt;Element&gt; iter = root.elementIterator();</span><br><span class="line">			<span class="keyword">while</span>(iter.hasNext())&#123;</span><br><span class="line">				Element ele = (Element)iter.next();</span><br><span class="line">				String id = ele.attributeValue(ID_ATTRIBUTE);</span><br><span class="line">				String beanClassName = ele.attributeValue(CLASS_ATTRIBUTE);</span><br><span class="line">				BeanDefinition bd = <span class="keyword">new</span> GenericBeanDefinition(id,beanClassName);</span><br><span class="line">				<span class="keyword">if</span> (ele.attribute(SCOPE_ATTRIBUTE)!=<span class="keyword">null</span>) &#123;					</span><br><span class="line">					bd.setScope(ele.attributeValue(SCOPE_ATTRIBUTE));					</span><br><span class="line">				&#125;</span><br><span class="line">				parsePropertyElement(ele,bd); </span><br><span class="line">				<span class="keyword">this</span>.registry.registerBeanDefinition(id, bd);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125; <span class="keyword">catch</span> (Exception e) &#123;		</span><br><span class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> BeanDefinitionStoreException(<span class="string">"IOException parsing XML document from "</span> + resource.getDescription(),e);</span><br><span class="line">		&#125;<span class="keyword">finally</span>&#123;</span><br><span class="line">			<span class="keyword">if</span>(is != <span class="keyword">null</span>)&#123;</span><br><span class="line">				<span class="keyword">try</span> &#123;</span><br><span class="line">					is.close();</span><br><span class="line">				&#125; <span class="keyword">catch</span> (IOException e) &#123;					</span><br><span class="line">					e.printStackTrace();</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">parsePropertyElement</span><span class="params">(Element beanElem, BeanDefinition bd)</span> </span>&#123;</span><br><span class="line">		Iterator iter= beanElem.elementIterator(PROPERTY_ELEMENT);</span><br><span class="line">		<span class="keyword">while</span>(iter.hasNext())&#123;</span><br><span class="line">			Element propElem = (Element)iter.next();</span><br><span class="line">			String propertyName = propElem.attributeValue(NAME_ATTRIBUTE);</span><br><span class="line">			<span class="keyword">if</span> (!StringUtils.hasLength(propertyName)) &#123;</span><br><span class="line">				logger.fatal(<span class="string">"Tag 'property' must have a 'name' attribute"</span>);</span><br><span class="line">				<span class="keyword">return</span>;</span><br><span class="line">			&#125;</span><br><span class="line">			</span><br><span class="line">			</span><br><span class="line">			Object val = parsePropertyValue(propElem, bd, propertyName);</span><br><span class="line">			PropertyValue pv = <span class="keyword">new</span> PropertyValue(propertyName, val);</span><br><span class="line">			</span><br><span class="line">			bd.getPropertyValues().add(pv);</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> Object <span class="title">parsePropertyValue</span><span class="params">(Element ele, BeanDefinition bd, String propertyName)</span> </span>&#123;</span><br><span class="line">		String elementName = (propertyName != <span class="keyword">null</span>) ?</span><br><span class="line">						<span class="string">"&lt;property&gt; element for property '"</span> + propertyName + <span class="string">"'"</span> :</span><br><span class="line">						<span class="string">"&lt;constructor-arg&gt; element"</span>;</span><br><span class="line"></span><br><span class="line">		</span><br><span class="line">		<span class="keyword">boolean</span> hasRefAttribute = (ele.attribute(REF_ATTRIBUTE)!=<span class="keyword">null</span>);</span><br><span class="line">		<span class="keyword">boolean</span> hasValueAttribute = (ele.attribute(VALUE_ATTRIBUTE) !=<span class="keyword">null</span>);</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">if</span> (hasRefAttribute) &#123;</span><br><span class="line">			String refName = ele.attributeValue(REF_ATTRIBUTE);</span><br><span class="line">			<span class="keyword">if</span> (!StringUtils.hasText(refName)) &#123;</span><br><span class="line">				logger.error(elementName + <span class="string">" contains empty 'ref' attribute"</span>);</span><br><span class="line">			&#125;</span><br><span class="line">			RuntimeBeanReference ref = <span class="keyword">new</span> RuntimeBeanReference(refName);			</span><br><span class="line">			<span class="keyword">return</span> ref;</span><br><span class="line">		&#125;<span class="keyword">else</span> <span class="keyword">if</span> (hasValueAttribute) &#123;</span><br><span class="line">			TypedStringValue valueHolder = <span class="keyword">new</span> TypedStringValue(ele.attributeValue(VALUE_ATTRIBUTE));</span><br><span class="line">			</span><br><span class="line">			<span class="keyword">return</span> valueHolder;</span><br><span class="line">		&#125;		</span><br><span class="line">		<span class="keyword">else</span> &#123;</span><br><span class="line">			</span><br><span class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(elementName + <span class="string">" must specify a ref or value"</span>);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>实际情况中，我们说需要将ref。new出来的。</p>
<p>将一个名称变为实例，</p>
<h4 id="注入bean"><a href="#注入bean" class="headerlink" title="注入bean"></a>注入bean</h4><p>TDD的思路</p>
<ul>
<li><ol>
<li>针对接口写“high level”的测试用例，暂时不用pass，可以保持fail状态<ul>
<li>例如ApplicationContextTestV2</li>
</ul>
</li>
<li>对一些子任务写测试用例<ul>
<li>BeanDefinitionTestV2 ：</li>
<li>BeanDefinitionValueResolverTest ：测试ref和value</li>
</ul>
</li>
<li>把子任务生成的代码，类组合起来，让high level的测试用例pass</li>
</ol>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">populateBean</span><span class="params">(BeanDefinition bd, Object bean)</span></span>&#123;</span><br><span class="line">	List&lt;PropertyValue&gt; pvs = bd.getPropertyValues();</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">if</span> (pvs == <span class="keyword">null</span> || pvs.isEmpty()) &#123;</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	BeanDefinitionValueResolver valueResolver = <span class="keyword">new</span> BeanDefinitionValueResolver(<span class="keyword">this</span>);</span><br><span class="line">	SimpleTypeConverter converter = <span class="keyword">new</span> SimpleTypeConverter(); </span><br><span class="line">	<span class="keyword">try</span>&#123;</span><br><span class="line">		</span><br><span class="line">		BeanInfo beanInfo = Introspector.getBeanInfo(bean.getClass());</span><br><span class="line">		PropertyDescriptor[] pds = beanInfo.getPropertyDescriptors();</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">for</span> (PropertyValue pv : pvs)&#123;</span><br><span class="line">			String propertyName = pv.getName();</span><br><span class="line">			Object originalValue = pv.getValue();</span><br><span class="line">			Object resolvedValue = valueResolver.resolveValueIfNecessary(originalValue);			</span><br><span class="line">			</span><br><span class="line">			<span class="keyword">for</span> (PropertyDescriptor pd : pds) &#123;</span><br><span class="line">				<span class="keyword">if</span>(pd.getName().equals(propertyName))&#123;</span><br><span class="line">					Object convertedValue = converter.convertIfNecessary(resolvedValue, pd.getPropertyType());</span><br><span class="line">					pd.getWriteMethod().invoke(bean, convertedValue);</span><br><span class="line">					<span class="keyword">break</span>;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;<span class="keyword">catch</span>(Exception ex)&#123;</span><br><span class="line">		<span class="keyword">throw</span> <span class="keyword">new</span> BeanCreationException(<span class="string">"Failed to obtain BeanInfo for class ["</span> + bd.getBeanClassName() + <span class="string">"]"</span>, ex);</span><br><span class="line">	&#125;	</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里要实现setter的注入</p>
<p>现在唯一知道的就说它的名称，可以使用javabean使用的功能。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">BeanInfo beanInfo = Introspector.getBeanInfo(bean.getClass());</span><br><span class="line">PropertyDescriptor[] pds = beanInfo.getPropertyDescriptors();</span><br><span class="line"><span class="keyword">for</span>(PropertyDescriptor pd : pds)&#123;</span><br><span class="line">             <span class="keyword">if</span>(pd.getName().equals(proertyName))&#123;</span><br><span class="line">                 pd.getWriteMethod().invoke(bean,resolvedValue);</span><br><span class="line">                 <span class="keyword">break</span>;</span><br><span class="line">             &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>代码中的bean就是petStoreService</p>
<p>Introspector可以拿到bean的info也就是拿到petStoreService的相关信息。</p>
<p>然后调用getPropertyDescriptors（）属性的描述器</p>
<p>proertyName就相当于bean的名称。</p>
<p>如果相等就认为找到了这个属性，就调用它的getWriteMethod其实就是它的get和set方法。 </p>
<p>通过反射的方式，bean是对象本身，resolvedValue就是AccountDao</p>
<p>下一个循环就可能是把itemDao也set进去。</p>
<p>此时再运行测试用例</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testGetBeanProperty</span><span class="params">()</span></span>&#123;</span><br><span class="line">    ApplicationContext ctx = <span class="keyword">new</span> ClassPathXmlApplicationContext(<span class="string">"petstore-v2.xml"</span>);</span><br><span class="line">    PetStoreService petStore = (PetStoreService)ctx.getBean(<span class="string">"petStore"</span>);</span><br><span class="line"></span><br><span class="line">    assertNotNull(petStore.getAccountDao());</span><br><span class="line">    assertNotNull(petStore.getItemDao());</span><br><span class="line">    </span><br><span class="line">    assertTrue(petStore.getAccountDao() <span class="keyword">instanceof</span> AccountDao);</span><br><span class="line">    assertTrue(petStore.getItemDao() <span class="keyword">instanceof</span> ItemDao);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>不报错就证明已经注入进去了。</p>
<p>那么此时我们测试了是一个ref的属性。</p>
<h4 id="注入value"><a href="#注入value" class="headerlink" title="注入value"></a>注入value</h4><p>现在将</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"owner"</span> <span class="attr">value</span>=<span class="string">"liuxin"</span>/&gt;</span></span><br></pre></td></tr></table></figure>
<p>加入到PetStoreService中以及它的getter和setter方法。</p>
<p>此时再增加一个int类型的</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;property name=&quot;version&quot;  value=&quot;2&quot;/&gt;</span><br></pre></td></tr></table></figure>
<p>此时再运行测试用例就会失败</p>
<p>我们在xml文件当中没有类型只有字符串。所在setVersion的时候就会报错，因为不是int类型的。</p>
<p>所以一定要根据类型去转换。</p>
<p>目标：做转换</p>
<h4 id="实现类型转换"><a href="#实现类型转换" class="headerlink" title="实现类型转换"></a>实现类型转换</h4><p><img src="http://pcq0v117m.bkt.clouddn.com/Spring%E7%B1%BB%E5%9E%8B%E8%BD%AC%E6%8D%A2%E8%AE%BE%E8%AE%A1%E5%9B%BE.jpg" alt="">    </p>
<p>上图是Spring做类型转换的设计图</p>
<p>创建一个想做类型转换的接口，它只有一个方法。</p>
<p>convertIfNessessary如果有必要的话就进行一个转换，两个参数，一个是2一个是类型</p>
<p>传递给这个方法后，这个方法会返回一个整型的值</p>
<p>它的实现是SimpleTypeConverter利用了java的beans</p>
<p>想实现这个功能，先实现小功能，依次通过测试用例来实现</p>
<p>先写一个测试类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CustomNumberEditorTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Test</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testConvertString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">//true 代表是否允许为null</span></span><br><span class="line">		CustomNumberEditor editor = <span class="keyword">new</span> CustomNumberEditor(Integer.class,<span class="keyword">true</span>);</span><br><span class="line">		</span><br><span class="line">		editor.setAsText(<span class="string">"3"</span>);</span><br><span class="line">		Object value = editor.getValue();</span><br><span class="line">		Assert.assertTrue(value <span class="keyword">instanceof</span> Integer);		</span><br><span class="line">		Assert.assertEquals(<span class="number">3</span>, ((Integer)editor.getValue()).intValue());</span><br><span class="line">		</span><br><span class="line">		</span><br><span class="line">		editor.setAsText(<span class="string">""</span>);</span><br><span class="line">		Assert.assertTrue(editor.getValue() == <span class="keyword">null</span>);</span><br><span class="line">		</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">try</span>&#123;</span><br><span class="line">			editor.setAsText(<span class="string">"3.1"</span>);</span><br><span class="line">			</span><br><span class="line">		&#125;<span class="keyword">catch</span>(IllegalArgumentException e)&#123;</span><br><span class="line">			<span class="keyword">return</span> ;</span><br><span class="line">		&#125;</span><br><span class="line">		Assert.fail();		</span><br><span class="line">		</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Setter注入的回顾</p>
<ul>
<li>1.引入新的概念PropertyValue<ul>
<li>RuntimeBeanReference</li>
<li>TypedStringValue</li>
</ul>
</li>
<li>2.用BeanDefinitionResolver去resolve</li>
<li>3.使用TypeConverter去把字符的值进行转型</li>
</ul>
<h4 id="课后答疑"><a href="#课后答疑" class="headerlink" title="课后答疑"></a>课后答疑</h4><p>我们用BeanDefinition表达<bean>标签中的id，class</bean></p>
<p>那么property ref value怎么表达</p>
<p>ref如恶化保证从factory中获取的时候已经是一个bean</p>
<h3 id="使用构造器注入"><a href="#使用构造器注入" class="headerlink" title="使用构造器注入"></a>使用构造器注入</h3><h4 id="解析xml"><a href="#解析xml" class="headerlink" title="解析xml"></a>解析xml</h4><p><strong>xml文件</strong></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">"http://www.springframework.org/schema/beans"</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://www.springframework.org/schema/beans</span></span></span><br><span class="line"><span class="tag"><span class="string">           http://www.springframework.org/schema/beans/spring-beans.xsd"</span>&gt;</span></span><br><span class="line">	</span><br><span class="line">  <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"petStore"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">class</span>=<span class="string">"org.litespring.service.v3.PetStoreService"</span> &gt;</span>  </span><br><span class="line">   	<span class="tag">&lt;<span class="name">constructor-arg</span>  <span class="attr">ref</span>=<span class="string">"accountDao"</span>/&gt;</span></span><br><span class="line">   	<span class="tag">&lt;<span class="name">constructor-arg</span>  <span class="attr">ref</span>=<span class="string">"itemDao"</span>/&gt;</span></span><br><span class="line">   	<span class="tag">&lt;<span class="name">constructor-arg</span>  <span class="attr">value</span>=<span class="string">"1"</span>/&gt;</span>       </span><br><span class="line">  <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"></span><br><span class="line">   <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"itemDao"</span> <span class="attr">class</span>=<span class="string">"org.litespring.dao.v3.ItemDao"</span>&gt;</span></span><br><span class="line">   </span><br><span class="line">  <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"accountDao"</span>  <span class="attr">class</span>=<span class="string">"org.litespring.dao.v3.AccountDao"</span>&gt;</span></span><br><span class="line">   </span><br><span class="line">  <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>在实现层面肯定要去解析xml才可以。假设，在解析它们的时候，解析完需要用一个类来表达这些构造器的参数。</p>
<p>所以仍然要做一个设计，请先查看类图。</p>
<p><img src="http://pcq0v117m.bkt.clouddn.com/Contstructor-arg.png" alt=""></p>
<p>会新增加一个类ConstructorArgument</p>
<p>里面会有一个list，list里面的ValueHolder是ref或value</p>
<p>那么为什么不能将List<valueholder>中的 ValueHolder换成Object呢？</valueholder></p>
<p>其实Spring中支持的Constructor-arg是比较复杂的</p>
<p><img src="http://pcq0v117m.bkt.clouddn.com/Spring%E6%94%AF%E6%8C%81%E7%9A%84constructor%E7%B1%BB%E5%9E%8B.png" alt=""></p>
<p>type指定类型</p>
<p>name表示注入到参数名称是years中，指定参数名称。</p>
<p>index指定参数顺序。</p>
<p>因此我们这里简化了，这里只用value</p>
<p>在ConstructorArgument中有一个静态的</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">public static class ValueHolder</span><br></pre></td></tr></table></figure>
<p>静态内部类，因为它只在ConstructorArgument中使用，只用来描述一个构造函数的参数，高内聚。</p>
<p>这里我们只用了value</p>
<h4 id="和setter做对比"><a href="#和setter做对比" class="headerlink" title="和setter做对比"></a>和setter做对比</h4><ul>
<li>和setter注入做对比<ul>
<li>设计一个数据结构PropertyValue/ConstructorArgument</li>
<li>解析XML，填充这个数据结构</li>
<li>利用这个数据结构做事情</li>
</ul>
</li>
</ul>
<h4 id="实现构造器注入"><a href="#实现构造器注入" class="headerlink" title="实现构造器注入"></a>实现构造器注入</h4><p>如果一个类有多个构造函数，那么怎么选取</p>
<p><img src="http://pcq0v117m.bkt.clouddn.com/%E9%80%89%E5%8F%96%E6%9E%84%E9%80%A0%E5%87%BD%E6%95%B0.png" alt=""></p>
<p>找到参数合适的之后也要匹配参数对象类型是否一致，能不能对这个类型做赋值或转型操作。</p>
<p>设计一个类来解决这个问题。</p>
<p><img src="http://pcq0v117m.bkt.clouddn.com/%E7%B1%BB%E5%9E%8B%E8%BD%AC%E6%8D%A2Construstor.png" alt=""></p>
<p>可以把一个ref变成一个实际的类型对象出来。</p>
<p>通过find来找到这个对象，然后通过autowire来创建对象。在创建对象的过程当中就会把三个参数的值注入到对象中去了。这个就是ConstructorResolver的作用。</p>
<p>BeanDefinition可以获取ConstructorArgument</p>
<p>ConstructorResolver</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br></pre></td><td class="code"><pre><span class="line">ublic <span class="class"><span class="keyword">class</span> <span class="title">ConstructorResolver</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">protected</span> <span class="keyword">final</span> Log logger = LogFactory.getLog(getClass());</span><br><span class="line">	</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> ConfigurableBeanFactory beanFactory;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">ConstructorResolver</span><span class="params">(ConfigurableBeanFactory beanFactory)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.beanFactory = beanFactory;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> Object <span class="title">autowireConstructor</span><span class="params">(<span class="keyword">final</span> BeanDefinition bd)</span> </span>&#123;</span><br><span class="line">		</span><br><span class="line">		Constructor&lt;?&gt; constructorToUse = <span class="keyword">null</span>;		<span class="comment">//找到一个可以用的Constructor</span></span><br><span class="line">		Object[] argsToUse = <span class="keyword">null</span>;	<span class="comment">//PetStoreService需要有参数，这里用Objcet来记录</span></span><br><span class="line">	</span><br><span class="line">		Class&lt;?&gt; beanClass = <span class="keyword">null</span>; <span class="comment">//通过BeanFactory来获取，每次进来都装载</span></span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			beanClass = <span class="keyword">this</span>.beanFactory.getBeanClassLoader().loadClass(bd.getBeanClassName());</span><br><span class="line">			</span><br><span class="line">		&#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</span><br><span class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> BeanCreationException( bd.getID(), <span class="string">"Instantiation of bean failed, can't resolve class"</span>, e);</span><br><span class="line">		&#125;	</span><br><span class="line">		</span><br><span class="line">		</span><br><span class="line">		Constructor&lt;?&gt;[] candidates = beanClass.getConstructors();	<span class="comment">//反射方法</span></span><br><span class="line">		</span><br><span class="line">		</span><br><span class="line">		BeanDefinitionValueResolver valueResolver =</span><br><span class="line">				<span class="keyword">new</span> BeanDefinitionValueResolver(<span class="keyword">this</span>.beanFactory);</span><br><span class="line">		</span><br><span class="line">		ConstructorArgument cargs = bd.getConstructorArgument();</span><br><span class="line">        </span><br><span class="line">		SimpleTypeConverter typeConverter = <span class="keyword">new</span> SimpleTypeConverter();</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;candidates.length;i++)&#123;</span><br><span class="line">			</span><br><span class="line">			Class&lt;?&gt; [] parameterTypes = candidates[i].getParameterTypes();<span class="comment">//拿到两个参数</span></span><br><span class="line">			<span class="keyword">if</span>(parameterTypes.length != cargs.getArgumentCount())&#123;<span class="comment">//是否和xml中的数量相等</span></span><br><span class="line">				<span class="keyword">continue</span>; <span class="comment">//不管用，找第二个构造函数的循环</span></span><br><span class="line">			&#125;			</span><br><span class="line">			argsToUse = <span class="keyword">new</span> Object[parameterTypes.length]; </span><br><span class="line">			</span><br><span class="line">			<span class="keyword">boolean</span> result = <span class="keyword">this</span>.valuesMatchTypes(parameterTypes,  <span class="comment">//值是否和ref匹配</span></span><br><span class="line">					cargs.getArgumentValues(), </span><br><span class="line">					argsToUse, </span><br><span class="line">					valueResolver, </span><br><span class="line">					typeConverter);</span><br><span class="line">			</span><br><span class="line">			<span class="keyword">if</span>(result)&#123;</span><br><span class="line">				constructorToUse = candidates[i];<span class="comment">//如果匹配成功，这个候选的构造函数就是我们要的</span></span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			&#125;</span><br><span class="line">			</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">		</span><br><span class="line">		<span class="comment">//找不到一个合适的构造函数</span></span><br><span class="line">		<span class="keyword">if</span>(constructorToUse == <span class="keyword">null</span>)&#123;</span><br><span class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> BeanCreationException( bd.getID(), <span class="string">"can't find a apporiate constructor"</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> constructorToUse.newInstance(argsToUse); <span class="comment">//传递对象</span></span><br><span class="line">		&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> BeanCreationException( bd.getID(), <span class="string">"can't find a create instance using "</span>+constructorToUse);</span><br><span class="line">		&#125;		</span><br><span class="line">		</span><br><span class="line">		</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">valuesMatchTypes</span><span class="params">(Class&lt;?&gt; [] parameterTypes,</span></span></span><br><span class="line"><span class="function"><span class="params">			List&lt;ConstructorArgument.ValueHolder&gt; valueHolders,</span></span></span><br><span class="line"><span class="function"><span class="params">			Object[] argsToUse,</span></span></span><br><span class="line"><span class="function"><span class="params">			BeanDefinitionValueResolver valueResolver,</span></span></span><br><span class="line"><span class="function"><span class="params">			SimpleTypeConverter typeConverter )</span></span>&#123;</span><br><span class="line">		</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;parameterTypes.length;i++)&#123;</span><br><span class="line">			ConstructorArgument.ValueHolder valueHolder </span><br><span class="line">				= valueHolders.get(i);</span><br><span class="line">			<span class="comment">//获取参数的值，可能是TypedStringValue, 也可能是RuntimeBeanReference</span></span><br><span class="line">			Object originalValue = valueHolder.getValue();</span><br><span class="line">			</span><br><span class="line">			<span class="keyword">try</span>&#123;</span><br><span class="line">				<span class="comment">//获得真正的值</span></span><br><span class="line">				Object resolvedValue = valueResolver.resolveValueIfNecessary( originalValue);</span><br><span class="line">				<span class="comment">//如果参数类型是 int, 但是值是字符串,例如"3",还需要转型</span></span><br><span class="line">				<span class="comment">//如果转型失败，则抛出异常。说明这个构造函数不可用</span></span><br><span class="line">				Object convertedValue = typeConverter.convertIfNecessary(resolvedValue, parameterTypes[i]);</span><br><span class="line">				<span class="comment">//转型成功，记录下来</span></span><br><span class="line">				argsToUse[i] = convertedValue;</span><br><span class="line">			&#125;<span class="keyword">catch</span>(Exception e)&#123;</span><br><span class="line">				logger.error(e);</span><br><span class="line">				<span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">			&#125;				</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Commons-BeanUtils"><a href="#Commons-BeanUtils" class="headerlink" title="Commons-BeanUtils"></a>Commons-BeanUtils</h3>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/09/10/hello-world/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Bill">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/09/10/hello-world/" itemprop="url">Hello World</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-09-10T16:30:00+08:00">
                2018-09-10
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>Welcome to <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a>! This is your very first post. Check <a href="https://hexo.io/docs/" target="_blank" rel="noopener">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a href="https://hexo.io/docs/troubleshooting.html" target="_blank" rel="noopener">troubleshooting</a> or you can ask me on <a href="https://github.com/hexojs/hexo/issues" target="_blank" rel="noopener">GitHub</a>.</p>
<h2 id="Quick-Start"><a href="#Quick-Start" class="headerlink" title="Quick Start"></a>Quick Start</h2><h3 id="Create-a-new-post"><a href="#Create-a-new-post" class="headerlink" title="Create a new post"></a>Create a new post</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo new <span class="string">"My New Post"</span></span><br></pre></td></tr></table></figure>
<p>More info: <a href="https://hexo.io/docs/writing.html" target="_blank" rel="noopener">Writing</a></p>
<h3 id="Run-server"><a href="#Run-server" class="headerlink" title="Run server"></a>Run server</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo server</span><br></pre></td></tr></table></figure>
<p>More info: <a href="https://hexo.io/docs/server.html" target="_blank" rel="noopener">Server</a></p>
<h3 id="Generate-static-files"><a href="#Generate-static-files" class="headerlink" title="Generate static files"></a>Generate static files</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo generate</span><br></pre></td></tr></table></figure>
<p>More info: <a href="https://hexo.io/docs/generating.html" target="_blank" rel="noopener">Generating</a></p>
<h3 id="Deploy-to-remote-sites"><a href="#Deploy-to-remote-sites" class="headerlink" title="Deploy to remote sites"></a>Deploy to remote sites</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo deploy</span><br></pre></td></tr></table></figure>
<p>More info: <a href="https://hexo.io/docs/deployment.html" target="_blank" rel="noopener">Deployment</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/09/10/数据类型问题/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Bill">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/09/10/数据类型问题/" itemprop="url">数据类型相关</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-09-10T16:30:00+08:00">
                2018-09-10
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/数据结构/" itemprop="url" rel="index">
                    <span itemprop="name">数据结构</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="基本数据类型"><a href="#基本数据类型" class="headerlink" title="基本数据类型"></a>基本数据类型</h2><hr>
<h3 id="long类型："><a href="#long类型：" class="headerlink" title="long类型："></a>long类型：</h3><p>（1）例子：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">public class Test &#123;</span><br><span class="line">    public static void main(String[] args) &#123;</span><br><span class="line">        long l1=1000*60*60*24*365*10L;</span><br><span class="line">        long l2=1000*60*60*24*3650L;</span><br><span class="line">        System.out.println(l1);</span><br><span class="line">        System.out.println(l2);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">System.out:</span><br><span class="line">14712289280</span><br><span class="line">315360000000</span><br></pre></td></tr></table></figure></p>
<p>两次输出不一致。原因：在运算的时候是按照int类型计算的，只有当与带L的数运算的时候才开始按Long运算。<br>所以这里可以尽量把L数据类型提前到int类型异常之前。</p>
<hr>
<h3 id="String类型"><a href="#String类型" class="headerlink" title="String类型"></a>String类型</h3><p>String s1=”dfd”; 相当于在堆内存的常量池中创建了一个对象。<br>如果再有<br>String s2=”dfd”; 就会先检查常量池中是否有这个值，如果有就不会再创建，而是把值给s2;<br>new String（”dfd”）； 就是在内存中<br>==比较的是内存地址。<br>所以在比较内容的时候最好使用equals</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/09/10/Spring/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Bill">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/09/10/Spring/" itemprop="url">未命名</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-09-10T16:30:00+08:00">
                2018-09-10
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>Spring</p>
<h3 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h3><p>耦合具有两面性。一方面，紧密耦合的代码难以测试，难以复用、难以理解，并且典型地表现出“打地鼠”式的bug特性。另一方面，一定程度的耦合又是必须的—完全没有耦合的代码什么都做不了。为了完成有意义的功能，不同的类必须适当的进行交互。总而言之，耦合是必须的，但应当被小心谨慎地管理。</p>
<p>创建应用组件之间协作的行为通常称为装配（wiring）。Spring有多种装配bean的方式，采用xml是很常见的一种装配行为。</p>
<h4 id="观察它如何工作"><a href="#观察它如何工作" class="headerlink" title="观察它如何工作"></a>观察它如何工作</h4><p>Spring通过应用上下文(Application Context)装载bean的定义并把它们组装起来。Spring应用上下文全权负责对象的创建和组装。Spring自带了多种应用上下文的实现，它们之间主要的区别仅仅在于如何配置。</p>
<p>ClassPathXmlApplicationContext    该类加载位于应用程序类路径下的一个或多个XML配置文件。</p>
<h4 id="容纳你的Bean"><a href="#容纳你的Bean" class="headerlink" title="容纳你的Bean"></a>容纳你的Bean</h4><p>在基于Spring的应用中，你的应用对象生存于Spring容器(container)中。Spring容器负责创建对象，装配它们，配置它们并管理它们的整个生命周期，从生存到死亡(在这里，可能就是new 到 finalize())。</p>
<p>首先了解容纳对象的容器，有助于理解对象是如何被管理的。</p>
<p>容器上Spring容器的核心。Spring容器使用DI管理构成应用的组建，它会创建相互协作的组件之间的关联。</p>
<p>Spring容器并不是只有一个。Spring自带了多个容器实现，可以归为两种不同的类型。bean工厂上最简单的容器，提供基本的DI支持。应用上下文基于BeanFactory构建，并提供应用框架级别的服务，例如从属性文件解析文本信息以及发布应用事件给感兴趣的事件监听者。</p>
<p>虽然我们可以在bean工厂和应用上下文之间任选一种。但bean工厂对大多数应用来说太低级了，因此，应用上下文要比bean工厂更受欢迎。我们把精力集中在应用上下文上，不再浪费时间讨论bean工厂。</p>
<h5 id="使用应用上下文"><a href="#使用应用上下文" class="headerlink" title="使用应用上下文"></a>使用应用上下文</h5><p>常用的几个应用上下文</p>
<p>AnnotationConfigApplicationContext：从一个或多个基于Java的配置类中加载Spring应用上下文。</p>
<p>ClassPathXmlApplicationContext：从类路径下的一个或多个XML配置文件中加载上下文定义，把应用上下文的定义文件作为类资源。</p>
<p>FileSystemXmlApplicationContext：从文件系统下的一个或多个XML配置文件中加载上下文定义。</p>
<p>DI是组装应用对象的一种方式，借助这种方式对象无需知道依赖来自何处或者依赖的实现方式。不同于自己获取依赖对象，对象会在运行期赋予它们所依赖的对象。依赖对象通常会通过接口了解所注入的对象，这样的话就能确保低耦合。</p>
<h3 id="装配Bean"><a href="#装配Bean" class="headerlink" title="装配Bean"></a>装配Bean</h3><h4 id="Spring-配置的可选方案"><a href="#Spring-配置的可选方案" class="headerlink" title="Spring 配置的可选方案"></a>Spring 配置的可选方案</h4><p>Spring容器负责创建应用程序中的bean并通过DI来协调这些对象之间的关系。但是，作为开发人员，你需要告诉Spring要创建哪些bean并且如何将其装配在一起。</p>
<p>当描述bean如何进行装配时，Spring具有非常大的灵活性，它提供了三种主要的装配机制：</p>
<ul>
<li>在XML中进行显式配置</li>
<li>在Java中进行显示配置</li>
<li>隐式的bean发现机制和自动装配</li>
</ul>
<h4 id="自动装配bean"><a href="#自动装配bean" class="headerlink" title="自动装配bean"></a>自动装配bean</h4><p>Spring从两个角度来实现自动化装配：</p>
<ul>
<li>组件扫描(component scanning)：Spring 会自动发现应用上下文中所创建的bean。</li>
<li>自动装配(autowiring)：Spring 自动满足bean之间的依赖。</li>
</ul>
<p>组件扫描和自动装配组合在一起就能发挥出强大的威力，它们能够将你的显示配置降低到最少。</p>
<h5 id="创建可被发现的bean"><a href="#创建可被发现的bean" class="headerlink" title="创建可被发现的bean"></a>创建可被发现的bean</h5><p>CD为我们阐述DI如何运行提供了一个很好的样例。如果你不将CD插入(注入)到CD播放器中，那么CD播放器其实是没有太大的用处的。所以，可以这样说，CD播放器依赖于CD才能完成它的使命。</p>
<p>使用</p>
<p>@Component 注解：这个简单的注解表明该类会作为组件类，并告知Spring要为这个类创建bean。</p>
<p>不过组件扫描默认是不开启的。需要显示配置一下Spring，从而命令它去寻找带有@Component注解的类，并为其创建bean。</p>
<p>@Configuration</p>
<p>@ComponentScan：这个注解能够在Spring中启用组件扫描。默认会扫描与配置类相同的包。会扫描这个包以及这个包下的所有子包，查找带有@Component注解的类。</p>
<p>XML方式</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;context:component-scan base-<span class="keyword">package</span>=<span class="string">"soundsystem"</span>/&gt;</span><br></pre></td></tr></table></figure>
<h3 id="高级装配"><a href="#高级装配" class="headerlink" title="高级装配"></a>高级装配</h3><h4 id="3-5-运行时值注入"><a href="#3-5-运行时值注入" class="headerlink" title="3.5 运行时值注入"></a>3.5 运行时值注入</h4><p>当我们讨论依赖注入的时候，我们通常所讨论的是将一个bean引用注入到另一个bean的属性或构造器参数中。它通常来讲指的是将一个对象与另一个对象进行关联。</p>
<p>但是bean装配的另外一个方面指的是将一个值注入到bean的属性或者构造器参数中。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/09/10/Shiro/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Bill">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/09/10/Shiro/" itemprop="url">Shiro简介</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-09-10T16:30:00+08:00">
                2018-09-10
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/框架/" itemprop="url" rel="index">
                    <span itemprop="name">框架</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="Shiro简介"><a href="#Shiro简介" class="headerlink" title="Shiro简介"></a>Shiro简介</h3><ol>
<li>Apache Shiro 是 Java 的一个安全框架。可以帮助我们完成：认证、授权、加密、会话管理、与Web集成、缓存等。</li>
</ol>
<p>基本功能点如下图：</p>
<p><img src="http://dl2.iteye.com/upload/attachment/0093/9788/d59f6d02-1f45-3285-8983-4ea5f18111d5.png" alt=""></p>
<p>Authentication：身份认证/登录，验证用户是不是拥有相应的身份;</p>
<p>Authorization：授权，即权限验证，验证某个已认证的用户是否拥有某个权限；即判断用户是否能做事情，常见的如：验证某个用户是否拥有某个角色。或者细粒度的验证某个用户对某个资源是否具有某个权限；</p>
<p>Session Manager：会话管理，即用户登录后就是一次会话，在没有退出之前，它的所有信息都在会话中；会话可以是普通JavaSE环境的，也可以是如Web环境的；</p>
<p>Cryptography：加密，保护数据的安全性，如密码加密存储到数据库，而不是明文存储；</p>
<p>Web Support：Web支持，可以非常容易的集成到Web环境；</p>
<p>Caching：缓存，比如用户登录后，其用户信息、拥有的角色/权限不必每次去查，这样可以提高效率；</p>
<p>Concurrency：shiro支持多线程应用的并发验证，即如在一个线程中开启另一个线程，能把权限自动传播过去；</p>
<p>Testing：提供测试支持；</p>
<p>Run As：允许一个用户假装为另一个用户（如果他们允许）的身份进行访问；</p>
<p>Remember Me：记住我，这个是非常常见的功能，即一次登录后，下次再来的话不用登录了。</p>
<p>记住一点，Shiro不会去维护用户、维护权限；这些需要我们自己去设计/提供；然后通过相应的接口注入给Shiro即可。</p>
<p>对于一个好框架，从内部看来应该具有非常简单易于使用的API，且API契约明确；从内部来看的话，其应该有一个可扩展的框架，即非常容易插入用户自定义实现，因为任何框架都不能满足所有需求。</p>
<p>首先，我们从外部来看Shiro吧，即从应用程序角度的来观察如何使用Shiro完成工作。如下图：</p>
<p><img src="http://dl2.iteye.com/upload/attachment/0093/9788/d59f6d02-1f45-3285-8983-4ea5f18111d5.png" alt=""></p>
<p>可以看到：应用代码直接交互的对象是Subject，也就是说Shiro的对外API核心就是Subject；其每个API的含义：</p>
<p>Subject：主体，代表了当前“用户”，这个用户不一定是一个具体的人，与当前应用交互的任何东西都是Subject，如网络爬虫，机器人等；即一个抽象概念；所有Subject都绑定到SecurityManager，与Subject的所有交互都会委托给SecurityManager；可以把Subject认为是一个门面；SecurityManager才是实际的执行者；</p>
<p>SecurityManager：安全管理器；即所有与安全有关的操作都会与SecurityManager交互；且它管理着所有Subject；可以看出它是Shiro的核心，它负责与后边介绍的其他组件进行交互，如果学习过SpringMVC，你可以把它看成DispatcherServlet前端控制器；</p>
<p>Realm：域，Shiro从从Realm获取安全数据（如用户、角色、权限），就是说SecurityManager要验证用户身份，那么它需要从Realm获取相应的用户进行比较以确定用户身份是否合法；也需要从Realm得到用户相应的角色/权限进行验证用户是否能进行操作；可以把Realm看成DataSource，即安全数据源。</p>
<p>从这个意义上来说，Realm本质上是一个安全特定的DAO：它封装数据源的连接细节，并根据需要将相关数据提供给Shiro。配置Shiro时，您必须至少指定一个Realm用于认证和/或授权。SecurityManager可能配置了多个领域，但至少需要一个。</p>
<p>Shiro提供开箱即用的Realm连接到许多安全数据源（又名目录），如LDAP，关系数据库（JDBC），文本配置源（如INI和属性文件等）。</p>
<p>也就是说对于我们而言，最简单的一个Shiro应用：</p>
<p>1、应用代码通过Subject来进行认证和授权，而Subject又委托给SecurityManager；</p>
<p>2、我们需要给Shiro的SecurityManager注入Realm，从而让SecurityManager能得到合法的用户及其权限进行判断。</p>
<p><strong>从以上也可以看出，Shiro不提供维护用户/权限，而是通过Realm让开发人员自己注入。</strong></p>
<p> 接下来我们来从Shiro内部来看下Shiro的架构，如下图所示：</p>
<p><img src="http://dl2.iteye.com/upload/attachment/0093/9792/9b959a65-799d-396e-b5f5-b4fcfe88f53c.png" alt=""></p>
<p>Subject:主体，可以看到主体可以是任何可以与应用交互的”用户”；记录了当前操作的用户信息，我们对这个Subject进行认证和授权。</p>
<p>SecurityManager：相当于SpringMVC中的DispatcherServlet或者Struts2中的FilterDispatcher；是Shiro的心脏；所有具体的交互都通过SecurityManager进行控制；它管理着所有Subject、且负责进行认证和授权、及会话、缓存的管理。</p>
<p>Authenticator：认证器，负责主体认证的，这是一个扩展点，如果用户觉得Shiro默认的不好，可以自定义实现；其需要认证策略（Authentication Strategy），即什么情况下算用户认证通过了。用户用户登录认证的，主题的认证是否通过都是有authenticator来做的。</p>
<p>Authrizer：授权器，或者访问控制器，用来决定主体是否有权限进行相应的操作；即控制着用户能访问应用中的哪些功能；</p>
<p>Realm：可以有1个或多个Realm，可以认为是安全实体数据源，即用于获取安全实体的；可以是JDBC实现，也可以是LDAP实现，或者内存实现等等；由用户提供；注意：Shiro不知道你的用户/权限存储在哪及以何种格式存储；所以我们一般在应用中都需要实现自己的Realm；</p>
<p>SessionManager：如果写过Servlet就应该知道Session的概念，Session呢需要有人去管理它的生命周期，这个组件就是SessionManager；而Shiro并不仅仅可以用在Web环境，也可以用在如普通的JavaSE环境、EJB等环境；所有呢，Shiro就抽象了一个自己的Session来管理主体与应用之间交互的数据；这样的话，比如我们在Web环境用，刚开始是一台Web服务器；接着又上了台EJB服务器；这时想把两台服务器的会话数据放到一个地方，这个时候就可以实现自己的分布式会话（如把数据放到Memcached服务器）；</p>
<p>SessionDAO：DAO大家都用过，数据访问对象，用于会话的CRUD，比如我们想把Session保存到数据库，那么可以实现自己的SessionDAO，通过如JDBC写到数据库；比如想把Session放到Memcached中，可以实现自己的Memcached SessionDAO；另外SessionDAO中可以使用Cache进行缓存，以提高性能；通一管理session，不论分布式还是单应用都帮你做好了，比如对session的塞入一个用户和删除一个用户，而这个是用的redis这样的缓存的话就用sessionDAO。</p>
<p>CacheManager：缓存控制器，来管理如用户、角色、权限等的缓存的；因为这些数据基本上很少去改变，放到缓存中后可以提高访问的性能。</p>
<p>Cryptography：密码模块，Shiro提高了一些常见的加密组件用于如密码加密/解密的。</p>
<h3 id="身份验证"><a href="#身份验证" class="headerlink" title="身份验证"></a>身份验证</h3><h4 id="配置文件模拟Shiro简单认证流程"><a href="#配置文件模拟Shiro简单认证流程" class="headerlink" title="配置文件模拟Shiro简单认证流程"></a>配置文件模拟Shiro简单认证流程</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ShiroLoginTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testSubjectLoginAndLogout</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">//使用工厂模式创建一个工厂类，并且加载ini配置文件，配置文件中包含了用户主体的登录信息</span></span><br><span class="line">        Factory&lt;SecurityManager&gt; factory = <span class="keyword">new</span> IniSecurityManagerFactory(<span class="string">"classpath:shiro-config/userInfo.ini"</span>);</span><br><span class="line">        <span class="comment">//创建安全管理器</span></span><br><span class="line">        SecurityManager securityManager = factory.getInstance();</span><br><span class="line">        <span class="comment">//设置当前的环境，使用securityManager</span></span><br><span class="line">        SecurityUtils.setSecurityManager(securityManager);</span><br><span class="line">        <span class="comment">//从当前环境中获取主体</span></span><br><span class="line">        Subject subject = SecurityUtils.getSubject();</span><br><span class="line">        UsernamePasswordToken token = <span class="keyword">new</span> UsernamePasswordToken(<span class="string">"jack"</span>,<span class="string">"123456"</span>);</span><br><span class="line"></span><br><span class="line">        subject.login(token);</span><br><span class="line">        <span class="comment">//判斷用戶是否登录</span></span><br><span class="line">        <span class="keyword">boolean</span> isLogin = subject.isAuthenticated();</span><br><span class="line">        System.out.println(<span class="string">"用户的登录状态是："</span>+isLogin);</span><br><span class="line">        subject.logout();</span><br><span class="line">        isLogin = subject.isAuthenticated();</span><br><span class="line">        System.out.println();</span><br><span class="line">        System.out.println(<span class="string">"用户的登录状态是："</span>+isLogin);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">new</span> ShiroLoginTest().testSubjectLoginAndLogout();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个例子是通过工厂类来加载ini文件，然后通过subject进行匹配来验证是否有权限的。</p>
<ol>
<li>首先通过new IniSecurityManagerFactory 并指定一个ini配置文件创建一个SecurityManger工厂；</li>
<li>接着获取SecurityMnager并绑定到SecurityUtils，这是一个全局的设置，设置一次即可。</li>
<li>通过SecurityUtils得到Subject，其会自动绑定到当前线程；如果在web环境在请求结束时需要接触绑定；然后获取身份验证的Token，如用户名/密码；</li>
<li>调用subject.login方法进行登录，其会自动委托给SecurityManager.login方法进行登录。</li>
<li>如果身份验证失败请捕获AuthenticationException或其子类，常见的如： DisabledAccountException（禁用的帐号）、LockedAccountException（锁定的帐号）、UnknownAccountException（错误的帐号）、ExcessiveAttemptsException（登录失败次数过多）、IncorrectCredentialsException （错误的凭证）、ExpiredCredentialsException（过期的凭证）等，具体请查看其继承关系；对于页面的错误消息展示，最好使用如“用户名/密码错误”而不是“用户名错误”/“密码错误”，防止一些恶意用户非法扫描帐号库； </li>
<li>同样的调用subject.logout退出，也会自动委托给SecurityManager.logout方法退出。</li>
</ol>
<p><strong>从上面的代码可以大概总结出身份验证的步骤：</strong></p>
<ol>
<li>收集用户身份/凭证，即用户名/密码</li>
<li>调用Subject.login进行登记，如果失败将得到相应的AuthenticationException异常，根据异常提示用户错误信息；否则登录成功；</li>
<li>最后调用Subject.logout进行退出操作；</li>
</ol>
<p>如上测试的几个问题：</p>
<ol>
<li>用户名/密码是硬编码在ini配置文件，以后需要改为如数据库存储，且密码需要加密存储；</li>
<li>用户身份Token可能不仅仅是用户名/密码，也可能还有其他的，如登录时允许用户名/邮箱/手机号同时登录。</li>
</ol>
<h4 id="身份认证流程"><a href="#身份认证流程" class="headerlink" title="身份认证流程"></a>身份认证流程</h4><p><img src="http://dl2.iteye.com/upload/attachment/0094/0173/8d639160-cd3e-3b9c-8dd6-c7f9221827a5.png" alt=""></p>
<p>流程如下：</p>
<ol>
<li>首先调用Subject.login(token)进行登录，其会自动委托给Security Manager，调用之前必须通过SecurityUtils. setSecurityManager()设置；</li>
<li>SecurityManager负责真正的身份验证逻辑；它会委托给Authenticator进行身份验证；</li>
<li>Authenticator才是真正的身份验证者，Shiro API中核心的身份认证入口点，此处可以自定义插入自己的实现；</li>
<li>Authenticator可能会委托给相应的AuthenticationStrategy进行多Realm身份验证，默认ModularRealmAuthenticator会调用AuthenticationStrategy进行多Realm身份验证；</li>
<li>Authenticator会把相应的token传入Realm，从Realm获取身份验证信息，如果没有返回/抛出异常表示身份验证失败了。此处可以配置多个Realm，将按照相应的顺序及策略进行访问。</li>
</ol>
<h4 id="Realm"><a href="#Realm" class="headerlink" title="Realm"></a>Realm</h4><p>Realm:域，Shiro从Realm获取安全数据（如用户、角色、权限），就是说SecurityManager要验证用户身份，那么它需要从Realm获取响应的用户进行比较以确定用户身份是否合法；也需要从Realm得到用户相应的角色/权限进行验证用户是否能进行操作；可以把Realm看出DataSource，即安全数据源。如我们之前的ini配置方式将使用org.apache.shiro.realm.text.IniRealm</p>
<p>org.apache.shiro.realm.Realm接口如下：   </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">String <span class="title">getName</span><span class="params">()</span></span>; <span class="comment">//返回一个唯一的Realm名字  </span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">supports</span><span class="params">(AuthenticationToken token)</span></span>; <span class="comment">//判断此Realm是否支持此Token  </span></span><br><span class="line"></span><br><span class="line"><span class="function">AuthenticationInfo <span class="title">getAuthenticationInfo</span><span class="params">(AuthenticationToken token)</span>  </span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="keyword">throws</span> AuthenticationException</span>;  <span class="comment">//根据Token获取认证信息</span></span><br></pre></td></tr></table></figure>
<p>Shiro默认提供的Realm</p>
<p><img src="http://dl2.iteye.com/upload/attachment/0094/0175/34062d4e-8ac5-378a-a9e2-4845f0828292.png" alt=""></p>
<p>以后一般继承AuthorizingRealm（授权）即可；其继承了AuthenticatingRealm（即身份验证），而且也间接继承了CachingRealm（带有缓存实现）。其中主要默认实现如下：</p>
<p><strong>org.apache.shiro.realm.text.IniRealm</strong>：[users]部分指定用户名/密码及其角色；[roles]部分指定角色即权限信息；</p>
<p><strong>org.apache.shiro.realm.text.PropertiesRealm</strong>：user.username=password,role1,role2指定用户名/密码及其角色；role.role1=permission1,permission2指定角色及权限信息；</p>
<p><strong>org.apache.shiro.realm.jdbc.JdbcRealm</strong>：通过sql查询相应的信息，如“select password from users where username = ?”获取用户密码，“select password, password_salt from users where username = ?”获取用户密码及盐；“select role_name from user_roles where username = ?”获取用户角色；“select permission from roles_permissions where role_name = ?”获取角色对应的权限信息；也可以调用相应的api进行自定义sql；</p>
<h4 id="JDBC-Realm使用"><a href="#JDBC-Realm使用" class="headerlink" title="JDBC Realm使用"></a>JDBC Realm使用</h4><h5 id="ini配置（shiro-jdbc-realm-ini）"><a href="#ini配置（shiro-jdbc-realm-ini）" class="headerlink" title="ini配置（shiro-jdbc-realm.ini）"></a>ini配置（shiro-jdbc-realm.ini）</h5><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">jdbcRealm</span>=org.apache.shiro.realm.jdbc.JdbcRealm</span><br><span class="line"><span class="attr">dataSource</span>=com.alibaba.druid.pool.DruidDataSource</span><br><span class="line">dataSource.driverClassName=com.mysql.jdbc.Driver</span><br><span class="line">dataSource.url=jdbc:mysql://localhost:3306/shiro</span><br><span class="line">dataSource.username=root</span><br><span class="line"><span class="comment">#dataSource.password=123</span></span><br><span class="line">jdbcRealm.dataSource=$dataSource</span><br><span class="line">securityManager.realms=$jdbcRealm</span><br></pre></td></tr></table></figure>
<h4 id="Authenticator及AuthenticationStrategy"><a href="#Authenticator及AuthenticationStrategy" class="headerlink" title="Authenticator及AuthenticationStrategy"></a>Authenticator及AuthenticationStrategy</h4><p>Authentication的职责是验证用户账户，是Shiro API中身份验证核心的入口点：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> AuthenticationInfo <span class="title">authenticate</span><span class="params">(AuthenticationToken authenticationToken)</span>  </span></span><br><span class="line"><span class="function">            <span class="keyword">throws</span> AuthenticationException</span>;</span><br></pre></td></tr></table></figure>
<p>如果验证成功，将返回AuthenticationInfo验证信息；此信息中包含了身份及凭证；如果验证失败将抛出相应的AuthenticationException实现。 </p>
<p>SecurityManager接口继承了Authenticator，另外还有一个ModularRealmAuthenticator实现，其委托给多个Realm进行验证，验证规则通过AuthenticationStrategy接口指定，默认提供的实现：</p>
<p><strong>FirstSuccessfulStrategy</strong>：只要有一个Realm验证成功即可，只返回第一个Realm身份验证成功的认证信息，其他的忽略；</p>
<p><strong>AtLeastOneSuccessfulStrategy</strong>：只要有一个Realm验证成功即可，和FirstSuccessfulStrategy不同，返回所有Realm身份验证成功的认证信息；</p>
<p><strong>AllSuccessfulStrategy</strong>：所有Realm验证成功才算成功，且返回所有Realm身份验证成功的认证信息，如果有一个失败就失败了。</p>
<p>ModularRealmAuthenticator默认使用AtLeastOneSuccessfulStrategy策略。</p>
<h3 id="授权"><a href="#授权" class="headerlink" title="授权"></a>授权</h3><p>授权，也叫访问控制，即在应用中控制谁能访问哪些资源（如访问页面/编辑数据/页面操作等）。在授权中需了解的几个关键对象：主体（Subject）、资源（Resource）、权限（Permission）、角色（Role）。 </p>
<p><strong>主体</strong></p>
<p>主体，即访问应用的用户，在Shiro中使用Subject代表该用户。用户只有授权后才允许访问相应的资源。</p>
<p><strong>资源</strong></p>
<p>在应用中用户可以访问的任何东西，比如访问JSP页面、查看/编辑某些数据、访问某个业务方法、打印文本等等都是资源。用户只要授权后才能访问。</p>
<p><strong>权限</strong></p>
<p>安全策略中的原子授权单位，通过权限我们可以表示在应用中用户有没有操作某个资源的权力。即权限表示在应用中用户能不能访问某个资源，如：</p>
<p>访问用户列表页面</p>
<p>查看/新增/修改/删除用户数据（即很多时候都是CRUD（增查改删）式权限控制）</p>
<p>打印文档等等。。。</p>
<p>如上可以看出，权限代表了用户有没有操作某个资源的权利，即反映在某个资源上的操作允不允许，不反映谁去执行这个操作。所以后续还需要把权限赋予给用户，即定义哪个用户允许在某个资源上做什么操作（权限），Shiro不会去做这件事情，而是由实现人员提供。 </p>
<p>Shiro支持粗粒度权限（如用户模块的所有权限）和细粒度权限（操作某个用户的权限，即实例级别的），后续部分介绍。 </p>
<p><strong>角色</strong></p>
<p>角色代表了操作集合，可以理解为权限的集合，一般情况下我们会赋予用户角色而不是权限，即这样用户可以拥有一组权限，赋予权限时比较方便。典型的如：项目经理、技术总监、CTO、开发工程师等都是角色，不同的角色拥有一组不同的权限。</p>
<p><strong>隐式角色</strong>：即直接通过角色来验证用户有没有操作权限，如在应用中CTO、技术总监、开发工程师可以使用打印机，假设某天不允许开发工程师使用打印机，此时需要从应用中删除相应代码；再如在应用中CTO、技术总监可以查看用户、查看权限；突然有一天不允许技术总监查看用户、查看权限了，需要在相关代码中把技术总监角色从判断逻辑中删除掉；即粒度是以角色为单位进行访问控制的，粒度较粗；如果进行修改可能造成多处代码修改。 </p>
<p><strong>显示角色</strong>：在程序中通过权限控制谁能访问某个资源，角色聚合一组权限集合；这样假设哪个角色不能访问某个资源，只需要从角色代表的权限集合中移除即可；无须修改多处代码；即粒度是以资源/实例为单位的；粒度较细。 </p>
<h4 id="授权方式"><a href="#授权方式" class="headerlink" title="授权方式"></a>授权方式</h4><p>Shiro支持三种方式的授权：</p>
<ol>
<li>Java代码方式</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Subject subject = SecurityUtils.getSubject();</span><br><span class="line"><span class="keyword">if</span> (subject.hasRole(<span class="string">"admin"</span>))&#123;</span><br><span class="line">    <span class="comment">//有权限</span></span><br><span class="line">&#125;<span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">//没权限</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol start="2">
<li>注解式:通过在执行的Java方法上放置相应的注解完成：</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequiresRoles</span>(<span class="string">"admin"</span>)  </span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">hello</span><span class="params">()</span> </span>&#123;  </span><br><span class="line">    <span class="comment">//有权限  </span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>没有权限将抛出相应的异常；</p>
<ol start="3">
<li>JSP/GSP标签：在JSP/GSP页面通过相应的标签完成：</li>
</ol>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;shiro:hasRole name=<span class="string">"admin"</span>&gt;  </span><br><span class="line">&lt;!— 有权限 —&gt;  </span><br><span class="line">&lt;<span class="regexp">/shiro:hasRole&gt;</span></span><br></pre></td></tr></table></figure>
<p>后续部分将详细介绍如何使用。   </p>
<h4 id="授权-1"><a href="#授权-1" class="headerlink" title="授权"></a>授权</h4><p><strong>基于角色的访问控制（隐式角色）</strong></p>
 <figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[users]</span>  </span><br><span class="line"><span class="attr">zhang</span>=<span class="number">123</span>,role1,role2  </span><br><span class="line"><span class="attr">wang</span>=<span class="number">123</span>,role1</span><br></pre></td></tr></table></figure>
<p>规则：“用户名=密码,角色1，角色2”，如果需要在应用中判断用户是否有相应角色，就需要在相应的Realm中返回角色信息，也就是说Shiro不负责维护用户-角色信息，需要应用提供，Shiro只是提供相应的接口方便验证，后续会介绍如何动态的获取用户角色。 </p>
<p>测试代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span>  </span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testHasRole</span><span class="params">()</span> </span>&#123;  </span><br><span class="line">    login(<span class="string">"classpath:shiro-role.ini"</span>, <span class="string">"zhang"</span>, <span class="string">"123"</span>);  </span><br><span class="line">    <span class="comment">//判断拥有角色：role1  </span></span><br><span class="line">    Assert.assertTrue(subject().hasRole(<span class="string">"role1"</span>));  </span><br><span class="line">    <span class="comment">//判断拥有角色：role1 and role2  </span></span><br><span class="line">    Assert.assertTrue(subject().hasAllRoles(Arrays.asList(<span class="string">"role1"</span>, <span class="string">"role2"</span>)));  </span><br><span class="line">    <span class="comment">//判断拥有角色：role1 and role2 and !role3  </span></span><br><span class="line">    <span class="keyword">boolean</span>[] result = subject().hasRoles(Arrays.asList(<span class="string">"role1"</span>, <span class="string">"role2"</span>, <span class="string">"role3"</span>));  </span><br><span class="line">    Assert.assertEquals(<span class="keyword">true</span>, result[<span class="number">0</span>]);  </span><br><span class="line">    Assert.assertEquals(<span class="keyword">true</span>, result[<span class="number">1</span>]);  </span><br><span class="line">    Assert.assertEquals(<span class="keyword">false</span>, result[<span class="number">2</span>]);  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Shiro提供了hasRole/hasRole用于判断用户是否拥有某个角色/某些权限；但是没有提供如hashAnyRole用于判断是否有某些权限中的某一个。  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span>(expected = UnauthorizedException.class)  </span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testCheckRole</span><span class="params">()</span> </span>&#123;  </span><br><span class="line">    login(<span class="string">"classpath:shiro-role.ini"</span>, <span class="string">"zhang"</span>, <span class="string">"123"</span>);  </span><br><span class="line">    <span class="comment">//断言拥有角色：role1  </span></span><br><span class="line">    subject().checkRole(<span class="string">"role1"</span>);  </span><br><span class="line">    <span class="comment">//断言拥有角色：role1 and role3 失败抛出异常  </span></span><br><span class="line">    subject().checkRoles(<span class="string">"role1"</span>, <span class="string">"role3"</span>);  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Shiro提供的checkRole/checkRoles和hasRole/hasAllRoles不同的地方是它在判断为假的情况下会抛出UnauthorizedException异常。 </p>
<p>到此基于角色的访问控制（即隐式角色）就完成了，这种方式的缺点就是如果很多地方进行了角色判断，但是有一天不需要了那么就需要修改相应代码把所有相关的地方进行删除；这就是粗粒度造成的问题。 </p>
<p><strong>基于资源的访问控制（显示角色</strong> )</p>
<p>1、在ini配置文件配置用户拥有的角色及角色-权限关系（shiro-permission.ini）  </p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[users]</span>  </span><br><span class="line"><span class="attr">zhang</span>=<span class="number">123</span>,role1,role2  </span><br><span class="line"><span class="attr">wang</span>=<span class="number">123</span>,role1  </span><br><span class="line"><span class="section">[roles]</span>  </span><br><span class="line"><span class="attr">role1</span>=user:create,user:update  </span><br><span class="line"><span class="attr">role2</span>=user:create,user:delete</span><br></pre></td></tr></table></figure>
<p>规则：“用户名=密码，角色1，角色2”“角色=权限1，权限2”，即首先根据用户名找到角色，然后根据角色再找到权限；即角色是权限集合；Shiro同样不进行权限的维护，需要我们通过Realm返回相应的权限信息。只需要维护“用户——角色”之间的关系即可。 </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span>  </span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testIsPermitted</span><span class="params">()</span> </span>&#123;  </span><br><span class="line">    login(<span class="string">"classpath:shiro-permission.ini"</span>, <span class="string">"zhang"</span>, <span class="string">"123"</span>);  </span><br><span class="line">    <span class="comment">//判断拥有权限：user:create  </span></span><br><span class="line">    Assert.assertTrue(subject().isPermitted(<span class="string">"user:create"</span>));  </span><br><span class="line">    <span class="comment">//判断拥有权限：user:update and user:delete  </span></span><br><span class="line">    Assert.assertTrue(subject().isPermittedAll(<span class="string">"user:update"</span>, <span class="string">"user:delete"</span>));  </span><br><span class="line">    <span class="comment">//判断没有权限：user:view  </span></span><br><span class="line">    Assert.assertFalse(subject().isPermitted(<span class="string">"user:view"</span>));  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Shiro提供了isPermitted和isPermittedAll用于判断用户是否拥有某个权限或所有权限，也没有提供如isPermittedAny用于判断拥有某一个权限的接口。 </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span>(expected = UnauthorizedException.class)  </span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testCheckPermission</span> <span class="params">()</span> </span>&#123;  </span><br><span class="line">    login(<span class="string">"classpath:shiro-permission.ini"</span>, <span class="string">"zhang"</span>, <span class="string">"123"</span>);  </span><br><span class="line">    <span class="comment">//断言拥有权限：user:create  </span></span><br><span class="line">    subject().checkPermission(<span class="string">"user:create"</span>);  </span><br><span class="line">    <span class="comment">//断言拥有权限：user:delete and user:update  </span></span><br><span class="line">    subject().checkPermissions(<span class="string">"user:delete"</span>, <span class="string">"user:update"</span>);  </span><br><span class="line">    <span class="comment">//断言拥有权限：user:view 失败抛出异常  </span></span><br><span class="line">    subject().checkPermissions(<span class="string">"user:view"</span>);  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>但是失败的情况下会抛出UnauthorizedException异常。</p>
<p> 到此基于资源的访问控制（显示角色）就完成了，也可以叫基于权限的访问控制，这种方式的一般规则是“资源标识符：操作”，即是资源级别的粒度；这种方式的好处就是如果要修改基本都是一个资源级别的修改，不会对其他模块代码产生影响，粒度小。但是实现起来可能稍微复杂点，需要维护“用户——角色，角色——权限（资源：操作）”之间的关系。  </p>
<h4 id="Permission"><a href="#Permission" class="headerlink" title="Permission"></a>Permission</h4><p>字符串通配符权限</p>
<p> 规则：“资源标识符：操作：对象实例ID”  即对哪个资源的哪个实例可以进行什么操作。其默认支持通配符权限字符串，“:”表示资源/操作/实例的分割；“,”表示操作的分割；“*”表示任意资源/操作/实例。</p>
<ol>
<li>单个资源单个权限</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">subject().checkPermissions(<span class="string">"system:user:update"</span>);</span><br></pre></td></tr></table></figure>
<ol start="2">
<li>单个资源多个权限</li>
</ol>
<p>ini配置文件：</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">role41</span>=system:user:update,system:user:delete</span><br></pre></td></tr></table></figure>
<p>然后通过如下代码判断  </p>
 <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">subject().checkPermissions(<span class="string">"system:user:update"</span>, <span class="string">"system:user:delete"</span>);</span><br></pre></td></tr></table></figure>
<p>用户拥有资源“system:user”的“update”和“delete”权限。如上可以简写成：</p>
<p>ini配置（表示角色4拥有system:user资源的update和delete权限）     </p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">role42</span>=<span class="string">"system:user:update,delete"</span></span><br></pre></td></tr></table></figure>
<p> 接着可以通过如下代码判断   </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">subject().checkPermissions(<span class="string">"system:user:update,delete"</span>);</span><br></pre></td></tr></table></figure>
<p>通过“system:user:update,delete”验证”system:user:update, system:user:delete”是没问题的，但是反过来是规则不成立。</p>
<ol start="3">
<li>单个资源全部权限</li>
</ol>
<p>ini配置   </p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">role51</span>=<span class="string">"system:user:create,update,delete,view"</span></span><br></pre></td></tr></table></figure>
<p>然后通过如下代码判断   </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">subject().checkPermissions(<span class="string">"system:user:create,delete,update:view"</span>);</span><br></pre></td></tr></table></figure>
<p>用户拥有资源“system:user”的“create”、“update”、“delete”和“view”所有权限。如上可以简写成：</p>
<p>ini配置文件（表示角色5拥有system:user的所有权限）  </p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">role52</span>=system:user:*</span><br></pre></td></tr></table></figure>
<p>也可以简写为（推荐上边的写法）：  </p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">role53</span>=system:user</span><br></pre></td></tr></table></figure>
<p>然后通过如下代码判断  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">subject().checkPermissions(<span class="string">"system:user:*"</span>);  </span><br><span class="line">subject().checkPermissions(<span class="string">"system:user"</span>);</span><br></pre></td></tr></table></figure>
<p>通过“system:user:*”验证“system:user:create,delete,update:view”可以，但是反过来是不成立的。</p>
<ol start="4">
<li><strong>所有资源全部权限</strong> </li>
</ol>
<p>ini配置   </p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">role61</span>=*:view</span><br></pre></td></tr></table></figure>
<p>然后通过如下代码判断  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">subject().checkPermissions(<span class="string">"user:view"</span>);</span><br></pre></td></tr></table></figure>
<p>用户拥有所有资源的“view”所有权限。假设判断的权限是“”system:user:view”，那么需要“role5=<em>:</em>:view”这样写才行。</p>
<ol start="5">
<li><strong>实例级别的权限</strong> </li>
</ol>
<p><strong>5.1、单个实例单个权限</strong></p>
<p> ini配置  </p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">role71</span>=user:view:<span class="number">1</span></span><br></pre></td></tr></table></figure>
<p>对资源user的1实例拥有view权限。</p>
<p>然后通过如下代码判断 </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">subject().checkPermissions(<span class="string">"user:view:1"</span>);</span><br></pre></td></tr></table></figure>
<p><strong>5.2、单个实例多个权限</strong></p>
<p> ini配置             </p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">role72</span>=<span class="string">"user:update,delete:1"</span></span><br></pre></td></tr></table></figure>
<p>对资源user的1实例拥有update、delete权限。</p>
<p>然后通过如下代码判断</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">subject().checkPermissions(<span class="string">"user:delete,update:1"</span>);  </span><br><span class="line">subject().checkPermissions(<span class="string">"user:update:1"</span>, <span class="string">"user:delete:1"</span>);</span><br></pre></td></tr></table></figure>
<p><strong>5.3、单个实例所有权限</strong> </p>
<p>ini配置    </p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">role73</span>=user:*:<span class="number">1</span></span><br></pre></td></tr></table></figure>
<p>对资源user的1实例拥有所有权限。</p>
<p>然后通过如下代码判断 </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">subject().checkPermissions(<span class="string">"user:update:1"</span>, <span class="string">"user:delete:1"</span>, <span class="string">"user:view:1"</span>);</span><br></pre></td></tr></table></figure>
<p><strong>5.4、所有实例单个权限</strong> </p>
<p>ini配置   </p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">role74</span>=user:auth:*</span><br></pre></td></tr></table></figure>
<p>对资源user的1实例拥有所有权限。</p>
<p>然后通过如下代码判断 </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">subject().checkPermissions(<span class="string">"user:auth:1"</span>, <span class="string">"user:auth:2"</span>);</span><br></pre></td></tr></table></figure>
<p><strong>5.5、所有实例所有权限</strong></p>
<p> ini配置   </p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">role75</span>=user:*:*</span><br></pre></td></tr></table></figure>
<p>对资源user的1实例拥有所有权限。</p>
<p>然后通过如下代码判断 </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">subject().checkPermissions(<span class="string">"user:view:1"</span>, <span class="string">"user:auth:2"</span>);</span><br></pre></td></tr></table></figure>
<p><strong>6、Shiro对权限字符串缺失部分的处理</strong> </p>
<p>如“user:view”等价于“user:view:<em>”；而“organization”等价于“organization:</em>”或者“organization:<em>:</em>”。可以这么理解，这种方式实现了前缀匹配。</p>
<p>另外如“user:<em>”可以匹配如“user:delete”、“user:delete”可以匹配如“user:delete:1”、“user:</em>:1”可以匹配如“user:view:1”、“user”可以匹配“user:view”或“user:view:1”等。即<em>可以匹配所有，不加</em>可以进行前缀匹配；但是如“<em>:view”不能匹配“system:user:view”，需要使用“</em>:<em>:view”，即后缀匹配必须指定前缀（多个冒号就需要多个</em>来匹配）。</p>
<p><strong>7、WildcardPermission</strong></p>
<p> 如下两种方式是等价的：    </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">subject().checkPermission(<span class="string">"menu:view:1"</span>);  </span><br><span class="line">subject().checkPermission(<span class="keyword">new</span> WildcardPermission(<span class="string">"menu:view:1"</span>));</span><br></pre></td></tr></table></figure>
<p>因此没什么必要的话使用字符串更方便。</p>
<p> <strong>8、性能问题</strong></p>
<p>通配符匹配方式比字符串相等匹配来说是更复杂的，因此需要花费更长时间，但是一般系统的权限不会太多，且可以配合缓存来提供其性能，如果这样性能还达不到要求我们可以实现位操作算法实现性能更好的权限匹配。另外实例级别的权限验证如果数据量太大也不建议使用，可能造成查询权限及匹配变慢。可以考虑比如在sql查询时加上权限字符串之类的方式在查询时就完成了权限匹配。</p>
<h4 id="授权流程"><a href="#授权流程" class="headerlink" title="授权流程"></a>授权流程</h4><p> <img src="http://dl2.iteye.com/upload/attachment/0094/0549/541e4da3-d1a5-3d13-83a6-b65c3596ee4e.png" alt=""></p>
<p>流程如下：</p>
<p>1、首先调用Subject.isPermitted<em>/hasRole</em>接口，其会委托给SecurityManager，而SecurityManager接着会委托给Authorizer；</p>
<p>2、Authorizer是真正的授权者，如果我们调用如isPermitted(“user:view”)，其首先会通过PermissionResolver把字符串转换成相应的Permission实例；</p>
<p>3、在进行授权之前，其会调用相应的Realm获取Subject相应的角色/权限用于匹配传入的角色/权限；</p>
<p>4、Authorizer会判断Realm的角色/权限是否和传入的匹配，如果有多个Realm，会委托给ModularRealmAuthorizer进行循环判断，如果匹配如isPermitted<em>/hasRole</em>会返回true，否则返回false表示授权失败。</p>
<p>ModularRealmAuthorizer进行多Realm匹配流程：</p>
<p>1、首先检查相应的Realm是否实现了实现了Authorizer；</p>
<p>2、如果实现了Authorizer，那么接着调用其相应的isPermitted<em>/hasRole</em>接口进行匹配；</p>
<p>3、如果有一个Realm匹配那么将返回true，否则返回false。</p>
<p>如果Realm进行授权的话，应该继承AuthorizingRealm，其流程是：</p>
<p>1.1、如果调用hasRole*，则直接获取AuthorizationInfo.getRoles()与传入的角色比较即可；</p>
<p>1.2、首先如果调用如isPermitted(“user:view”)，首先通过PermissionResolver将权限字符串转换成相应的Permission实例，默认使用WildcardPermissionResolver，即转换为通配符的WildcardPermission；</p>
<p>2、通过AuthorizationInfo.getObjectPermissions()得到Permission实例集合；通过AuthorizationInfo. getStringPermissions()得到字符串集合并通过PermissionResolver解析为Permission实例；然后获取用户的角色，并通过RolePermissionResolver解析角色对应的权限集合（默认没有实现，可以自己提供）；</p>
<p>3、接着调用Permission. implies(Permission p)逐个与传入的权限比较，如果有匹配的则返回true，否则false。 </p>
<h4 id="Authorizer、PermissionResolver及RolePermissionResolver"><a href="#Authorizer、PermissionResolver及RolePermissionResolver" class="headerlink" title="Authorizer、PermissionResolver及RolePermissionResolver"></a>Authorizer、PermissionResolver及RolePermissionResolver</h4><p>Authorizer的职责是进行授权（访问控制），是Shiro API中授权核心的入口点，其提供了相应的角色/权限判断接口，具体请参考其Javadoc。SecurityManager继承了Authorizer接口，且提供了ModularRealmAuthorizer用于多Realm时的授权匹配。PermissionResolver用于解析权限字符串到Permission实例，而RolePermissionResolver用于根据角色解析相应的权限集合。 </p>
<p>我们可以通过如下ini配置更改Authorizer实现：   </p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">authorizer</span>=org.apache.shiro.authz.ModularRealmAuthorizer  </span><br><span class="line">securityManager.authorizer=$authorizer</span><br></pre></td></tr></table></figure>
<p>对于ModularRealmAuthorizer，相应的AuthorizingSecurityManager会在初始化完成后自动将相应的realm设置进去，我们也可以通过调用其setRealms()方法进行设置。对于实现自己的authorizer可以参考ModularRealmAuthorizer实现即可，在此就不提供示例了。</p>
<p>设置ModularRealmAuthorizer的permissionResolver，其会自动设置到相应的Realm上（其实现了PermissionResolverAware接口），如： </p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">permissionResolver</span>=org.apache.shiro.authz.permission.WildcardPermissionResolver  </span><br><span class="line">authorizer.permissionResolver=$permissionResolver</span><br></pre></td></tr></table></figure>
<p>设置ModularRealmAuthorizer的rolePermissionResolver，其会自动设置到相应的Realm上（其实现了RolePermissionResolverAware接口），如： </p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">rolePermissionResolver</span>=com.github.zhangkaitao.shiro.chapter3.permission.MyRolePermissionResolver  </span><br><span class="line">authorizer.rolePermissionResolver=$rolePermissionResolver</span><br></pre></td></tr></table></figure>
<p><strong>示例</strong> </p>
<p><strong>1、ini配置（shiro-authorizer.ini）</strong> </p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[main]</span>  </span><br><span class="line"><span class="comment">#自定义authorizer  </span></span><br><span class="line"><span class="attr">authorizer</span>=org.apache.shiro.authz.ModularRealmAuthorizer  </span><br><span class="line"><span class="comment">#自定义permissionResolver  </span></span><br><span class="line"><span class="comment">#permissionResolver=org.apache.shiro.authz.permission.WildcardPermissionResolver  </span></span><br><span class="line"><span class="attr">permissionResolver</span>=com.github.zhangkaitao.shiro.chapter3.permission.BitAndWildPermissionResolver  </span><br><span class="line">authorizer.permissionResolver=$permissionResolver  </span><br><span class="line"><span class="comment">#自定义rolePermissionResolver  </span></span><br><span class="line"><span class="attr">rolePermissionResolver</span>=com.github.zhangkaitao.shiro.chapter3.permission.MyRolePermissionResolver  </span><br><span class="line">authorizer.rolePermissionResolver=$rolePermissionResolver  </span><br><span class="line">  </span><br><span class="line">securityManager.authorizer=$authorizer</span><br></pre></td></tr></table></figure>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#自定义realm 一定要放在securityManager.authorizer赋值之后（因为调用setRealms会将realms设置给authorizer，并给各个Realm设置permissionResolver和rolePermissionResolver）  </span></span><br><span class="line"><span class="attr">realm</span>=com.github.zhangkaitao.shiro.chapter3.realm.MyRealm  </span><br><span class="line">securityManager.realms=$realm</span><br></pre></td></tr></table></figure>
<p>设置securityManager 的realms一定要放到最后，因为在调用SecurityManager.setRealms时会将realms设置给authorizer，并为各个Realm设置permissionResolver和rolePermissionResolver。另外，不能使用IniSecurityManagerFactory创建的IniRealm，因为其初始化顺序的问题可能造成后续的初始化Permission造成影响。 </p>
<h5 id="2、定义BitAndWildPermissionResolver及BitPermission"><a href="#2、定义BitAndWildPermissionResolver及BitPermission" class="headerlink" title="2、定义BitAndWildPermissionResolver及BitPermission"></a><strong>2、定义BitAndWildPermissionResolver及BitPermission</strong></h5><p>BitPermission用于实现位移方式的权限，如规则是：</p>
<p>权限字符串格式：+资源字符串+权限位+实例ID；以+开头中间通过+分割；权限：0 表示所有权限；1 新增（二进制：0001）、2 修改（二进制：0010）、4 删除（二进制：0100）、8 查看（二进制：1000）；如 +user+10 表示对资源user拥有修改/查看权限。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BitPermission</span> <span class="keyword">implements</span> <span class="title">Permission</span> </span>&#123;  </span><br><span class="line">    <span class="keyword">private</span> String resourceIdentify;  </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> permissionBit;  </span><br><span class="line">    <span class="keyword">private</span> String instanceId;  </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">BitPermission</span><span class="params">(String permissionString)</span> </span>&#123;  </span><br><span class="line">        String[] array = permissionString.split(<span class="string">"\\+"</span>);  </span><br><span class="line">        <span class="keyword">if</span>(array.length &gt; <span class="number">1</span>) &#123;  </span><br><span class="line">            resourceIdentify = array[<span class="number">1</span>];  </span><br><span class="line">        &#125;  </span><br><span class="line">        <span class="keyword">if</span>(StringUtils.isEmpty(resourceIdentify)) &#123;  </span><br><span class="line">            resourceIdentify = <span class="string">"*"</span>;  </span><br><span class="line">        &#125;  </span><br><span class="line">        <span class="keyword">if</span>(array.length &gt; <span class="number">2</span>) &#123;  </span><br><span class="line">            permissionBit = Integer.valueOf(array[<span class="number">2</span>]);  </span><br><span class="line">        &#125;  </span><br><span class="line">        <span class="keyword">if</span>(array.length &gt; <span class="number">3</span>) &#123;  </span><br><span class="line">            instanceId = array[<span class="number">3</span>];  </span><br><span class="line">        &#125;  </span><br><span class="line">        <span class="keyword">if</span>(StringUtils.isEmpty(instanceId)) &#123;  </span><br><span class="line">            instanceId = <span class="string">"*"</span>;  </span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="meta">@Override</span>  </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">implies</span><span class="params">(Permission p)</span> </span>&#123;  </span><br><span class="line">        <span class="keyword">if</span>(!(p <span class="keyword">instanceof</span> BitPermission)) &#123;  </span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;  </span><br><span class="line">        &#125;  </span><br><span class="line">        BitPermission other = (BitPermission) p;  </span><br><span class="line">        <span class="keyword">if</span>(!(<span class="string">"*"</span>.equals(<span class="keyword">this</span>.resourceIdentify) || <span class="keyword">this</span>.resourceIdentify.equals(other.resourceIdentify))) &#123;  </span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;  </span><br><span class="line">        &#125;  </span><br><span class="line">        <span class="keyword">if</span>(!(<span class="keyword">this</span>.permissionBit ==<span class="number">0</span> || (<span class="keyword">this</span>.permissionBit &amp; other.permissionBit) != <span class="number">0</span>)) &#123;  </span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;  </span><br><span class="line">        &#125;  </span><br><span class="line">        <span class="keyword">if</span>(!(<span class="string">"*"</span>.equals(<span class="keyword">this</span>.instanceId) || <span class="keyword">this</span>.instanceId.equals(other.instanceId))) &#123;  </span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;  </span><br><span class="line">        &#125;  </span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Permission接口提供了boolean implies(Permission p)方法用于判断权限匹配的；  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BitAndWildPermissionResolver</span> <span class="keyword">implements</span> <span class="title">PermissionResolver</span> </span>&#123;  </span><br><span class="line">    <span class="meta">@Override</span>  </span><br><span class="line">    <span class="function"><span class="keyword">public</span> Permission <span class="title">resolvePermission</span><span class="params">(String permissionString)</span> </span>&#123;  </span><br><span class="line">        <span class="keyword">if</span>(permissionString.startsWith(<span class="string">"+"</span>)) &#123;  </span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> BitPermission(permissionString);  </span><br><span class="line">        &#125;  </span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> WildcardPermission(permissionString);  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>BitAndWildPermissionResolver实现了PermissionResolver接口，并根据权限字符串是否以“+”开头来解析权限字符串为BitPermission或WildcardPermission。</p>
<h5 id="定义MyRolePermissionResolver"><a href="#定义MyRolePermissionResolver" class="headerlink" title="定义MyRolePermissionResolver"></a><strong>定义MyRolePermissionResolver</strong></h5><p>RolePermissionResolver用于根据角色字符串来解析得到权限集合。  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyRolePermissionResolver</span> <span class="keyword">implements</span> <span class="title">RolePermissionResolver</span> </span>&#123;  </span><br><span class="line">    <span class="meta">@Override</span>  </span><br><span class="line">    <span class="function"><span class="keyword">public</span> Collection&lt;Permission&gt; <span class="title">resolvePermissionsInRole</span><span class="params">(String roleString)</span> </span>&#123;  </span><br><span class="line">        <span class="keyword">if</span>(<span class="string">"role1"</span>.equals(roleString)) &#123;  </span><br><span class="line">            <span class="keyword">return</span> Arrays.asList((Permission)<span class="keyword">new</span> WildcardPermission(<span class="string">"menu:*"</span>));  </span><br><span class="line">        &#125;  </span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>此处的实现很简单，如果用户拥有role1，那么就返回一个“menu:*”的权限。</p>
<h5 id="自定义Realm"><a href="#自定义Realm" class="headerlink" title="自定义Realm"></a><strong>自定义Realm</strong></h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyRealm</span> <span class="keyword">extends</span> <span class="title">AuthorizingRealm</span> </span>&#123;  </span><br><span class="line">    <span class="meta">@Override</span>  </span><br><span class="line">    <span class="function"><span class="keyword">protected</span> AuthorizationInfo <span class="title">doGetAuthorizationInfo</span><span class="params">(PrincipalCollection principals)</span> </span>&#123;  </span><br><span class="line">        SimpleAuthorizationInfo authorizationInfo = <span class="keyword">new</span> SimpleAuthorizationInfo();  </span><br><span class="line">        authorizationInfo.addRole(<span class="string">"role1"</span>);  </span><br><span class="line">        authorizationInfo.addRole(<span class="string">"role2"</span>);  </span><br><span class="line">        authorizationInfo.addObjectPermission(<span class="keyword">new</span> BitPermission(<span class="string">"+user1+10"</span>));  </span><br><span class="line">        authorizationInfo.addObjectPermission(<span class="keyword">new</span> WildcardPermission(<span class="string">"user1:*"</span>));  </span><br><span class="line">        authorizationInfo.addStringPermission(<span class="string">"+user2+10"</span>);  </span><br><span class="line">        authorizationInfo.addStringPermission(<span class="string">"user2:*"</span>);  </span><br><span class="line">        <span class="keyword">return</span> authorizationInfo;  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="meta">@Override</span>  </span><br><span class="line">    <span class="function"><span class="keyword">protected</span> AuthenticationInfo <span class="title">doGetAuthenticationInfo</span><span class="params">(AuthenticationToken token)</span> <span class="keyword">throws</span> AuthenticationException </span>&#123;  </span><br><span class="line">        <span class="comment">//和com.github.zhangkaitao.shiro.chapter2.realm.MyRealm1. getAuthenticationInfo代码一样，省略  </span></span><br><span class="line">&#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>此时我们继承AuthorizingRealm而不是实现Realm接口；推荐使用AuthorizingRealm，因为：</p>
<p>AuthenticationInfo doGetAuthenticationInfo(AuthenticationToken token)：表示获取身份验证信息；</p>
<p>AuthorizationInfo doGetAuthorizationInfo(PrincipalCollection principals)：表示根据用户身份获取授权信息。</p>
<p>这种方式的好处是当只需要身份验证时只需要获取身份验证信息而不需要获取授权信息。对于AuthenticationInfo和AuthorizationInfo请参考其Javadoc获取相关接口信息。</p>
<p>另外我们可以使用JdbcRealm，需要做的操作如下：</p>
<p>1、执行sql/ shiro-init-data.sql 插入相关的权限数据；</p>
<p>2、使用shiro-jdbc-authorizer.ini配置文件，需要设置jdbcRealm.permissionsLookupEnabled</p>
<p>为true来开启权限查询。</p>
<p>此次还要注意就是不能把我们自定义的如“+user1+10”配置到INI配置文件，即使有IniRealm完成，因为IniRealm在new完成后就会解析这些权限字符串，默认使用了WildcardPermissionResolver完成，即此处是一个设计权限，如果采用生命周期（如使用初始化方法）的方式进行加载就可以解决我们自定义permissionResolver的问题。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AuthorizerTest</span> <span class="keyword">extends</span> <span class="title">BaseTest</span> </span>&#123;  </span><br><span class="line">  </span><br><span class="line">    <span class="meta">@Test</span>  </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testIsPermitted</span><span class="params">()</span> </span>&#123;  </span><br><span class="line">        login(<span class="string">"classpath:shiro-authorizer.ini"</span>, <span class="string">"zhang"</span>, <span class="string">"123"</span>);  </span><br><span class="line">        <span class="comment">//判断拥有权限：user:create  </span></span><br><span class="line">        Assert.assertTrue(subject().isPermitted(<span class="string">"user1:update"</span>));  </span><br><span class="line">        Assert.assertTrue(subject().isPermitted(<span class="string">"user2:update"</span>));  </span><br><span class="line">        <span class="comment">//通过二进制位的方式表示权限  </span></span><br><span class="line">        Assert.assertTrue(subject().isPermitted(<span class="string">"+user1+2"</span>));<span class="comment">//新增权限  </span></span><br><span class="line">        Assert.assertTrue(subject().isPermitted(<span class="string">"+user1+8"</span>));<span class="comment">//查看权限  </span></span><br><span class="line">        Assert.assertTrue(subject().isPermitted(<span class="string">"+user2+10"</span>));<span class="comment">//新增及查看  </span></span><br><span class="line">  </span><br><span class="line">        Assert.assertFalse(subject().isPermitted(<span class="string">"+user1+4"</span>));<span class="comment">//没有删除权限  </span></span><br><span class="line">  </span><br><span class="line">        Assert.assertTrue(subject().isPermitted(<span class="string">"menu:view"</span>));<span class="comment">//通过MyRolePermissionResolver解析得到的权限  </span></span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="INI配置"><a href="#INI配置" class="headerlink" title="INI配置"></a>INI配置</h3><p>之前章节我们已经接触过一些INI配置规则了，如果大家使用过如Spring之类的IoC/DI容器的话，Shiro提供的INI配置也是非常类似的，即可以理解为是一个IoC/DI容器，但是区别在于它从一个根对象securityManager开始。</p>
<h4 id="根对象SecurityManager"><a href="#根对象SecurityManager" class="headerlink" title="根对象SecurityManager"></a>根对象SecurityManager</h4><p> 从之前的Shiro架构图可以看出，Shiro是从根对象SecurityManager进行身份验证和授权的；也就是所有操作都是自它开始的，这个对象是线程安全且整个应用只需要一个即可，因此Shiro提供了SecurityUtils让我们绑定它为全局的，方便后续操作。</p>
<p> 因为Shiro的类都是POJO的，因此都很容易放到任何IoC容器管理。但是和一般的IoC容器的区别在于，Shiro从根对象securityManager开始导航；Shiro支持的依赖注入：public空参构造器对象的创建、setter依赖注入。</p>
<p> 1、纯Java代码写法 </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">DefaultSecurityManager securityManager = <span class="keyword">new</span> DefaultSecurityManager();  </span><br><span class="line"><span class="comment">//设置authenticator  </span></span><br><span class="line">ModularRealmAuthenticator authenticator = <span class="keyword">new</span> ModularRealmAuthenticator();  </span><br><span class="line">authenticator.setAuthenticationStrategy(<span class="keyword">new</span> AtLeastOneSuccessfulStrategy());  </span><br><span class="line">securityManager.setAuthenticator(authenticator);  </span><br><span class="line">  </span><br><span class="line"><span class="comment">//设置authorizer  </span></span><br><span class="line">ModularRealmAuthorizer authorizer = <span class="keyword">new</span> ModularRealmAuthorizer();  </span><br><span class="line">authorizer.setPermissionResolver(<span class="keyword">new</span> WildcardPermissionResolver());  </span><br><span class="line">securityManager.setAuthorizer(authorizer);  </span><br><span class="line">  </span><br><span class="line"><span class="comment">//设置Realm  </span></span><br><span class="line">DruidDataSource ds = <span class="keyword">new</span> DruidDataSource();  </span><br><span class="line">ds.setDriverClassName(<span class="string">"com.mysql.jdbc.Driver"</span>);  </span><br><span class="line">ds.setUrl(<span class="string">"jdbc:mysql://localhost:3306/shiro"</span>);  </span><br><span class="line">ds.setUsername(<span class="string">"root"</span>);  </span><br><span class="line">ds.setPassword(<span class="string">""</span>);  </span><br><span class="line">  </span><br><span class="line">JdbcRealm jdbcRealm = <span class="keyword">new</span> JdbcRealm();  </span><br><span class="line">jdbcRealm.setDataSource(ds);  </span><br><span class="line">jdbcRealm.setPermissionsLookupEnabled(<span class="keyword">true</span>);  </span><br><span class="line">securityManager.setRealms(Arrays.asList((Realm) jdbcRealm));  </span><br><span class="line">  </span><br><span class="line"><span class="comment">//将SecurityManager设置到SecurityUtils 方便全局使用  </span></span><br><span class="line">SecurityUtils.setSecurityManager(securityManager);  </span><br><span class="line">  </span><br><span class="line">Subject subject = SecurityUtils.getSubject();  </span><br><span class="line">UsernamePasswordToken token = <span class="keyword">new</span> UsernamePasswordToken(<span class="string">"zhang"</span>, <span class="string">"123"</span>);  </span><br><span class="line">subject.login(token);  </span><br><span class="line">Assert.assertTrue(subject.isAuthenticated());</span><br></pre></td></tr></table></figure>
<p>2.1、等价的INI配置（shiro-config.ini） </p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[main]</span>  </span><br><span class="line"><span class="comment">#authenticator  </span></span><br><span class="line"><span class="attr">authenticator</span>=org.apache.shiro.authc.pam.ModularRealmAuthenticator  </span><br><span class="line"><span class="attr">authenticationStrategy</span>=org.apache.shiro.authc.pam.AtLeastOneSuccessfulStrategy  </span><br><span class="line">authenticator.authenticationStrategy=$authenticationStrategy  </span><br><span class="line">securityManager.authenticator=$authenticator  </span><br><span class="line">  </span><br><span class="line"><span class="comment">#authorizer  </span></span><br><span class="line"><span class="attr">authorizer</span>=org.apache.shiro.authz.ModularRealmAuthorizer  </span><br><span class="line"><span class="attr">permissionResolver</span>=org.apache.shiro.authz.permission.WildcardPermissionResolver  </span><br><span class="line">authorizer.permissionResolver=$permissionResolver  </span><br><span class="line">securityManager.authorizer=$authorizer  </span><br><span class="line">  </span><br><span class="line"><span class="comment">#realm  </span></span><br><span class="line"><span class="attr">dataSource</span>=com.alibaba.druid.pool.DruidDataSource  </span><br><span class="line">dataSource.driverClassName=com.mysql.jdbc.Driver  </span><br><span class="line">dataSource.url=jdbc:mysql://localhost:3306/shiro  </span><br><span class="line">dataSource.username=root  </span><br><span class="line"><span class="comment">#dataSource.password=  </span></span><br><span class="line"><span class="attr">jdbcRealm</span>=org.apache.shiro.realm.jdbc.JdbcRealm  </span><br><span class="line">jdbcRealm.dataSource=$dataSource  </span><br><span class="line">jdbcRealm.permissionsLookupEnabled=true  </span><br><span class="line">securityManager.realms=$jdbcRealm</span><br></pre></td></tr></table></figure>
<p>即使没接触过IoC容器的知识，如上配置也是很容易理解的：</p>
<p>1、对象名=全限定类名  相对于调用public无参构造器创建对象</p>
<p>2、对象名.属性名=值    相当于调用setter方法设置常量值</p>
<p>3、对象名.属性名=$对象引用    相当于调用setter方法设置对象引用</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">Factory&lt;org.apache.shiro.mgt.SecurityManager&gt; factory =  </span><br><span class="line">         <span class="keyword">new</span> IniSecurityManagerFactory(<span class="string">"classpath:shiro-config.ini"</span>);  </span><br><span class="line">  </span><br><span class="line">org.apache.shiro.mgt.SecurityManager securityManager = factory.getInstance();  </span><br><span class="line">  </span><br><span class="line"><span class="comment">//将SecurityManager设置到SecurityUtils 方便全局使用  </span></span><br><span class="line">SecurityUtils.setSecurityManager(securityManager);  </span><br><span class="line">Subject subject = SecurityUtils.getSubject();  </span><br><span class="line">UsernamePasswordToken token = <span class="keyword">new</span> UsernamePasswordToken(<span class="string">"zhang"</span>, <span class="string">"123"</span>);  </span><br><span class="line">subject.login(token);  </span><br><span class="line">  </span><br><span class="line">Assert.assertTrue(subject.isAuthenticated());</span><br></pre></td></tr></table></figure>
<p>如上代码是从Shiro INI配置中获取相应的securityManager实例： </p>
<ol>
<li>默认情况先创建一个名字为securityManager，类型为org.apache.shiro.mgt.DefaultSecurityManager的默认的SecurityManager，如果想自定义，只需要在ini配置文件中指定“securityManager=SecurityManager实现类”即可，名字必须为securityManager，它是起始的根； </li>
<li>IniSecurityManagerFactory是创建securityManager的工厂，其需要一个ini配置文件路径，其支持“classpath:”（类路径）、“file:”（文件系统）、“url:”（网络）三种路径格式，默认是文件系统； </li>
<li>接着获取SecuriyManager实例，后续步骤和之前的一样。 </li>
</ol>
<p>从如上可以看出Shiro INI配置方式本身提供了一个简单的IoC/DI机制方便在配置文件配置，但是是从securityManager这个根对象开始导航。    </p>
<h4 id="INI配置-1"><a href="#INI配置-1" class="headerlink" title="INI配置"></a>INI配置</h4><p>ini配置文件类似于Java中的properties（kye=value），不过提供了将key/value分类的特性，key是每个部分不重复即可，而不是整个配置文件。如下是INI配置分类：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[main]</span>  </span><br><span class="line"><span class="comment">#提供了对根对象securityManager及其依赖的配置  </span></span><br><span class="line"><span class="attr">securityManager</span>=org.apache.shiro.mgt.DefaultSecurityManager  </span><br><span class="line">…………  </span><br><span class="line">securityManager.realms=$jdbcRealm  </span><br><span class="line">  </span><br><span class="line"><span class="section">[users]</span>  </span><br><span class="line"><span class="comment">#提供了对用户/密码及其角色的配置，用户名=密码，角色1，角色2  </span></span><br><span class="line"><span class="attr">username</span>=password,role1,role2  </span><br><span class="line">  </span><br><span class="line"><span class="section">[roles]</span>  </span><br><span class="line"><span class="comment">#提供了角色及权限之间关系的配置，角色=权限1，权限2  </span></span><br><span class="line"><span class="attr">role1</span>=permission1,permission2  </span><br><span class="line">  </span><br><span class="line"><span class="section">[urls]</span>  </span><br><span class="line"><span class="comment">#用于web，提供了对web url拦截相关的配置，url=拦截器[参数]，拦截器  </span></span><br><span class="line">/index.html = anon  </span><br><span class="line">/admin/** = authc, roles[admin], perms["permission1"]</span><br></pre></td></tr></table></figure>
<p><strong>[main]**</strong>部分**</p>
<p>提供了对根对象securityManager及其依赖对象的配置。</p>
<p><strong>创建对象</strong> </p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">securityManager</span>=org.apache.shiro.mgt.DefaultSecurityManager</span><br></pre></td></tr></table></figure>
<p>其构造器必须是public空参构造器，通过反射创建相应的实例。</p>
<p> <strong>常量值setter注入</strong>   </p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">dataSource.driverClassName=com.mysql.jdbc.Driver  </span><br><span class="line">jdbcRealm.permissionsLookupEnabled=true</span><br></pre></td></tr></table></figure>
<p>会自动调用jdbcRealm.setPermissionsLookupEnabled(true)，对于这种常量值会自动类型转换。</p>
<p> <strong>对象引用setter注入</strong>   </p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">authenticator</span>=org.apache.shiro.authc.pam.ModularRealmAuthenticator  </span><br><span class="line"><span class="attr">authenticationStrategy</span>=org.apache.shiro.authc.pam.AtLeastOneSuccessfulStrategy  </span><br><span class="line">authenticator.authenticationStrategy=$authenticationStrategy  </span><br><span class="line">securityManager.authenticator=$authenticator</span><br></pre></td></tr></table></figure>
<p>会自动通过securityManager.setAuthenticator(authenticator)注入引用依赖。</p>
<p> <strong>嵌套属性setter注入</strong>   </p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">securityManager.authenticator.authenticationStrategy=$authenticationStrategy</span><br></pre></td></tr></table></figure>
<p><strong>byte数组setter注入</strong>   </p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#base64 byte[]  </span></span><br><span class="line">authenticator.bytes=aGVsbG8=  </span><br><span class="line"><span class="comment">#hex byte[]  </span></span><br><span class="line">authenticator.bytes=0x68656c6c6f</span><br></pre></td></tr></table></figure>
<p>默认需要使用Base64进行编码，也可以使用0x十六进制。</p>
<p> <strong>Array/Set/List setter注入</strong>   </p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">authenticator.array=1,2,3  </span><br><span class="line">authenticator.set=$jdbcRealm,$jdbcRealm</span><br></pre></td></tr></table></figure>
<p>多个之间通过“，”分割。</p>
<p> <strong>Map setter注入</strong>  </p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">authenticator.map=$jdbcRealm:$jdbcRealm,1:1,key:abc</span><br></pre></td></tr></table></figure>
<p>即格式是：map=key：value，key：value，可以注入常量及引用值，常量的话都看作字符串（即使有泛型也不会自动造型）。        </p>
<p> <strong>实例化/注入顺序</strong>   </p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">realm</span>=Realm1  </span><br><span class="line"><span class="attr">realm</span>=Realm12  </span><br><span class="line">  </span><br><span class="line">authenticator.bytes=aGVsbG8=  </span><br><span class="line">authenticator.bytes=0x68656c6c6f</span><br></pre></td></tr></table></figure>
<p>后边的覆盖前边的注入。</p>
<p> 测试用例请参考配置文件shiro-config-main.ini。 </p>
<p> <strong>[users]部分</strong></p>
<p>配置用户名/密码及其角色，格式：“用户名=密码，角色1，角色2”，角色部分可省略。如：</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[users]</span>  </span><br><span class="line"><span class="attr">zhang</span>=<span class="number">123</span>,role1,role2  </span><br><span class="line"><span class="attr">wang</span>=<span class="number">123</span></span><br></pre></td></tr></table></figure>
<p>密码一般生成其摘要/加密存储，后续章节介绍。</p>
<p> <strong>[roles]部分</strong></p>
<p>配置角色及权限之间的关系，格式：“角色=权限1，权限2”；如：</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[roles]</span>  </span><br><span class="line"><span class="attr">role1</span>=user:create,user:update  </span><br><span class="line"><span class="attr">role2</span>=*</span><br></pre></td></tr></table></figure>
<p>如果只有角色没有对应的权限，可以不配roles，具体规则请参考授权章节。</p>
<p> <strong>[urls]部分</strong></p>
<p> 配置url及相应的拦截器之间的关系，格式：“url=拦截器[参数]，拦截器[参数]，如：    </p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[urls]</span>  </span><br><span class="line">/admin/** = authc, roles[admin], perms["permission1"]</span><br></pre></td></tr></table></figure>
<h3 id="编码-加密"><a href="#编码-加密" class="headerlink" title="编码/加密"></a>编码/加密</h3><p>在涉及到密码存储问题上，应该加密/生成密码摘要存储，而不是存储明文密码。比如之前的600w csdn账号泄露对用户可能造成很大损失，因此应加密/生成不可逆的摘要方式存储。</p>
<h4 id="编码-解码"><a href="#编码-解码" class="headerlink" title="编码/解码"></a>编码/解码</h4><p>Shiro提供了base64和16进制字符串编码/解码的API支持，方便一些编码解码操作。Shiro内部的一些数据的存储/表示都使用了base64和16进制字符串。  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">String str = <span class="string">"hello"</span>;  </span><br><span class="line">String base64Encoded = Base64.encodeToString(str.getBytes()); <span class="comment">//编码 </span></span><br><span class="line">String str2 = Base64.decodeToString(base64Encoded);  <span class="comment">//解码</span></span><br><span class="line">Assert.assertEquals(str, str2);</span><br></pre></td></tr></table></figure>
<p>通过如上方式可以进行16进制字符串编码/解码操作，更多API请参考其Javadoc。</p>
<p>还有一个可能经常用到的类CodecSupport，提供了toBytes(str, “utf-8”) / toString(bytes, “utf-8”)用于在byte数组/String之间转换。</p>
<h4 id="散列算法"><a href="#散列算法" class="headerlink" title="散列算法"></a>散列算法</h4><p>散列算法一般用于生成数据的摘要信息，是一种不可逆算法，一般适合存储密码之类的数据，常见的散列算法如MD5、SHA等。一般进行散列时最好提供一个salt（盐），比如加密密码”admin”，产生的散列值是”21232f297a57a5a743894a0e4a801fc3 “,可以到一些MD5解密网站很容易的通过散列值得到密码”admin”，即如果直接对密码进行散列相对来说破解更容易，此时我们可以加一些只有系统知道的干扰数据，如用户名和ID（即盐）；这样散列的对象是“密码+用户名+ID”，这样生成的散列值相对来说更难破解。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">String str = <span class="string">"hello"</span>;  </span><br><span class="line">String salt = <span class="string">"123"</span>;  </span><br><span class="line">String md5 = <span class="keyword">new</span> Md5Hash(str, salt).toString();<span class="comment">//还可以转换为 toBase64()/toHex()</span></span><br></pre></td></tr></table></figure>
<p>如上代码通过盐“123”MD5散列“hello”。另外散列时还可以指定散列次数，如2次表示：md5(md5(str))：“new Md5Hash(str, salt, 2).toString()” </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">String str = <span class="string">"hello"</span>;  </span><br><span class="line">String salt = <span class="string">"123"</span>;  </span><br><span class="line">String sha1 = <span class="keyword">new</span> Sha256Hash(str, salt).toString();</span><br></pre></td></tr></table></figure>
<p>使用SHA256算法生成相应的散列数据，另外还有如SHA1、SHA512算法。     </p>
<p> Shiro还提供了通用的散列支持：  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">String str = <span class="string">"hello"</span>;  </span><br><span class="line">String salt = <span class="string">"123"</span>;  </span><br><span class="line"><span class="comment">//内部使用MessageDigest  </span></span><br><span class="line">String simpleHash = <span class="keyword">new</span> SimpleHash(<span class="string">"SHA-1"</span>, str, salt).toString();</span><br></pre></td></tr></table></figure>
<p>通过调用SimpleHash时指定散列算法，其内部使用了Java的MessageDigest实现。</p>
<p> 为了方便使用，Shiro提供了HashService，默认提供了DefaultHashService实现。  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">DefaultHashService hashService = <span class="keyword">new</span> DefaultHashService(); <span class="comment">//默认算法SHA-512  </span></span><br><span class="line">hashService.setHashAlgorithmName(<span class="string">"SHA-512"</span>);  </span><br><span class="line">hashService.setPrivateSalt(<span class="keyword">new</span> SimpleByteSource(<span class="string">"123"</span>)); <span class="comment">//私盐，默认无  </span></span><br><span class="line">hashService.setGeneratePublicSalt(<span class="keyword">true</span>);<span class="comment">//是否生成公盐，默认false  </span></span><br><span class="line">hashService.setRandomNumberGenerator(<span class="keyword">new</span> SecureRandomNumberGenerator());<span class="comment">//用于生成公盐。默认就这个  </span></span><br><span class="line">hashService.setHashIterations(<span class="number">1</span>); <span class="comment">//生成Hash值的迭代次数  </span></span><br><span class="line">  </span><br><span class="line">HashRequest request = <span class="keyword">new</span> HashRequest.Builder()  </span><br><span class="line">            .setAlgorithmName(<span class="string">"MD5"</span>).setSource(ByteSource.Util.bytes(<span class="string">"hello"</span>))  </span><br><span class="line">            .setSalt(ByteSource.Util.bytes(<span class="string">"123"</span>)).setIterations(<span class="number">2</span>).build();  </span><br><span class="line">String hex = hashService.computeHash(request).toHex();</span><br></pre></td></tr></table></figure>
<ol>
<li>首先创建一个DefaultHashService，默认使用SHA-512算法；</li>
<li>可以通过hashAlgorithmName属性修改算法；</li>
<li>可以通过privateSalt设置一个私盐，其在散列时自动与用户传入的公盐混合产生一个新盐；</li>
<li>可以通过generatePublicSalt属性在用户没有传入公盐的情况下是否生成公盐；</li>
<li>可以设置randomNumberGenerator用于生成公盐；</li>
<li>可以设置hashIterations属性来修改默认加密迭代次数；</li>
<li>需要构建一个HashRequest，传入算法、数据、公盐、迭代次数。</li>
</ol>
<p>SecureRandomNumberGenerator用于生成一个随机数：  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">SecureRandomNumberGenerator randomNumberGenerator =  </span><br><span class="line">     <span class="keyword">new</span> SecureRandomNumberGenerator();  </span><br><span class="line">randomNumberGenerator.setSeed(<span class="string">"123"</span>.getBytes());  </span><br><span class="line">String hex = randomNumberGenerator.nextBytes().toHex();</span><br></pre></td></tr></table></figure>
<h4 id="加密-解密"><a href="#加密-解密" class="headerlink" title="加密/解密"></a>加密/解密</h4><p>Shiro还提供对称式加密/解密算法的支持，如AES、Blowfish等；当前还没有提供对非对称加密/解密算法支持，未来版本可能提供。</p>
<p> AES算法实现：  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">AesCipherService aesCipherService = <span class="keyword">new</span> AesCipherService();  </span><br><span class="line">aesCipherService.setKeySize(<span class="number">128</span>); <span class="comment">//设置key长度  </span></span><br><span class="line"><span class="comment">//生成key  </span></span><br><span class="line">Key key = aesCipherService.generateNewKey();  </span><br><span class="line">String text = <span class="string">"hello"</span>;  </span><br><span class="line"><span class="comment">//加密  </span></span><br><span class="line">String encrptText =   </span><br><span class="line">aesCipherService.encrypt(text.getBytes(), key.getEncoded()).toHex();  </span><br><span class="line"><span class="comment">//解密  </span></span><br><span class="line">String text2 =  </span><br><span class="line"> <span class="keyword">new</span> String(aesCipherService.decrypt(Hex.decode(encrptText), key.getEncoded()).getBytes());  </span><br><span class="line">  </span><br><span class="line">Assert.assertEquals(text, text2);</span><br></pre></td></tr></table></figure>
<h4 id="PasswordService-CredentialsMatcher"><a href="#PasswordService-CredentialsMatcher" class="headerlink" title="PasswordService/CredentialsMatcher"></a>PasswordService/CredentialsMatcher</h4><p>Shiro提供了PasswordService及CredentialsMatcher用于提供加密密码及验证密码服务。  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">PasswordService</span> </span>&#123;  </span><br><span class="line">    <span class="comment">//输入明文密码得到密文密码  </span></span><br><span class="line">    <span class="function">String <span class="title">encryptPassword</span><span class="params">(Object plaintextPassword)</span> <span class="keyword">throws</span> IllegalArgumentException</span>;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">CredentialsMatcher</span> </span>&#123;  </span><br><span class="line">    <span class="comment">//匹配用户输入的token的凭证（未加密）与系统提供的凭证（已加密）  </span></span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">doCredentialsMatch</span><span class="params">(AuthenticationToken token, AuthenticationInfo info)</span></span>;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Shiro默认提供了PasswordService实现DefaultPasswordService；CredentialsMatcher实现PasswordMatcher及HashedCredentialsMatcher（更强大）。</p>
<p> <strong>DefaultPasswordService配合PasswordMatcher实现简单的密码加密与验证服务</strong></p>
<ol>
<li>定义Realm（com.github.zhangkaitao.shiro.chapter5.hash.realm.MyRealm） </li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyRealm</span> <span class="keyword">extends</span> <span class="title">AuthorizingRealm</span> </span>&#123;  </span><br><span class="line">    <span class="keyword">private</span> PasswordService passwordService;  </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setPasswordService</span><span class="params">(PasswordService passwordService)</span> </span>&#123;  </span><br><span class="line">        <span class="keyword">this</span>.passwordService = passwordService;  </span><br><span class="line">    &#125;  </span><br><span class="line">     <span class="comment">//省略doGetAuthorizationInfo，具体看代码   </span></span><br><span class="line">    <span class="meta">@Override</span>  </span><br><span class="line">    <span class="function"><span class="keyword">protected</span> AuthenticationInfo <span class="title">doGetAuthenticationInfo</span><span class="params">(AuthenticationToken token)</span> <span class="keyword">throws</span> AuthenticationException </span>&#123;  </span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> SimpleAuthenticationInfo(  </span><br><span class="line">                <span class="string">"wu"</span>,  </span><br><span class="line">                passwordService.encryptPassword(<span class="string">"123"</span>),  </span><br><span class="line">                getName());  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>为了方便，直接注入一个passwordService来加密密码，实际使用时需要在Service层使用passwordService加密密码并存到数据库。</p>
<p> 2、ini配置（shiro-passwordservice.ini）  </p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[main]</span>  </span><br><span class="line"><span class="attr">passwordService</span>=org.apache.shiro.authc.credential.DefaultPasswordService  </span><br><span class="line"><span class="attr">hashService</span>=org.apache.shiro.crypto.hash.DefaultHashService  </span><br><span class="line">passwordService.hashService=$hashService  </span><br><span class="line"><span class="attr">hashFormat</span>=org.apache.shiro.crypto.hash.format.Shiro1CryptFormat  </span><br><span class="line">passwordService.hashFormat=$hashFormat  </span><br><span class="line"><span class="attr">hashFormatFactory</span>=org.apache.shiro.crypto.hash.format.DefaultHashFormatFactory  </span><br><span class="line">passwordService.hashFormatFactory=$hashFormatFactory  </span><br><span class="line">  </span><br><span class="line"><span class="attr">passwordMatcher</span>=org.apache.shiro.authc.credential.PasswordMatcher  </span><br><span class="line">passwordMatcher.passwordService=$passwordService  </span><br><span class="line">  </span><br><span class="line"><span class="attr">myRealm</span>=com.github.zhangkaitao.shiro.chapter5.hash.realm.MyRealm  </span><br><span class="line">myRealm.passwordService=$passwordService  </span><br><span class="line">myRealm.credentialsMatcher=$passwordMatcher  </span><br><span class="line">securityManager.realms=$myRealm</span><br></pre></td></tr></table></figure>
<p>2.1、passwordService使用DefaultPasswordService，如果有必要也可以自定义；</p>
<p>2.2、hashService定义散列密码使用的HashService，默认使用DefaultHashService（默认SHA-256算法）；</p>
<p>2.3、hashFormat用于对散列出的值进行格式化，默认使用Shiro1CryptFormat，另外提供了Base64Format和HexFormat，对于有salt的密码请自定义实现ParsableHashFormat然后把salt格式化到散列值中；</p>
<p>2.4、hashFormatFactory用于根据散列值得到散列的密码和salt；因为如果使用如SHA算法，那么会生成一个salt，此salt需要保存到散列后的值中以便之后与传入的密码比较时使用；默认使用DefaultHashFormatFactory；</p>
<p>2.5、passwordMatcher使用PasswordMatcher，其是一个CredentialsMatcher实现；</p>
<p>2.6、将credentialsMatcher赋值给myRealm，myRealm间接继承了AuthenticatingRealm，其在调用getAuthenticationInfo方法获取到AuthenticationInfo信息后，会使用credentialsMatcher来验证凭据是否匹配，如果不匹配将抛出IncorrectCredentialsException异常。</p>
<p>如上方式的缺点是：salt保存在散列值中；没有实现如密码重试次数限制。</p>
<p><strong>HashedCredentialsMatcher实现密码验证服务</strong></p>
<p> Shiro提供了CredentialsMatcher的散列实现HashedCredentialsMatcher，和之前的PasswordMatcher不同的是，它只用于密码验证，且可以提供自己的盐，而不是随机生成盐，且生成密码散列值的算法需要自己写，因为能提供自己的盐。 </p>
<p><strong>1、生成密码散列值</strong></p>
<p> 此处我们使用MD5算法，“密码+盐（用户名+随机数）”的方式生成散列值：  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">String algorithmName = <span class="string">"md5"</span>;  </span><br><span class="line">String username = <span class="string">"liu"</span>;  </span><br><span class="line">String password = <span class="string">"123"</span>;  </span><br><span class="line">String salt1 = username;  </span><br><span class="line">String salt2 = <span class="keyword">new</span> SecureRandomNumberGenerator().nextBytes().toHex();  </span><br><span class="line"><span class="keyword">int</span> hashIterations = <span class="number">2</span>;  </span><br><span class="line">  </span><br><span class="line">SimpleHash hash = <span class="keyword">new</span> SimpleHash(algorithmName, password, salt1 + salt2, hashIterations);  </span><br><span class="line">String encodedPassword = hash.toHex();</span><br></pre></td></tr></table></figure>
<p>如果要写用户模块，需要在新增用户/重置密码时使用如上算法保存密码，将生成的密码及salt2存入数据库（因为我们的散列算法是：md5(md5(密码+username+salt2))）。</p>
<p> 2、生成Realm（com.github.zhangkaitao.shiro.chapter5.hash.realm.MyRealm2） </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> AuthenticationInfo <span class="title">doGetAuthenticationInfo</span><span class="params">(AuthenticationToken token)</span> <span class="keyword">throws</span> AuthenticationException </span>&#123;  </span><br><span class="line">    String username = <span class="string">"liu"</span>; <span class="comment">//用户名及salt1  </span></span><br><span class="line">    String password = <span class="string">"202cb962ac59075b964b07152d234b70"</span>; <span class="comment">//加密后的密码  </span></span><br><span class="line">    String salt2 = <span class="string">"202cb962ac59075b964b07152d234b70"</span>;  </span><br><span class="line">SimpleAuthenticationInfo ai =   </span><br><span class="line">        <span class="keyword">new</span> SimpleAuthenticationInfo(username, password, getName());  </span><br><span class="line">    ai.setCredentialsSalt(ByteSource.Util.bytes(username+salt2)); <span class="comment">//盐是用户名+随机数  </span></span><br><span class="line">        <span class="keyword">return</span> ai;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>此处就是把步骤1中生成的相应数据组装为SimpleAuthenticationInfo，通过SimpleAuthenticationInfo的credentialsSalt设置盐，HashedCredentialsMatcher会自动识别这个盐。</p>
<p> 如果使用JdbcRealm，需要修改获取用户信息（包括盐）的sql：“select password, password_salt from users where username = ?”，而我们的盐是由username+password_salt组成，所以需要通过如下ini配置（shiro-jdbc-hashedCredentialsMatcher.ini）修改：  </p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">jdbcRealm.saltStyle=COLUMN  </span><br><span class="line">jdbcRealm.authenticationQuery=select password, concat(username,password_salt) from users where username = ?  </span><br><span class="line">jdbcRealm.credentialsMatcher=$credentialsMatcher</span><br></pre></td></tr></table></figure>
<p>1、saltStyle表示使用密码+盐的机制，authenticationQuery第一列是密码，第二列是盐；</p>
<p>2、通过authenticationQuery指定密码及盐查询SQL；</p>
<p>此处还要注意Shiro默认使用了apache commons BeanUtils，默认是不进行Enum类型转型的，此时需要自己注册一个Enum转换器“BeanUtilsBean.getInstance().getConvertUtils().register(new EnumConverter(), JdbcRealm.SaltStyle.class);”具体请参考示例“com.github.zhangkaitao.shiro.chapter5.hash.PasswordTest”中的代码。 </p>
<p>另外可以参考配置shiro-jdbc-passwordservice.ini，提供了JdbcRealm的测试用例，测试前请先调用sql/shiro-init-data.sql初始化用户数据。</p>
<p>3、ini配置（shiro-hashedCredentialsMatcher.ini）  </p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[main]</span>  </span><br><span class="line"><span class="attr">credentialsMatcher</span>=org.apache.shiro.authc.credential.HashedCredentialsMatcher  </span><br><span class="line">credentialsMatcher.hashAlgorithmName=md5  </span><br><span class="line">credentialsMatcher.hashIterations=2  </span><br><span class="line">credentialsMatcher.storedCredentialsHexEncoded=true  </span><br><span class="line"><span class="attr">myRealm</span>=com.github.zhangkaitao.shiro.chapter5.hash.realm.MyRealm2  </span><br><span class="line">myRealm.credentialsMatcher=$credentialsMatcher  </span><br><span class="line">securityManager.realms=$myRealm</span><br></pre></td></tr></table></figure>
<p>1、通过credentialsMatcher.hashAlgorithmName=md5指定散列算法为md5，需要和生成密码时的一样；</p>
<p>2、credentialsMatcher.hashIterations=2，散列迭代次数，需要和生成密码时的意义；</p>
<p>3、credentialsMatcher.storedCredentialsHexEncoded=true表示是否存储散列后的密码为16进制，需要和生成密码时的一样，默认是base64；</p>
<p>此处最需要注意的就是HashedCredentialsMatcher的算法需要和生成密码时的算法一样。另外HashedCredentialsMatcher会自动根据AuthenticationInfo的类型是否是SaltedAuthenticationInfo来获取credentialsSalt盐。 </p>
<p><strong>密码重试次数限制</strong></p>
<p>如在1个小时内密码最多重试5次，如果尝试次数超过5次就锁定1小时，1小时后可再次重试，如果还是重试失败，可以锁定如1天，以此类推，防止密码被暴力破解。我们通过继承HashedCredentialsMatcher，且使用Ehcache记录重试次数和超时时间。</p>
 <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">doCredentialsMatch</span><span class="params">(AuthenticationToken token, AuthenticationInfo info)</span> </span>&#123;  </span><br><span class="line">       String username = (String)token.getPrincipal();  </span><br><span class="line">        <span class="comment">//retry count + 1  </span></span><br><span class="line">        Element element = passwordRetryCache.get(username);  </span><br><span class="line">        <span class="keyword">if</span>(element == <span class="keyword">null</span>) &#123;  </span><br><span class="line">            element = <span class="keyword">new</span> Element(username , <span class="keyword">new</span> AtomicInteger(<span class="number">0</span>));  </span><br><span class="line">            passwordRetryCache.put(element);  </span><br><span class="line">        &#125;  </span><br><span class="line">        AtomicInteger retryCount = (AtomicInteger)element.getObjectValue();  </span><br><span class="line">        <span class="keyword">if</span>(retryCount.incrementAndGet() &gt; <span class="number">5</span>) &#123;  </span><br><span class="line">            <span class="comment">//if retry count &gt; 5 throw  </span></span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> ExcessiveAttemptsException();  </span><br><span class="line">        &#125;  </span><br><span class="line">  </span><br><span class="line">        <span class="keyword">boolean</span> matches = <span class="keyword">super</span>.doCredentialsMatch(token, info);  </span><br><span class="line">        <span class="keyword">if</span>(matches) &#123;  </span><br><span class="line">            <span class="comment">//clear retry count  </span></span><br><span class="line">            passwordRetryCache.remove(username);  </span><br><span class="line">        &#125;  </span><br><span class="line">        <span class="keyword">return</span> matches;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如上代码逻辑比较简单，即如果密码输入正确清除cache中的记录；否则cache中的重试次数+1，如果超出5次那么抛出异常表示超出重试次数了。</p>
<h3 id="Realm及相关对象"><a href="#Realm及相关对象" class="headerlink" title="Realm及相关对象"></a>Realm及相关对象</h3><h4 id="Realm-1"><a href="#Realm-1" class="headerlink" title="Realm"></a>Realm</h4><p>接下来看下一般真实环境下的Realm如何实现。</p>
<p><strong>1、定义实体及关系</strong></p>
<p> <img src="http://dl2.iteye.com/upload/attachment/0094/1329/dd9f6a00-f6bc-3563-8afd-0c11048060b8.png" alt=""></p>
<p>上图表示  用户-角色之间是多对多关系，角色-权限之间是多对多关系；且用户和权限之间通过角色建立关系；在系统中验证时通过权限验证，角色只是权限集合，即所谓的显示角色；其实权限应该对应到资源（如菜单、URL、页面按钮、Java方法等）中，即应该将权限字符串存储到资源实体中，但是目前为了简单化，直接提取一个权限表。</p>
<p>用户实体包括：编号(id)、用户名(username)、密码(password)、盐(salt)、是否锁定(locked)；是否锁定用于封禁用户使用，其实最好使用Enum字段存储，可以实现更复杂的用户状态实现。</p>
<p>角色实体包括：、编号(id)、角色标识符（role）、描述（description）、是否可用（available）；其中角色标识符用于在程序中进行隐式角色判断的，描述用于以后再前台界面显示的、是否可用表示角色当前是否激活。</p>
<p>权限实体包括：编号（id）、权限标识符（permission）、描述（description）、是否可用（available）；含义和角色实体类似不再阐述。</p>
<p>另外还有两个关系实体：用户-角色实体（用户编号、角色编号，且组合为复合主键）；角色-权限实体（角色编号、权限编号，且组合为复合主键）。</p>
<p> <strong>2、环境准备</strong></p>
<p> 为了方便数据库操作，使用了“org.springframework: spring-jdbc: 4.0.0.RELEASE”依赖，虽然是spring4版本的，但使用上和spring3无区别。其他依赖请参考源码的pom.xml。</p>
<p> <strong>3、定义Service及Dao</strong></p>
<p> 为了实现的简单性，只实现必须的功能，其他的可以自己实现即可。</p>
<p> <strong>PermissionService</strong>  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">PermissionService</span> </span>&#123;  </span><br><span class="line">    <span class="function"><span class="keyword">public</span> Permission <span class="title">createPermission</span><span class="params">(Permission permission)</span></span>;  </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">deletePermission</span><span class="params">(Long permissionId)</span></span>;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>实现基本的创建/删除权限。</p>
<p> <strong>RoleService</strong>  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">RoleService</span> </span>&#123;  </span><br><span class="line">    <span class="function"><span class="keyword">public</span> Role <span class="title">createRole</span><span class="params">(Role role)</span></span>;  </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">deleteRole</span><span class="params">(Long roleId)</span></span>;  </span><br><span class="line">    <span class="comment">//添加角色-权限之间关系  </span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">correlationPermissions</span><span class="params">(Long roleId, Long... permissionIds)</span></span>;  </span><br><span class="line">    <span class="comment">//移除角色-权限之间关系  </span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">uncorrelationPermissions</span><span class="params">(Long roleId, Long... permissionIds)</span></span>;<span class="comment">//  </span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>相对于PermissionService多了关联/移除关联角色-权限功能。</p>
<p> <strong>UserService</strong>  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">UserService</span> </span>&#123;  </span><br><span class="line">    <span class="function"><span class="keyword">public</span> User <span class="title">createUser</span><span class="params">(User user)</span></span>; <span class="comment">//创建账户  </span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">changePassword</span><span class="params">(Long userId, String newPassword)</span></span>;<span class="comment">//修改密码  </span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">correlationRoles</span><span class="params">(Long userId, Long... roleIds)</span></span>; <span class="comment">//添加用户-角色关系  </span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">uncorrelationRoles</span><span class="params">(Long userId, Long... roleIds)</span></span>;<span class="comment">// 移除用户-角色关系  </span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> User <span class="title">findByUsername</span><span class="params">(String username)</span></span>;<span class="comment">// 根据用户名查找用户  </span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Set&lt;String&gt; <span class="title">findRoles</span><span class="params">(String username)</span></span>;<span class="comment">// 根据用户名查找其角色  </span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Set&lt;String&gt; <span class="title">findPermissions</span><span class="params">(String username)</span></span>; <span class="comment">//根据用户名查找其权限  </span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>此处使用findByUsername、findRoles及findPermissions来查找用户名对应的帐号、角色及权限信息。之后的Realm就使用这些方法来查找相关信息。 </p>
<p><strong>UserServiceImpl</strong>   </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> User <span class="title">createUser</span><span class="params">(User user)</span> </span>&#123;  </span><br><span class="line">    <span class="comment">//加密密码  </span></span><br><span class="line">    passwordHelper.encryptPassword(user);  </span><br><span class="line">    <span class="keyword">return</span> userDao.createUser(user);  </span><br><span class="line">&#125;  </span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">changePassword</span><span class="params">(Long userId, String newPassword)</span> </span>&#123;  </span><br><span class="line">    User user =userDao.findOne(userId);  </span><br><span class="line">    user.setPassword(newPassword);  </span><br><span class="line">    passwordHelper.encryptPassword(user);  </span><br><span class="line">    userDao.updateUser(user);  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在创建账户及修改密码时直接把生成密码操作委托给PasswordHelper。</p>
<p> <strong>PasswordHelper</strong> </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PasswordHelper</span> </span>&#123;  </span><br><span class="line">    <span class="keyword">private</span> RandomNumberGenerator randomNumberGenerator =  </span><br><span class="line">     <span class="keyword">new</span> SecureRandomNumberGenerator();  </span><br><span class="line">    <span class="keyword">private</span> String algorithmName = <span class="string">"md5"</span>;  </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> hashIterations = <span class="number">2</span>;  </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">encryptPassword</span><span class="params">(User user)</span> </span>&#123;  </span><br><span class="line">        user.setSalt(randomNumberGenerator.nextBytes().toHex());  </span><br><span class="line">        String newPassword = <span class="keyword">new</span> SimpleHash(  </span><br><span class="line">                algorithmName,  </span><br><span class="line">                user.getPassword(),  </span><br><span class="line">                ByteSource.Util.bytes(user.getCredentialsSalt()),  </span><br><span class="line">                hashIterations).toHex();  </span><br><span class="line">        user.setPassword(newPassword);  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>之后的CredentialsMatcher需要和此处加密的算法一样。user.getCredentialsSalt()辅助方法返回username+salt。</p>
<p>为了节省篇幅，对于DAO/Service的接口及实现，具体请参考源码com.github.zhangkaitao.shiro.chapter6。另外请参考Service层的测试用例com.github.zhangkaitao.shiro.chapter6.service.ServiceTest。</p>
<p><strong>4、定义Realm</strong></p>
<p> <strong>RetryLimitHashedCredentialsMatcher</strong>  </p>
<p><strong>UserRealm</strong> </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserRealm</span> <span class="keyword">extends</span> <span class="title">AuthorizingRealm</span> </span>&#123;  </span><br><span class="line">    <span class="keyword">private</span> UserService userService = <span class="keyword">new</span> UserServiceImpl();  </span><br><span class="line">    <span class="function"><span class="keyword">protected</span> AuthorizationInfo <span class="title">doGetAuthorizationInfo</span><span class="params">(PrincipalCollection principals)</span> </span>&#123;  </span><br><span class="line">        String username = (String)principals.getPrimaryPrincipal();  </span><br><span class="line">        SimpleAuthorizationInfo authorizationInfo = <span class="keyword">new</span> SimpleAuthorizationInfo();  </span><br><span class="line">        authorizationInfo.setRoles(userService.findRoles(username));  </span><br><span class="line">        authorizationInfo.setStringPermissions(userService.findPermissions(username));  </span><br><span class="line">        <span class="keyword">return</span> authorizationInfo;  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="function"><span class="keyword">protected</span> AuthenticationInfo <span class="title">doGetAuthenticationInfo</span><span class="params">(AuthenticationToken token)</span> <span class="keyword">throws</span> AuthenticationException </span>&#123;  </span><br><span class="line">        String username = (String)token.getPrincipal();  </span><br><span class="line">        User user = userService.findByUsername(username);  </span><br><span class="line">        <span class="keyword">if</span>(user == <span class="keyword">null</span>) &#123;  </span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> UnknownAccountException();<span class="comment">//没找到帐号  </span></span><br><span class="line">        &#125;  </span><br><span class="line">        <span class="keyword">if</span>(Boolean.TRUE.equals(user.getLocked())) &#123;  </span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> LockedAccountException(); <span class="comment">//帐号锁定  </span></span><br><span class="line">        &#125;  </span><br><span class="line">        <span class="comment">//交给AuthenticatingRealm使用CredentialsMatcher进行密码匹配，如果觉得人家的不好可以在此判断或自定义实现  </span></span><br><span class="line">        SimpleAuthenticationInfo authenticationInfo = <span class="keyword">new</span> SimpleAuthenticationInfo(  </span><br><span class="line">                user.getUsername(), <span class="comment">//用户名  </span></span><br><span class="line">                user.getPassword(), <span class="comment">//密码  </span></span><br><span class="line">                ByteSource.Util.bytes(user.getCredentialsSalt()),<span class="comment">//salt=username+salt  </span></span><br><span class="line">                getName()  <span class="comment">//realm name  </span></span><br><span class="line">        );  </span><br><span class="line">        <span class="keyword">return</span> authenticationInfo;  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>1、UserRealm父类AuthorizingRealm将获取Subject相关信息分成两步</strong>：获取身份验证信息（doGetAuthenticationInfo）及授权信息（doGetAuthorizationInfo）；</p>
<p><strong>2、doGetAuthenticationInfo获取身份验证相关信息</strong>：首先根据传入的用户名获取User信息；然后如果user为空，那么抛出没找到帐号异常UnknownAccountException；如果user找到但锁定了抛出锁定异常LockedAccountException；最后生成AuthenticationInfo信息，交给间接父类AuthenticatingRealm使用CredentialsMatcher进行判断密码是否匹配，如果不匹配将抛出密码错误异常IncorrectCredentialsException；另外如果密码重试此处太多将抛出超出重试次数异常ExcessiveAttemptsException；在组装SimpleAuthenticationInfo信息时，需要传入：身份信息（用户名）、凭据（密文密码）、盐（username+salt），CredentialsMatcher使用盐加密传入的明文密码和此处的密文密码进行匹配。</p>
<p><strong>3、doGetAuthorizationInfo获取授权信息</strong>：PrincipalCollection是一个身份集合，因为我们现在就一个Realm，所以直接调用getPrimaryPrincipal得到之前传入的用户名即可；然后根据用户名调用UserService接口获取角色及权限信息。</p>
<p><strong>5、测试用例</strong></p>
<p>为了节省篇幅，请参考测试用例com.github.zhangkaitao.shiro.chapter6.realm.UserRealmTest。包含了：登录成功、用户名错误、密码错误、密码超出重试次数、有/没有角色、有/没有权限的测试。</p>
<h4 id="AuthenticationToken"><a href="#AuthenticationToken" class="headerlink" title="AuthenticationToken"></a>AuthenticationToken</h4><p><img src="http://dl2.iteye.com/upload/attachment/0094/1333/6c026012-2583-3a26-af70-bb1b0eae491b.png" alt=""></p>
<p>AuthenticationToken用于收集用户提交的身份（如用户名）及凭据（如密码）：  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">AuthenticationToken</span> <span class="keyword">extends</span> <span class="title">Serializable</span> </span>&#123;  </span><br><span class="line">    <span class="function">Object <span class="title">getPrincipal</span><span class="params">()</span></span>; <span class="comment">//身份  </span></span><br><span class="line">    <span class="function">Object <span class="title">getCredentials</span><span class="params">()</span></span>; <span class="comment">//凭据  </span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>扩展接口RememberMeAuthenticationToken：提供了“boolean isRememberMe()”现“记住我”的功能；</p>
<p>扩展接口是HostAuthenticationToken：提供了“String getHost()”方法用于获取用户“主机”的功能。</p>
<p>Shiro提供了一个直接拿来用的UsernamePasswordToken，用于实现用户名/密码Token组，另外其实现了RememberMeAuthenticationToken和HostAuthenticationToken，可以实现记住我及主机验证的支持。</p>
<h4 id="AuthenticationInfo"><a href="#AuthenticationInfo" class="headerlink" title="AuthenticationInfo"></a>AuthenticationInfo</h4><p><img src="http://dl2.iteye.com/upload/attachment/0094/1337/0be597af-cd61-34ce-b1f0-8ebd15dbdeb9.png" alt=""></p>
<p>AuthenticationInfo有两个作用：</p>
<p> 1、如果Realm是AuthenticatingRealm子类，则提供给AuthenticatingRealm内部使用的CredentialsMatcher进行凭据验证；（如果没有继承它需要在自己的Realm中自己实现验证）；</p>
<p> 2、提供给SecurityManager来创建Subject（提供身份信息）；</p>
<p> MergableAuthenticationInfo用于提供在多Realm时合并AuthenticationInfo的功能，主要合并Principal、如果是其他的如credentialsSalt，会用后边的信息覆盖前边的。</p>
<p>比如HashedCredentialsMatcher，在验证时会判断AuthenticationInfo是否是SaltedAuthenticationInfo子类，来获取盐信息。</p>
<p>Account相当于我们之前的User，SimpleAccount是其一个实现；在IniRealm、PropertiesRealm这种静态创建帐号信息的场景中使用，这些Realm直接继承了SimpleAccountRealm，而SimpleAccountRealm提供了相关的API来动态维护SimpleAccount；即可以通过这些API来动态增删改查SimpleAccount；动态增删改查角色/权限信息。及如果您的帐号不是特别多，可以使用这种方式，具体请参考SimpleAccountRealm Javadoc。</p>
<h4 id="PrincipalCollection"><a href="#PrincipalCollection" class="headerlink" title="PrincipalCollection"></a>PrincipalCollection</h4><p> <img src="http://dl2.iteye.com/upload/attachment/0094/1341/772c988b-e930-31d1-ad14-c9ae8f476f66.png" alt=""></p>
<p>因为我们可以在Shiro中同时配置多个Realm，所以呢身份信息可能就有多个；因此其提供了PrincipalCollection 用于聚合这些身份信息：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">PrincipalCollection</span> <span class="keyword">extends</span> <span class="title">Iterable</span>, <span class="title">Serializable</span> </span>&#123;  </span><br><span class="line">    <span class="function">Object <span class="title">getPrimaryPrincipal</span><span class="params">()</span></span>; <span class="comment">//得到主要的身份  </span></span><br><span class="line">    &lt;T&gt; <span class="function">T <span class="title">oneByType</span><span class="params">(Class&lt;T&gt; type)</span></span>; <span class="comment">//根据身份类型获取第一个  </span></span><br><span class="line">    &lt;T&gt; <span class="function">Collection&lt;T&gt; <span class="title">byType</span><span class="params">(Class&lt;T&gt; type)</span></span>; <span class="comment">//根据身份类型获取一组  </span></span><br><span class="line">    <span class="function">List <span class="title">asList</span><span class="params">()</span></span>; <span class="comment">//转换为List  </span></span><br><span class="line">    <span class="function">Set <span class="title">asSet</span><span class="params">()</span></span>; <span class="comment">//转换为Set  </span></span><br><span class="line">    <span class="function">Collection <span class="title">fromRealm</span><span class="params">(String realmName)</span></span>; <span class="comment">//根据Realm名字获取  </span></span><br><span class="line">    <span class="function">Set&lt;String&gt; <span class="title">getRealmNames</span><span class="params">()</span></span>; <span class="comment">//获取所有身份验证通过的Realm名字  </span></span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">isEmpty</span><span class="params">()</span></span>; <span class="comment">//判断是否为空  </span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>因为PrincipalCollection聚合了多个，此处最需要注意的是getPrimaryPrincipal，如果只有一个Principal那么直接返回即可，如果有多个Principal，则返回第一个（因为内部使用Map存储，所以可以认为是返回任意一个）；oneByType / byType根据凭据的类型返回相应的Principal；fromRealm根据Realm名字（每个Principal都与一个Realm关联）获取相应的Principal。</p>
<p>MutablePrincipalCollection是一个可变的PrincipalCollection接口，即提供了如下可变方法：  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">MutablePrincipalCollection</span> <span class="keyword">extends</span> <span class="title">PrincipalCollection</span> </span>&#123;  </span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">add</span><span class="params">(Object principal, String realmName)</span></span>; <span class="comment">//添加Realm-Principal的关联  </span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">addAll</span><span class="params">(Collection principals, String realmName)</span></span>; <span class="comment">//添加一组Realm-Principal的关联  </span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">addAll</span><span class="params">(PrincipalCollection principals)</span></span>;<span class="comment">//添加PrincipalCollection  </span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">clear</span><span class="params">()</span></span>;<span class="comment">//清空  </span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>目前Shiro只提供了一个实现SimplePrincipalCollection，还记得之前的AuthenticationStrategy实现嘛，用于在多Realm时判断是否满足条件的，在大多数实现中（继承了AbstractAuthenticationStrategy）afterAttempt方法会进行AuthenticationInfo（实现了MergableAuthenticationInfo）的merge，比如SimpleAuthenticationInfo会合并多个Principal为一个PrincipalCollection。</p>
<p>对于PrincipalMap是Shiro 1.2中的一个实验品，暂时无用，具体可以参考其Javadoc。接下来通过示例来看看PrincipalCollection。</p>
<p><strong>1、准备三个Realm</strong></p>
<p> <strong>MyRealm1</strong> </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyRealm1</span> <span class="keyword">implements</span> <span class="title">Realm</span> </span>&#123;  </span><br><span class="line">    <span class="meta">@Override</span>  </span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123;  </span><br><span class="line">        <span class="keyword">return</span> <span class="string">"a"</span>; <span class="comment">//realm name 为 “a”  </span></span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="comment">//省略supports方法，具体请见源码  </span></span><br><span class="line">    <span class="meta">@Override</span>  </span><br><span class="line">    <span class="function"><span class="keyword">public</span> AuthenticationInfo <span class="title">getAuthenticationInfo</span><span class="params">(AuthenticationToken token)</span> <span class="keyword">throws</span> AuthenticationException </span>&#123;  </span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> SimpleAuthenticationInfo(  </span><br><span class="line">                <span class="string">"zhang"</span>, <span class="comment">//身份 字符串类型  </span></span><br><span class="line">                <span class="string">"123"</span>,   <span class="comment">//凭据  </span></span><br><span class="line">                getName() <span class="comment">//Realm Name  </span></span><br><span class="line">        );  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>MyRealm2</strong>  </p>
<p>和MyRealm1完全一样，只是Realm名字为b。</p>
<p> <strong>MyRealm3</strong> </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyRealm3</span> <span class="keyword">implements</span> <span class="title">Realm</span> </span>&#123;  </span><br><span class="line">    <span class="meta">@Override</span>  </span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123;  </span><br><span class="line">        <span class="keyword">return</span> <span class="string">"c"</span>; <span class="comment">//realm name 为 “c”  </span></span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="comment">//省略supports方法，具体请见源码  </span></span><br><span class="line">    <span class="meta">@Override</span>  </span><br><span class="line">    <span class="function"><span class="keyword">public</span> AuthenticationInfo <span class="title">getAuthenticationInfo</span><span class="params">(AuthenticationToken token)</span> <span class="keyword">throws</span> AuthenticationException </span>&#123;  </span><br><span class="line">        User user = <span class="keyword">new</span> User(<span class="string">"zhang"</span>, <span class="string">"123"</span>);  </span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> SimpleAuthenticationInfo(  </span><br><span class="line">                user, <span class="comment">//身份 User类型  </span></span><br><span class="line">                <span class="string">"123"</span>,   <span class="comment">//凭据  </span></span><br><span class="line">                getName() <span class="comment">//Realm Name  </span></span><br><span class="line">        );  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>和MyRealm1同名，但返回的Principal是User类型。</p>
<h4 id="AuthorizationInfo"><a href="#AuthorizationInfo" class="headerlink" title="AuthorizationInfo"></a>AuthorizationInfo</h4><p><img src="http://dl2.iteye.com/upload/attachment/0094/1345/c8868cea-6b01-34cc-b7be-45ee244bd217.png" alt=""></p>
<p>AuthorizationInfo用于聚合授权信息的：  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">AuthorizationInfo</span> <span class="keyword">extends</span> <span class="title">Serializable</span> </span>&#123;  </span><br><span class="line">    <span class="function">Collection&lt;String&gt; <span class="title">getRoles</span><span class="params">()</span></span>; <span class="comment">//获取角色字符串信息  </span></span><br><span class="line">    <span class="function">Collection&lt;String&gt; <span class="title">getStringPermissions</span><span class="params">()</span></span>; <span class="comment">//获取权限字符串信息  </span></span><br><span class="line">    <span class="function">Collection&lt;Permission&gt; <span class="title">getObjectPermissions</span><span class="params">()</span></span>; <span class="comment">//获取Permission对象信息  </span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>当我们使用AuthorizingRealm时，如果身份验证成功，在进行授权时就通过doGetAuthorizationInfo方法获取角色/权限信息用于授权验证。</p>
<p>Shiro提供了一个实现SimpleAuthorizationInfo，大多数时候使用这个即可。</p>
<p> 对于Account及SimpleAccount，之前的【6.3 AuthenticationInfo】已经介绍过了，用于SimpleAccountRealm子类，实现动态角色/权限维护的。</p>
<h4 id="Subject"><a href="#Subject" class="headerlink" title="Subject"></a>Subject</h4><p> <img src="http://dl2.iteye.com/upload/attachment/0094/1347/131b0c95-9aed-36b0-9c09-0a6f9c6b3605.png" alt=""></p>
<p>Subject是Shiro的核心对象，基本所有身份验证、授权都是通过Subject完成。</p>
<p> <strong>1、身份信息获取</strong>  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">Object <span class="title">getPrincipal</span><span class="params">()</span></span>; <span class="comment">//Primary Principal  </span></span><br><span class="line"><span class="function">PrincipalCollection <span class="title">getPrincipals</span><span class="params">()</span></span>; <span class="comment">// PrincipalCollection</span></span><br></pre></td></tr></table></figure>
<p><strong>2、身份验证</strong>  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">login</span><span class="params">(AuthenticationToken token)</span> <span class="keyword">throws</span> AuthenticationException</span>;  </span><br><span class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">isAuthenticated</span><span class="params">()</span></span>;  </span><br><span class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">isRemembered</span><span class="params">()</span></span>;</span><br></pre></td></tr></table></figure>
<p>通过login登录，如果登录失败将抛出相应的AuthenticationException，如果登录成功调用isAuthenticated就会返回true，即已经通过身份验证；如果isRemembered返回true，表示是通过记住我功能登录的而不是调用login方法登录的。isAuthenticated/isRemembered是互斥的，即如果其中一个返回true，另一个返回false。</p>
<p> <strong>3、角色授权验证</strong>   </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">hasRole</span><span class="params">(String roleIdentifier)</span></span>;  </span><br><span class="line"><span class="keyword">boolean</span>[] hasRoles(List&lt;String&gt; roleIdentifiers);  </span><br><span class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">hasAllRoles</span><span class="params">(Collection&lt;String&gt; roleIdentifiers)</span></span>;  </span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">checkRole</span><span class="params">(String roleIdentifier)</span> <span class="keyword">throws</span> AuthorizationException</span>;  </span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">checkRoles</span><span class="params">(Collection&lt;String&gt; roleIdentifiers)</span> <span class="keyword">throws</span> AuthorizationException</span>;  </span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">checkRoles</span><span class="params">(String... roleIdentifiers)</span> <span class="keyword">throws</span> AuthorizationException</span>;</span><br></pre></td></tr></table></figure>
<p>hasRole<em>进行角色验证，验证后返回true/false；而checkRole</em>验证失败时抛出AuthorizationException异常。 </p>
<p> <strong>4、权限授权验证</strong>  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">isPermitted</span><span class="params">(String permission)</span></span>;  </span><br><span class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">isPermitted</span><span class="params">(Permission permission)</span></span>;  </span><br><span class="line"><span class="keyword">boolean</span>[] isPermitted(String... permissions);  </span><br><span class="line"><span class="keyword">boolean</span>[] isPermitted(List&lt;Permission&gt; permissions);  </span><br><span class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">isPermittedAll</span><span class="params">(String... permissions)</span></span>;  </span><br><span class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">isPermittedAll</span><span class="params">(Collection&lt;Permission&gt; permissions)</span></span>;  </span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">checkPermission</span><span class="params">(String permission)</span> <span class="keyword">throws</span> AuthorizationException</span>;  </span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">checkPermission</span><span class="params">(Permission permission)</span> <span class="keyword">throws</span> AuthorizationException</span>;  </span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">checkPermissions</span><span class="params">(String... permissions)</span> <span class="keyword">throws</span> AuthorizationException</span>;  </span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">checkPermissions</span><span class="params">(Collection&lt;Permission&gt; permissions)</span> <span class="keyword">throws</span> AuthorizationException</span>;</span><br></pre></td></tr></table></figure>
<p>isPermitted<em>进行权限验证，验证后返回true/false；而checkPermission</em>验证失败时抛出AuthorizationException。</p>
<p> <strong>5、会话</strong>  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">Session <span class="title">getSession</span><span class="params">()</span></span>; <span class="comment">//相当于getSession(true)  </span></span><br><span class="line"><span class="function">Session <span class="title">getSession</span><span class="params">(<span class="keyword">boolean</span> create)</span></span>;</span><br></pre></td></tr></table></figure>
<p>类似于Web中的会话。如果登录成功就相当于建立了会话，接着可以使用getSession获取；如果create=false如果没有会话将返回null，而create=true如果没有会话会强制创建一个。</p>
<p> <strong>6、退出</strong>   </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">logout</span><span class="params">()</span></span>;</span><br></pre></td></tr></table></figure>
<p><strong>7、RunAs</strong>    </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">runAs</span><span class="params">(PrincipalCollection principals)</span> <span class="keyword">throws</span> NullPointerException, IllegalStateException</span>;  </span><br><span class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">isRunAs</span><span class="params">()</span></span>;  </span><br><span class="line"><span class="function">PrincipalCollection <span class="title">getPreviousPrincipals</span><span class="params">()</span></span>;  </span><br><span class="line"><span class="function">PrincipalCollection <span class="title">releaseRunAs</span><span class="params">()</span></span>;</span><br></pre></td></tr></table></figure>
<p>RunAs即实现“允许A假设为B身份进行访问”；通过调用subject.runAs(b)进行访问；接着调用subject.getPrincipals将获取到B的身份；此时调用isRunAs将返回true；而a的身份需要通过subject. getPreviousPrincipals获取；如果不需要RunAs了调用subject. releaseRunAs即可。</p>
<p> <strong>8、多线程</strong>  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;V&gt; <span class="function">V <span class="title">execute</span><span class="params">(Callable&lt;V&gt; callable)</span> <span class="keyword">throws</span> ExecutionException</span>;  </span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">execute</span><span class="params">(Runnable runnable)</span></span>;  </span><br><span class="line">&lt;V&gt; <span class="function">Callable&lt;V&gt; <span class="title">associateWith</span><span class="params">(Callable&lt;V&gt; callable)</span></span>;  </span><br><span class="line"><span class="function">Runnable <span class="title">associateWith</span><span class="params">(Runnable runnable)</span></span>;</span><br></pre></td></tr></table></figure>
<p>实现线程之间的Subject传播，因为Subject是线程绑定的；因此在多线程执行中需要传播到相应的线程才能获取到相应的Subject。最简单的办法就是通过execute(runnable/callable实例)直接调用；或者通过associateWith(runnable/callable实例)得到一个包装后的实例；它们都是通过：1、把当前线程的Subject绑定过去；2、在线程执行结束后自动释放。 </p>
<p>Subject自己不会实现相应的身份验证/授权逻辑，而是通过DelegatingSubject委托给SecurityManager实现；及可以理解为Subject是一个面门。</p>
<p>对于Subject的构建一般没必要我们去创建；一般通过SecurityUtils.getSubject()获取：  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Subject <span class="title">getSubject</span><span class="params">()</span> </span>&#123;  </span><br><span class="line">    Subject subject = ThreadContext.getSubject();  </span><br><span class="line">    <span class="keyword">if</span> (subject == <span class="keyword">null</span>) &#123;  </span><br><span class="line">        subject = (<span class="keyword">new</span> Subject.Builder()).buildSubject();  </span><br><span class="line">        ThreadContext.bind(subject);  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="keyword">return</span> subject;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>即首先查看当前线程是否绑定了Subject，如果没有通过Subject.Builder构建一个然后绑定到现场返回。</p>
<p> 如果想自定义创建，可以通过：  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">new</span> Subject.Builder().principals(身份).authenticated(<span class="keyword">true</span>/<span class="keyword">false</span>).buildSubject()</span><br></pre></td></tr></table></figure>
<p>这种可以创建相应的Subject实例了，然后自己绑定到线程即可。在new Builder()时如果没有传入SecurityManager，自动调用SecurityUtils.getSecurityManager获取；也可以自己传入一个实例。</p>
<p> 对于Subject我们一般这么使用：</p>
<p><strong>1.身份验证（login）</strong></p>
<p><strong>2.授权（hasRole*/isPermitted<em>或checkRole</em>/checkPermission*）</strong></p>
<p><strong>3.将相应的数据存储到会话（Session）</strong></p>
<p><strong>4.切换身份（RunAs）/多线程身份传播</strong></p>
<p><strong>5.退出</strong></p>
<p>而我们必须的功能就是1、2、5。到目前为止我们就可以使用Shiro进行应用程序的安全控制了，但是还是缺少如对Web验证、Java方法验证等的一些简化实现。      </p>
<h3 id="与Web集成"><a href="#与Web集成" class="headerlink" title="与Web集成"></a>与Web集成</h3><p>Shiro提供了与Web集成的支持，其通过一个ShiroFilter入口来拦截需要安全控制的URL，然后进行相应的控制，ShiroFilter类似于如Strut2/SpringMVC这种web框架的前端控制器，其是安全控制的入口点，其负责读取配置（如ini配置文件），然后判断URL是否需要登录/权限等工作。</p>
<h4 id="准备环境"><a href="#准备环境" class="headerlink" title="准备环境"></a>准备环境</h4><p><strong>创建webapp应用</strong>  </p>
<p>此处我们使用了jetty-maven-plugin和tomcat7-maven-plugin插件；这样可以直接使用“mvn jetty:run”或“mvn tomcat7:run”直接运行webapp了。然后通过URL<a href="http://localhost:8080/chapter7/访问即可。" target="_blank" rel="noopener">http://localhost:8080/chapter7/访问即可。</a></p>
<p> shiro-web  </p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.shiro<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>shiro-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.2.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span>  </span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h4 id="ShiroFilter入口"><a href="#ShiroFilter入口" class="headerlink" title="ShiroFilter入口"></a>ShiroFilter入口</h4><p><strong>1、Shiro 1.1及以前版本配置方式</strong>    </p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">filter</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">filter-name</span>&gt;</span>iniShiroFilter<span class="tag">&lt;/<span class="name">filter-name</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">filter-class</span>&gt;</span>org.apache.shiro.web.servlet.IniShiroFilter<span class="tag">&lt;/<span class="name">filter-class</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">init-param</span>&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;<span class="name">param-name</span>&gt;</span>configPath<span class="tag">&lt;/<span class="name">param-name</span>&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;<span class="name">param-value</span>&gt;</span>classpath:shiro.ini<span class="tag">&lt;/<span class="name">param-value</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;/<span class="name">init-param</span>&gt;</span>  </span><br><span class="line"><span class="tag">&lt;/<span class="name">filter</span>&gt;</span>  </span><br><span class="line"><span class="tag">&lt;<span class="name">filter-mapping</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">filter-name</span>&gt;</span>iniShiroFilter<span class="tag">&lt;/<span class="name">filter-name</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/*<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span>  </span><br><span class="line"><span class="tag">&lt;/<span class="name">filter-mapping</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>1、使用IniShiroFilter作为Shiro安全控制的入口点，通过url-pattern指定需要安全的URL；</p>
<p>2、通过configPath指定ini配置文件位置，默认是先从/WEB-INF/shiro.ini加载，如果没有就默认加载classpath:shiro.ini，即默认相对于web应用上下文根路径；</p>
<p>3、也可以通过如下方式直接内嵌ini配置文件内容到web.xml</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">init-param</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">param-name</span>&gt;</span>config<span class="tag">&lt;/<span class="name">param-name</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">param-value</span>&gt;</span>  </span><br><span class="line">        ini配置文件贴在这  </span><br><span class="line">    <span class="tag">&lt;/<span class="name">param-value</span>&gt;</span>  </span><br><span class="line"><span class="tag">&lt;/<span class="name">init-param</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p><strong>2、Shiro 1.2及以后版本的配置方式</strong></p>
<p>从Shiro 1.2开始引入了Environment/WebEnvironment的概念，即由它们的实现提供相应的SecurityManager及其相应的依赖。ShiroFilter会自动找到Environment然后获取相应的依赖。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">listener</span>&gt;</span>  </span><br><span class="line">   <span class="tag">&lt;<span class="name">listener-class</span>&gt;</span>org.apache.shiro.web.env.EnvironmentLoaderListener<span class="tag">&lt;/<span class="name">listener-class</span>&gt;</span>  </span><br><span class="line"><span class="tag">&lt;/<span class="name">listener</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>通过EnvironmentLoaderListener来创建相应的WebEnvironment，并自动绑定到ServletContext，默认使用IniWebEnvironment实现。</p>
<p> 可以通过如下配置修改默认实现及其加载的配置文件位置：  </p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">context-param</span>&gt;</span>  </span><br><span class="line">   <span class="tag">&lt;<span class="name">param-name</span>&gt;</span>shiroEnvironmentClass<span class="tag">&lt;/<span class="name">param-name</span>&gt;</span>  </span><br><span class="line">   <span class="tag">&lt;<span class="name">param-value</span>&gt;</span>org.apache.shiro.web.env.IniWebEnvironment<span class="tag">&lt;/<span class="name">param-value</span>&gt;</span>  </span><br><span class="line"><span class="tag">&lt;/<span class="name">context-param</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">context-param</span>&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;<span class="name">param-name</span>&gt;</span>shiroConfigLocations<span class="tag">&lt;/<span class="name">param-name</span>&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;<span class="name">param-value</span>&gt;</span>classpath:shiro.ini<span class="tag">&lt;/<span class="name">param-value</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;/<span class="name">context-param</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>shiroConfigLocations默认是“/WEB-INF/shiro.ini”，IniWebEnvironment默认是先从/WEB-INF/shiro.ini加载，如果没有就默认加载classpath:shiro.ini。</p>
<p> <strong>3、与Spring集成</strong>  </p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">filter</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">filter-name</span>&gt;</span>shiroFilter<span class="tag">&lt;/<span class="name">filter-name</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">filter-class</span>&gt;</span>org.springframework.web.filter.DelegatingFilterProxy<span class="tag">&lt;/<span class="name">filter-class</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">init-param</span>&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;<span class="name">param-name</span>&gt;</span>targetFilterLifecycle<span class="tag">&lt;/<span class="name">param-name</span>&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;<span class="name">param-value</span>&gt;</span>true<span class="tag">&lt;/<span class="name">param-value</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;/<span class="name">init-param</span>&gt;</span>  </span><br><span class="line"><span class="tag">&lt;/<span class="name">filter</span>&gt;</span>  </span><br><span class="line"><span class="tag">&lt;<span class="name">filter-mapping</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">filter-name</span>&gt;</span>shiroFilter<span class="tag">&lt;/<span class="name">filter-name</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/*<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span>  </span><br><span class="line"><span class="tag">&lt;/<span class="name">filter-mapping</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>DelegatingFilterProxy作用是自动到spring容器查找名字为shiroFilter（filter-name）的bean并把所有Filter的操作委托给它。然后将ShiroFilter配置到spring容器即可：  </p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"shiroFilter"</span> <span class="attr">class</span>=<span class="string">"org.apache.shiro.spring.web.ShiroFilterFactoryBean"</span>&gt;</span>  </span><br><span class="line"><span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"securityManager"</span> <span class="attr">ref</span>=<span class="string">"securityManager"</span>/&gt;</span>  </span><br><span class="line"><span class="tag">&lt;<span class="name">!—忽略其他，详见与Spring集成部分</span> <span class="attr">--</span>&gt;</span>  </span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>最后不要忘了使用org.springframework.web.context.ContextLoaderListener加载这个spring配置文件即可。放在struts或者springmvc的前端控制器上面。</p>
<p>因为我们现在的shiro版本是1.2的，因此之后的测试都是使用1.2的配置。</p>
<h4 id="Web-INI配置"><a href="#Web-INI配置" class="headerlink" title="Web INI配置"></a>Web INI配置</h4><p>ini配置部分和之前的相比将多出对url部分的配置。       </p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[main]</span>  </span><br><span class="line"><span class="comment">#默认是/login.jsp  </span></span><br><span class="line">authc.loginUrl=/login  </span><br><span class="line">roles.unauthorizedUrl=/unauthorized  </span><br><span class="line">perms.unauthorizedUrl=/unauthorized  </span><br><span class="line"><span class="section">[users]</span>  </span><br><span class="line"><span class="attr">zhang</span>=<span class="number">123</span>,admin  </span><br><span class="line"><span class="attr">wang</span>=<span class="number">123</span>  </span><br><span class="line"><span class="section">[roles]</span>  </span><br><span class="line"><span class="attr">admin</span>=user:*,menu:*  </span><br><span class="line"><span class="section">[urls]</span>  </span><br><span class="line">/login=anon  </span><br><span class="line">/unauthorized=anon  </span><br><span class="line">/static/**=anon  </span><br><span class="line">/authenticated=authc  </span><br><span class="line">/role=authc,roles[admin]  </span><br><span class="line">/permission=authc,perms["user:create"]</span><br></pre></td></tr></table></figure>
<p>其中最重要的就是[urls]部分的配置，其格式是： “url=拦截器[参数]，拦截器[参数]”；即如果当前请求的url匹配[urls]部分的某个url模式，将会执行其配置的拦截器。比如anon拦截器表示匿名访问（即不需要登录即可访问）；authc拦截器表示需要身份认证通过后才能访问；roles[admin]拦截器表示需要有admin角色授权才能访问；而perms[“user:create”]拦截器表示需要有“user:create”权限才能访问。</p>
<p><strong>url**</strong>模式使用Ant风格模式**</p>
<p>Ant路径通配符支持?、*、**，注意通配符匹配不包括目录分隔符“/”：</p>
<p><strong>?**</strong>：匹配一个字符**，如”/admin?”将匹配/admin1，但不匹配/admin或/admin2；</p>
<p><strong>***</strong>：匹配零个或多个字符串*<em>，如/admin</em>将匹配/admin、/admin123，但不匹配/admin/1；</p>
<p><strong><em>**</em></strong>：匹配路径中的零个或多个路径<strong>，如/admin/</strong>将匹配/admin/a或/admin/a/b。</p>
<p><strong>url**</strong>模式匹配顺序**</p>
<p>url模式匹配顺序是按照在配置中的声明顺序匹配，即从头开始使用第一个匹配的url模式对应的拦截器链。如：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">/bb/**=filter1  </span><br><span class="line">/bb/aa=filter2  </span><br><span class="line">/**=filter3</span><br></pre></td></tr></table></figure>
<p>如果请求的url是“/bb/aa”，因为按照声明顺序进行匹配，那么将使用filter1进行拦截。</p>
<p>拦截器将在下一节详细介绍。接着我们来看看身份验证、授权及退出在web中如何实现。</p>
<p> <strong>1、身份验证（登录）</strong></p>
<p><strong>1.1、首先配置需要身份验证的url</strong>  </p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">/authenticated=authc  </span><br><span class="line">/role=authc,roles[admin]  </span><br><span class="line">/permission=authc,perms["user:create"]</span><br></pre></td></tr></table></figure>
<p>即访问这些地址时会首先判断用户有没有登录，如果没有登录默会跳转到登录页面，默认是/login.jsp，可以通过在[main]部分通过如下配置修改：   </p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">authc.loginUrl=/login</span><br></pre></td></tr></table></figure>
<p><strong>1.2、登录Servle</strong> </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@WebServlet</span>(name = <span class="string">"loginServlet"</span>, urlPatterns = <span class="string">"/login"</span>)  </span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LoginServlet</span> <span class="keyword">extends</span> <span class="title">HttpServlet</span> </span>&#123;  </span><br><span class="line">    <span class="meta">@Override</span>  </span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doGet</span><span class="params">(HttpServletRequest req, HttpServletResponse resp)</span>  </span></span><br><span class="line"><span class="function">      <span class="keyword">throws</span> ServletException, IOException </span>&#123;  </span><br><span class="line">        req.getRequestDispatcher(<span class="string">"/WEB-INF/jsp/login.jsp"</span>).forward(req, resp);  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="meta">@Override</span>  </span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doPost</span><span class="params">(HttpServletRequest req, HttpServletResponse resp)</span>  </span></span><br><span class="line"><span class="function">      <span class="keyword">throws</span> ServletException, IOException </span>&#123;  </span><br><span class="line">        String error = <span class="keyword">null</span>;  </span><br><span class="line">        String username = req.getParameter(<span class="string">"username"</span>);  </span><br><span class="line">        String password = req.getParameter(<span class="string">"password"</span>);  </span><br><span class="line">        Subject subject = SecurityUtils.getSubject();  </span><br><span class="line">        UsernamePasswordToken token = <span class="keyword">new</span> UsernamePasswordToken(username, password);  </span><br><span class="line">        <span class="keyword">try</span> &#123;  </span><br><span class="line">            subject.login(token);  </span><br><span class="line">        &#125; <span class="keyword">catch</span> (UnknownAccountException e) &#123;  </span><br><span class="line">            error = <span class="string">"用户名/密码错误"</span>;  </span><br><span class="line">        &#125; <span class="keyword">catch</span> (IncorrectCredentialsException e) &#123;  </span><br><span class="line">            error = <span class="string">"用户名/密码错误"</span>;  </span><br><span class="line">        &#125; <span class="keyword">catch</span> (AuthenticationException e) &#123;  </span><br><span class="line">            <span class="comment">//其他错误，比如锁定，如果想单独处理请单独catch处理  </span></span><br><span class="line">            error = <span class="string">"其他错误："</span> + e.getMessage();  </span><br><span class="line">        &#125;  </span><br><span class="line">        <span class="keyword">if</span>(error != <span class="keyword">null</span>) &#123;<span class="comment">//出错了，返回登录页面  </span></span><br><span class="line">            req.setAttribute(<span class="string">"error"</span>, error);  </span><br><span class="line">            req.getRequestDispatcher(<span class="string">"/WEB-INF/jsp/login.jsp"</span>).forward(req, resp);  </span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;<span class="comment">//登录成功  </span></span><br><span class="line">            req.getRequestDispatcher(<span class="string">"/WEB-INF/jsp/loginSuccess.jsp"</span>).forward(req, resp);  </span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>1、doGet请求时展示登录页面；</p>
<p>2、doPost时进行登录，登录时收集username/password参数，然后提交给Subject进行登录。如果有错误再返回到登录页面；否则跳转到登录成功页面（此处应该返回到访问登录页面之前的那个页面，或者没有上一个页面时访问主页）。</p>
<p>3、JSP页面请参考源码。</p>
<p><strong>1.3**</strong>、测试**</p>
<p>首先输入<a href="http://localhost:8080/chapter7/login进行登录，登录成功后接着可以访问http://localhost:8080/chapter7/authenticated来显示当前登录的用户：" target="_blank" rel="noopener">http://localhost:8080/chapter7/login进行登录，登录成功后接着可以访问http://localhost:8080/chapter7/authenticated来显示当前登录的用户：</a> </p>
<ol>
<li>${subject.principal}身份验证已通过。  </li>
</ol>
<p>当前实现的一个缺点就是，永远返回到同一个成功页面（比如首页），在实际项目中比如支付时如果没有登录将跳转到登录页面，登录成功后再跳回到支付页面；对于这种功能大家可以在登录时把当前请求保存下来，然后登录成功后再重定向到该请求即可。</p>
<p>Shiro内置了登录（身份验证）的实现：基于表单的和基于Basic的验证，其通过拦截器实现。</p>
<h4 id="2、基于Basic的拦截器身份验证"><a href="#2、基于Basic的拦截器身份验证" class="headerlink" title="2、基于Basic的拦截器身份验证"></a><strong>2、基于Basic的拦截器身份验证</strong></h4><p><strong>2.1、shiro-basicfilterlogin.ini配置</strong>   </p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[main]</span>  </span><br><span class="line">authcBasic.applicationName=please login  </span><br><span class="line">………省略users  </span><br><span class="line"><span class="section">[urls]</span>  </span><br><span class="line">/role=authcBasic,roles[admin]</span><br></pre></td></tr></table></figure>
<p>1、authcBasic是org.apache.shiro.web.filter.authc.BasicHttpAuthenticationFilter类型的实例，其用于实现基于Basic的身份验证；applicationName用于弹出的登录框显示信息使用，如图：</p>
<p> <img src="http://dl2.iteye.com/upload/attachment/0094/3895/00e16ed3-afea-3614-926c-bdc2b09d5d8e.png" alt=""></p>
<p>2、[urls]部分配置了/role地址需要走authcBasic拦截器，即如果访问/role时还没有通过身份验证那么将弹出如上图的对话框进行登录，登录成功即可访问。</p>
<p> <strong>2.2、web.xml</strong></p>
<p>把shiroConfigLocations改为shiro-basicfilterlogin.ini即可</p>
<p><strong>2.3、测试</strong></p>
<p>输入<a href="http://localhost:8080/chapter7/role，会弹出之前的Basic验证对话框输入“zhang/123”即可登录成功进行访问。" target="_blank" rel="noopener">http://localhost:8080/chapter7/role，会弹出之前的Basic验证对话框输入“zhang/123”即可登录成功进行访问。</a></p>
<h4 id="3、基于表单的拦截器身份验证"><a href="#3、基于表单的拦截器身份验证" class="headerlink" title="3、基于表单的拦截器身份验证"></a><strong>3、基于表单的拦截器身份验证</strong></h4><p>基于表单的拦截器身份验证和【1】类似，但是更简单，因为其已经实现了大部分登录逻辑；我们只需要指定：登录地址/登录失败后错误信息存哪/成功的地址即可。</p>
<p><strong>3.1、shiro-formfilterlogin.ini</strong>   </p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[main]</span>  </span><br><span class="line">authc.loginUrl=/formfilterlogin  </span><br><span class="line">authc.usernameParam=username  </span><br><span class="line">authc.passwordParam=password  </span><br><span class="line">authc.successUrl=/  </span><br><span class="line">authc.failureKeyAttribute=shiroLoginFailure  </span><br><span class="line">  </span><br><span class="line"><span class="section">[urls]</span>  </span><br><span class="line">/role=authc,roles[admin]</span><br></pre></td></tr></table></figure>
<p>1、authc是org.apache.shiro.web.filter.authc.FormAuthenticationFilter类型的实例，其用于实现基于表单的身份验证；通过loginUrl指定当身份验证时的登录表单；usernameParam指定登录表单提交的用户名参数名；passwordParam指定登录表单提交的密码参数名；successUrl指定登录成功后重定向的默认地址（默认是“/”）（如果有上一个地址会自动重定向带该地址）；failureKeyAttribute指定登录失败时的request属性key（默认shiroLoginFailure）；这样可以在登录表单得到该错误key显示相应的错误消息；</p>
<p> <strong>3.2、web.xml</strong></p>
<p>把shiroConfigLocations改为shiro- formfilterlogin.ini即可。</p>
<p><strong>3.3、登录Servlet</strong>   </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@WebServlet</span>(name = <span class="string">"formFilterLoginServlet"</span>, urlPatterns = <span class="string">"/formfilterlogin"</span>)  </span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FormFilterLoginServlet</span> <span class="keyword">extends</span> <span class="title">HttpServlet</span> </span>&#123;  </span><br><span class="line">    <span class="meta">@Override</span>  </span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doGet</span><span class="params">(HttpServletRequest req, HttpServletResponse resp)</span>  </span></span><br><span class="line"><span class="function">      <span class="keyword">throws</span> ServletException, IOException </span>&#123;  </span><br><span class="line">        doPost(req, resp);  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="meta">@Override</span>  </span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doPost</span><span class="params">(HttpServletRequest req, HttpServletResponse resp)</span>  </span></span><br><span class="line"><span class="function">     <span class="keyword">throws</span> ServletException, IOException </span>&#123;  </span><br><span class="line">        String errorClassName = (String)req.getAttribute(<span class="string">"shiroLoginFailure"</span>);  </span><br><span class="line">        <span class="keyword">if</span>(UnknownAccountException.class.getName().equals(errorClassName)) &#123;  </span><br><span class="line">            req.setAttribute(<span class="string">"error"</span>, <span class="string">"用户名/密码错误"</span>);  </span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span>(IncorrectCredentialsException.class.getName().equals(errorClassName)) &#123;  </span><br><span class="line">            req.setAttribute(<span class="string">"error"</span>, <span class="string">"用户名/密码错误"</span>);  </span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span>(errorClassName != <span class="keyword">null</span>) &#123;  </span><br><span class="line">            req.setAttribute(<span class="string">"error"</span>, <span class="string">"未知错误："</span> + errorClassName);  </span><br><span class="line">        &#125;  </span><br><span class="line">        req.getRequestDispatcher(<span class="string">"/WEB-INF/jsp/formfilterlogin.jsp"</span>).forward(req, resp);  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在登录Servlet中通过shiroLoginFailure得到authc登录失败时的异常类型名，然后根据此异常名来决定显示什么错误消息。</p>
<p> <strong>4、测试</strong></p>
<p> 输入<a href="http://localhost:8080/chapter7/role，会跳转到“/formfilterlogin”登录表单，提交表单如果authc拦截器登录成功后，会直接重定向会之前的地址“/role”；假设我们直接访问“/formfilterlogin”的话登录成功将直接到默认的successUrl。" target="_blank" rel="noopener">http://localhost:8080/chapter7/role，会跳转到“/formfilterlogin”登录表单，提交表单如果authc拦截器登录成功后，会直接重定向会之前的地址“/role”；假设我们直接访问“/formfilterlogin”的话登录成功将直接到默认的successUrl。</a></p>
<h4 id="授权（角色-权限验证）"><a href="#授权（角色-权限验证）" class="headerlink" title="授权（角色/权限验证）"></a>授权（角色/权限验证）</h4><p> <strong>4.1、shiro.ini</strong>     </p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[main]</span>  </span><br><span class="line">roles.unauthorizedUrl=/unauthorized  </span><br><span class="line">perms.unauthorizedUrl=/unauthorized  </span><br><span class="line"><span class="section"> [urls]</span>  </span><br><span class="line">/role=authc,roles[admin]  </span><br><span class="line">/permission=authc,perms["user:create"]</span><br></pre></td></tr></table></figure>
<p>通过unauthorizedUrl属性指定如果授权失败时重定向到的地址。roles是org.apache.shiro.web.filter.authz.RolesAuthorizationFilter类型的实例，通过参数指定访问时需要的角色，如“[admin]”，如果有多个使用“，”分割，且验证时是hasAllRole验证，即且的关系。Perms是org.apache.shiro.web.filter.authz.PermissionsAuthorizationFilter类型的实例，和roles类似，只是验证权限字符串。</p>
<p> <strong>4.2、web.xml</strong></p>
<p> 把shiroConfigLocations改为shiro.ini即可。</p>
<h4 id="4-3、RoleServlet-PermissionServlet"><a href="#4-3、RoleServlet-PermissionServlet" class="headerlink" title="4.3、RoleServlet/PermissionServlet"></a><strong>4.3、RoleServlet/PermissionServlet</strong></h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@WebServlet</span>(name = <span class="string">"permissionServlet"</span>, urlPatterns = <span class="string">"/permission"</span>)  </span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PermissionServlet</span> <span class="keyword">extends</span> <span class="title">HttpServlet</span> </span>&#123;  </span><br><span class="line">    <span class="meta">@Override</span>  </span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doGet</span><span class="params">(HttpServletRequest req, HttpServletResponse resp)</span>  </span></span><br><span class="line"><span class="function">      <span class="keyword">throws</span> ServletException, IOException </span>&#123;  </span><br><span class="line">        Subject subject = SecurityUtils.getSubject();  </span><br><span class="line">        subject.checkPermission(<span class="string">"user:create"</span>);  </span><br><span class="line">        req.getRequestDispatcher(<span class="string">"/WEB-INF/jsp/hasPermission.jsp"</span>).forward(req, resp);  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@WebServlet</span>(name = <span class="string">"roleServlet"</span>, urlPatterns = <span class="string">"/role"</span>)  </span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RoleServlet</span> <span class="keyword">extends</span> <span class="title">HttpServlet</span> </span>&#123;  </span><br><span class="line">    <span class="meta">@Override</span>  </span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doGet</span><span class="params">(HttpServletRequest req, HttpServletResponse resp)</span>  </span></span><br><span class="line"><span class="function">      <span class="keyword">throws</span> ServletException, IOException </span>&#123;  </span><br><span class="line">        Subject subject = SecurityUtils.getSubject();  </span><br><span class="line">        subject.checkRole(<span class="string">"admin"</span>);  </span><br><span class="line">        req.getRequestDispatcher(<span class="string">"/WEB-INF/jsp/hasRole.jsp"</span>).forward(req, resp);  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>4.4、测试</strong></p>
<p> 首先访问<a href="http://localhost:8080/chapter7/login，使用帐号“zhang/123”进行登录，再访问/role或/permission时会跳转到成功页面（因为其授权成功了）；如果使用帐号“wang/123”登录成功后访问这两个地址会跳转到“/unauthorized”即没有授权页面。" target="_blank" rel="noopener">http://localhost:8080/chapter7/login，使用帐号“zhang/123”进行登录，再访问/role或/permission时会跳转到成功页面（因为其授权成功了）；如果使用帐号“wang/123”登录成功后访问这两个地址会跳转到“/unauthorized”即没有授权页面。</a> </p>
<h4 id="退出"><a href="#退出" class="headerlink" title="退出"></a><strong>退出</strong></h4><p><strong>5.1、shiro.ini</strong>   </p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[urls]</span>  </span><br><span class="line">/logout=anon</span><br></pre></td></tr></table></figure>
<p><strong>5.2、LogoutServlet</strong>  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@WebServlet</span>(name = <span class="string">"logoutServlet"</span>, urlPatterns = <span class="string">"/logout"</span>)  </span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LogoutServlet</span> <span class="keyword">extends</span> <span class="title">HttpServlet</span> </span>&#123;  </span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doGet</span><span class="params">(HttpServletRequest req, HttpServletResponse resp)</span>  </span></span><br><span class="line"><span class="function">      <span class="keyword">throws</span> ServletException, IOException </span>&#123;  </span><br><span class="line">        SecurityUtils.getSubject().logout();  </span><br><span class="line">        req.getRequestDispatcher(<span class="string">"/WEB-INF/jsp/logoutSuccess.jsp"</span>).forward(req, resp);  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>直接调用Subject.logout即可，退出成功后转发/重定向到相应页面即可。</p>
<p> <strong>5.3、测试</strong></p>
<p>首先访问<a href="http://localhost:8080/chapter7/login，使用帐号“zhang/123”进行登录，登录成功后访问/logout即可退出。" target="_blank" rel="noopener">http://localhost:8080/chapter7/login，使用帐号“zhang/123”进行登录，登录成功后访问/logout即可退出。</a></p>
<p>Shiro也提供了logout拦截器用于退出，其是org.apache.shiro.web.filter.authc.LogoutFilter类型的实例，我们可以在shiro.ini配置文件中通过如下配置完成退出：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[main]</span>  </span><br><span class="line">logout.redirectUrl=/login  </span><br><span class="line">  </span><br><span class="line"><span class="section">[urls]</span>  </span><br><span class="line">/logout2=logout</span><br></pre></td></tr></table></figure>
<p>通过logout.redirectUrl指定退出后重定向的地址；通过/logout2=logout指定退出url是/logout2。这样当我们登录成功后然后访问/logout2即可退出。</p>
<h3 id="拦截器机制"><a href="#拦截器机制" class="headerlink" title="拦截器机制"></a>拦截器机制</h3><h4 id="拦截器介绍"><a href="#拦截器介绍" class="headerlink" title="拦截器介绍"></a>拦截器介绍</h4><p>Shiro使用了与Servlet一样的Filter接口进行扩展；所以如果对Filter不熟悉可以参考《Servlet3.1规范》<a href="http://www.iteye.com/blogs/subjects/Servlet-3-1" target="_blank" rel="noopener">http://www.iteye.com/blogs/subjects/Servlet-3-1</a> 了解Filter的工作原理。首先下图是Shiro拦截器的基础类图：</p>
<p><img src="http://dl2.iteye.com/upload/attachment/0094/3897/b910abb9-2ef0-33b7-af4d-4c645263ed54.png" alt=""></p>
<p><strong>1、NameableFilter</strong></p>
<p>NameableFilter给Filter起个名字，如果没有设置默认就是FilterName；还记得之前的如authc吗？当我们组装拦截器链时会根据这个名字找到相应的拦截器实例； </p>
<p><strong>2、OncePerRequestFilter</strong></p>
<p>OncePerRequestFilter用于防止多次执行Filter的；也就是说一次请求只会走一次拦截器链；另外提供enabled属性，表示是否开启该拦截器实例，默认enabled=true表示开启，如果不想让某个拦截器工作，可以设置为false即可。</p>
<p> <strong>3、ShiroFilter</strong> </p>
<p>ShiroFilter是整个Shiro的入口点，用于拦截需要安全控制的请求进行处理，这个之前已经用过了。</p>
<p> <strong>4、AdviceFilter</strong></p>
<p> AdviceFilter提供了AOP风格的支持，类似于SpringMVC中的Interceptor：  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">preHandle</span><span class="params">(ServletRequest request, ServletResponse response)</span> <span class="keyword">throws</span> Exception  </span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">postHandle</span><span class="params">(ServletRequest request, ServletResponse response)</span> <span class="keyword">throws</span> Exception  </span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">afterCompletion</span><span class="params">(ServletRequest request, ServletResponse response, Exception exception)</span> <span class="keyword">throws</span> Exception</span>;</span><br></pre></td></tr></table></figure>
<p>preHandler：类似于AOP中的前置增强；在拦截器链执行之前执行；如果返回true则继续拦截器链；否则中断后续的拦截器链的执行直接返回；进行预处理（如基于表单的身份验证、授权）</p>
<p>postHandle：类似于AOP中的后置返回增强；在拦截器链执行完成后执行；进行后处理（如记录执行时间之类的）；</p>
<p>afterCompletion：类似于AOP中的后置最终增强；即不管有没有异常都会执行；可以进行清理资源（如接触Subject与线程的绑定之类的）；</p>
<p><strong>5、PathMatchingFilter</strong></p>
<p> PathMatchingFilter提供了基于Ant风格的请求路径匹配功能及拦截器参数解析的功能，如“roles[admin,user]”自动根据“，”分割解析到一个路径参数配置并绑定到相应的路径：  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">pathsMatch</span><span class="params">(String path, ServletRequest request)</span>  </span></span><br><span class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">onPreHandle</span><span class="params">(ServletRequest request, ServletResponse response, Object mappedValue)</span> <span class="keyword">throws</span> Exception</span></span><br></pre></td></tr></table></figure>
<p>pathsMatch：该方法用于path与请求路径进行匹配的方法；如果匹配返回true；</p>
<p>onPreHandle：在preHandle中，当pathsMatch匹配一个路径后，会调用opPreHandler方法并将路径绑定参数配置传给mappedValue；然后可以在这个方法中进行一些验证（如角色授权），如果验证失败可以返回false中断流程；默认返回true；也就是说子类可以只实现onPreHandle即可，无须实现preHandle。如果没有path与请求路径匹配，默认是通过的（即preHandle返回true）。</p>
<p><strong>6、AccessControlFilter</strong></p>
<p> AccessControlFilter提供了访问控制的基础功能；比如是否允许访问/当访问拒绝时如何处理等：  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">abstract</span> <span class="keyword">boolean</span> <span class="title">isAccessAllowed</span><span class="params">(ServletRequest request, ServletResponse response, Object mappedValue)</span> <span class="keyword">throws</span> Exception</span>;  </span><br><span class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">onAccessDenied</span><span class="params">(ServletRequest request, ServletResponse response, Object mappedValue)</span> <span class="keyword">throws</span> Exception</span>;  </span><br><span class="line"><span class="function"><span class="keyword">abstract</span> <span class="keyword">boolean</span> <span class="title">onAccessDenied</span><span class="params">(ServletRequest request, ServletResponse response)</span> <span class="keyword">throws</span> Exception</span>;</span><br></pre></td></tr></table></figure>
<p>isAccessAllowed：表示是否允许访问；mappedValue就是[urls]配置中拦截器参数部分，如果允许访问返回true，否则false；</p>
<p>onAccessDenied：表示当访问拒绝时是否已经处理了；如果返回true表示需要继续处理；如果返回false表示该拦截器实例已经处理了，将直接返回即可</p>
<p>onPreHandle会自动调用这两个方法决定是否继续处理：  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">onPreHandle</span><span class="params">(ServletRequest request, ServletResponse response, Object mappedValue)</span> <span class="keyword">throws</span> Exception </span>&#123;  </span><br><span class="line">    <span class="keyword">return</span> isAccessAllowed(request, response, mappedValue) || onAccessDenied(request, response, mappedValue);  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>另外AccessControlFilter还提供了如下方法用于处理如登录成功后/重定向到上一个请求：   </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">setLoginUrl</span><span class="params">(String loginUrl)</span> <span class="comment">//身份验证时使用，默认/login.jsp  </span></span></span><br><span class="line"><span class="function">String <span class="title">getLoginUrl</span><span class="params">()</span>  </span></span><br><span class="line"><span class="function">Subject <span class="title">getSubject</span><span class="params">(ServletRequest request, ServletResponse response)</span> <span class="comment">//获取Subject实例  </span></span></span><br><span class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">isLoginRequest</span><span class="params">(ServletRequest request, ServletResponse response)</span><span class="comment">//当前请求是否是登录请求  </span></span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">saveRequestAndRedirectToLogin</span><span class="params">(ServletRequest request, ServletResponse response)</span> <span class="keyword">throws</span> IOException <span class="comment">//将当前请求保存起来并重定向到登录页面  </span></span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">saveRequest</span><span class="params">(ServletRequest request)</span> <span class="comment">//将请求保存起来，如登录成功后再重定向回该请求  </span></span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">redirectToLogin</span><span class="params">(ServletRequest request, ServletResponse response)</span> <span class="comment">//重定向到登录页面</span></span></span><br></pre></td></tr></table></figure>
<p>比如基于表单的身份验证就需要使用这些功能。</p>
<p>到此基本的拦截器就完事了，如果我们想进行访问访问的控制就可以继承AccessControlFilter；如果我们要添加一些通用数据我们可以直接继承PathMatchingFilter。</p>
<h4 id="拦截器链"><a href="#拦截器链" class="headerlink" title="拦截器链"></a>拦截器链</h4><p><strong>Shiro对Servlet容器的FilterChain进行了代理</strong>，即ShiroFilter在继续Servlet容器的Filter链的执行之前，通过ProxiedFilterChain对Servlet容器的FilterChain进行了代理；即先走Shiro自己的Filter体系，然后才会委托给Servlet容器的FilterChain进行Servlet容器级别的Filter链执行；Shiro的ProxiedFilterChain执行流程：<strong>1、先执行Shiro自己的Filter链；2、再执行Servlet容器的Filter链（即原始的Filter）。</strong></p>
<p>而ProxiedFilterChain是通过FilterChainResolver根据配置文件中[urls]部分是否与请求的URL是否匹配解析得到的。 </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">FilterChain <span class="title">getChain</span><span class="params">(ServletRequest request, ServletResponse response, FilterChain originalChain)</span></span>;</span><br></pre></td></tr></table></figure>
<p>即传入原始的chain得到一个代理的chain。</p>
<p>Shiro内部提供了一个路径匹配的FilterChainResolver实现：PathMatchingFilterChainResolver，其根据[urls]中配置的url模式（默认Ant风格）=拦截器链和请求的url是否匹配来解析得到配置的拦截器链的；而PathMatchingFilterChainResolver内部通过FilterChainManager维护着拦截器链，比如DefaultFilterChainManager实现维护着url模式与拦截器链的关系。因此我们可以通过FilterChainManager进行动态动态增加url模式与拦截器链的关系。</p>
<p>DefaultFilterChainManager会默认添加org.apache.shiro.web.filter.mgt.DefaultFilter中声明的拦截器：  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">enum</span> DefaultFilter &#123;  </span><br><span class="line">    anon(AnonymousFilter.class),  </span><br><span class="line">    authc(FormAuthenticationFilter.class),  </span><br><span class="line">    authcBasic(BasicHttpAuthenticationFilter.class),  </span><br><span class="line">    logout(LogoutFilter.class),  </span><br><span class="line">    noSessionCreation(NoSessionCreationFilter.class),  </span><br><span class="line">    perms(PermissionsAuthorizationFilter.class),  </span><br><span class="line">    port(PortFilter.class),  </span><br><span class="line">    rest(HttpMethodPermissionFilter.class),  </span><br><span class="line">    roles(RolesAuthorizationFilter.class),  </span><br><span class="line">    ssl(SslFilter.class),  </span><br><span class="line">    user(UserFilter.class);  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>下一节会介绍这些拦截器的作用。</p>
<p>如果要注册自定义拦截器，IniSecurityManagerFactory/WebIniSecurityManagerFactory在启动时会自动扫描ini配置文件中的[filters]/[main]部分并注册这些拦截器到DefaultFilterChainManager；且创建相应的url模式与其拦截器关系链。如果使用Spring后续章节会介绍如果注册自定义拦截器。</p>
<p>如果想自定义FilterChainResolver，可以通过实现WebEnvironment接口完成：  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyIniWebEnvironment</span> <span class="keyword">extends</span> <span class="title">IniWebEnvironment</span> </span>&#123;  </span><br><span class="line">    <span class="meta">@Override</span>  </span><br><span class="line">    <span class="function"><span class="keyword">protected</span> FilterChainResolver <span class="title">createFilterChainResolver</span><span class="params">()</span> </span>&#123;  </span><br><span class="line">        <span class="comment">//在此处扩展自己的FilterChainResolver  </span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">super</span>.createFilterChainResolver();  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>FilterChain之间的关系。如果想动态实现url-拦截器的注册，就可以通过实现此处的FilterChainResolver来完成，比如：  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//1、创建FilterChainResolver  </span></span><br><span class="line">PathMatchingFilterChainResolver filterChainResolver =  </span><br><span class="line">        <span class="keyword">new</span> PathMatchingFilterChainResolver();  </span><br><span class="line"><span class="comment">//2、创建FilterChainManager  </span></span><br><span class="line">DefaultFilterChainManager filterChainManager = <span class="keyword">new</span> DefaultFilterChainManager();  </span><br><span class="line"><span class="comment">//3、注册Filter  </span></span><br><span class="line"><span class="keyword">for</span>(DefaultFilter filter : DefaultFilter.values()) &#123;  </span><br><span class="line">    filterChainManager.addFilter(  </span><br><span class="line">        filter.name(), (Filter) ClassUtils.newInstance(filter.getFilterClass()));  </span><br><span class="line">&#125;  </span><br><span class="line"><span class="comment">//4、注册URL-Filter的映射关系  </span></span><br><span class="line">filterChainManager.addToChain(<span class="string">"/login.jsp"</span>, <span class="string">"authc"</span>);  </span><br><span class="line">filterChainManager.addToChain(<span class="string">"/unauthorized.jsp"</span>, <span class="string">"anon"</span>);  </span><br><span class="line">filterChainManager.addToChain(<span class="string">"/**"</span>, <span class="string">"authc"</span>);  </span><br><span class="line">filterChainManager.addToChain(<span class="string">"/**"</span>, <span class="string">"roles"</span>, <span class="string">"admin"</span>);  </span><br><span class="line">  </span><br><span class="line"><span class="comment">//5、设置Filter的属性  </span></span><br><span class="line">FormAuthenticationFilter authcFilter =  </span><br><span class="line">         (FormAuthenticationFilter)filterChainManager.getFilter(<span class="string">"authc"</span>);  </span><br><span class="line">authcFilter.setLoginUrl(<span class="string">"/login.jsp"</span>);  </span><br><span class="line">RolesAuthorizationFilter rolesFilter =  </span><br><span class="line">          (RolesAuthorizationFilter)filterChainManager.getFilter(<span class="string">"roles"</span>);  </span><br><span class="line">rolesFilter.setUnauthorizedUrl(<span class="string">"/unauthorized.jsp"</span>);  </span><br><span class="line">  </span><br><span class="line">filterChainResolver.setFilterChainManager(filterChainManager);  </span><br><span class="line"><span class="keyword">return</span> filterChainResolver;</span><br></pre></td></tr></table></figure>
<p>此处自己去实现注册filter，及url模式与filter之间的映射关系。可以通过定制FilterChainResolver或FilterChainManager来完成诸如动态URL匹配的实现。</p>
<p>然后再web.xml中进行如下配置Environment：    </p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">context-param</span>&gt;</span>  </span><br><span class="line"><span class="tag">&lt;<span class="name">param-name</span>&gt;</span>shiroEnvironmentClass<span class="tag">&lt;/<span class="name">param-name</span>&gt;</span> <span class="tag">&lt;<span class="name">param-value</span>&gt;</span>com.github.zhangkaitao.shiro.chapter8.web.env.MyIniWebEnvironment<span class="tag">&lt;/<span class="name">param-value</span>&gt;</span>  </span><br><span class="line"><span class="tag">&lt;/<span class="name">context-param</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h4 id="自定义拦截器"><a href="#自定义拦截器" class="headerlink" title="自定义拦截器"></a>自定义拦截器</h4><p>通过自定义自己的拦截器可以扩展一些功能，诸如动态url-角色/权限访问控制的实现、根据Subject身份信息获取用户信息绑定到Request（即设置通用数据）、验证码验证、在线用户信息的保存等等，因为其本质就是一个Filter；所以Filter能做的它就能做。</p>
<p> <strong>1、扩展OncePerRequestFilter</strong></p>
<p> OncePerRequestFilter保证一次请求只调用一次doFilterInternal，即如内部的forward不会再多执行一次doFilterInternal：   </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyOncePerRequestFilter</span> <span class="keyword">extends</span> <span class="title">OncePerRequestFilter</span> </span>&#123;  </span><br><span class="line">    <span class="meta">@Override</span>  </span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doFilterInternal</span><span class="params">(ServletRequest request, ServletResponse response, FilterChain chain)</span> <span class="keyword">throws</span> ServletException, IOException </span>&#123;  </span><br><span class="line">        System.out.println(<span class="string">"=========once per request filter"</span>);  </span><br><span class="line">        chain.doFilter(request, response);  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/09/10/MySQL主主说明/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Bill">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/09/10/MySQL主主说明/" itemprop="url">MySQL多主循环 使用</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-09-10T16:30:00+08:00">
                2018-09-10
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/数据库/" itemprop="url" rel="index">
                    <span itemprop="name">数据库</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="配置文件样例："><a href="#配置文件样例：" class="headerlink" title="配置文件样例："></a>配置文件样例：</h3><p>164：<br>port=3306<br>server-id=164<br>log-bin=mysql<br>binlog-do-db=mytest<br>binlog-ignore-db=mysql  #忽略的数据库<br>log-slave-updates=true    #需要<br>replicate-do-db=mytest    #要同步的数据库，如果需要多个库，重复这行<br>replicate-do-db=zero_bos #<br>slave-skip-errors=all   #忽略同步过程中的错误</p>
<h3 id="参数说明"><a href="#参数说明" class="headerlink" title="参数说明"></a>参数说明</h3><p>MySQL的配置文件各种参数说明<br>binlog-do-db：指定mysql的binlog日志记录哪个db<br>Replicate_Do_DB：参数是在slave上配置，指定slave要复制哪个库<br>binlog-do-db=需要复制的数据库名，如果复制多个数据库，重复设置这个选项即可<br>binlog-ignore-db=不需要复制的数据库苦命，如果复制多个数据库，重复设置这个选项即可<br>replicate-do-db=需要复制的数据库名，如果复制多个数据库，重复设置这个选项即可<br>replicate-ignore-db=需要复制的数据库名，如果复制多个数据库，重复设置这个选项即可<br>log-bin=mysql-bin  //启动二进制日志系统<br>sync_binlog = 1 or N：This makes MySQL synchronize the binary log’s contents to disk each time it commits a transaction </p>
<p>注意：如果你想做一个复杂点的结构：比如说，A-&gt;B-&gt;C，其中B是A的从服务器，同时B又是C的主服务器，那么B服务器除了需要打开log-bin之外，还需要打开log-slave-updates选项，你可以再B上使用“show variables like ‘log%’;”来确认是否已经生效。</p>
<h3 id="注意事项"><a href="#注意事项" class="headerlink" title="注意事项"></a>注意事项</h3><ol>
<li>若同步某一数据库，应确保主从服务器上均有此数据库</li>
<li>不指定‘binlog-do-db’ 与‘replicate-do-db’即位同步整个服务器</li>
<li>配置完成后，尽量不要对从库进行插入、更新等操作，只进行查询操作即可</li>
</ol>
<h3 id="常用操作命令"><a href="#常用操作命令" class="headerlink" title="常用操作命令"></a>常用操作命令</h3><ol>
<li>停止从库服务：slave stop;</li>
<li>重置从库服务：slave reset;   // 重新启动从库服务后，会从新同步</li>
</ol>
<h4 id="权限相关"><a href="#权限相关" class="headerlink" title="权限相关"></a>权限相关</h4><ol>
<li>在主服务器上查询当前二进制文件的文件名及偏移位置：show master status;</li>
<li>启动从服务器上的复制线程：start slave;</li>
<li>刷新权限：FLUSH PRIVILEGES;</li>
</ol>
<h4 id="日志相关"><a href="#日志相关" class="headerlink" title="日志相关"></a>日志相关</h4><ol>
<li>是否启用了日志：show variables like ‘log_%’; </li>
<li>刷新日志：flush logs;</li>
</ol>
<h3 id="从库"><a href="#从库" class="headerlink" title="从库"></a>从库</h3><p>从库更改要复制的主库：change master to master_host=’10.0.0.164’,master_user=’replicate’,master_password=’123456’，<br>master_log_file=’mysql-bin.000013’,master_log_pos=107;;</p>
<h3 id="遇到的错误"><a href="#遇到的错误" class="headerlink" title="遇到的错误"></a>遇到的错误</h3><h4 id="1"><a href="#1" class="headerlink" title="1"></a>1</h4><p>1.错误提示：<br>Last_IO_Error: Got fatal error 1236 from master when reading dat<br>a from binary log: ‘Could not find first log file name in binary log index file’<br>解决方法：查看master的错误日志<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">180413 16:33:02 [Note] Error reading relay <span class="built_in">log</span> event: slave SQL thread was killed</span><br><span class="line">180413 16:33:02 [Note] Slave I/O thread killed <span class="keyword">while</span> connecting to master</span><br><span class="line">180413 16:33:02 [Note] Slave I/O thread exiting, <span class="built_in">read</span> up to <span class="built_in">log</span> <span class="string">'mysql.000004'</span>, position 107</span><br><span class="line">180413 16:33:05 [Note] Slave SQL thread initialized, starting replication <span class="keyword">in</span> <span class="built_in">log</span> <span class="string">'mysql.000004'</span> at position 107, relay <span class="built_in">log</span> <span class="string">'.\DESKTOP-5ECA991-relay-bin.000015'</span> position: 4</span><br><span class="line">180413 16:33:06 [ERROR] Slave I/O: error connecting to master <span class="string">'root@10.0.0.32:3306'</span> - retry-time: 60  retries: 86400, Error_code: 2003</span><br></pre></td></tr></table></figure></p>
<p>将从库的改为’mysql.000004’ at position 107</p>
<h4 id="2"><a href="#2" class="headerlink" title="2"></a>2</h4><p>2.错误提示<br>Slave I/O: Got fatal error 1236 from master when reading data from binary<br>log: ‘Binary log is not open’,Error_code: 1236<br>原因：没有设置log-bin，在master的my文件中设置log-bin=mysql-bin  //启动二进制日志系统 </p>
<h3 id="主从相关单词意义"><a href="#主从相关单词意义" class="headerlink" title="主从相关单词意义"></a>主从相关单词意义</h3><ol>
<li>Slave_IO_Running: No是主从同步故障</li>
<li>Slave_SQL_Running: Yes是从服务器读取中继日志</li>
</ol>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/09/10/Python/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Bill">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/09/10/Python/" itemprop="url">Python基础</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-09-10T16:30:00+08:00">
                2018-09-10
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Python/" itemprop="url" rel="index">
                    <span itemprop="name">Python</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="Pycharm使用"><a href="#Pycharm使用" class="headerlink" title="Pycharm使用"></a>Pycharm使用</h3><ol>
<li>单步执行： F8 step over</li>
<li>F8会直接把函数执行完，F7可以进入到函数内。step into</li>
<li>单步跟踪技巧 </li>
</ol>
<h3 id="基础知识"><a href="#基础知识" class="headerlink" title="基础知识"></a>基础知识</h3><p>1、编译型语言和解释型语言</p>
<p>开发源代码之后，通过编译器可以生成一个可执行文件。可以直接运行</p>
<p>解释性语言：将源程序丢给解释器，会按照从上向下依次翻译，读一行翻译一行然后交给CPU执行一行。<br>读取一行，翻译一行，执行一行</p>
<p>编译型语言执行快。编译型语言不能跨平台。真正和硬件打交道的是操作系统。</p>
<p>解释型语言：在不同的操作系统上面，安装不同的解释器。由解释器进行翻译和执行。</p>
<h4 id="Python的设计目标"><a href="#Python的设计目标" class="headerlink" title="Python的设计目标"></a>Python的设计目标</h4><ul>
<li>一门简单直观的语言并与主要竞争者一样强大</li>
<li>开源，以便任何人都可以为它做贡献</li>
<li>代码容易理解</li>
<li>适用于短期开发的日常任务</li>
</ul>
<p>设计哲学：</p>
<ul>
<li>优雅</li>
<li>明确</li>
<li>简单</li>
</ul>
<p>用一种方法，做一件事情，最好是只有一种方法来做一件事。</p>
<p>如果面临多种选择，Python开发者一般会拒绝花俏的语法，而选择明确没有或者很少有歧义的语法</p>
<h4 id="为什么选择Python"><a href="#为什么选择Python" class="headerlink" title="为什么选择Python"></a>为什么选择Python</h4><p>Python和Java是 1:5 的代码量</p>
<p>代码少、速度快、心情好</p>
<h4 id="Python特点"><a href="#Python特点" class="headerlink" title="Python特点"></a>Python特点</h4><ul>
<li>函数、模块、数字、字符串都是对象，在Python 中一切皆对象</li>
<li>完全支持继承、重载、多重继承</li>
<li>支持重载运算符，也支持泛型设计</li>
</ul>
<p>Python拥有一个强大的标准库，Python语言的核心只包含 数字、字符串、列表、字典、文件 等常见类型和函数，而由Python 标准库提供了 系统管理、网络通信、文本处理、数据库接口、图形系统、XML处理 等额外的功能</p>
<p>Python 社区提供了大量的第三方模块，使用方式与标准库类似。它们的功能覆盖  科学计算、人工智能、机器学习、Web开发、数据库接口、图形系统  多个领域</p>
<p>面向对象的思维方式</p>
<ul>
<li>面向对象是一种思维方式，也是一门程序设计技术</li>
<li>要解决一个问题前，首先考虑 由谁 来做，怎么做事情是 谁 的职责，最后把事情做好就行！</li>
<li>对象就是谁</li>
<li>要解决复杂的问题，就可以找多个不同的对象，各司其职，共同实现、最终完成需求</li>
</ul>
<h4 id="Python-优缺点"><a href="#Python-优缺点" class="headerlink" title="Python 优缺点"></a>Python 优缺点</h4><p>简单易学，速度慢一点点</p>
<h3 id="Python源程序的基本概念"><a href="#Python源程序的基本概念" class="headerlink" title="Python源程序的基本概念"></a>Python源程序的基本概念</h3><ol>
<li>Python 源程序就是一个特殊格式的文本文件，可以使用任意文本编辑软件做Python的开发</li>
<li>Python 程序的 文件扩展名 通常都是 .py</li>
</ol>
<p>每行代码负责完成一个动作。</p>
<p>缩进错误：要整齐</p>
<p>python中的中文：2.0不支持中文，python3.0支持中文</p>
<h4 id="Python的程序执行原理"><a href="#Python的程序执行原理" class="headerlink" title="Python的程序执行原理"></a>Python的程序执行原理</h4><ol>
<li>操作系统会首先让CPU把 Python 解释器 的程序复制到 内存中</li>
<li>Python 解释器 根据语法规则， 从上向下 让 CPU 翻译 Python 程序中的代码</li>
<li>CPU 负责执行翻译完成的代码</li>
</ol>
<h3 id="变量"><a href="#变量" class="headerlink" title="变量"></a>变量</h3><h4 id="变量的类型"><a href="#变量的类型" class="headerlink" title="变量的类型"></a>变量的类型</h4><p>在内存中创建一个变量，会包括：</p>
<ol>
<li>变量的名称</li>
<li>变量保存的数据</li>
<li>变量存储数据的类型</li>
<li>变量的地址（标示）</li>
</ol>
<p>在Python中，定义变量时是不需要指定变量的类型的<br>在运行的时候，Python 解释器， 会根据赋值语句等号右侧的数据自动推到出变量中保存数据的准确类型</p>
<p>数据类型：</p>
<ul>
<li>整形 int</li>
<li>布尔 bool</li>
<li>浮点 float</li>
<li>字符 str</li>
</ul>
<p>判断数据类型<br>type(xx)</p>
<p>在3.0中，int和long都被归为int型，不再需要去判断长度</p>
<p>** 次方</p>
<h4 id="不同类型变量之间的计算"><a href="#不同类型变量之间的计算" class="headerlink" title="不同类型变量之间的计算"></a>不同类型变量之间的计算</h4><ol>
<li>在Python中，数字类型的变量可以直接进行运算。包括int ling float bool</li>
<li>字符串变量之间使用 + 拼接字符串  字符串可以运行 * ；数字和字符串不能进行拼接</li>
</ol>
<h4 id="变量的输入"><a href="#变量的输入" class="headerlink" title="变量的输入"></a>变量的输入</h4><ol>
<li>关于函数：一个提前准备好的功能（别人写好的代码），可以直接使用，而不用关心内部的细节</li>
</ol>
<p>例如：print（x）  type(x)</p>
<ol start="2">
<li>input(“请输入:”)</li>
</ol>
<h4 id="变量的格式化输出"><a href="#变量的格式化输出" class="headerlink" title="变量的格式化输出"></a>变量的格式化输出</h4><p>%s 字符串<br>%d 有符号十进制整数，%06d 表示输出的整数显示位数 ， 不足的地方使用0补全<br>%f 浮点数， %。02f 表示小数点后只显示两位<br>%% 输出%</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">name = <span class="string">"大明"</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">"我的名字叫 %s 就是我"</span> % name)</span><br></pre></td></tr></table></figure>
<p>%06d  ：如果不够6位数字  会在前面用 0 来代替   000123</p>
<p>%.3f  :3代表小数点后面显示几位，没有的用 0 代替</p>
<h4 id="变量的命名"><a href="#变量的命名" class="headerlink" title="变量的命名"></a>变量的命名</h4><p>1、关键字<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">import keyword</span><br><span class="line"><span class="built_in">print</span>(keyword.kwlist)</span><br></pre></td></tr></table></figure></p>
<p>导入工具包”keyword”然后查看关键字列表<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[<span class="string">'False'</span>, <span class="string">'None'</span>, <span class="string">'True'</span>, <span class="string">'and'</span>, <span class="string">'as'</span>, <span class="string">'assert'</span>, <span class="string">'break'</span>, <span class="string">'class'</span>, <span class="string">'continue'</span>, <span class="string">'def'</span>, <span class="string">'del'</span>, <span class="string">'elif'</span>, <span class="string">'else'</span>, <span class="string">'except'</span>, <span class="string">'finally'</span>, <span class="string">'for'</span>, <span class="string">'from'</span>, <span class="string">'global'</span>, <span class="string">'if'</span>, <span class="string">'import'</span>, <span class="string">'in'</span>, <span class="string">'is'</span>, <span class="string">'lambda'</span>, <span class="string">'nonlocal'</span>, <span class="string">'not'</span>, <span class="string">'or'</span>, <span class="string">'pass'</span>, <span class="string">'raise'</span>, <span class="string">'return'</span>, <span class="string">'try'</span>, <span class="string">'while'</span>, <span class="string">'with'</span>, <span class="string">'yield'</span>]</span><br></pre></td></tr></table></figure></p>
<p>2、变量的命名规则</p>
<ol>
<li>在定义变量时，为了保证代码格式。 = 的左右应该各保留一个空格</li>
<li>在Python中，如果变量名需要由两个或多个单词组成时，可以按照以下方式命名<br>a. 每个单词都使用小写字母<br>b. 单词与单词之间使用 _ 下划线 连接<br>c. 驼峰不使用下划线：小驼峰（首单词首字母小写，后面的大写）和大驼峰（所有的单词都是首字母大写），Python中习惯下划线</li>
</ol>
<h3 id="判断语句"><a href="#判断语句" class="headerlink" title="判断语句"></a>判断语句</h3><h4 id="if"><a href="#if" class="headerlink" title="if"></a>if</h4><p>格式：<br>    if 要判断的条件:<br>        条件成立时，要做的事情<br>        。。。。<br>注意：代码的缩进为一个tab键，或者4个空格–建议使用空格<br> 在Python开发中，Tab和空格不要混用！</p>
<p>if写完后，下一条语句要加一个tab或4个空格</p>
<p>如果条件成立，执行下面带有缩进的代码。如果不成立就向下执行下面不带缩进的代码</p>
<h4 id="else-处理条件不满足的情况"><a href="#else-处理条件不满足的情况" class="headerlink" title="else 处理条件不满足的情况"></a>else 处理条件不满足的情况</h4><p>if 要判断的条件：<br>    条件成立时，要做的事情<br>    ….<br>else:<br>    条件不成立时，要做的事情</p>
<h4 id="逻辑运算"><a href="#逻辑运算" class="headerlink" title="逻辑运算"></a>逻辑运算</h4><p>or  and  not<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">python_score = 80</span><br><span class="line">c_score = 50</span><br><span class="line"><span class="keyword">if</span> python_score &gt; 60 or c_score &gt; 60:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"考试通过"</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"考试未通过"</span>)</span><br></pre></td></tr></table></figure></p>
<h4 id="if-语句进阶-elif"><a href="#if-语句进阶-elif" class="headerlink" title="if 语句进阶 elif"></a>if 语句进阶 elif</h4><p>if 条件1:<br>     …..<br>elif 条件2：<br>    …..<br>elif 条件3：<br>    。。。。</p>
<p>注意：</p>
<ol>
<li>elif 和 else 都必须和 if 联合使用，而不能单独使用</li>
<li>可以将 if elif 和 else 以及各自缩进的代码 看成一个 完整的代码块<br><img src="http://whyathere.github.io/images/Python/if综合示例.jpg" alt=""></li>
</ol>
<h4 id="if-嵌套"><a href="#if-嵌套" class="headerlink" title="if 嵌套"></a>if 嵌套</h4><p>if内嵌套的 if 应以第二个 if 为基础再次进行基础上的缩进</p>
<h4 id="随机数的使用"><a href="#随机数的使用" class="headerlink" title="随机数的使用"></a>随机数的使用</h4><ol>
<li>首先导入模块工具包<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">import random</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>random.randint(10,20) 第一个数必须比第二个数小</p>
<p>import random 要在代码的最顶部</p>
<h3 id="循环"><a href="#循环" class="headerlink" title="循环"></a>循环</h3><p>目的：重复计算<br>程序的三大流程<br>while<br>break 和 continue<br>while 循环嵌套</p>
<h4 id="while-语句基本语法"><a href="#while-语句基本语法" class="headerlink" title="while 语句基本语法"></a>while 语句基本语法</h4><p>while 条件（判断 计数器 是否达到 目标次数）:<br>        条件满足时，做的事情1<br>        条件满足时，做的事情2<br>        。。。。<br>        处理条件(计数器+1)<br>while 语句以及缩进部分是一个 完整的代码</p>
<h4 id="continue-和-break"><a href="#continue-和-break" class="headerlink" title="continue 和 break"></a>continue 和 break</h4><p>continue：满足某一个条件时，不执行后续重复代码</p>
<p>break：满足后跳出循环</p>
<h3 id="print-扩展"><a href="#print-扩展" class="headerlink" title="print 扩展"></a>print 扩展</h3><p>默认情况下：print 函数输出内容后，会自动在内容末尾增加换行<br>如果不希望末尾增加换行，可以在 print 函数输出内容的后面增加 , end=””<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">print</span>(<span class="string">"*"</span>,end=<span class="string">"---"</span>)</span><br><span class="line">会在打印 * 之后加 <span class="string">"---"</span></span><br></pre></td></tr></table></figure></p>
<h3 id="循环嵌套"><a href="#循环嵌套" class="headerlink" title="循环嵌套"></a>循环嵌套</h3><p>例子：九九成表法<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">row = 1</span><br><span class="line"><span class="keyword">while</span> row &lt;= 9:</span><br><span class="line">    j = 1</span><br><span class="line">    <span class="keyword">while</span> j &lt;= row:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"%d * %d = %d"</span> %(j,row,row * j),end=<span class="string">"   "</span>)</span><br><span class="line">        j += 1</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">""</span>)</span><br><span class="line">    row += 1</span><br></pre></td></tr></table></figure></p>
<h4 id="使用转义字符调整格式"><a href="#使用转义字符调整格式" class="headerlink" title="使用转义字符调整格式"></a>使用转义字符调整格式</h4><p>九九成表法发现对不齐<br>原因是：开始是一位数字，后面变成了两位，但是每次后面都是加一个空格</p>
<p>字符串中的转移字符：</p>
<ul>
<li>\t 在控制台输出一个制表符，协助在输出文本时 垂直方向 保持对其</li>
<li>\n 在控制台输出一个换行符</li>
<li>制表符 的功能是在不使用表格的情况下在 垂直方向 按列对齐文本<br>  \        反斜杠符号<br>  .        单引号<br>  “        双引号<br>  n        换行<br>  t        横向制表符<br>  r        回车</li>
</ul>
<p>在每个字符后面添加一个 \t 就会让它对齐<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">print</span>(<span class="string">"1\t2\t3"</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">"10\t20\t30"</span>)</span><br></pre></td></tr></table></figure></p>
<p>那么九九乘法表里面的  end=”” 改为end = “\t” 就可以了。  \t 制表符<br>\” 会输出 “</p>
<h3 id="函数"><a href="#函数" class="headerlink" title="函数"></a>函数</h3><p>函数的定义：就是把具有独立功能的代码块  组织成一个小模块，在需要的时候调用</p>
<ol>
<li>定义函数 – 封装 独立的功能</li>
<li>调用函数 – 享受 封装 的成果</li>
</ol>
<p>函数的作用：在开发程序时，使用函数可以提高编写的效率以及代码的 重用</p>
<p>def 函数名():<br>    函数封装的代码</p>
<ol>
<li>函数的名称 应该能够表达 函数封装代码 的功能， 方便后续的调用</li>
<li>函数名称 的命名应该 符合 标识符的</li>
<li><p> 可以由字母、下划线和数字组合<br> 不能以数字开头<br> 不能与关键字重名</p>
</li>
</ol>
<p>调用的时候直接   函数名+()  即可调用函数</p>
<p>只有在程序中，主动调用函数，才会让函数执行</p>
<h4 id="函数的参数"><a href="#函数的参数" class="headerlink" title="函数的参数"></a>函数的参数</h4><p>参数的作用：<br>        函数：把 具有独立功能的代码块 组织成一个小模块，在需要的时候 调用<br>        函数的参数：增加函数的 通用性，针对 相同的数据处理逻辑， 能够 适应更多的数据</p>
<pre><code>1. 在函数 内部 把参数当做 变量 使用，进行需要的数据处理
2. 函数调用时，按照函数定义的参数顺序，把 希望在函数内部处理的数据，通过参数 传递
</code></pre><h4 id="形参和实参"><a href="#形参和实参" class="headerlink" title="形参和实参"></a>形参和实参</h4><p>形参：定义 函数 时，小括号中的参数，是用来接收参数用的，在函数内部 作为变量使用<br>实参：调用 函数 时，小括号中的参数，是用来把数据传递到 函数内部 用的</p>
<h4 id="函数的返回值"><a href="#函数的返回值" class="headerlink" title="函数的返回值"></a>函数的返回值</h4><p>一个函数执行结束后，告诉调用者一个结果，以便于调用者针对具体的结果做后续的处理</p>
<p>返回值 是函数 完成工作后，最后 给调用者的 一个结果<br>在函数中使用 return 关键字可以返回结果<br>调用函数一方 ，可以 使用变量 来接收 函数的返回结果</p>
<p>这里不需要定义返回值类型</p>
<p>return 表示返回，后续的代码都不会被执行</p>
<h4 id="函数的嵌套调用"><a href="#函数的嵌套调用" class="headerlink" title="函数的嵌套调用"></a>函数的嵌套调用</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">def print_line(char,<span class="built_in">times</span>):</span><br><span class="line">    <span class="built_in">print</span>(char * <span class="built_in">times</span>)</span><br></pre></td></tr></table></figure>
<p>提示：工作中针对需求的变化，应该冷静思考，不要轻易修改之前已经完成的，能够正常执行的函数！</p>
<h4 id="函数的文档注释"><a href="#函数的文档注释" class="headerlink" title="函数的文档注释"></a>函数的文档注释</h4><ul>
<li>在开发中，如果希望给函数添加注释，应该在 定义函数 的下方，使用 连续的三对引号</li>
<li>在 连续的三对引号 之间编写对函数的说明文字</li>
<li>在 函数调用 位置，使用快捷键 CTRL+Q 可以查看函数的说明信息</li>
</ul>
<p>函数定义时需要注意：</p>
<ol>
<li>因为 函数体相对比较独立，函数定义的上方，应该和其他代码（包括注释）保留两行空格</li>
</ol>
<h3 id="模块"><a href="#模块" class="headerlink" title="模块"></a>模块</h3><p>模块：模块是 Python 程序框架的一个核心概念</p>
<ul>
<li>模块 就好比是 工具包，要想使用这个工具包中的工具，就需要 导入 import 这个模块</li>
<li>每一个以扩展名 py 结尾的 Python 源代码文件都是一个 模块</li>
<li><p>在模块中定义的 全局变量、函数 都是模块能够提供给外界直接使用的工具</p>
</li>
<li><p>可以 在一个 Python 文件中 定义 变量 或者 函数</p>
</li>
<li>然后 在 另外一个文件中 使用 import 导入这个模块</li>
<li>导入之后，就可以使用 模块名.变量/模块名.函数 的方式，使用这个模块中定义的变量或者函数</li>
</ul>
<p>模块可以让 曾经编写过的代码 方便的被复用</p>
<h4 id="Pyc文件"><a href="#Pyc文件" class="headerlink" title="Pyc文件"></a>Pyc文件</h4><p>C  是 compiled 编译过 的意思<br>pyc 文件是由 Python 解释器将 模块的源码 转换为 字节码</p>
<h3 id="命名规则"><a href="#命名规则" class="headerlink" title="命名规则"></a>命名规则</h3><ol>
<li>项目  只使用 小写字母、数字和下划线。不能数字开头；不能和关键字重名</li>
</ol>
<h3 id="高级变量类型"><a href="#高级变量类型" class="headerlink" title="高级变量类型"></a>高级变量类型</h3><ul>
<li>列表</li>
<li>元组</li>
<li>字典</li>
<li>字符串</li>
<li>公共方法</li>
<li>变量高级</li>
</ul>
<p>Python 中数据类型可以分为 数字型 和 非数据型<br>分类：<br>    数字型</p>
<ul>
<li>整型 （int）</li>
<li>浮点型（float）</li>
<li>布尔型（bool）<br>  真 True 非 0 数 – 非零即真<br>  假 False 0 </li>
<li>复数型（complex）<br>  主要用于科学计算，例如：平面场问题、波动问题、电感电容等问题</li>
</ul>
<p>非数字型</p>
<ul>
<li>字符串</li>
<li>列表</li>
<li>元组</li>
<li>字典</li>
</ul>
<p>在Python中，所有 非数字型变量 都支持以下特点：</p>
<ol>
<li>都是一个 序列 sequence ， 也可以理解为 容器</li>
<li>取值 [1]</li>
<li>遍历 for in </li>
<li>计算长度、最大/最小值、比较、删除</li>
<li>链接 + 和 重复 *</li>
<li>切片</li>
</ol>
<h4 id="列表"><a href="#列表" class="headerlink" title="列表"></a>列表</h4><p>List 是 Python 中使用 最频繁 的数据类型，在其他语言中叫 数组<br>例：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">name_list = [<span class="string">"张三"</span>,<span class="string">"lisi"</span>,<span class="string">"wangwu"</span>,89]</span><br></pre></td></tr></table></figure>
<p><img src="http://whyathere.github.io/images/Python/列表.jpg" alt=""></p>
<p>常用的几个方法：</p>
<h5 id="取索引"><a href="#取索引" class="headerlink" title="取索引"></a>取索引</h5><p>name_list.index()<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">name_list = [<span class="string">"张三"</span>,<span class="string">"lisi"</span>,<span class="string">"wangwu"</span>,89]</span><br><span class="line">name_list.index(<span class="string">"wangwu"</span>)</span><br></pre></td></tr></table></figure></p>
<h5 id="修改：直接赋值"><a href="#修改：直接赋值" class="headerlink" title="修改：直接赋值"></a>修改：直接赋值</h5><p>name_list[1] = “ddd”</p>
<p>注意：列表指定的索引超出范围，程序会报错！</p>
<h5 id="增加参数"><a href="#增加参数" class="headerlink" title="增加参数"></a>增加参数</h5><ol>
<li><p>name_list.append(“测试”)   # 追加到末尾</p>
</li>
<li><p>插入 Insert<br>name_list.insert(1,”插入”)</p>
</li>
<li><p>extend  追加到末尾</p>
</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">temp_list = [<span class="string">"乌龙"</span>,<span class="string">"ceshi"</span>]</span><br><span class="line">name_list.extend(temp_list)</span><br></pre></td></tr></table></figure>
<p>打印 name_list 就会多出extend的内容</p>
<h5 id="删除"><a href="#删除" class="headerlink" title="删除"></a>删除</h5><ol>
<li>remove</li>
</ol>
<p>可以从列表中删除指定的数据<br>name_list.remove(“乌龙”)</p>
<ol start="2">
<li>pop</li>
</ol>
<p>默认可以把列表中最后一个元素删除</p>
<p>pop(3)  # 指定要删除元素的索引</p>
<ol start="3">
<li>clear</li>
</ol>
<p>name_list.clear()   # 清空列表内容</p>
<ol start="4">
<li>del 关键字</li>
</ol>
<p>del name_list[0]   # 删除下标为 0  元素</p>
<p>del本质上是用来将一个变量从内存中删除</p>
<p>name = “ddd”<br>del name  # 在内存中删除，就无法找到name了</p>
<p>在日常开发中，要从列表删除数据，建议使用列表提供的方法</p>
<h5 id="统计"><a href="#统计" class="headerlink" title="统计"></a>统计</h5><ol>
<li>len<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">list_len = len(name_list)</span><br><span class="line"><span class="built_in">print</span>(list_len)</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>统计列表中有几个元素</p>
<ol start="2">
<li>count 可以统计列表中某一个数据出现的次数</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">count = name_list.count(<span class="string">"zhangsan"</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">"zhangsan出现了 %d 次"</span> % count)</span><br></pre></td></tr></table></figure>
<h5 id="列表排序"><a href="#列表排序" class="headerlink" title="列表排序"></a>列表排序</h5><ol>
<li>sort  升序</li>
<li>sort(reverse=True)  降序</li>
<li>name_list.reverse() 逆序（反转）  #倒过来打印</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">name_list = [<span class="string">"张三"</span>,<span class="string">"lisi"</span>,<span class="string">"wangwu"</span>,<span class="string">"wangwu"</span>]</span><br><span class="line">num_list = [1,4,6,3,40,20]</span><br><span class="line">name_list.sort(reverse=True)</span><br><span class="line">num_list.sort(reverse=True)</span><br><span class="line"><span class="built_in">print</span>(name_list)</span><br><span class="line"><span class="built_in">print</span>(num_list)</span><br></pre></td></tr></table></figure>
<h5 id="关键字、函数和方法"><a href="#关键字、函数和方法" class="headerlink" title="关键字、函数和方法"></a>关键字、函数和方法</h5><ul>
<li><p>关键字 是 Python 内置的、具有特殊意义的标识符<br>关键字 后面不需要使用括号</p>
</li>
<li><p>函数 封装了独立的功能，可以直接调用</p>
</li>
</ul>
<p>函数名（参数）</p>
<p>函数需要死记硬背</p>
<ul>
<li>方法 和函数类似，同样封装了独立的功能</li>
<li>方法 需要通过 对象 来调用，表示针对这个 对象 要做的操作</li>
<li><h5 id="列表的循环遍历"><a href="#列表的循环遍历" class="headerlink" title="列表的循环遍历"></a>列表的循环遍历</h5></li>
<li><p>在 Python 中为了提高列表的遍历效率，专门提高 迭代 iteration 遍历</p>
</li>
<li>使用 for 就能够实现迭代遍历</li>
</ul>
<p>for 循环内部使用的变量 in 列表</p>
<p>for name in name_list:<br>    循环内部针对列表元素进行操作<br>    print(name)<br>迭代遍历：顺序的从列表中依次的获取数据，每一次循环过程中，数据都会保存在my_name 这个变量中<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> my_name <span class="keyword">in</span> name_list:</span><br><span class="line">    <span class="built_in">print</span>(my_name)</span><br></pre></td></tr></table></figure></p>
<h5 id="应用场景"><a href="#应用场景" class="headerlink" title="应用场景"></a>应用场景</h5><ul>
<li>尽管 Python 的列表 中可以 存储不同类型的数据</li>
<li>但在开发中，更多的应用场景是<ol>
<li>列表 存储相同类型 的数据</li>
<li>通过 迭代遍历 ，在循环体内部，针对列表中的每一项元素， 执行相同的操作</li>
</ol>
</li>
</ul>
<h4 id="元组"><a href="#元组" class="headerlink" title="元组"></a>元组</h4><ul>
<li>Tuple （元组）与列表类似，不同之处在于元组的 元素不能修改<ul>
<li>元组 表示多个元素组成的序列</li>
<li>元组 在 Python 开发中，有特定的应用场景</li>
</ul>
</li>
<li>用于存储 一串 信息、数据 之间使用 ， 分割</li>
<li>元组用 （） 定义</li>
<li>元组的 索引 从 0 开始</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">info_tuple = (<span class="string">"zhangsan"</span>,<span class="string">"lisi"</span>,18)</span><br></pre></td></tr></table></figure>
<p>可以用 type 来验证类型</p>
<p>如果元组只有一个元素  则 type 会显示这个元素的 类型</p>
<h5 id="元组的常用操作"><a href="#元组的常用操作" class="headerlink" title="元组的常用操作"></a>元组的常用操作</h5><ul>
<li>定义一个元组 info = ()  # 定义一个空元组</li>
</ul>
<ol>
<li>取值和取索引</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">info_tuple = (<span class="string">"zhangsan"</span>,<span class="string">"lisi"</span>,56)</span><br><span class="line"><span class="built_in">print</span>(info_tuple[0])</span><br><span class="line"><span class="built_in">print</span>(info_tuple.index(<span class="string">"zhangsan"</span>))</span><br></pre></td></tr></table></figure>
<ol start="2">
<li>统计计数<br>统计元组中包含的 个数<br>print(info_tuple.count(“zhangsan”))</li>
</ol>
<p>统计元组中包含元素的个数</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">print</span>(len(info_tuple))</span><br></pre></td></tr></table></figure>
<h5 id="元组的循环遍历"><a href="#元组的循环遍历" class="headerlink" title="元组的循环遍历"></a>元组的循环遍历</h5><p>取值 就是从 元组 中获取存储在指定位置的数据<br>遍历 就是 从头到尾 依次 从 元组 中获取数据</p>
<p> for item in info:<br>    循环内部针对元组元素进行操作<br>    print(item)</p>
<ul>
<li>在 Python 中，可以使用 for 循环遍历所有非数字类型的变量：列表、元组、字典 以及 字符串</li>
<li><p>提示：在实际开发中，除非 能够确认元组中的数据类型，否则针对元组的循环遍历需求并不是很多<br>例：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">info_tuple = (<span class="string">"zhangsan"</span>,<span class="string">"lisi"</span>,56,<span class="string">"zhangsan"</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> temp <span class="keyword">in</span> info_tuple:</span><br><span class="line">    <span class="built_in">print</span>(temp)</span><br></pre></td></tr></table></figure>
<p>  使用格式字符串拼接 my_info 这个变量不方便！<br>  因为元组中通常保存的数据类型是不同的！</p>
</li>
</ul>
<h5 id="应用场景-1"><a href="#应用场景-1" class="headerlink" title="应用场景"></a>应用场景</h5><ul>
<li>尽管可以使用 for in 遍历 元组</li>
<li>但是在开发中，更多的应用场景是：<pre><code>-函数的 参数 和返回值，一个函数可以接收任意多个参数，后者 一次返回多个数据 
</code></pre></li>
</ul>
<p>格式化字符串，格式化字符串后面的（）本质上就是一个元组</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">info_tuple = (<span class="string">"zhangsan"</span>,56)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">"%s 的年龄 %d"</span> % info_tuple)</span><br></pre></td></tr></table></figure>
<p>以下结果是一样的</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">info_tuple = (<span class="string">"zhangsan"</span>,56,1.85)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">"%s 的年龄 %d 身高是 %.2f"</span> % info_tuple)</span><br><span class="line"></span><br><span class="line">info_str = <span class="string">"%s 的年龄 %d 身高是 %.2f"</span> % info_tuple</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(info_str)</span><br></pre></td></tr></table></figure>
<h5 id="列表和元组之间的转换"><a href="#列表和元组之间的转换" class="headerlink" title="列表和元组之间的转换"></a>列表和元组之间的转换</h5><p>场景：函数的参数 和 返回值， 一个函数可以接收 任意多个参数 ， 或者 一次返回多个数据<br>    格式化字符串，格式化字符串后面的（）本质上就是一个元组<br>    让列表不可以被修改，以保护数据安全<br>转换例子：</p>
<ul>
<li><p>使用 list 函数可以把元组转换成列表<br>list(元组)<br>   使用 tuple 函数可以把列表转换成元组</p>
<p>tuple(列表)</p>
</li>
</ul>
<h4 id="字典"><a href="#字典" class="headerlink" title="字典"></a>字典</h4><h5 id="字典的定义"><a href="#字典的定义" class="headerlink" title="字典的定义"></a>字典的定义</h5><p>dictionary （字典）是除了列表以外 Python 之中 最灵活 的数据类型<br>字典同样可以用来 存储多个数据</p>
<ul>
<li>通常用于存储 描述一个 物体 的相关信息</li>
<li>和列表的区别<ul>
<li>列表 是 有序 的对象集合</li>
<li>字典 是 无序 的对象集合</li>
</ul>
</li>
<li>字典用 {} 定义</li>
<li>字典使用 键值对 存储数据，键值对之间使用 ， 分隔<ul>
<li>键 key 是索引</li>
<li>值 value 是数据</li>
<li>键 和 值 之间使用 ： 分隔</li>
<li>键必须是唯一的</li>
<li>值 可以取任何数据类型， 但 键 只能使用 字符串、数字和 元组</li>
</ul>
</li>
</ul>
<p><img src="http://whyathere.github.io/images/Python/字典.jpg" alt=""></p>
<p>字典.keys()  所有 key 列表<br>字典.values() 所有 value 列表<br>字典.items()  所有（key,value） 元组列表</p>
<p>字典是无序的数据集合，使用print 函数输出字典时，通常<br>输出的顺序和定义的顺序是不一致的</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">xiaoming = &#123;<span class="string">"name"</span>:<span class="string">"小明"</span>,</span><br><span class="line">            <span class="string">"age"</span> : 18,</span><br><span class="line">            <span class="string">"address"</span> : <span class="string">"上海宝山"</span>,</span><br><span class="line">            <span class="string">"gender"</span> : True,</span><br><span class="line">            <span class="string">"height"</span> : 1.75</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(xiaoming)</span><br></pre></td></tr></table></figure>
<h5 id="字典的常用操作"><a href="#字典的常用操作" class="headerlink" title="字典的常用操作"></a>字典的常用操作</h5><ol>
<li><p>取值  输入 key 可以拿到 value</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">print</span>(xiaoming[<span class="string">"address"</span>])</span><br></pre></td></tr></table></figure>
</li>
<li><p>增加/修改<br>修改</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">xiaoming[<span class="string">"address"</span>] = <span class="string">"上海徐汇"</span></span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>如果 key  存在会修改已经存在的键值对，如果不存在 key 会增加键值对</p>
<ol start="3">
<li>删除  pop</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">xiaoming.pop(<span class="string">"address"</span>)</span><br></pre></td></tr></table></figure>
<ol start="4">
<li><p>统计键值对的数量</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">print</span>(len(xiaoming))</span><br></pre></td></tr></table></figure>
</li>
<li><p>合并字典</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">temp_dict = &#123;<span class="string">"height"</span> : 1.98&#125;</span><br><span class="line"></span><br><span class="line">xiaoming.update(temp_dict)</span><br></pre></td></tr></table></figure>
</li>
<li><p>清空 clear</p>
</li>
</ol>
<h5 id="循环遍历"><a href="#循环遍历" class="headerlink" title="循环遍历"></a>循环遍历</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> k <span class="keyword">in</span>  xiaoming:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"%s - %s"</span> % (k,xiaoming[k]))</span><br></pre></td></tr></table></figure>
<p>迭代遍历字典<br>变量K是每一次循环中，获取到的键值对的key</p>
<h5 id="字典和列表组合的应用场景"><a href="#字典和列表组合的应用场景" class="headerlink" title="字典和列表组合的应用场景"></a>字典和列表组合的应用场景</h5><p>开发中，更多的是：</p>
<pre><code>- 使用 多个键值对，存储 描述一个 物体 的相关信息 -- 描述更复杂的数据信息
- 将 多个字典 放在 一个列表 中，再进行遍历，在循环体内部这对每一个字典进行 相同的处理
</code></pre><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">xiaoming = [&#123;<span class="string">"name"</span>: <span class="string">"小明"</span>,</span><br><span class="line">             <span class="string">"age"</span>: 18,</span><br><span class="line">             <span class="string">"address"</span>: <span class="string">"上海宝山"</span>,</span><br><span class="line">             <span class="string">"gender"</span>: True,</span><br><span class="line">             &#125;,</span><br><span class="line">            &#123;<span class="string">"name"</span>: <span class="string">"大明"</span>,</span><br><span class="line">             <span class="string">"age"</span>: 29,</span><br><span class="line">             <span class="string">"address"</span>: <span class="string">"上海浦东"</span>,</span><br><span class="line">             <span class="string">"gender"</span>: False,</span><br><span class="line">             &#125;</span><br><span class="line">            ]</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> k <span class="keyword">in</span> xiaoming:</span><br><span class="line">    <span class="built_in">print</span>(k)</span><br></pre></td></tr></table></figure>
<p>字典是无序的，列表是有序的</p>
<h4 id="字符串"><a href="#字符串" class="headerlink" title="字符串"></a>字符串</h4><ul>
<li>字符串 就是一串字符，是编程语言中表示文本的数据类型</li>
<li><p>在 Python 中可以使用  一对双引号 “ 或者 一对单引号 ‘ 定义一个字符串</p>
<ul>
<li>虽然可以使用 \” 或者 \’ 做字符串的转义，但是在实际开发中：<ul>
<li>如果字符串内部需要使用 “ 可以使用 ‘ 定义字符串</li>
<li>如果字符串内部需要使用 ‘ 可以使用 “ 定义字符串</li>
</ul>
</li>
<li>可以使用 索引 获取一个字符串中 指定位置的字符，索引计数从 0 开始</li>
<li><p>也可以使用 for 循环遍历 字符串每一个字符串</p>
<p>大多数编程语言都是用 “ 来定义字符串</p>
</li>
</ul>
</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">str1 = <span class="string">"hello python"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> char <span class="keyword">in</span>  str1:</span><br><span class="line">    <span class="built_in">print</span>(char)</span><br></pre></td></tr></table></figure>
<p>‘我的外号是”大西瓜”‘<br>打印： 我的外号是”大西瓜”</p>
<p>可以通过索引的方式来获取  字符串中的字符</p>
<p>字符串的索引值是从 0 开始的</p>
<p>字符串（索引）从字符串中取出单个字符<br>字符串.index（字符串）获取小字符串第一次出现的索引</p>
<ol>
<li>len(字符串) 获取字符串的长度</li>
<li>字符串.count（字符串）小字符串在大字符串中出现的次数</li>
<li>某一个子字符串出现的位置    print(str1.index(“python”))</li>
</ol>
<h5 id="字符串的常用操作"><a href="#字符串的常用操作" class="headerlink" title="字符串的常用操作"></a>字符串的常用操作</h5><p>Python 中内置提供的方法足够多。</p>
<ol>
<li><p>判断类型</p>
<ul>
<li>string.isspace()        如果string中只包含空格，则返回true<br>   string.isalnum()        如果string至少有一个字符并且所有字符都是字母或数字则返回True</li>
<li>string.isalpha()      如果string至少有一个字符并且所有字符都是字母则返回True</li>
<li>string.isdecimal()    如果string只包含数字则返回True，全角数字<br>   string.isdigit()         如果string只包含数字则返回True，全角数字、（1）、\u00b2<br>   string.isnumeric()    如果string只包含数字则返回True，全角数字，汉子数字<br>   string.istitle()        如果string是标题化的（每个单词的首字母大写）则返回True<br>   string.islower()        如果string中包含至少一个区分大小写的字符，并且所有这些（区分大小写的）字符都是小写，则返回True<br>   string.isupper（）        如果string中包含至少一个区分大小写的字符，并且所有这些（区分大小写的）字符都是大写，则返回True</li>
</ul>
</li>
<li><p>查找和替换<br> <img src="http://whyathere.github.io/images/Python/str-查找和替换.jpg" alt=""></p>
</li>
<li><p>大小写转化<br> <img src="http://whyathere.github.io/images/Python/str-大小写转换.jpg" alt=""></p>
</li>
<li><p>文本对齐<br> <img src="http://whyathere.github.io/images/Python/str-文本对齐.jpg" alt=""></p>
</li>
<li><p>去除空白字符</p>
<p> <img src="http://whyathere.github.io/images/Python/str-去除空白字符.jpg" alt=""></p>
</li>
<li><p>拆分和连接</p>
<p> <img src="http://whyathere.github.io/images/Python/str-拆分和连接.jpg" alt=""></p>
</li>
</ol>
<p>实例：</p>
<ol>
<li><p>判断空白字符</p>
<pre><code><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">str1 = <span class="string">"hello python"</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(str1.isspace())</span><br></pre></td></tr></table></figure>
</code></pre></li>
</ol>
<p>在python中，转义字符属于是  空</p>
<ol start="2">
<li><p>判断字符串中是否只包含数字</p>
<pre><code><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">str1 = <span class="string">"\u00b2"</span></span><br><span class="line"></span><br><span class="line"> 这三个方法都不能判断小数。是否只包含数字</span><br><span class="line"><span class="built_in">print</span>(str1)</span><br><span class="line"><span class="built_in">print</span>(str1.isdecimal()) <span class="comment"># 只能判断单纯的数字</span></span><br><span class="line"><span class="built_in">print</span>(str1.isdigit())   <span class="comment"># 不仅能判断阿拉伯数字</span></span><br><span class="line"><span class="built_in">print</span>(str1.isnumeric())</span><br></pre></td></tr></table></figure>
</code></pre></li>
</ol>
<p>先使用 strip 方法去除字符串中的空白字符。包括转义字符<br>再使用 center 方法居中显示文本</p>
<h5 id="拆分分隔符，拼接成一个整齐的字符串"><a href="#拆分分隔符，拼接成一个整齐的字符串" class="headerlink" title="拆分分隔符，拼接成一个整齐的字符串"></a>拆分分隔符，拼接成一个整齐的字符串</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">poem_str = <span class="string">"登黄鹤楼\t 王之涣\t 白日依山尽\t\n黄河入海流\t\t欲穷千里目"</span></span><br><span class="line"><span class="built_in">print</span>(poem_str)</span><br></pre></td></tr></table></figure>
<p>显示不整齐</p>
<ol>
<li>将字符串中的空白字符全部去掉</li>
<li>再使用 “ “ 作为分隔符，拼接成一个整齐的字符串</li>
</ol>
<p>poem_list=poem_str.split()  可以把大的字符串拆分成一个没有空格的列表</p>
<p>[‘登黄鹤楼’, ‘王之涣’, ‘白日依山尽’, ‘黄河入海流’, ‘欲穷千里目’]</p>
<p>合并字符串<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">poem_str = <span class="string">"登黄鹤楼\t 王之涣\t 白日依山尽\t\n黄河入海流\t\t欲穷千里目"</span></span><br><span class="line"><span class="built_in">print</span>(poem_str)</span><br><span class="line">poem_list=poem_str.split()</span><br><span class="line"><span class="built_in">print</span>(poem_list)</span><br><span class="line">result = <span class="string">" "</span>.join(poem_list)</span><br><span class="line"><span class="built_in">print</span>(result)</span><br></pre></td></tr></table></figure></p>
<p>split 可以将大的字符串拆分成列表</p>
<p>join 将seq中所有的元素，合并为一个新的字符串</p>
<h5 id="字符串的切片"><a href="#字符串的切片" class="headerlink" title="字符串的切片"></a>字符串的切片</h5><ul>
<li><strong>切片</strong> 方法适用于 <strong>字符串</strong> 、<strong>列表</strong>、<strong>元组</strong><ul>
<li><strong>切片</strong> 使用 <strong>索引值</strong> 来限定范围，从一个大的 <strong>字符串</strong> 中 <strong>切出</strong> 小的 <strong>字符串</strong></li>
<li><strong>列表</strong> 和 <strong>元组</strong> 都是 <strong>有序</strong> 集合，都能够 <strong>通过索引值</strong> 获取到对应的数据</li>
<li><strong>字典</strong> 是一个 <strong>无序</strong> 的集合，是使用 <strong>键值对</strong> 保存数据</li>
</ul>
</li>
</ul>
<p><strong>语法</strong> ： 字符串[开始索引:结束索引:步长]</p>
<p><strong>逆序</strong>   num_str[-1::-1]   num_str[::-1]</p>
<ol>
<li>从开始位置每隔一个字符取字符串   print(str_demo[::2])</li>
<li>从索引 1 开始，每隔一个字符取字符串  print(str_demo[1::2])</li>
<li>截取从2 - 末尾 - 1 的字符  print(str_demo[2:-1])</li>
<li>截取末尾两个字符 print(str_demo[-2:])</li>
<li>字符串的逆序     print(str_demo[-1::-1])  取完整字符串的时候 print(str_demo[::-1]) 就可以了</li>
</ol>
<h4 id="公共方法"><a href="#公共方法" class="headerlink" title="公共方法"></a>公共方法</h4><p>定义：列表、元组、字典、字符串 都能够使用的方法叫公共方法</p>
<h5 id="Python内置函数"><a href="#Python内置函数" class="headerlink" title="Python内置函数"></a>Python内置函数</h5><p>不需要 import 就可以使用的</p>
<table>
<thead>
<tr>
<th style="text-align:left"><strong>函数</strong></th>
<th style="text-align:left"><strong>描述</strong></th>
<th style="text-align:left"><strong>备注</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">len(item)</td>
<td style="text-align:left">计算容器中元素个数</td>
<td style="text-align:left">字典就是键值对的个数</td>
</tr>
<tr>
<td style="text-align:left">del(item)</td>
<td style="text-align:left">删除变量</td>
<td style="text-align:left">del有两种方式  del a[1] ;del(a[1])</td>
</tr>
<tr>
<td style="text-align:left">max(item)</td>
<td style="text-align:left">返回容器中元素最大值</td>
<td style="text-align:left">如果是字典，只针对key比较</td>
</tr>
<tr>
<td style="text-align:left">min(item)</td>
<td style="text-align:left">返回容器中元素的最小值</td>
<td style="text-align:left">如果是字典，只针对key比较</td>
</tr>
<tr>
<td style="text-align:left">cmp(item1,item2)</td>
<td style="text-align:left">比较两个值，-1小于/0 相等 /1 大于</td>
<td style="text-align:left">Python 3.x 取消了cmp函数</td>
</tr>
</tbody>
</table>
<p><strong>cmp</strong> 字典和字典不能比较大小   列表和元组可以</p>
<p><strong>注意</strong></p>
<ul>
<li><strong>字符串</strong> 比较符合以下规则 ： “0” &lt; “A” &lt; “a”</li>
</ul>
<h5 id="高级数据类型的切片"><a href="#高级数据类型的切片" class="headerlink" title="高级数据类型的切片"></a>高级数据类型的切片</h5><table>
<thead>
<tr>
<th style="text-align:left"><strong>描述</strong></th>
<th style="text-align:left"><strong>Python表达式</strong></th>
<th style="text-align:left"><strong>结果</strong></th>
<th style="text-align:left"><strong>支持的数据类型</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">切片</td>
<td style="text-align:left">“0123456789”[::-2]</td>
<td style="text-align:left">“97531”</td>
<td style="text-align:left">字符串、列表、元组</td>
</tr>
</tbody>
</table>
<ul>
<li><strong>切片</strong> 使用 <strong>索引值</strong> 来限定范围，从一个大的 <strong>字符串</strong> 中 <strong>切出</strong> 小的 <strong>字符串</strong></li>
<li><strong>列表</strong> 和 <strong>元组</strong> 都是 <strong>有序</strong> 的集合，都能够 <strong>通过索引值</strong> 获取到对应的数据</li>
<li><p><strong>字典</strong> 是一个 <strong>无序</strong> 集合，是使用 <strong>键值对</strong> 保存数据</p>
<p>  <code>print([4,2,3,4,5,6][1:3])</code></p>
</li>
</ul>
<p><strong>字典是不支持切片的</strong></p>
<h5 id="算数运算符"><a href="#算数运算符" class="headerlink" title="算数运算符"></a>算数运算符</h5><table>
<thead>
<tr>
<th style="text-align:center">运算符</th>
<th style="text-align:left">Python表达式</th>
<th style="text-align:left">结果</th>
<th style="text-align:left">描述</th>
<th style="text-align:left">支持的数据类型</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">+</td>
<td style="text-align:left">[1,2]+[3,4]</td>
<td style="text-align:left">[1,2,3,4]</td>
<td style="text-align:left">合并</td>
<td style="text-align:left">字符串、列表、元组</td>
</tr>
<tr>
<td style="text-align:center">**</td>
<td style="text-align:left">[“Hi!”]*2</td>
<td style="text-align:left">[‘Hi!’,’Hi!’]</td>
<td style="text-align:left">重复</td>
<td style="text-align:left">字符串、列表、元组</td>
</tr>
<tr>
<td style="text-align:center">in</td>
<td style="text-align:left">3 in (1,2,3)</td>
<td style="text-align:left">True</td>
<td style="text-align:left">元素是否存在</td>
<td style="text-align:left">字符串列表、元组、字典</td>
</tr>
<tr>
<td style="text-align:center">not in</td>
<td style="text-align:left">4 not in（1,2,3）</td>
<td style="text-align:left">True</td>
<td style="text-align:left">元素是否存在</td>
<td style="text-align:left">字符串、列表、元组、字典</td>
</tr>
<tr>
<td style="text-align:center">&gt; &gt;= = == &lt; &lt;=</td>
<td style="text-align:left">(1,2,3)&lt;(2,2,3)</td>
<td style="text-align:left">True</td>
<td style="text-align:left">元素比较</td>
<td style="text-align:left">字符串、列表、元组</td>
</tr>
</tbody>
</table>
<p><strong>注意</strong></p>
<ul>
<li>in 在对 <strong>字典</strong> 操作时，判断的是 <strong>字典的键</strong></li>
<li>in 和 not in 被称为 <strong>成员运算符</strong></li>
</ul>
<h5 id="完整的-for-循环语法"><a href="#完整的-for-循环语法" class="headerlink" title="完整的 for 循环语法"></a>完整的 for 循环语法</h5><ul>
<li>在 Python 中完整的 for 循环 的语法如下：</li>
</ul>
<pre><code>for 变量 in 集合：
    循环体代码
else：
    没有通过 break 退出循环，循环结束后，会执行的代码
</code></pre><p>当for循环把列表中的元素遍历完以后，else下面的代码就会执行！<br>当整个集合没有遍历完成，for循环就结束（循环体内部使用break），else下面的代码就不会执行。</p>
<p><strong>应用场景</strong></p>
<ul>
<li>在 <strong>迭代遍历</strong> 嵌套的数据类型时，例如 <strong>一个列表包含了多个字典</strong></li>
<li>需求： 要判断 某一个字典中 是否存在 指定的 值<ul>
<li>如果 <strong>存在</strong>，提示并且退出循环</li>
<li>如果 <strong>不存在</strong>，在 <strong>循环整体结束</strong> 后，希望 <strong>得到一个统一的提示</strong><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">students = [</span><br><span class="line">    &#123;<span class="string">"name"</span>:<span class="string">"阿土"</span>&#125;,</span><br><span class="line">    &#123;<span class="string">"name"</span>:<span class="string">"小妹"</span>&#125;</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line">find_name = <span class="string">"小妹"</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> stu_dict <span class="keyword">in</span>  students:</span><br><span class="line">    <span class="built_in">print</span>(stu_dict)</span><br><span class="line">    <span class="keyword">if</span> stu_dict[<span class="string">"name"</span>] == find_name:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"找到了 %s"</span> % find_name)</span><br><span class="line">		<span class="built_in">break</span></span><br><span class="line">	<span class="keyword">else</span>:</span><br><span class="line"><span class="built_in">print</span>(<span class="string">"循环结束"</span>)</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
</ul>
<p>break 后就不会再执行 else 后面的代码</p>
<h3 id="小程序-名片管理"><a href="#小程序-名片管理" class="headerlink" title="小程序-名片管理"></a>小程序-名片管理</h3><h4 id="雏形"><a href="#雏形" class="headerlink" title="雏形"></a>雏形</h4><p>pass 关键字 ，表示一个占位符，能够保证程序的代码结构正确。程序运行时，pass关键字不会执行任何的操作。</p>
<p>通过无限循环，让用户可以在只有 输入 0 的时候才退出程序<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span> True:</span><br><span class="line"></span><br><span class="line">    action_str = input(<span class="string">"请选择希望执行的操作:"</span>)</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"您选择的操作是【%s】"</span> % action_str)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> action_str <span class="keyword">in</span> [<span class="string">"1"</span>,<span class="string">"2"</span>,<span class="string">"3"</span>]:</span><br><span class="line"></span><br><span class="line">        pass</span><br><span class="line">    <span class="keyword">elif</span> action_str == <span class="string">"0"</span>:</span><br><span class="line"></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"欢迎再次使用[名片管理系统]"</span>)</span><br><span class="line">        <span class="built_in">break</span></span><br><span class="line">        <span class="comment"># pass</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"您输入的不正确，请重新选择"</span>)</span><br></pre></td></tr></table></figure></p>
<p><strong>TODO 注释</strong></p>
<ul>
<li>在 # 后跟上 TODO ， 用于标记需要去做的工作<blockquote>
<p>  <code># TODO（作者/邮件）显示系统菜单</code><br>像一个锚点，点击后会跳到这个地方</p>
</blockquote>
</li>
</ul>
<h5 id="显示欢迎界面以及功能菜单"><a href="#显示欢迎界面以及功能菜单" class="headerlink" title="显示欢迎界面以及功能菜单"></a>显示欢迎界面以及功能菜单</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">import cards_tools</span><br><span class="line"><span class="keyword">while</span> True:</span><br><span class="line"></span><br><span class="line">    <span class="comment"># TODO 显示功能菜单</span></span><br><span class="line">    cards_tools.show_menu()</span><br><span class="line">    action_str = input(<span class="string">"请选择希望执行的操作:"</span>)</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"您选择的操作是【%s】"</span> % action_str)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> action_str <span class="keyword">in</span> [<span class="string">"1"</span>,<span class="string">"2"</span>,<span class="string">"3"</span>]:</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 新增名片</span></span><br><span class="line">        <span class="keyword">if</span> action_str == <span class="string">"1"</span>:</span><br><span class="line">            cards_tools.new_card()</span><br><span class="line">            pass</span><br><span class="line">        <span class="comment"># 显示全部</span></span><br><span class="line">        <span class="keyword">elif</span> action_str == <span class="string">"2"</span>:</span><br><span class="line">            cards_tools.show_all()</span><br><span class="line">            pass</span><br><span class="line">        <span class="comment"># 查询名片</span></span><br><span class="line">        <span class="keyword">elif</span> action_str == <span class="string">"3"</span>:</span><br><span class="line">            cards_tools.search_card()</span><br><span class="line">            pass</span><br><span class="line">        pass</span><br><span class="line">    <span class="keyword">elif</span> action_str == <span class="string">"0"</span>:</span><br><span class="line"></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"欢迎再次使用[名片管理系统]"</span>)</span><br><span class="line">        <span class="built_in">break</span></span><br><span class="line">        <span class="comment"># pass</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"您输入的不正确，请重新选择"</span>)</span><br></pre></td></tr></table></figure>
<h5 id="保存名片数据的结构"><a href="#保存名片数据的结构" class="headerlink" title="保存名片数据的结构"></a>保存名片数据的结构</h5><p><strong>程序就是用来处理数据的，而变量就是用来存储数据的</strong></p>
<ul>
<li>使用 <strong>字典</strong> 记录 <strong>每一张名片</strong> 的详细信息</li>
<li>使用 <strong>列表</strong> 统一记录所有的 <strong>名片字典</strong></li>
</ul>
<h5 id="新增名片"><a href="#新增名片" class="headerlink" title="新增名片"></a>新增名片</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">def new_card():</span><br><span class="line">    <span class="string">""</span><span class="string">"新增名片"</span><span class="string">""</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"新增名片"</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 1. 提示用户输入名片的详细信息</span></span><br><span class="line">    name = input(<span class="string">"请输入姓名:"</span>)</span><br><span class="line">    phone = input(<span class="string">"请输入电话号码"</span>)</span><br><span class="line">    qq = input(<span class="string">"请输入QQ"</span>)</span><br><span class="line">    email = input(<span class="string">"请输入邮箱: "</span>)</span><br><span class="line">    <span class="comment"># 2.使用用户输入的信息建立一个名片字典</span></span><br><span class="line"></span><br><span class="line">    card_dict = &#123;</span><br><span class="line">        <span class="string">"name"</span>: name,</span><br><span class="line">        <span class="string">"phone"</span>: phone,</span><br><span class="line">        <span class="string">"qq"</span>: qq,</span><br><span class="line">        <span class="string">"email"</span>: email</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment"># 3.将名片字典添加到列表中</span></span><br><span class="line">    card_list.append(card_dict)</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(card_list)</span><br><span class="line">    <span class="comment"># 4.提示用户添加成功</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"添加 %s 的名片成功！"</span> % name)</span><br></pre></td></tr></table></figure>
<h3 id="变量的进阶"><a href="#变量的进阶" class="headerlink" title="变量的进阶"></a>变量的进阶</h3><h4 id="变量的引用"><a href="#变量的引用" class="headerlink" title="变量的引用"></a>变量的引用</h4><ul>
<li><strong>变量</strong> 和 <strong>数据</strong> 都是保存在 <strong>内存</strong> 中的</li>
<li>在 Pyhton 中 <strong>函数</strong> 的 <strong>参数传递</strong> 以及 <strong>返回值</strong> 都是靠 <strong>引用</strong> 传递的</li>
</ul>
<h5 id="引用的概念"><a href="#引用的概念" class="headerlink" title="引用的概念"></a>引用的概念</h5><p>在 Python 中</p>
<ul>
<li><strong>变量</strong> 和 <strong>数据</strong> 是分开存储的</li>
<li><strong>数据</strong> 保存在内存中的一个位置</li>
<li><strong>变量</strong> 中保存着数据在内存中的地址</li>
<li><strong>变量</strong> 中 <strong>记录数据的地址</strong>，就叫做 <strong>内存地址</strong></li>
<li>使用 id() 函数可以查看变量中保存数据所在的 <strong>内存地址</strong></li>
</ul>
<p>注意：如果变量已经被定义，当给一个变量复制的时候，本质上是 <strong>修改了数据的引用</strong></p>
<ul>
<li>变量指向了新的引用</li>
</ul>
<h5 id="可变类型和不可变类型"><a href="#可变类型和不可变类型" class="headerlink" title="可变类型和不可变类型"></a>可变类型和不可变类型</h5><ul>
<li><strong>不可变类型</strong> ，内存中的数据不允许被修改：<ul>
<li><strong>数字类型</strong> int，bool，float，complex，long（2.x）</li>
<li><strong>字符串</strong> str</li>
<li><strong>元组</strong> tuple</li>
</ul>
</li>
<li><strong>可变类型</strong>，<strong>内存中的数据可以被修改</strong>：<ul>
<li><strong>列表</strong> list</li>
<li><strong>字典</strong> dict</li>
</ul>
</li>
</ul>
<p>注意：字典的 key <strong>只能使用不可变类型的数据</strong></p>
<p><strong>注意</strong></p>
<ol>
<li><strong>可变类型</strong>的数据变化，是通过 <strong>方法</strong> 来实现的</li>
<li>如果给一个可变类型的变量，赋值了一个新的数据，<strong>引用会修改</strong><ul>
<li>变量  <strong>不再</strong> 对之前的数据引用</li>
<li>变量  <strong>改为</strong> 对新赋值的数据引用</li>
</ul>
</li>
</ol>
<p><strong>哈希</strong></p>
<ul>
<li>Python 中内置有一个名字叫做 hash(0) 的函数<ul>
<li>接收一个不可变类型 的数据作为<strong>参数</strong></li>
<li><strong>返回</strong> 结果是一个 <strong>整数</strong></li>
</ul>
</li>
<li>哈希 是一种 <strong>算法</strong>，其作用就是 提取数据的 特征码（指纹）<ul>
<li><strong>相同的内容</strong> 得到 <strong>相同的结果</strong></li>
<li><strong>不同的内容</strong> 得到 <strong>不同的结果</strong></li>
</ul>
</li>
<li>在 Python 中，设置字典的 <strong>键值对</strong> 时，会首先对 key 进行 hash 已决定如何在<strong>内存</strong>中保存字典的数据，以方便 <strong>后续</strong> 对字典的操作：<strong>增</strong> <strong>删</strong> <strong>改</strong> <strong>查</strong><ul>
<li>键值对的 key 必须是不可变类型的数据</li>
<li>键值对的 value 可以是任意类型的数据</li>
</ul>
</li>
</ul>
<h5 id="局部变量和全局变量"><a href="#局部变量和全局变量" class="headerlink" title="局部变量和全局变量"></a>局部变量和全局变量</h5><h6 id="局部变量的作用"><a href="#局部变量的作用" class="headerlink" title="局部变量的作用"></a>局部变量的作用</h6><ul>
<li>在函数内部使用，临时保存 函数内部需要使用的数据</li>
</ul>
<h6 id="局部变量的生命周期"><a href="#局部变量的生命周期" class="headerlink" title="局部变量的生命周期"></a>局部变量的生命周期</h6><ul>
<li>所谓 <strong>生命周期</strong> 就是变量从 <strong>被创建</strong> 到<strong>被系统回收</strong> 的过程</li>
<li><strong>局部变量</strong> 在 函数执行时 才会被创建</li>
<li><strong>函数执行结束后</strong> 局部变量 <strong>被系统</strong>回收</li>
<li><strong>局部变量在生命周期</strong> 内，可以用来存储 <strong>函数内部临时使用到的数据</strong></li>
</ul>
<h4 id="局部变量"><a href="#局部变量" class="headerlink" title="局部变量"></a>局部变量</h4><ul>
<li><strong>局部变量</strong> 是在 <strong>函数内部</strong> 定义的变量，<strong>只能在函数内部使用</strong></li>
<li>函数执行结束后，<strong>函数内部的局部变量</strong>，<strong>会被系统回收</strong></li>
<li><strong>不同的函数</strong>，可以定义相同的名字的局部变量，但是彼此之间 <strong>不会产生影响</strong></li>
</ul>
<p>局部变量的作用</p>
<ul>
<li>在函数内部使用，临时 保存 函数内部需要使用的数据</li>
</ul>
<h3 id="递归"><a href="#递归" class="headerlink" title="递归"></a>递归</h3><h4 id="特点"><a href="#特点" class="headerlink" title="特点"></a>特点</h4><ul>
<li>一个函数内部调用自己<ul>
<li>函数内部可以调用其他函数，当然在函数内部也可以调用自己</li>
</ul>
</li>
</ul>
<p>代码特点</p>
<ol>
<li>函数内部的代码是相同的，只是针对 <strong>参数</strong>不同，<strong>处理的结果不同</strong></li>
<li>当 <strong>参数满足一个条件时</strong>，函数不再执行 <ul>
<li><strong>这个非常重要</strong>，通常被称为递归的出口，否则 <strong>会出现死循环</strong></li>
</ul>
</li>
</ol>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/2/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><a class="page-number" href="/page/2/">2</a><span class="page-number current">3</span><a class="page-number" href="/page/4/">4</a><a class="page-number" href="/page/5/">5</a><a class="extend next" rel="next" href="/page/4/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">John Doe</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">46</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">14</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">25</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          

          

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2019</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">John Doe</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Muse</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  

</body>
</html>
